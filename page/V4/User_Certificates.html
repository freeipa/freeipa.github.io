
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>User_Certificates &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/User_Certificates';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/User_Certificates.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>User_Certificates</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smart-card-authentication">Smart Card Authentication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#client-certificate-authentication">Client Certificate Authentication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#s-mime-and-user-signing-certificates">S/MIME and User Signing Certificates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-user-certificates">Storing User Certificates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#searching-certificates-by-clients">Searching Certificates by Clients</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#certificate-identity-mapping">Certificate Identity Mapping</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-custom-user-identifier">Storing Custom User Identifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#granularity-of-the-certificate-identity-mapping">Granularity of the Certificate Identity Mapping</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changes-to-certificate-bookkeeping">Changes to Certificate Bookkeeping</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revocation-of-the-certificates">Revocation of the Certificates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-test">How to Test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-freeipa-dogtag-pki-to-issue-user-certificates">Using FreeIPA/Dogtag PKI to issue user certificates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-cli-commands-to-manager-user-certificates">Using CLI commands to manager user certificates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-sssd-to-lookup-users-by-certificate">Using SSSD to lookup users by certificate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-smart-card-authentication-using-sssd-and-freeipa">Use case: smart card authentication using SSSD and FreeIPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="user-certificates">
<h1>User_Certificates<a class="headerlink" href="#user-certificates" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>FreeIPA <a class="reference external" href="Releases/4.1.0">4.1.0</a> or older and its <a class="reference external" href="PKI">PKI</a>
component can release certificates for <em>hosts</em> and <em>services</em>, both are
using the same <a class="reference external" href="PKI">PKI</a> profile. This functionality covers basic
needs of servers and their services, mostly TLS encryption, rarely also
TLS authentication (current profile can serve both as client and server
certificate for authentication). However, it does not allow <strong>users</strong> to
also leverage the benefits of the integrated <a class="reference external" href="PKI">PKI</a>, making it a
long standing <a class="reference external" href="PKI">PKI</a> debt. With <a class="reference external" href="V4/Certificate_Profiles">multiple certificate
profiles</a> and <a class="reference external" href="V4/Sub-CAs">ability to create lightweight
sub-CAs</a>, the user certificate extension is finally
realizable.</p>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h2>
</section>
<section id="smart-card-authentication">
<h2>Smart Card Authentication<a class="headerlink" href="#smart-card-authentication" title="Link to this heading">#</a></h2>
<p>This is the primary use case for this feature. FreeIPA administrators
should be able to issue Smart Cards (or X509 certificates in general) to
their users and configure FreeIPA to enable matching of the certificate
to the user entry itself. The feature will primarily focus on the new
SSSD PKCS#11 interface (<a class="reference external" href="https://fedorahosted.org/sssd/ticket/546">SSSD RFE ticket
#546</a>). The alternative for
SSSD PKCS#11 interface is the standard <code class="docutils literal notranslate"><span class="pre">pam_pkcs11</span></code> that is available
also on non-Linux platforms, but does not provide tight integration with
FreeIPA - certificate matching has to be configured on each client
(<a class="reference external" href="https://github.com/OpenSC/pam_pkcs11/blob/master/doc/README.ldap_mapper">example
config</a>).</p>
<p>This use case is generic and can result in different implementations,
given there are several options how the Smart Card certificate is loaded
to FreeIPA and if it is available before hand at all.</p>
</section>
<section id="client-certificate-authentication">
<h2>Client Certificate Authentication<a class="headerlink" href="#client-certificate-authentication" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="PKI">PKI</a> needs to be able to issue user certificates that can be
used for user certificate authentication against server, for example to
<a class="reference external" href="https://fedorahosted.org/mod_nss/">mod_nss</a> or
<a class="reference external" href="http://www.modssl.org/">mod_ssl</a>
<a class="reference external" href="http://httpd.apache.org/">Apache</a> modules.</p>
</section>
<section id="s-mime-and-user-signing-certificates">
<h2>S/MIME and User Signing Certificates<a class="headerlink" href="#s-mime-and-user-signing-certificates" title="Link to this heading">#</a></h2>
<p>Certificates can be used not only for user authentication, but also for
signing (<a class="reference external" href="http://en.wikipedia.org/wiki/S/MIME">S/MIME</a>). Mail user
agents are even able to catch them automatically from LDAP, as long as
the certificate is in user entry in <code class="docutils literal notranslate"><span class="pre">userCertificate;binary</span></code> attribute
(<a class="reference external" href="http://forums.mozillazine.org/viewtopic.php?t=465963">related MozillaZine
discussion</a>).
FreeIPA should be able to to both issue the certificate for signing in
its default profiles, but be able to serve as a server for MUAs to
automatically download the user S/MIME certificates.</p>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Link to this heading">#</a></h2>
<p>This feature consists of 4 main parts that need to be designed to met
the proposed use cases:</p>
<ul class="simple">
<li><p>Ability to issue user certificate with different profiles and key
usage (client/server authentication, signing or subject). This is
being solved by <a class="reference external" href="V4/Certificate_Profiles">V4/Certificate Profiles</a>
and <a class="reference external" href="V4/Sub-CAs">V4/Sub-CAs</a> designs.</p></li>
<li><p>Requesting and storing user certificates from <a class="reference external" href="PKI">PKI</a> in the
tree so that they can be searched, displayed by Web UI and revoked,
when needed</p></li>
<li><p>Searching certificates by clients - Smart Card, S/MIME use cases</p></li>
<li><p>Enrolling external certificates to the system - Smart Card use case</p></li>
</ul>
</section>
<section id="storing-user-certificates">
<h2>Storing User Certificates<a class="headerlink" href="#storing-user-certificates" title="Link to this heading">#</a></h2>
<p>Service and Host certificates are currently stored in the entries
themselves, when the certificate is request by the <code class="docutils literal notranslate"><span class="pre">cert-request</span></code>
command. When service/host is deleted, the stored certificate is
decoded, serial number identified and certificate then revoked in the
<a class="reference external" href="PKI">PKI</a>. The certificate is also revoked when the service/host
requests another certificate. There is thus always just one active
certificate for a service/host. Web UI is able to display the
service/host certificate and allow also manual revocation.</p>
<p>User certificates, multiple certificate profiles and sub-CAs add a twist
to this design as not all certificates need to be stored directly in the
user/service/host entry. For example, while S/MIME signing certificates
should be in the user entry so that mail clients can search for them,
TLS encryption or especially short-lived certificates (<a class="reference external" href="http://www.ietf.org/staging/draft-mccallum-websso-00.txt">Web
SSO</a> or
<a class="reference external" href="https://tools.ietf.org/html/rfc6717">kx509</a>) should not be in the
user entry at all to avoid unnecessary pollution of the <a class="reference external" href="Directory_Server">Directory
Server</a> replication changelog or making user entry
unnecessary big (and thus adding a risk of LDAP performance problems).</p>
<p>This design therefore removes the assumption that all certificates are
stored in user entry.</p>
</section>
<section id="searching-certificates-by-clients">
<h2>Searching Certificates by Clients<a class="headerlink" href="#searching-certificates-by-clients" title="Link to this heading">#</a></h2>
<p>In both cases, when (user) certificate is stored in an entry or not,
clients searching user authenticating with such certificate (read -
Smart Card use case) have to identify the user entry. The certificate
entry itself does not always identify the user entry in LDAP, the
clients (SSSD or pam_pkcs11) have to search for the user by other means.</p>
<p>There are several options how the clients can run the search:</p>
<ul class="simple">
<li><p><strong>Binary match on whole certificate</strong>: this is the simplest approach
to do as the user certificate can be retrieved from the Smart Card
and used in an LDAP filter. This approach requires the certificate to
be loaded in FreeIPA before Smart Card authentication. The
performance cost for searching by the whole blob (around 1K of binary
certificate) was not found to be significant enough to not allow this
as an option.</p></li>
<li><p><strong>CertificateMatch or CertificateExactMatch</strong>: support of the <a class="reference external" href="https://tools.ietf.org/html/rfc4523">RFC
4523, section 3.2</a> in the
<a class="reference external" href="Directory_Server">Directory Server</a> would allow search by a
certificate field directly in the LDAP search. However, this standard
is not supported in the 389 Directory Server yet, it is a complex
feature to add. See for example research done based on other LDAP
server variants (<a class="reference external" href="http://www.openldap.org/pub/slim/CMPaper.pdf">OpenLDAP
paper</a>, <a class="reference external" href="http://www.openldap.org/conf/odd-sandiego-2004/Sangseok.pdf">related
presentation</a>).
This approach also assumes that the certificate is in the user entry.</p></li>
<li><p><strong>Match on custom certificate attributes</strong>: in some environments it
is not possible for FreeIPA to dictate what should be in the
certificate as the certificate is provided by a 3rd party CA. However
this CA includes information in the certificate that is known in
advance and is unique per user. In this case is important to be able
to pre-provision user objects with the matching attribute+value that
will be found on the user’s Smart Card. This also means SSSD needs to
find, from a global configuration entry, what attribute it needs to
extract in order to use it to search the correct user entry. This
allows use of certificates without an explicit per-user provisioning
step when they are given a certificate/Smart Card.</p></li>
<li><p><strong>Match on a Kerberos principal</strong>: this is a special case of the
<em>Match on custom certificate attributes</em> option, but it is being
called out specifically as it would be the best default for FreeIPA
issued certificates that already contain the Kerberos principal SAN
extension and thus no modification to FreeIPA is needed.</p></li>
</ul>
<p>Given the high development costs of a <em>CertificateMatch</em>, this design
aims to cover support for <em>Binary match on whole certificate</em> option and
also discusses the proposal for the <em>Match on custom certificate
attributes</em> option.</p>
</section>
<section id="certificate-identity-mapping">
<h2>Certificate Identity Mapping<a class="headerlink" href="#certificate-identity-mapping" title="Link to this heading">#</a></h2>
<p>As noted in the <em>Match on custom certificate attributes</em> option, admin
should be able to specify custom rules for extracting the selected
certificate fields and use them in a user search filter. This leads to a
new <strong>Certificate Identity Mapping</strong> concept - a server side
configuration that would specify how the user should be search when
specific certificates are used.</p>
<p><strong>Certificate Identity Mapping parts</strong></p>
<ul class="simple">
<li><p><strong>Selector</strong>: what certificates does it apply to - especially issuer.
It can also select key usage or other certificate fields that the
client (SSSD) will use to match the authentication Smart
Card/certificate</p></li>
<li><p><strong>LDAP filter</strong>: the actual LDAP filter with placeholders from the
certificate that will be used for searching the user. The placeholder
should be an ASN.1 compatible way of telling SSSD the path to the
attribute itself. It should also support custom certificate
extensions, i.e. custom OID</p></li>
</ul>
<p>When Smart Card is authenticating to the system, SSSD would check all
the Certificate Identity Mapping, see which matches the public
certificate, extract the selected fields and use the resulting LDAP
filter for user search.</p>
<p>The search itself is only one part of the problem. FreeIPA also needs to
be able to <strong>store</strong> the unique per user configuration and an attribute
and let admin set it.</p>
<section id="storing-custom-user-identifier">
<h3>Storing Custom User Identifier<a class="headerlink" href="#storing-custom-user-identifier" title="Link to this heading">#</a></h3>
<p>When <em>Certificate Identity Mapping</em> are used, FreeIPA should be able to
provide a convenient attribute that can be used for storing the custom
matching field value (unless standard user attribute like <code class="docutils literal notranslate"><span class="pre">employeID</span></code>
is used). There should be a new attribute just for this purpose, with
Syntax and MatchingRule flexible enough to cover most use cases:</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>OID</p></th>
<th class="head"><p>Attribute Name</p></th>
<th class="head"><p>Syntax</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>TBD</p></td>
<td><p>ipaUserCertMatch</p></td>
<td><p>TBD</p></td>
<td><p>Custom matching attribute selection.</p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="granularity-of-the-certificate-identity-mapping">
<h3>Granularity of the Certificate Identity Mapping<a class="headerlink" href="#granularity-of-the-certificate-identity-mapping" title="Link to this heading">#</a></h3>
<p>Admins should be able to set the profile both for internal CA, but
especially for the <strong>external CA</strong>, from which each may use different
combination of the fields for the matching.</p>
</section>
</section>
<section id="changes-to-certificate-bookkeeping">
<h2>Changes to Certificate Bookkeeping<a class="headerlink" href="#changes-to-certificate-bookkeeping" title="Link to this heading">#</a></h2>
<p>This design changes the default expectation of current cert management
API for hosts and services as it always expected <code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> to
be filled and used for certificate manipulation and bookkeeping
(listing, revoking). Instead, some certificates may not be stored in the
user entry at all and only stored in Dogtag (especially the short lived
certificates).</p>
<section id="revocation-of-the-certificates">
<h3>Revocation of the Certificates<a class="headerlink" href="#revocation-of-the-certificates" title="Link to this heading">#</a></h3>
<p>All older version of FreeIPA always revoked the certificate when an
object (host, service) was deleted or disabled. With every revocation,
the certificate has to be added to the revocation list and properly
distributed in the CRL object. Big CRL revocation lists may cause issues
with replication
(<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4048">#4048</a>) or CRL
processing.</p>
<p>With this feature, objects are likely to have multiple certificates and
the revocation list growth would increase even more. This design
therefore plans to <strong>stop revoking certificates automatically</strong> as in
most cases (deleting objects/certificates when not useful) the
certificate does not have to be added to the revocation list and can be
simply deleted and left for natural expiration. However, there are still
cases when revocation is due (the key was compromised, user leaves
organization and retained a copy of the private key) and FreeIPA needs
to have ability to revoke these certificates.</p>
</section>
</section>
<section id="feature-management">
<h2>Feature Management<a class="headerlink" href="#feature-management" title="Link to this heading">#</a></h2>
<p>UI</p>
<p>When viewing an active user’s entry in FreeIPA WebUI the number of
certificates issued to the user will be displayed along with a button to
view a list of these certificates as Base64 encoded blobs. The
functionality to add and remove arbitrary certificates to the user (UI
counterpart of commands discussed in the section below) will also be
developed.</p>
<p>WebUI with also be extended to allow to request certificates for users
when a suitable <a class="reference external" href="V4/Certificate_Profiles">Certificate Profile</a> to
handle this task is configured.</p>
<p>CLI</p>
<p>Both <code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> values for externally issued certificates and
the special matching attribute (<code class="docutils literal notranslate"><span class="pre">ipaUserCertMatch</span></code>) can be added with
the standard <code class="docutils literal notranslate"><span class="pre">object-mod</span></code> command. These entries can live in similar
tree as the <a class="reference external" href="V4/Sub-CAs">Sub-CAs</a>.</p>
<p>Using <a class="reference external" href="V4/Certificate_Profiles">Certificate Profiles</a> feature it is
possible to issue certificates to users using <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">cert-request</span></code>
command. If the profile has <code class="docutils literal notranslate"><span class="pre">ipaCertProfileStoreIssued</span></code> attribute set
to <code class="docutils literal notranslate"><span class="pre">TRUE</span></code>, then the whole DER encoded certificate blob will be stored
in the <code class="docutils literal notranslate"><span class="pre">userCertificate;binary</span></code> attribute of the user entry.</p>
<p>Moreover, <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-add-cert</span></code> and <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-remove-cert</span></code> commands
were developed to add or remove arbitrary certificates to/from user’s
<code class="docutils literal notranslate"><span class="pre">userCertificate;binary</span></code> attribute. Both command share the following
syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span> <span class="n">user</span><span class="o">-</span><span class="p">{</span><span class="n">add</span><span class="o">|</span><span class="n">remove</span><span class="p">}</span><span class="o">-</span><span class="n">cert</span> <span class="p">[</span><span class="n">UID</span><span class="p">]</span> <span class="o">--</span><span class="n">certificate</span><span class="o">=</span><span class="p">[</span><span class="n">BASE64</span> <span class="n">BLOB</span><span class="p">]</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">UID</span></code> corresponds to the user login and <code class="docutils literal notranslate"><span class="pre">BASE64</span> <span class="pre">BLOB</span></code> is the
Base64 encoded blob between <code class="docutils literal notranslate"><span class="pre">-----BEGIN</span> <span class="pre">CERTIFICATE-----</span></code> and
<code class="docutils literal notranslate"><span class="pre">-----END</span> <span class="pre">CERTIFICATE-----</span></code> lines in standard PEM certificate. The
<code class="docutils literal notranslate"><span class="pre">--certificate</span></code> can be specified more that once to add or remove
multiple certificates in one call.</p>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">#</a></h2>
<p>A <strong>per certificate profile configuration</strong> (<a class="reference external" href="V4/Certificate_Profiles">Certificate Profile
design</a>) should be added, allowing admin
select the proper <code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> field treatment for the respective
profile, mostly based whether the certificate is short-lived or
long-lived:</p>
<ul class="simple">
<li><p>Store certificate</p></li>
<li><p>Do not track issued certificate</p></li>
</ul>
<p>If the <em>Store certificate</em> option is selected, there should be another
option available:</p>
<ul class="simple">
<li><p>Automatically revoke certificate when identity is disabled or deleted</p></li>
</ul>
</section>
<section id="upgrade">
<h2>Upgrade<a class="headerlink" href="#upgrade" title="Link to this heading">#</a></h2>
<p>Upgraded FreeIPA servers should default to <em>Store issued and enrolled
certificates</em> to avoid change of behavior with service and host
certificates. New installations should default to only <em>Record issued
and enrolled certificate</em> to avoid storing unnecessary data.</p>
</section>
<section id="how-to-test">
<h2>How to Test<a class="headerlink" href="#how-to-test" title="Link to this heading">#</a></h2>
</section>
<section id="using-freeipa-dogtag-pki-to-issue-user-certificates">
<h2>Using FreeIPA/Dogtag PKI to issue user certificates<a class="headerlink" href="#using-freeipa-dogtag-pki-to-issue-user-certificates" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>create/import a new certificate profile for handling requests for
user certificates. For quick testing of the feature you can just
export the default FreeIPA certificate profile to a file, change the
<code class="docutils literal notranslate"><span class="pre">profileId</span></code> and <code class="docutils literal notranslate"><span class="pre">desc</span></code> fields to values you like and import the
modified profile back to FreeIPA:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa certprofile-show caIPAserviceCert --out=caIPAuserCert.txt
...edit the resulting file...
$ ipa certprofile-import caIPAuserCert --file=caIPAuserCert.txt --store=True
</pre></div>
</div>
<p>For a comprehensive guide to preparation of certificate profile tailored
to a specifc use case see <a class="reference external" href="https://blog-ftweedal.rhcloud.com/2015/08/user-certificates-and-custom-profiles-with-freeipa-4-2/">this blog post from Fraser
Tweedale</a></p>
<ul class="simple">
<li><p>add a new CA ACL which permits requesting certificates for user
entries and add the custom profile to this CA ACL</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa caacl-add users_caIPAuserCert --usercat=all
$ ipa caacl-add-profile users_caIPAuserCert --certprofiles=caIPAuserCert
</pre></div>
</div>
<ul class="simple">
<li><p>generate a certificate request for the user e.g. using OpenSSL</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ openssl req -new -newkey rsa:2048 -days 365 -nodes -keyout private.key -out cert.csr -subj &#39;/CN=tuser&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>use <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">cert-request</span></code> command to request a new certificate for the
user.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa cert-request cert.csr --principal=tuser --profile-id=caIPAuserCert
</pre></div>
</div>
<ul class="simple">
<li><p>If using WebUI go to <em>Authentication</em> → <em>Certificates</em> and click the
<code class="docutils literal notranslate"><span class="pre">Issue</span></code> button. Select the custom profile in the <em>Profile ID</em>
drop-down menu, fill in the user login in <em>Principal</em> field and paste
the Base64 encoded CSR into the text field</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-show</span></code> and the user entry in WebUI should now display the
Base64 encoded certificate in addition to other attributes</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa user-show tuser
  User login: tuser
  First name: Test
  Last name: User
  Home directory: /home/tuser
  Login shell: /bin/sh
  Email address: tuser@ipadom.org
  UID: 553000003
  GID: 553000003
  Certificate: MIID/zCCAuegAwIBAgIBCz...
  Account disabled: False
  Password: False
  Member of groups: ipausers
  Kerberos keys available: False
</pre></div>
</div>
<ul class="simple">
<li><p>the newly issued certificate should be visible when viewing list of
certificates in WebUI</p></li>
</ul>
</section>
<section id="using-cli-commands-to-manager-user-certificates">
<h2>Using CLI commands to manager user certificates<a class="headerlink" href="#using-cli-commands-to-manager-user-certificates" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>generate one or more self-signed certificates using e.g. OpenSSL</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ openssl req -x509 -newkey rsa:2048 -days 365 -nodes -keyout private.key -out cert.pem -subj &#39;/CN=tuser&#39;
</pre></div>
</div>
<ul class="simple">
<li><p>convert the certificate do DER for easier handling through CLI</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ openssl x509 -outform der -in cert.pem -out cert.der
</pre></div>
</div>
<ul class="simple">
<li><p>use <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-add-cert</span></code> to add the certificate(s) to the user:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa user-add-cert tuser --certificate=&quot;$(base64 cert.der)&quot;
</pre></div>
</div>
<ul class="simple">
<li><p>use <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-show</span> <span class="pre">tuser</span></code> or view the user in the WebUI to verify
that the newly added certificate is displayed</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa user-show tuser
  User login: tuser
  First name: Test
  Last name: User
  Home directory: /home/tuser
  Login shell: /bin/sh
  Email address: tuser@ipadom.org
  UID: 553000003
  GID: 553000003
  Certificate: MIIC8zCCAdugAwIBAgI...
  Account disabled: False
  Password: False
  Member of groups: ipausers
  Kerberos keys available: False
</pre></div>
</div>
<ul class="simple">
<li><p>check that the following error is raised when you try to add the same
certificate again</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span><span class="p">:</span> <span class="n">ERROR</span><span class="p">:</span> <span class="s1">&#39;usercertificate;binary&#39;</span> <span class="n">already</span> <span class="n">contains</span> <span class="n">one</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">values</span>
</pre></div>
</div>
<ul class="simple">
<li><p>remove the certificate from the user entry using
<code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-remove-cert</span></code></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa user-remove-cert tuser --certificate=&quot;$(base64 cert.der)&quot;
</pre></div>
</div>
<ul class="simple">
<li><p>run <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-show</span> <span class="pre">tuser</span></code> or view the user in the WebUI; the
certificate will be no longer present</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa user-show tuser
  User login: tuser
  First name: Test
  Last name: User
  Home directory: /home/tuser
  Login shell: /bin/sh
  Email address: tuser@ipadom.org
  UID: 553000003
  GID: 553000003
  Account disabled: False
  Password: False
  Member of groups: ipausers
  Kerberos keys available: False
</pre></div>
</div>
<ul class="simple">
<li><p>check that an attempt to remove already removed certificate will
raise the error:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span><span class="p">:</span> <span class="n">ERROR</span><span class="p">:</span> <span class="n">usercertificate</span><span class="p">;</span><span class="n">binary</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">contain</span> <span class="s1">&#39;one or more values to remove&#39;</span>
</pre></div>
</div>
</section>
<section id="using-sssd-to-lookup-users-by-certificate">
<h2>Using SSSD to lookup users by certificate<a class="headerlink" href="#using-sssd-to-lookup-users-by-certificate" title="Link to this heading">#</a></h2>
<p>Starting with <a class="reference external" href="https://fedorahosted.org/sssd/wiki/Releases/Notes-1.13.0">version
1.13.0</a>
SSSD is now able to lookup user entries by the certificates issued to
them. To test this feature <em>sssd-dbus</em> package must be installed.</p>
<ul class="simple">
<li><p>enable SSSD Infopipe D-Bus interface by adding <code class="docutils literal notranslate"><span class="pre">ifp</span></code> to the
<code class="docutils literal notranslate"><span class="pre">services</span></code> entry in the <code class="docutils literal notranslate"><span class="pre">[sssd]</span></code> section of SSSD configuration
file (<code class="docutils literal notranslate"><span class="pre">/etc/sssd/sssd.conf</span></code> on Fedora).</p></li>
<li><p>restart sssd</p></li>
<li><p>add a certificate to the user entry with one of the methods discussed
in previous sections. Make sure you have the PEM certificate file at
hand</p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/sssd/wiki/DesignDocs/LookupUsersByCertificate">Query the SSSD D-Bus
interface</a>
for the user entry associated with the certificate by running the
following command as root:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dbus-send --system --print-reply  --dest=org.freedesktop.sssd.infopipe /org/freedesktop/sssd/infopipe/Users \</span>
<span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">sssd</span><span class="o">.</span><span class="n">infopipe</span><span class="o">.</span><span class="n">Users</span><span class="o">.</span><span class="n">FindByCertificate</span> <span class="n">string</span><span class="p">:</span><span class="s2">&quot;$(cat cert.pem)&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>check that the last element of the object path returned by the D-Bus
interface is the same as the UID of the user possessing the
certificate:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">method</span> <span class="k">return</span> <span class="n">sender</span><span class="o">=</span><span class="p">:</span><span class="mf">1.792</span> <span class="o">-&gt;</span> <span class="n">dest</span><span class="o">=</span><span class="p">:</span><span class="mf">1.793</span> <span class="n">reply_serial</span><span class="o">=</span><span class="mi">2</span> <span class="nb">object</span> <span class="n">path</span>
<span class="s2">&quot;/org/freedesktop/sssd/infopipe/Users/ipadom_2eorg/883600001&quot;</span>
</pre></div>
</div>
</section>
<section id="use-case-smart-card-authentication-using-sssd-and-freeipa">
<h2>Use case: smart card authentication using SSSD and FreeIPA<a class="headerlink" href="#use-case-smart-card-authentication-using-sssd-and-freeipa" title="Link to this heading">#</a></h2>
<p>Nathan Kinder put together blog series focused on practical provisioning
of Smart Cards using OpenSC and testing it with FreeIPA:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://blog-nkinder.rhcloud.com/?p=179">Part 1: Using smart cards with
FreeIPA</a></p></li>
<li><p><a class="reference external" href="https://blog-nkinder.rhcloud.com/?p=184">Part 2: Using smart cards with
FreeIPA</a></p></li>
</ul>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://blog-nkinder.rhcloud.com/?p=179">Nathan Kinder: Part 1: Using smart cards with
FreeIPA</a></p></li>
<li><p><a class="reference external" href="https://blog-nkinder.rhcloud.com/?p=184">Nathan Kinder: Part 2: Using smart cards with
FreeIPA</a></p></li>
<li><p><a class="reference external" href="https://blog-ftweedal.rhcloud.com/2015/08/user-certificates-and-custom-profiles-with-freeipa-4-2/">Fraser Tweedale: User certificates and custom profiles with FreeIPA
4.2</a></p></li>
</ul>
</section>
<section id="test-plan">
<h2>Test Plan<a class="headerlink" href="#test-plan" title="Link to this heading">#</a></h2>
<p>TBD</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smart-card-authentication">Smart Card Authentication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#client-certificate-authentication">Client Certificate Authentication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#s-mime-and-user-signing-certificates">S/MIME and User Signing Certificates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-user-certificates">Storing User Certificates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#searching-certificates-by-clients">Searching Certificates by Clients</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#certificate-identity-mapping">Certificate Identity Mapping</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-custom-user-identifier">Storing Custom User Identifier</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#granularity-of-the-certificate-identity-mapping">Granularity of the Certificate Identity Mapping</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changes-to-certificate-bookkeeping">Changes to Certificate Bookkeeping</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revocation-of-the-certificates">Revocation of the Certificates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-test">How to Test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-freeipa-dogtag-pki-to-issue-user-certificates">Using FreeIPA/Dogtag PKI to issue user certificates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-cli-commands-to-manager-user-certificates">Using CLI commands to manager user certificates</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-sssd-to-lookup-users-by-certificate">Using SSSD to lookup users by certificate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-smart-card-authentication-using-sssd-and-freeipa">Use case: smart card authentication using SSSD and FreeIPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>