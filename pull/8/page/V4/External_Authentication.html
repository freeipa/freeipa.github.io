

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>External_Authentication &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/External_Authentication';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="/_static/freeipa-logo-small.png" class="logo__image only-light" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/External_Authentication.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>External_Authentication</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#workflows">Workflows</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#external-authentication-workflow">External Authentication workflow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#negotiate-authentication-with-kerberos-credentials-workflow">Negotiate authentication with kerberos credentials workflow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#applications-operations">Applications operations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-changes">Main Changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use">How to Use</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#external-links">External links</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="external-authentication">
<h1>External_Authentication<a class="headerlink" href="#external-authentication" title="Permalink to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h2>
<p>In modern systems sometimes users need to be allowed to authenticate
using alternative protocols, like Federation protocols (SAML) or
Hardware Security Modules like Smart Cards (X509). This Feature captures
the changes needed to allow these alternative authentication methods to
interact with the FreeIPA UI and HTTP RPC pipes.</p>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">#</a></h2>
<p>An Active Directory Domain User uses ADFS (SAML) to authenticate to a
trusted IPA server, the user is known to the system but doesn’t have
Krb5 creds to interact with the framework.</p>
<p>A Smartcard owner wants to log in to the Web UI using the smartcard
without having to rely on PKINIT for Single Sign On. The user can be
authenticated via X509 certs to Apache but lacks krb5 creds to interact
with the framework.</p>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Permalink to this heading">#</a></h2>
<p>The solution is to allow the apache authentication modules to map the
user to an identity known by IPA and then impersonate the user by
requesting a ticket from the KDC (Protocol Transitioning).</p>
<figure class="align-default" id="id1">
<img alt="Ext-Auth.svg" src="../../_images/Ext-Auth.svg" /><figcaption>
<p><span class="caption-text">Ext-Auth.svg</span><a class="headerlink" href="#id1" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>The image above represent the final architecture implementing external
authentication.</p>
</section>
<section id="workflows">
<h2>Workflows<a class="headerlink" href="#workflows" title="Permalink to this heading">#</a></h2>
<p>The classic workflow where mod_auth_gssapi obtains a ticket and stores
it in a credential cache to be used by the ipa sever framework changes
to handle two different workflows: - External Authentication workflow. -
Negotiate authentication with kerberos credentials workflow. The form
based authentication internal workflow also changes slightly but it is
substantially the same as the Negotiate workflow so it won’t be
explicitly covered.</p>
<section id="external-authentication-workflow">
<h3>External Authentication workflow<a class="headerlink" href="#external-authentication-workflow" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>A user authenticates to an Apache module (A1)</p></li>
<li><p>After positive authentication the mod_lookup_identity module matches
the authenticated user to the correct IPA user via SSSD (A2).</p></li>
<li><p>With the correct principal name, mod_auth_gssapi performs a s4u2self
operation to obtain a ticket for the HTTP service on behalf of the
authenticating users (A3). The s4u2self step is actually done via
privilege separation interposition by gssproxy.</p></li>
<li><p>An (encrypted) credential is returned to mod_auth_gssapi, which
proceeds to store it in a ccache file (A4) that can be read by both
the Apache user and the ‘ipaapi’ user used to run the framework.</p></li>
<li><p>The workflow proceeds with step X described later.</p></li>
</ol>
</section>
<section id="negotiate-authentication-with-kerberos-credentials-workflow">
<h3>Negotiate authentication with kerberos credentials workflow<a class="headerlink" href="#negotiate-authentication-with-kerberos-credentials-workflow" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>A user with a kerberos ticket authenticates to mod_auth_gssapi (B1),
this happens via gssproxy interposition (B2) as the Apache server
does not have direct access to the HTTP keytab.</p></li>
<li><p>An (encrypted) credential is returned to mod_auth_gssapi, which
proceeds to store it (B3) in a ccache file that can be read by both
the Apache user and the ‘ipaapi’ user used to run the framework.</p></li>
<li><p>The wrokflow proceeds with step X described later.</p></li>
</ol>
</section>
<section id="applications-operations">
<h3>Applications operations<a class="headerlink" href="#applications-operations" title="Permalink to this heading">#</a></h3>
<blockquote>
<div><p>X. When the applications (ipa framewrok/dogtag/etc..) needs to talk
to the LDAP server (C1) it performs the usual s4u2proxy step using
these encrypted credentials (C2). the encrypted credentials are read
from the file ccache and are passed back to gssproxy which performs
the actual s4u2proxy operation as well as the context establishment
operation between HTTP and LDAP.</p>
</div></blockquote>
</section>
</section>
<section id="main-changes">
<h2>Main Changes<a class="headerlink" href="#main-changes" title="Permalink to this heading">#</a></h2>
<p>A few key changes to the current FreeIPA framework setup are needed:</p>
<ul class="simple">
<li><p>GSS-Proxy will need to be started on the box and given exclusive
access to the HTTP keytab, the configuration of GSS-Proxy must allow
impersonation only by the apache process (either via SELinux labels
or process uid) and allow proxying only by the Framework process
(again SELinux labels or process uid).
<a class="reference external" href="https://www.fedorahosted.org/freeipa/ticket/4189">4189</a></p></li>
<li><p>All the processes comprising the FreeIPA framework (Apache, framework
user, helper scrips) will need to be configured to be intercepted by
GSS-Proxy <a class="reference external" href="https://www.fedorahosted.org/freeipa/ticket/4189">4189</a></p></li>
<li><p>The Framework will need to be moved to a separate process interfaced
via mod_wsgi, so that the framework is not operating as the apache
user. <a class="reference external" href="https://www.fedorahosted.org/freeipa/ticket/5959">5959</a></p></li>
<li><p>credentials caches will need to be passed between the apache process
and the framework process, either by setting up a shared file area,
or by message passing of some kind (initially a shared file area
where both the apache user and the framework user can write is
probably sufficient).</p></li>
<li><p>The dogtag integration will finally need to be changed to use GSSAPI
authentication instead of using a certificate for the RA agent.
<a class="reference external" href="https://www.fedorahosted.org/freeipa/ticket/5011">5011</a> (this
step can be done separately after the rest)</p></li>
</ul>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">#</a></h2>
<p>The implementation requires changed to mod_auth_gssapi
(<a class="reference external" href="https://github.com/modauthgssapi/mod_auth_gssapi/pull/92">PR92</a>)
and other parts of the apache authentication configuration. It also
requires the introduction of GSS-Proxy to properly separate privileges
between the components.</p>
<ul class="simple">
<li><p><strong>Dependencies</strong>:</p>
<ul>
<li><p>New mod_auth_gssapi module including upstream PR92</p></li>
<li><p>New GSS-Proxy including access control for s4u2self VS s4u2proxy
functionality</p></li>
</ul>
</li>
</ul>
</section>
<section id="feature-management">
<h2>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">#</a></h2>
<p>UI</p>
<p>How the feature will be managed via the Web UI.</p>
<p>CLI</p>
<p>Authntication plugins for the CLI are TBD, the first goal is to get the
browser workflow working.</p>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">#</a></h2>
<p>Any configuration options? Any commands to enable/disable the feature or
turn on/off its parts?</p>
</section>
<section id="upgrade">
<h2>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this heading">#</a></h2>
<p>Configureation changes will be needed in various parts of FreeIPA. The
Framework will need to operate as a different user from the local apache
user:</p>
<ul class="simple">
<li><p>Create a new system user</p></li>
<li><p>Change/check file permissions for this new user</p></li>
<li><p>Change/check access permissions for any socket based interaction</p></li>
</ul>
<p>GSS-Proxy needs to be started:</p>
<ul class="simple">
<li><p>New service to be started by FreeIPA</p></li>
<li><p>New configuration snippets specific to the FreeIPA use case</p></li>
<li><p>SELinux Policy to make sure all the parts can properly communicate
with GSS-Proxy</p></li>
<li><p>IPA Keytab permissions need to be changed so that only GSS-Proxy can
access it</p></li>
</ul>
</section>
<section id="how-to-use">
<h2>How to Use<a class="headerlink" href="#how-to-use" title="Permalink to this heading">#</a></h2>
<p>Easy to follow instructions how to use the new feature according to the
<a class="reference external" href="#Use_Cases">use cases</a> described above. FreeIPA user needs to be
able to follow the steps and demonstrate the new features.</p>
<p>The chapter may be divided in sub-sections per <a class="reference external" href="#Use_Cases">Use
Case</a>.</p>
</section>
<section id="test-plan">
<h2>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">#</a></h2>
<p>Test scenarios that will be transformed to test cases for FreeIPA
<a class="reference external" href="V3/Integration_testing">Continuous Integration</a> during
implementation or review phase. This can be also link to <a class="reference external" href="https://git.fedorahosted.org/cgit/freeipa.git/">source in
cgit</a> with the test,
if appropriate.</p>
</section>
<section id="external-links">
<h2>External links<a class="headerlink" href="#external-links" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="V4/External_Authentication/Setup">The current smart card/x509 certificate
setup</a></p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/gss-proxy/ticket/133_GSS-Proxy_ticket">https://fedorahosted.org/gss-proxy/ticket/133 GSS-Proxy
ticket</a></p></li>
<li><p><a class="reference external" href="V4/External_Authentication/NSS_Impersonation">Using mod_nss’s NSSVerifyClient require + LookupUserByCertificate +
GssapiImpersonate</a>
– developer investigation</p></li>
</ul>
</section>
</section>


                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#workflows">Workflows</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#external-authentication-workflow">External Authentication workflow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#negotiate-authentication-with-kerberos-credentials-workflow">Negotiate authentication with kerberos credentials workflow</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#applications-operations">Applications operations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-changes">Main Changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use">How to Use</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#external-links">External links</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>