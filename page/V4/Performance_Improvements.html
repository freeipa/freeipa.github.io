
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Performance_Improvements &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/Performance_Improvements';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/Performance_Improvements.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Performance_Improvements</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slow-user-add">Slow user-add</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-slow-down-of-clis">Performance slow down of CLIs</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#authenticate">authenticate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#control-and-ldap-searches">Control and LDAP searches</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#add-user">Add user</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#update-of-the-group-membership">Update of the group membership</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#broken-schemacache">broken SchemaCache</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#option-noprivate-is-not-efficient">option –noprivate is not efficient</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cli-framework">CLI framework</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#user-add-cli">User-add CLI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-server">Directory Server</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ui">UI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cli">CLI</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slow-user-find">Slow user-find</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-do-extra-search-for-ipasshpubkey-attribute">Don’t do extra search for ipasshpubkey attribute</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-userpassword-krbprincipalkey-attributes-from-search-results">Remove userPassword, krbPrincipalKey attributes from search results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-members">processing members</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Feature Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">UI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">CLI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slow-host-find">Slow host-find</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Don’t do extra search for ipasshpubkey attribute</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Remove userPassword, krbPrincipalKey attributes from search results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">processing members</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Feature Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">UI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">CLI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Configuration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Upgrade</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#improvements-of-other-commands">Improvements of other commands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#typical-provisioning-ldapadd-entries-migrate-ds">typical provisioning: ldapadd entries, migrate-ds…</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case">Use case</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-throughput-and-ds-tuning">Provisioning throughput and DS tuning</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#entry-cache-tuning">Entry cache tuning</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#database-cache-tuning">database cache tuning</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#database-locks">database locks</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-throughput-and-ds-plugins">Provisioning throughput and DS plugins</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#small-db-10k-entries">Small DB (10K entries)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#medium-db-100k-entries">Medium DB (100K entries)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#memberof-plugin">Memberof plugin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#schema-compat-plugin">Schema compat plugin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#retrocl-plugin">RetroCL plugin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proposed-improvements">Proposed improvements</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#algorithm">Algorithm</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-constraints">Provisioning constraints</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-command">provisioning command</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detailed-descriptions-of-each-provisioning-costs">Detailed descriptions of each provisioning costs</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-the-test">summary of the test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-with-memberof-plugin">provisioning with memberof plugin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-without-memberof-plugin">provisioning without memberof plugin</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothese">Hypothese</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#all-commands">all commands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#all-commands-working-with-members-and-indirect-members">all commands working with members and indirect members</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find">*-find</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#members-and-indirect-members-processing">members and indirect members processing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#do-not-fetch-members-by-default">Do not fetch members by default</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-caching-of-members-during-find-command">Temporal caching of members during *-find command</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="performance-improvements">
<h1>Performance_Improvements<a class="headerlink" href="#performance-improvements" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>FreeIPA server has performance issue under certain circumstances. This
design page covers the improvements(topics) which will be done in scope
of 4.4 release. Each individual topic should have its own use cases,
design, implementation and feature management section.</p>
</section>
<section id="slow-user-add">
<h2>Slow user-add<a class="headerlink" href="#slow-user-add" title="Link to this heading">#</a></h2>
<p>Adding of higher number of users is slowing with the numbers of users
added.</p>
<p>Related ticket(s):
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448">#5448</a>,
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5788">#5788</a>,
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5787">#5787</a> ,
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5916">5916</a></p>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>We have already a big number of users. With new year it is required
to add couple thousands of users within a short period of time.</p></li>
<li><p>We are migrating from old solution to FreeIPA and need to add more
than 40K users.</p></li>
</ol>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Link to this heading">#</a></h2>
<p>Adding user is part of the ongoing administration of a freeipa
deployment. Few users can be added at a time but administrator may also
provision many users within a short period of administrative period
(typical a week end). Adding few users is usually done with CLIs like
<em>user-add</em>, <em>user-activate</em> or <em>user-undelete</em>. The problem of
performance with those CLI is that the CLI gets slower and slower as
there are more users in the deployment. Addressing this slow down is the
purpose of <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448">5448</a>.</p>
<p>On the other side administrator may want to fit into a given period, the
provisioning of large number of users. This is an administrative task
where it can be acceptable that during that period freeipa is not fully
operational. Some controls can be skipped or updates (like group
membership) can be postponed to the end of the provisioning. RFE should
be created for these improvements.</p>
<section id="performance-slow-down-of-clis">
<h3>Performance slow down of CLIs<a class="headerlink" href="#performance-slow-down-of-clis" title="Link to this heading">#</a></h3>
<p>There is slight difference between CLIs like <em>user-add</em>, <em>user-activate</em>
or <em>user-undelete</em> but regarding the performance they are all doing
similar phases:</p>
<ul class="simple">
<li><p>authenticate</p></li>
<li><p>do some controls with several searches on LDAP</p></li>
<li><p>add a user entry and make it member of groups (by default <em>ipausers</em>
group)</p></li>
<li><p>(optional: delete stage user or delete preserved user)</p></li>
</ul>
<p>In Freeipa 4.2 for example, adding a single user can last around 3sec
for the firsts users but if it already exist thousand of them it can
last for example 10sec with 50K users like described in this
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448#comment:10">update</a>. In
the rest of this paragraph, the base duration of <em>ipa user-add</em> is 10s
and duration of individual ldap request are given in percentage of 10s.</p>
<p>Regarding the duration (10s) of a <em>user-add</em> CLI with 50K users the
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448#comment:10">layout</a>
(initial durations) of the ldap operations given below. It shows that
‘~90%’ of “user-add” duration is spent in ‘DS’:</p>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kerberos</span> <span class="n">authentication</span><span class="p">:</span> <span class="mi">30</span><span class="o">%</span>
<span class="n">ldap</span> <span class="n">add</span><span class="p">:</span>                <span class="mi">28</span><span class="o">%</span>  <span class="p">(</span><span class="nb">sum</span> <span class="mi">58</span><span class="o">%</span><span class="p">)</span>
<span class="n">update</span> <span class="n">group</span> <span class="n">membership</span><span class="p">:</span> <span class="mi">15</span><span class="o">%</span>  <span class="p">(</span><span class="nb">sum</span> <span class="mi">73</span><span class="o">%</span><span class="p">)</span>
<span class="n">ldap</span> <span class="n">bind</span><span class="p">:</span>               <span class="mi">10</span><span class="o">%</span>  <span class="p">(</span><span class="nb">sum</span> <span class="mi">83</span><span class="o">%</span><span class="p">)</span>
<span class="n">user</span> <span class="n">membership</span> <span class="n">lookup</span><span class="p">:</span>   <span class="mi">8</span><span class="o">%</span>  <span class="p">(</span><span class="nb">sum</span> <span class="mi">91</span><span class="o">%</span><span class="p">)</span>
</pre></div>
</div>
<section id="authenticate">
<h4>authenticate<a class="headerlink" href="#authenticate" title="Link to this heading">#</a></h4>
<p>Authentication is done on the LDAP server using the GSSAPI external
mechanism and then being bound with the entry mapping the kerberos
principal. GSSAPI Kerberos authentication is also using LDAP server so
the complete authentication is looking like (note the delay between the
connection open and the BIND:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``Details:``

[11/Jan/2016:14:35:24 +0100] conn=86 fd=107 slot=107 connection from xxx to yyy
...
[11/Jan/2016:14:35:27 +0100] conn=86 op=0 BIND dn=&quot;&quot; method=sasl version=3 mech=GSSAPI
[11/Jan/2016:14:35:27 +0100] conn=4 op=376 RESULT err=0 tag=101 nentries=1 etime=0.004000
[11/Jan/2016:14:35:27 +0100] conn=86 op=0 RESULT err=14 tag=97 nentries=0 etime=0.015000, SASL bind in progress
[11/Jan/2016:14:35:28 +0100] conn=86 op=1 BIND dn=&quot;&quot; method=sasl version=3 mech=GSSAPI
[11/Jan/2016:14:35:28 +0100] conn=86 op=1 RESULT err=14 tag=97 nentries=0 etime=0.006000, SASL bind in progress
[11/Jan/2016:14:35:28 +0100] conn=86 op=2 BIND dn=&quot;&quot; method=sasl version=3 mech=GSSAPI
[11/Jan/2016:14:35:28 +0100] conn=86 op=2 RESULT err=0 tag=97 nentries=0 etime=0.002000 dn=&quot;uid=admin,cn=users,cn=accounts,``\ ``&quot;
....
....
&lt;MOD(s) to add the users into the related groups&gt;
....
</pre></div>
</div>
<p>kerberos authentication cost</p>
<p>The reason of the duration (3s in above example) taken by kerberos
authentication is that kerberos is doing several LDAP lookup and some of
them are quite expensive:</p>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">24</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">367</span> <span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(&amp;(|(objectClass=krbprincipalaux)(objectClass=krbprincipal)(objectClass=ipakrbprincipal))(|(ipaKrbPrincipalAlias=krbtgt/``\ ``@``\ ``)(krbPrincipalName=krbtgt/``\ ``@``\ ``)))&quot;</span>
<span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">24</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">367</span> <span class="n">RESULT</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span> <span class="n">tag</span><span class="o">=</span><span class="mi">101</span> <span class="n">nentries</span><span class="o">=</span><span class="mi">1</span> <span class="n">etime</span><span class="o">=</span><span class="mf">0.648000</span>
<span class="o">...</span>
<span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">24</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">369</span> <span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(&amp;(|(objectClass=krbprincipalaux)(objectClass=krbprincipal)(objectClass=ipakrbprincipal))(|(ipaKrbPrincipalAlias=ldap/``\ ``.``\ ``@``\ ``)(krbPrincipalName=ldap/``\ ``.``\ ``@``\ ``)))&quot;</span>
<span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">25</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">369</span> <span class="n">RESULT</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span> <span class="n">tag</span><span class="o">=</span><span class="mi">101</span> <span class="n">nentries</span><span class="o">=</span><span class="mi">1</span> <span class="n">etime</span><span class="o">=</span><span class="mf">0.646000</span>
<span class="o">...</span>
<span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">25</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">371</span> <span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(&amp;(|(objectClass=krbprincipalaux)(objectClass=krbprincipal))(krbPrincipalName=HTTP/``\ ``.``\ ``@``\ ``))&quot;</span>
<span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">26</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">371</span> <span class="n">RESULT</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span> <span class="n">tag</span><span class="o">=</span><span class="mi">101</span> <span class="n">nentries</span><span class="o">=</span><span class="mi">1</span> <span class="n">etime</span><span class="o">=</span><span class="mf">0.530000</span>
<span class="o">...</span>
<span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">26</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">373</span> <span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(&amp;(objectClass=ipaKrb5DelegationACL)(memberPrincipal=HTTP/``\ ``.``\ ``@``\ ``))&quot;</span>
<span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">26</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">373</span> <span class="n">RESULT</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span> <span class="n">tag</span><span class="o">=</span><span class="mi">101</span> <span class="n">nentries</span><span class="o">=</span><span class="mi">1</span> <span class="n">etime</span><span class="o">=</span><span class="mf">0.424000</span>
<span class="o">...</span>
<span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">26</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">374</span> <span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(&amp;(|(objectClass=krbprincipalaux)(objectClass=krbprincipal))(krbPrincipalName=admin@``\ ``))&quot;</span>
<span class="p">[</span><span class="mi">11</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">27</span> <span class="o">+</span><span class="mi">0100</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">4</span> <span class="n">op</span><span class="o">=</span><span class="mi">374</span> <span class="n">RESULT</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span> <span class="n">tag</span><span class="o">=</span><span class="mi">101</span> <span class="n">nentries</span><span class="o">=</span><span class="mi">1</span> <span class="n">etime</span><span class="o">=</span><span class="mf">0.551000</span>
</pre></div>
</div>
<p>The SRCH requests are costly because of the base search, each of them
triggers an internal lookup in the schema compat plugin map. The more
entries (users) are present in the map, the more expensive the lookup
is. For example, the same searches without schema compat lookup are 35
times faster.</p>
<p>There are several possibilities to avoid this extra cost:</p>
<ul class="simple">
<li><p>change the base search to that it does not cover the <em>cn=compat,</em>.
But krb principals are either in <em>cn=kerberos</em> and <em>cn=accounts</em>.
Changing the the single search into two searches on each branch was
too complex and this idea was dropped</p></li>
<li><p>Add a new ldap control supported by schema compat, so that a ldap
client could request schema compat to avoid lookup into the map. Two
tickets were opened for
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5599">client</a> and <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5597">server
side</a>.</p></li>
<li><p>Kerberos is looking of real users, not for compat users. The idea is
to make schema compat aware the request comes from kerberos
application and so avoid lookup in the map. Kerberos access ldap
server using <em>ldapi</em> interface and authenticate as <em>cn=directory
manager</em>. A simple fix on schema compat plugin side, is to ignore any
requests coming <em>ldapi/root</em>.</p></li>
</ul>
<p>The solution implemented to address the kerberos authentication cost was
fixing <strong>schema compat</strong> because it is an easy fix. 389-ds server,
<em>assuming</em> that a local agent (<em>ldapi</em> interface) bound as <em>root</em> (like
kerberos) is not interested by the schema compat mapped entries.</p>
<p>ldap bind cost</p>
<p>The ldap BIND itself is not expensive. In the above example, it lasts
around 0.012s that is not significant (0.1%) regarding the complete
user-add duration (take a base time of 10s). Looking at the top
consumption of DS plugins, none of plugin involved in BIND op appears in
top consumer.</p>
<p>For this reason we did not do specific improvement on LDAP BIND</p>
</section>
<section id="control-and-ldap-searches">
<h4>Control and LDAP searches<a class="headerlink" href="#control-and-ldap-searches" title="Link to this heading">#</a></h4>
<p>Adding a freeipa user mainly consist in add user entry and update the
group(s) the user entry belongs to. Before and after each of those two
steps, there are several LDAP searchs like: reading the config
(<em>cn=ipaconfig,cn=etc,</em>), checking that the user does not already exist
(active or preserved or private group), checking credential, and group
membership.</p>
<p>The total number of searches is typically 25 but only one is expensive
the search looking for group membership of the added user (see
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448#comment:10">update</a>).</p>
<p>Some optimization could likely be done on the 24 others. For example 13
out of the 24 are identical and are reading the config
(<em>cn=ipaconfig,cn=etc,</em>). The total of those search account for ~0.04s
that is not significant (0.4% req duration) but would likely increase
more response time because of the multiple requests to send/wait/decode.
The caching of the ipaconfig has been fixed in
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5463">5463</a>. With this fix,
only one lookup of ipaconfig is done.</p>
<p>The request that is expensive is :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">05</span><span class="o">/</span><span class="n">Apr</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">33</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">75540</span> <span class="n">op</span><span class="o">=</span><span class="mi">17</span> <span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(|(member=uid=tb51420,cn=users,cn=accounts,``\ ``)(memberUser=uid=tb51420,cn=users,cn=accounts,``\ ``)(memberHost=uid=tb51420,cn=users,cn=accounts,``\ ``))&quot;</span> <span class="n">attrs</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="p">[</span><span class="mi">05</span><span class="o">/</span><span class="n">Apr</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">33</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">75540</span> <span class="n">op</span><span class="o">=</span><span class="mi">17</span> <span class="n">RESULT</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span> <span class="n">tag</span><span class="o">=</span><span class="mi">101</span> <span class="n">nentries</span><span class="o">=</span><span class="mi">0</span> <span class="n">etime</span><span class="o">=</span><span class="mf">0.275000</span>
</pre></div>
</div>
</section>
<section id="add-user">
<h4>Add user<a class="headerlink" href="#add-user" title="Link to this heading">#</a></h4>
<p>The add of the user account is looking like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">05</span><span class="o">/</span><span class="n">Apr</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">31</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">75540</span> <span class="n">op</span><span class="o">=</span><span class="mi">13</span> <span class="n">ADD</span> <span class="n">dn</span><span class="o">=</span><span class="s2">&quot;uid=tb51420,cn=users,cn=accounts,``\ ``&quot;</span>
<span class="p">[</span><span class="mi">05</span><span class="o">/</span><span class="n">Apr</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">33</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">75540</span> <span class="n">op</span><span class="o">=</span><span class="mi">13</span> <span class="n">RESULT</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span> <span class="n">tag</span><span class="o">=</span><span class="mi">105</span> <span class="n">nentries</span><span class="o">=</span><span class="mi">0</span> <span class="n">etime</span><span class="o">=</span><span class="mf">1.850000</span>
</pre></div>
</div>
<p>The ldap ADD accounts for nearly 20% of the total CLI. But
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448#comment:6">90%</a> of the
time spent in the ADD is spent in 6 lookup in schema compat map. Those
lookup are <strong>internal searches</strong> done by DNA, uniqueness
(krbPrincipalName, krbCanonicalName, ipaUniqueID, uid) and schema compat
itself.</p>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span> <span class="n">identical</span> <span class="n">internal</span> <span class="n">search</span> <span class="n">done</span> <span class="n">by</span> <span class="s1">&#39;DNA&#39;</span>
<span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(&amp;(|(objectClass=posixAccount)(objectClass=posixGroup)(objectClass=ipaIDobject))(|(uidNumber=1677038171)(gidNumber=1677038171)))&quot;</span> <span class="n">attrs</span><span class="o">=</span><span class="s2">&quot;dn&quot;</span>
<span class="mi">3</span> <span class="n">searches</span> <span class="n">done</span> <span class="n">by</span> <span class="s1">&#39;uniqueness&#39;</span>
<span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(&amp;(objectClass=posixAccount)(|(uid=tb38189)))&quot;</span> <span class="n">attrs</span><span class="o">=</span><span class="s2">&quot;dn&quot;</span>
<span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(|(ipaUniqueID=8549a6d6-a969-11e5-bfb1-001a4a231292))&quot;</span> <span class="n">attrs</span><span class="o">=</span><span class="s2">&quot;dn&quot;</span>
<span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">2</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(|(krbPrincipalName=tb38189@``\ ``))&quot;</span> <span class="n">attrs</span><span class="o">=</span><span class="s2">&quot;dn&quot;</span>
<span class="mi">1</span> <span class="n">search</span> <span class="n">done</span> <span class="n">by</span> <span class="s1">&#39;schema compat&#39;</span><span class="o">.</span> <span class="n">note</span> <span class="n">this</span> <span class="n">one</span> <span class="n">dumps</span> <span class="n">ipausers</span> <span class="n">group</span>
<span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;cn=groups,cn=accounts,``\ ``&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">1</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(member=uid=tb38189,cn=users,cn=accounts,``\ ``)&quot;</span> <span class="n">attrs</span><span class="o">=</span><span class="n">ALL</span>
</pre></div>
</div>
<p>There are two options to reduce the impact of those internal searches:</p>
<ul class="simple">
<li><p>modify DNA and uniqueness plugins configuration like described
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448#comment:7">here</a>. It
does not fix the last internal search triggered by ‘schema compat’
itself. Those change improves the performance of LDAP ADD by 10.</p></li>
<li><p>Fixing schema compat plugin so that it does not trigger map lookup on
<strong>internal operations</strong>. This fix has a large impact as it applies
for any use case not only user-add. The gain is in the same range ADD
drops from 2.7s to 0.3s (see
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448#comment:10">update</a>)</p></li>
</ul>
<p>Because of the fix in schema compat being very simple (skip internal
operation), major gain (even for other use case). This is the one that
was implement.</p>
</section>
<section id="update-of-the-group-membership">
<h4>Update of the group membership<a class="headerlink" href="#update-of-the-group-membership" title="Link to this heading">#</a></h4>
<p>When a user is added it is by default added to the group
‘’cn=ipausers,cn=groups,cn=accounts,”. This updates last around 15% of
the duration of the CLI.
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448#comment:8">Half</a> of the
duration of group update is spent in schema compat plugin handling
<strong>internal operation</strong>. Those operations where triggered by others
plugins:</p>
<ul class="simple">
<li><p>memberof</p></li>
<li><p>mep</p></li>
<li><p>check-range</p></li>
<li><p>uuid</p></li>
<li><p>password-retry</p></li>
</ul>
<p>Except for <em>mep</em> plugins, changing the plugin configuration in order to
avoid schema compat divides by 2 the duration of the update of the
group.</p>
<p>There are two options to reduce the impact of those internal searches:</p>
<ul class="simple">
<li><p>modify the configuration of the above plugins like it is described
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448#comment:8">here</a>.
Improvement for mep plugin can not be achieve that way. The gains is
to divide by 2 the update</p></li>
<li><p>Fixing schema compat plugin so that it does not trigger map lookup on
<strong>internal operations</strong>. This fix has a large impact as it applies
for any use case not only MOD of groups. The gain is higher, MOD
drops from 1.56s to 0.46s
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5448#comment:10">update</a></p></li>
</ul>
<p>Because the fix in <strong>schema compat</strong> being very simple (skip internal
operation), <strong>major gain</strong> (even for other use case). This is the one
that was implemented.</p>
</section>
<section id="broken-schemacache">
<h4>broken SchemaCache<a class="headerlink" href="#broken-schemacache" title="Link to this heading">#</a></h4>
<p>Due <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5787">#5787</a> every IPA
command call downloads the LDAP schema first without any caching. It
took 40-60% of time of user-add command without groups.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``Profiler output:``

170386 function calls (170213 primitive calls) in  0.680  seconds
Ordered by: cumulative time

ncalls  tottime  percall  cumtime  percall filename:lineno(function)
...
206    0.000    0.000    0.470    0.002 /usr/lib/python2.7/site-packages/ipapython/ipaldap.py:731(_get_schema)
  1    0.000    0.000    0.470    0.470 /usr/lib/python2.7/site-packages/ipapython/ipaldap.py:113(get_schema)
  1    0.000    0.000    0.470    0.470 /usr/lib/python2.7/site-packages/ipapython/ipaldap.py:140(_retrieve_schema_from_server)
 32    0.000    0.000    0.364    0.011 /usr/lib64/python2.7/site-packages/ldap/ldapobject.py:87(_ldap_call)
 ...
</pre></div>
</div>
<p>This performance issue will be resolved by fixing
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5787">#5787</a>.</p>
</section>
<section id="option-noprivate-is-not-efficient">
<h4>option –noprivate is not efficient<a class="headerlink" href="#option-noprivate-is-not-efficient" title="Link to this heading">#</a></h4>
<p>Related ticket(s):
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5788">#5788</a></p>
<p>With option –noprivate postcallback of user_add command executes
user-mod command for simple value change. This is ineffective and
internal ldap mod call should be executed.</p>
</section>
<section id="cli-framework">
<h4>CLI framework<a class="headerlink" href="#cli-framework" title="Link to this heading">#</a></h4>
<p>The following
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Directory_Server">implementation</a>
drop the CLI duration from 10s to 3s. However, looking at the time spent
in those 3s, it appears that remaining ldap requests are only accounting
for 0.5s, so it remains more than 2s spent in CLI framework. The
following ticket <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5916">5916</a>
is to track this remaining part</p>
</section>
</section>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
<section id="user-add-cli">
<h3>User-add CLI<a class="headerlink" href="#user-add-cli" title="Link to this heading">#</a></h3>
<p>The improvement described in <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Control_and_LDAP_searches">Control and LDAP
searches</a>
was implemented since <strong>4.3.4</strong> with the ticket
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5463">5463</a> and
<a class="reference external" href="https://git.fedorahosted.org/cgit/freeipa.git/commit/?id=7f0d018c66da1fe2adedd45aa9f5a63c913e4527">commit</a></p>
</section>
<section id="directory-server">
<h3>Directory Server<a class="headerlink" href="#directory-server" title="Link to this heading">#</a></h3>
<p>The improvement seen in
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#authenticate">authenticate</a>
was implemented in slapi-nis plugin.</p>
<p>The improvements seen in ldap
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Add_user">ADD</a>
and
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Update_of_the_group_membership">MOD</a>
were implemented in slapi-nis plugin <a class="reference external" href="https://git.fedorahosted.org/cgit/slapi-nis.git/diff/src/back-sch.c?id=594fcb2320033d01cfe2b8121793d431d1017987">slapi-nis: process requests only
when initialization
completed</a>.
Actually the subject of the commit does not reflect those changes in
that file, where the perf improvement are</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span>  <span class="k">if</span> <span class="p">(</span><span class="n">slapi_op_internal</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">slapi_is_ldapi_conn</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isroot</span><span class="p">))</span> <span class="p">{</span>
<span class="o">+</span>      <span class="o">/*</span> <span class="n">The</span> <span class="n">plugin</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">engage</span> <span class="ow">in</span> <span class="n">internal</span> <span class="n">searches</span> <span class="n">of</span> <span class="n">other</span>
<span class="o">+</span>       <span class="o">*</span> <span class="n">plugins</span> <span class="ow">or</span> <span class="n">ldapi</span><span class="o">+</span><span class="n">cn</span><span class="o">=</span><span class="n">DM</span> <span class="o">*/</span>
<span class="o">+</span>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="o">+</span>  <span class="p">}</span>
</pre></div>
</div>
<p>Those improvements are available since <strong>Release 0.55</strong></p>
</section>
</section>
<section id="feature-management">
<h2>Feature Management<a class="headerlink" href="#feature-management" title="Link to this heading">#</a></h2>
<section id="ui">
<h3>UI<a class="headerlink" href="#ui" title="Link to this heading">#</a></h3>
</section>
<section id="cli">
<h3>CLI<a class="headerlink" href="#cli" title="Link to this heading">#</a></h3>
</section>
</section>
<section id="slow-user-find">
<h2>Slow user-find<a class="headerlink" href="#slow-user-find" title="Link to this heading">#</a></h2>
<p>High number of users stored in LDAP causes slowdown of the IPA command.</p>
<p>Related ticket(s):
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5281">#5281</a>,
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5282">#5282</a>,
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3376">#3376</a>,
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4995">#4995</a></p>
</section>
<section id="id1">
<h2>Use Cases<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Increase the usability of user-find command because with many users
searches in LDAP take too long and may result into timeout.</p></li>
</ol>
</section>
<section id="id2">
<h2>Design<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<section id="don-t-do-extra-search-for-ipasshpubkey-attribute">
<h3>Don’t do extra search for ipasshpubkey attribute<a class="headerlink" href="#don-t-do-extra-search-for-ipasshpubkey-attribute" title="Link to this heading">#</a></h3>
<p>Related ticket(s):
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3376">#3376</a>,
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5281">#5281</a></p>
<p><em>ipasshpubkey</em> can be fetched together with user entry, there is no need
for an extra search operation.</p>
<p><code class="docutils literal notranslate"><span class="pre">User-find</span> <span class="pre">with</span> <span class="pre">2000</span> <span class="pre">entries</span> <span class="pre">with</span> <span class="pre">sshpubkey</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">6310241</span> <span class="n">function</span> <span class="n">calls</span> <span class="p">(</span><span class="mi">6200125</span> <span class="n">primitive</span> <span class="n">calls</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">16.453</span> <span class="n">seconds</span>
   <span class="n">Ordered</span> <span class="n">by</span><span class="p">:</span> <span class="n">cumulative</span> <span class="n">time</span>
   <span class="n">ncalls</span>  <span class="n">tottime</span>  <span class="n">percall</span>  <span class="n">cumtime</span>  <span class="n">percall</span> <span class="n">filename</span><span class="p">:</span><span class="n">lineno</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
   <span class="o">....</span>
        <span class="mi">1</span>    <span class="mf">0.027</span>    <span class="mf">0.027</span>   <span class="mf">16.449</span>   <span class="mf">16.449</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2015</span><span class="p">(</span><span class="n">execute</span><span class="p">)</span>
     <span class="mi">6002</span>    <span class="mf">0.256</span>    <span class="mf">0.000</span>   <span class="mf">12.501</span>    <span class="mf">0.002</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipapython</span><span class="o">/</span><span class="n">ipaldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1272</span><span class="p">(</span><span class="n">find_entries</span><span class="p">)</span>
        <span class="mi">1</span>    <span class="mf">0.008</span>    <span class="mf">0.008</span>    <span class="mf">9.519</span>    <span class="mf">9.519</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">801</span><span class="p">(</span><span class="n">post_callback</span><span class="p">)</span>
        <span class="mi">1</span>    <span class="mf">0.041</span>    <span class="mf">0.041</span>    <span class="mf">9.392</span>    <span class="mf">9.392</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseuser</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">618</span><span class="p">(</span><span class="n">post_common_callback</span><span class="p">)</span>
    <span class="mi">16009</span>    <span class="mf">0.120</span>    <span class="mf">0.000</span>    <span class="mf">6.697</span>    <span class="mf">0.000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">87</span><span class="p">(</span><span class="n">_ldap_call</span><span class="p">)</span>
    <span class="mi">10006</span>    <span class="mf">0.024</span>    <span class="mf">0.000</span>    <span class="mf">6.348</span>    <span class="mf">0.001</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">472</span><span class="p">(</span><span class="n">result3</span><span class="p">)</span>
    <span class="mi">10006</span>    <span class="mf">0.057</span>    <span class="mf">0.000</span>    <span class="mf">6.324</span>    <span class="mf">0.001</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">480</span><span class="p">(</span><span class="n">result4</span><span class="p">)</span>
    <span class="mi">10006</span>    <span class="mf">6.114</span>    <span class="mf">0.001</span>    <span class="mf">6.114</span>    <span class="mf">0.001</span> <span class="p">{</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">result4</span><span class="p">}</span>
     <span class="mi">2000</span>    <span class="mf">0.053</span>    <span class="mf">0.000</span>    <span class="mf">5.341</span>    <span class="mf">0.003</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">733</span><span class="p">(</span><span class="n">get_password_attributes</span><span class="p">)</span>
        <span class="mi">1</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">4.283</span>    <span class="mf">4.283</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1145</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
     <span class="mi">2000</span>    <span class="mf">0.043</span>    <span class="mf">0.000</span>    <span class="mf">3.787</span>    <span class="mf">0.002</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">util</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">293</span><span class="p">(</span><span class="n">convert_sshpubkey_post</span><span class="p">)</span>
    <span class="mi">10004</span>    <span class="mf">0.095</span>    <span class="mf">0.000</span>    <span class="mf">3.147</span>    <span class="mf">0.000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipapython</span><span class="o">/</span><span class="n">ipaldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">895</span><span class="p">(</span><span class="n">_convert_result</span><span class="p">)</span>
<span class="o">.....</span>
</pre></div>
</div>
<p>As profiling output shows approximately <strong>23%</strong> of time was spent on
processing <em>ipasshpubkey</em> attribute because for each user it was
downloaded separately</p>
<p>ldap access log contains</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">15</span><span class="o">/</span><span class="n">Apr</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">11</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">30</span> <span class="n">op</span><span class="o">=</span><span class="mi">5624</span> <span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;uid=user1871,cn=users,cn=accounts,dc=example,dc=com&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">0</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(objectClass=*)&quot;</span> <span class="n">attrs</span><span class="o">=</span><span class="s2">&quot;ipaSshPubKey&quot;</span>
<span class="p">[</span><span class="mi">15</span><span class="o">/</span><span class="n">Apr</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">11</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">30</span> <span class="n">op</span><span class="o">=</span><span class="mi">5624</span> <span class="n">RESULT</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span> <span class="n">tag</span><span class="o">=</span><span class="mi">101</span> <span class="n">nentries</span><span class="o">=</span><span class="mi">1</span> <span class="n">etime</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p>for each user (2000 times for this case)</p>
<p>Fetching <em>ipsshpubkey</em> together with all attributes in one search will
increase speed rapidly.</p>
</section>
<section id="remove-userpassword-krbprincipalkey-attributes-from-search-results">
<h3>Remove userPassword, krbPrincipalKey attributes from search results<a class="headerlink" href="#remove-userpassword-krbprincipalkey-attributes-from-search-results" title="Link to this heading">#</a></h3>
<p>Related ticket(s):
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5281">#5281</a></p>
<p><em>userPassword</em> and <em>krbPrincipalKey</em> attributes require extra search.
These attribute should be removed from user-find command to get better
performance.</p>
<p><code class="docutils literal notranslate"><span class="pre">user-find</span> <span class="pre">with</span> <span class="pre">2000</span> <span class="pre">users:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">6310241</span> <span class="n">function</span> <span class="n">calls</span> <span class="p">(</span><span class="mi">6200125</span> <span class="n">primitive</span> <span class="n">calls</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">16.453</span> <span class="n">seconds</span>
   <span class="n">Ordered</span> <span class="n">by</span><span class="p">:</span> <span class="n">cumulative</span> <span class="n">time</span>
   <span class="n">ncalls</span>  <span class="n">tottime</span>  <span class="n">percall</span>  <span class="n">cumtime</span>  <span class="n">percall</span> <span class="n">filename</span><span class="p">:</span><span class="n">lineno</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
   <span class="o">....</span>
        <span class="mi">1</span>    <span class="mf">0.027</span>    <span class="mf">0.027</span>   <span class="mf">16.449</span>   <span class="mf">16.449</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2015</span><span class="p">(</span><span class="n">execute</span><span class="p">)</span>
     <span class="mi">6002</span>    <span class="mf">0.256</span>    <span class="mf">0.000</span>   <span class="mf">12.501</span>    <span class="mf">0.002</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipapython</span><span class="o">/</span><span class="n">ipaldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1272</span><span class="p">(</span><span class="n">find_entries</span><span class="p">)</span>
        <span class="mi">1</span>    <span class="mf">0.008</span>    <span class="mf">0.008</span>    <span class="mf">9.519</span>    <span class="mf">9.519</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">801</span><span class="p">(</span><span class="n">post_callback</span><span class="p">)</span>
        <span class="mi">1</span>    <span class="mf">0.041</span>    <span class="mf">0.041</span>    <span class="mf">9.392</span>    <span class="mf">9.392</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseuser</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">618</span><span class="p">(</span><span class="n">post_common_callback</span><span class="p">)</span>
    <span class="mi">16009</span>    <span class="mf">0.120</span>    <span class="mf">0.000</span>    <span class="mf">6.697</span>    <span class="mf">0.000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">87</span><span class="p">(</span><span class="n">_ldap_call</span><span class="p">)</span>
    <span class="mi">10006</span>    <span class="mf">0.024</span>    <span class="mf">0.000</span>    <span class="mf">6.348</span>    <span class="mf">0.001</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">472</span><span class="p">(</span><span class="n">result3</span><span class="p">)</span>
    <span class="mi">10006</span>    <span class="mf">0.057</span>    <span class="mf">0.000</span>    <span class="mf">6.324</span>    <span class="mf">0.001</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">480</span><span class="p">(</span><span class="n">result4</span><span class="p">)</span>
    <span class="mi">10006</span>    <span class="mf">6.114</span>    <span class="mf">0.001</span>    <span class="mf">6.114</span>    <span class="mf">0.001</span> <span class="p">{</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">result4</span><span class="p">}</span>
     <span class="mi">2000</span>    <span class="mf">0.053</span>    <span class="mf">0.000</span>    <span class="mf">5.341</span>    <span class="mf">0.003</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">733</span><span class="p">(</span><span class="n">get_password_attributes</span><span class="p">)</span>
        <span class="mi">1</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">4.283</span>    <span class="mf">4.283</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1145</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
        <span class="o">....</span>
</pre></div>
</div>
<p>Getting and processing password attributes took approximately <strong>32%</strong> of
time.</p>
<p>The ldap access log contains</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">15</span><span class="o">/</span><span class="n">Apr</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">12</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">30</span> <span class="n">op</span><span class="o">=</span><span class="mi">5764</span> <span class="n">SRCH</span> <span class="n">base</span><span class="o">=</span><span class="s2">&quot;uid=user1918,cn=users,cn=accounts,dc=example,dc=com&quot;</span> <span class="n">scope</span><span class="o">=</span><span class="mi">0</span> <span class="nb">filter</span><span class="o">=</span><span class="s2">&quot;(krbPrincipalKey=*)&quot;</span> <span class="n">attrs</span><span class="o">=</span><span class="s2">&quot;krbPrincipalKey&quot;</span>
<span class="p">[</span><span class="mi">15</span><span class="o">/</span><span class="n">Apr</span><span class="o">/</span><span class="mi">2016</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">12</span> <span class="o">+</span><span class="mi">0200</span><span class="p">]</span> <span class="n">conn</span><span class="o">=</span><span class="mi">30</span> <span class="n">op</span><span class="o">=</span><span class="mi">5764</span> <span class="n">RESULT</span> <span class="n">err</span><span class="o">=</span><span class="mi">0</span> <span class="n">tag</span><span class="o">=</span><span class="mi">101</span> <span class="n">nentries</span><span class="o">=</span><span class="mi">0</span> <span class="n">etime</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p>for each user (2000 times for this case)</p>
<p>Note: this change causes that the output of user-find is not backward
compatible.</p>
</section>
<section id="processing-members">
<h3>processing members<a class="headerlink" href="#processing-members" title="Link to this heading">#</a></h3>
<p>user-find does not process members (groups, roles, sudorules, hbacrules,
…) by default.</p>
<p>However with option –all</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa user-find --all
ipa: ERROR: cannot connect to &#39;``\ ```https://ipa.example.com/ipa/json`` &lt;https://ipa.example.com/ipa/json&gt;`__\ ``&#39;: Gateway Timeout
</pre></div>
</div>
<p>This testcase contains 2000 users with 110 direct and indirect
memberships.</p>
<p>Fro more details please read <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#.2A-find">*-find
section</a></p>
</section>
</section>
<section id="id3">
<h2>Implementation<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
</section>
<section id="id4">
<h2>Feature Management<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<section id="id5">
<h3>UI<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<p>WebUI is not affected, because it uses user-show heavily instead of
user-find. From user find it requires only list of primary keys.</p>
<p>user-find –pkey-only with 2000 users</p>
<p><code class="docutils literal notranslate"><span class="pre">708478</span> <span class="pre">function</span> <span class="pre">calls</span> <span class="pre">(694369</span> <span class="pre">primitive</span> <span class="pre">calls)</span> <span class="pre">in</span> <span class="pre">1.889</span> <span class="pre">seconds</span></code></p>
</section>
<section id="id6">
<h3>CLI<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
</section>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">#</a></h3>
<p>N/A</p>
</section>
</section>
<section id="upgrade">
<h2>Upgrade<a class="headerlink" href="#upgrade" title="Link to this heading">#</a></h2>
<p>N/A</p>
</section>
<section id="slow-host-find">
<h2>Slow host-find<a class="headerlink" href="#slow-host-find" title="Link to this heading">#</a></h2>
<p>High number of hosts stored in LDAP causes slowdown of the IPA command.</p>
<p>Issue here are similar to user-find issues.</p>
</section>
<section id="id7">
<h2>Use Cases<a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Increase the usability of host-find command because with many host
searches in LDAP take too long and may result into timeout.</p></li>
</ol>
</section>
<section id="id8">
<h2>Design<a class="headerlink" href="#id8" title="Link to this heading">#</a></h2>
<section id="id9">
<h3>Don’t do extra search for ipasshpubkey attribute<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<p>See
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Slow_user-find">user-find</a></p>
</section>
<section id="id10">
<h3>Remove userPassword, krbPrincipalKey attributes from search results<a class="headerlink" href="#id10" title="Link to this heading">#</a></h3>
<p>See
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Slow_user-find">user-find</a></p>
</section>
<section id="id11">
<h3>processing members<a class="headerlink" href="#id11" title="Link to this heading">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa host-find
ipa: ERROR: cannot connect to &#39;``\ ```https://ipa.example.com/ipa/json`` &lt;https://ipa.example.com/ipa/json&gt;`__\ ``&#39;: Gateway Timeout
</pre></div>
</div>
<p>This testcase contains 2000 hostss with 110 direct and indirect
memberships.</p>
<p>For more details please read <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#.2A-find">*-find
section</a></p>
</section>
</section>
<section id="id12">
<h2>Implementation<a class="headerlink" href="#id12" title="Link to this heading">#</a></h2>
</section>
<section id="id13">
<h2>Feature Management<a class="headerlink" href="#id13" title="Link to this heading">#</a></h2>
<section id="id14">
<h3>UI<a class="headerlink" href="#id14" title="Link to this heading">#</a></h3>
</section>
<section id="id15">
<h3>CLI<a class="headerlink" href="#id15" title="Link to this heading">#</a></h3>
</section>
<section id="id16">
<h3>Configuration<a class="headerlink" href="#id16" title="Link to this heading">#</a></h3>
<p>N/A</p>
</section>
</section>
<section id="id17">
<h2>Upgrade<a class="headerlink" href="#id17" title="Link to this heading">#</a></h2>
<p>N/A</p>
</section>
<section id="improvements-of-other-commands">
<h2>Improvements of other commands<a class="headerlink" href="#improvements-of-other-commands" title="Link to this heading">#</a></h2>
<p>Side effects/benefits from user commands related changes to other IPA
commands</p>
</section>
<section id="typical-provisioning-ldapadd-entries-migrate-ds">
<h2>typical provisioning: ldapadd entries, migrate-ds…<a class="headerlink" href="#typical-provisioning-ldapadd-entries-migrate-ds" title="Link to this heading">#</a></h2>
<section id="use-case">
<h3>Use case<a class="headerlink" href="#use-case" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>We are migrating (see <a class="reference external" href="http://www.freeipa.org/page/V4/FreeIPA_to_FreeIPA_Migration">this
RFE</a>)
from old solution to FreeIPA and need to add <strong>entries</strong>
(users/groups/hosts/rules…) withing a short period of time</p></li>
</ul>
<p>Freeipa LDAP entries are typically:</p>
<ul class="simple">
<li><p>read from a <strong>source instance</strong> into a <strong>ldif</strong> format</p></li>
<li><p>entries are possibly modified according to business/admin
requirements (for example during migration scenario)</p></li>
<li><p>added/imported into a <strong>target instance</strong></p></li>
</ul>
<p>This chapter is related to the performance problem that can occur during
<strong>add/import</strong></p>
<p>A provisioning tool
<a class="reference external" href="https://github.com/freeipa/freeipa-tools/blob/master/create-test-data.py">create-test-data.py</a>
is used to create a ldif file to import. Such tool/file can be used to
identify bottleneck and possible performance improvement and later used
to detect performance regression.</p>
<p>The entries are added synchronously and in sequence:</p>
<ul class="simple">
<li><p>users</p></li>
<li><p>hosts</p></li>
<li><p>user groups (nested)</p></li>
<li><p>host groups (nested)</p></li>
<li><p>sudo rules</p></li>
<li><p>hbac rules</p></li>
</ul>
<p>The specification of the data are:</p>
<ul class="simple">
<li><p>users - default 50K - each user is member of 10 user groups</p></li>
<li><p>hosts - default 40K - each host is member of 5 hostgroups</p></li>
<li><p>user group - default 1K - each group contains 1000 users</p></li>
<li><p>host group - default 1K - each group contains 400 hosts</p></li>
<li><p>sudo rule - default 200</p></li>
<li><p>hbac rules - default 200</p></li>
<li><p>each user will be direct member of random 5 unique hbac rules and 5
unique sudo rules</p></li>
<li><p>create a structure of nested groups and add users to these groups so
that users will be indirect member of more than 50 hbac rules and 50
sudo rulesthe same with host and hostgroups</p></li>
<li><p>so we can achieve results of user and host entries being direct and
indirect member of more than 100 groups/sudo rules/hbac rules</p></li>
</ul>
<p>Related opened tickets</p>
<ul class="simple">
<li><p><a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5861">5861</a>: failing
internal MOD when adding empty host group</p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5802">5802</a>: perf: adding
a group with 1000 users/hosts lasts long (up to 12s)</p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/389/ticket/48812">48812</a>: exclude
backends from plugin operation</p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5914">5914</a>: invalid
setting of DS lock table size</p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/389/ticket/48856">48856</a>: Memberof
plugins compute ‘memberof’ using internal searches that can be costly</p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/389/ticket/48861">48861</a>: Memberof
plugins can update several times the same entry to set the same
values</p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/389/ticket/48868">48868</a>: Checking of
cache tuning is too strict and make DS unusable</p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/389/ticket/48812">48812</a>: Exclude
Backends From Plugin Operations</p></li>
</ul>
</section>
<section id="provisioning-throughput-and-ds-tuning">
<h3>Provisioning throughput and DS tuning<a class="headerlink" href="#provisioning-throughput-and-ds-tuning" title="Link to this heading">#</a></h3>
<section id="entry-cache-tuning">
<h4>Entry cache tuning<a class="headerlink" href="#entry-cache-tuning" title="Link to this heading">#</a></h4>
<p>The following table shows the duration of import depending of the
<strong>entry cache</strong> size (domain). Tests have been done with different size
(10Mb, 50Mb, 100Mb) of <strong>db cache</strong>, it had almost no impact on the
duration.</p>
<p>The import was done with <strong>memberof: enabled</strong>. (slapi-nis and retroCL
disabled).</p>
<table class="table">
<tbody>
<tr class="row-odd"><td><p>Cache size</p></td>
<td><p>10Mb</p></td>
<td><p>100Mb</p></td>
<td><p>200Mb</p></td>
</tr>
<tr class="row-even"><td><p>Duration</p></td>
<td><p>4h00</p></td>
<td><p>2h30</p></td>
<td><p>1h40</p></td>
</tr>
<tr class="row-odd"><td><p>Entries cached</p></td>
<td><p>4%</p></td>
<td><p>45%</p></td>
<td><p>100%</p></td>
</tr>
</tbody>
</table>
<p>While the tests was running the number of entries in the <strong>entry
caches</strong> was monitored. When the cache was too small to fit all entries
(100Mb), monitoring shows that when adding sudorules and hbacrules
significantly reduce the number of entries in the cache. That means
added entries are <strong>large static groups</strong> like hbac having 2200 members.
The consequence of large static groups is that it moves out of the entry
cache the members entries that memberof will update. So memberof updates
will be slowed down because members entries need to be <strong>reloaded in
entry cache</strong> for the updates.</p>
<p>In conclusion:</p>
<ul class="simple">
<li><p>If provisioning contains large static group, it is better to have an
entry cache that can fit all entries (groups and members)</p></li>
<li><p>having entry cache larger than 400Mb is likely not a good idea
because it would also create a large memory footprint without giving
much benefit</p></li>
<li><p>the benefit of caching all entries is in the range of <strong>2-3 times</strong></p></li>
</ul>
<p>If the machine has enough memory, the <strong>entry cache could range from
100Mb to 400Mb</strong>. This tuning should leave enough free memory for the
file system cache.</p>
</section>
<section id="database-cache-tuning">
<h4>database cache tuning<a class="headerlink" href="#database-cache-tuning" title="Link to this heading">#</a></h4>
<p>Tuning of this attribute usually requires some iterating tests. In fact
having a large cache allows to cache more DB pages but can be a problem
during checkpointing. On the other side, db pages are also file pages.
So before going into the DB cache those pages, even evicted from DB
cache, usually remain into the <strong>file system</strong> cache and are easily
reloaded.</p>
<p>Relying on file system cache is a good approach to keep as much DB page
as possible. But on the other side having a too small DB cache can
create constant reload.</p>
<p>If the machine has enough memory, the <strong>db cache could range from 200Mb
to 500Mb</strong>. This tuning should leave enough free memory for the file
system cache.</p>
<p>In my tests tuning of db cache has no noticeable impact. So if we need
to save memory (for file system cache), it would be recommended to give
the priority to entry cache</p>
</section>
<section id="database-locks">
<h4>database locks<a class="headerlink" href="#database-locks" title="Link to this heading">#</a></h4>
<p>During tests it appears that the default number of database locks was
too low. This can be monitored with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldapsearch</span> <span class="o">-</span><span class="n">LLL</span> <span class="o">-</span><span class="n">o</span> <span class="n">ldif</span><span class="o">-</span><span class="n">wrap</span><span class="o">=</span><span class="n">no</span> <span class="o">-</span><span class="n">D</span> <span class="s2">&quot;cn=directory manager&quot;</span> <span class="o">-</span><span class="n">w</span> <span class="n">Secret123</span> <span class="o">-</span><span class="n">b</span> <span class="s2">&quot;cn=database,cn=monitor,cn=ldbm database,cn=plugins,cn=config&quot;</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">configured</span><span class="o">-</span><span class="n">locks</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">current</span><span class="o">-</span><span class="n">locks</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">locks</span>
<span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">database</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">monitor</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">ldbm</span> <span class="n">database</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">configured</span><span class="o">-</span><span class="n">locks</span><span class="p">:</span> <span class="mi">100000</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">current</span><span class="o">-</span><span class="n">locks</span><span class="p">:</span> <span class="mi">8980</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">locks</span><span class="p">:</span> <span class="mi">42675</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">One</span> <span class="pre">rule</span> <span class="pre">of</span> <span class="pre">thumb,</span> <span class="pre">for</span> <span class="pre">large</span> <span class="pre">provisioning,</span> <span class="pre">is</span> <span class="pre">to</span> <span class="pre">set</span> <span class="pre">database</span> <span class="pre">lock</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">half</span> <span class="pre">of</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">provisioned</span> <span class="pre">users</span> <span class="pre">and</span> <span class="pre">hosts.</span></code></p>
</section>
</section>
<section id="provisioning-throughput-and-ds-plugins">
<h3>Provisioning throughput and DS plugins<a class="headerlink" href="#provisioning-throughput-and-ds-plugins" title="Link to this heading">#</a></h3>
<section id="small-db-10k-entries">
<h4>Small DB (10K entries)<a class="headerlink" href="#small-db-10k-entries" title="Link to this heading">#</a></h4>
<p>The dataset is:</p>
<ul class="simple">
<li><p>5K users - each user is member of 10 users group</p></li>
<li><p>4K hosts - each host is member of 5 hosts group</p></li>
<li><p>100 users groups with 1000 users (+nested)</p></li>
<li><p>100 hosts group with 400 hosts (+nested)</p></li>
<li><p>100 sudorules with 2200 users/hosts (direct/indirect)</p></li>
<li><p>100 hbacrules</p>
<ul>
<li><p>20 with 2200 users/hosts (direct)</p></li>
<li><p>46 with 1400-1800 users/hosts (nested)</p></li>
<li><p>23 with 400-800 users/hosts (nested)</p></li>
<li><p>1 with no member</p></li>
</ul>
</li>
</ul>
<p>The following table present the provisioning duration and number of
operations (vast majority of them are internal) depending which plugins
are enabled:</p>
<table class="table">
<tbody>
<tr class="row-odd"><td><p>Plugin
enabled</p></td>
<td><p>P
rovisioning
Duration
(**)</p></td>
<td><p>ADD</p></td>
<td><p>MOD</p></td>
<td><p>SRCH</p></td>
</tr>
<tr class="row-even"><td><p>memberof</p></td>
<td><p>slapi-nis</p></td>
<td><p>retroCL</p></td>
<td><p>style=”
width:100px
style=”
text-align:
center;” Nb</p></td>
<td><p>style=”
width:100px
style=”tex
t-align:cen
ter;”  Cumul
srch
duration</p></td>
</tr>
<tr class="row-odd"><td><p>Y</p></td>
<td><p>Y</p></td>
<td><p>Y</p></td>
<td><p>4h36min</p></td>
<td><div class="line-block">
<div class="line">580K</div>
<div class="line">(95%
retroCL)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p>Y</p></td>
<td><p>Y</p></td>
<td><p><em>no</em></p></td>
<td><p>5h28min</p></td>
<td><p>15K</p></td>
</tr>
<tr class="row-odd"><td><p>Y</p></td>
<td><p><em>no</em></p></td>
<td><p><em>no</em></p></td>
<td><p>4h04min</p></td>
<td><p>15K</p></td>
</tr>
<tr class="row-even"><td><p><em>no</em></p></td>
<td><p>Y</p></td>
<td><p>Y</p></td>
<td><p>12min(*)</p></td>
<td><p>39K</p></td>
</tr>
<tr class="row-odd"><td><p><em>no</em></p></td>
<td><p>Y</p></td>
<td><p><em>no</em></p></td>
<td><p>11min(*)</p></td>
<td><p>15K</p></td>
</tr>
<tr class="row-even"><td><p><em>no</em></p></td>
<td><p><em>no</em></p></td>
<td><p><em>no</em></p></td>
<td><p>9min(*)</p></td>
<td><p>15K</p></td>
</tr>
</tbody>
</table>
<p>(<strong>*</strong>) If <strong>memberof</strong> plugin is disabled during provisioning, the
memberof attribute in the entries is not updated. So at the end of the
provisioning, we need to run fixup tasks to rebuild this attribute in
the entries. These duration are including fixup routines duration that
last 5m30 and trigger 9K MOD/0.4M SRCH. Note that to run fixup routines,
memberof plugin needs to be enabled.</p>
<p>(<strong>**</strong>) Some tests were not done the same day. Performance of the VM
over the days is not that stable. Strict comparison of duration are not
valid. The duration just gives a rough idea how long lasts the
provisioning.</p>
<p>(<strong>***</strong>) 80% of the SRCH are below 1ms and 99.5% are below 2ms. To
estimate the duration of the all SRCHs we take the hypothesis that each
individual SRCH costs 1ms.</p>
<p>Regarding the response time of the <strong>hbacrules</strong> that are the longest
ADD operations. There is no correlation between the duration of the ADD
operation and the number of members.</p>
<table class="table">
<tbody>
<tr class="row-odd"><td><p>HBAC rule</p></td>
<td><div class="line-block">
<div class="line">Empty</div>
<div class="line">group</div>
</div>
</td>
<td><p>Small grp
(400-800)</p></td>
<td><p>Medium grp
(
1400-1800)&gt;</p></td>
<td><p>Large grp
(2200)</p></td>
</tr>
<tr class="row-even"><td><p>min.</p></td>
<td><p>max.</p></td>
<td><p>min.</p></td>
<td><p>max.</p></td>
<td><p>min.</p></td>
</tr>
<tr class="row-odd"><td><p>Duration</p></td>
<td><p>58s</p></td>
<td><p>61s</p></td>
<td><p>136s</p></td>
<td><p>33s</p></td>
</tr>
</tbody>
</table>
</section>
<section id="medium-db-100k-entries">
<h4>Medium DB (100K entries)<a class="headerlink" href="#medium-db-100k-entries" title="Link to this heading">#</a></h4>
<p>The dataset is:</p>
<ul class="simple">
<li><p>50K users</p></li>
<li><p>40K hosts</p></li>
<li><p>x users groups with x users (+nested)</p></li>
<li><p>x hosts group with x hosts (+nested)</p></li>
<li><p>100 sudorules with 22500 users/hosts (direct/indirect)</p></li>
<li><p>100 hbacrules</p></li>
</ul>
<p>The following table shows value of provisioning of a medium DB in two
steps: provisioning without memberof and fixup of memberof.</p>
<figure class="align-default" id="id18">
<img alt="performance_improvements.png" src="../../_images/performance_improvements.png" />
<figcaption>
<p><span class="caption-text">performance_improvements.png</span><a class="headerlink" href="#id18" title="Link to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="memberof-plugin">
<h4>Memberof plugin<a class="headerlink" href="#memberof-plugin" title="Link to this heading">#</a></h4>
<p>According to the measurements (see
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Small_DB_.2810K_entries.29">table</a>),
the major bootleneck is the memberof plugin. Disabling memberof during
provisioning allows to make the full (provisioning+fixup) provisioning
<strong>20 times faster</strong> (13min instead of 4h14).</p>
<p><strong>Accelarate provisioning worth restarting DS</strong>. The
<a class="reference external" href="https://www.redhat.com/archives/freeipa-devel/2016-May/msg00226.html">discussion</a>
on freeipa-devel concluded that it is acceptable to restart DS in order
to accelerate provisioning.</p>
<p><strong>Replication will slowly converge</strong>. In a replicated topology, it would
be very difficult on <strong>all</strong> DS instances to disable memberof, wait for
provisioned entries to be replicated and finally run the fixup. It is
decided to disable/fixup only on the server where the provisioning
occurs. The user experience of provisioning will be better than now. On
replica, the replicated updates will be slow because of memberof being
enabled but it will not be worse than now.</p>
</section>
<section id="schema-compat-plugin">
<h4>Schema compat plugin<a class="headerlink" href="#schema-compat-plugin" title="Link to this heading">#</a></h4>
<p>According to the measurements (see
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Small_DB_.2810K_entries.29">table</a>),
the schema compat plugin <strong>is not</strong> a performance bottleneck. However,
when memberof is disabled, it <strong>reduces</strong> the number of SRCH by an extra
<strong>90%</strong> and the overall <strong>duration</strong> by an extra <strong>10%</strong>.</p>
<p>LDAP client is supposed to not access DS during provisioning so
disabling Schema Compat during this period has no impact and the later
restart will allow to reenable Schema Compat.</p>
<p>In conlusion, it gives an extra throughput benefice to disable Schema
Compat during provisioning and to reenable it later. Preferably is to
reenable it after the fixup, but then it will require one more restart.</p>
</section>
<section id="retrocl-plugin">
<h4>RetroCL plugin<a class="headerlink" href="#retrocl-plugin" title="Link to this heading">#</a></h4>
<p>According to the measurements (see
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Small_DB_.2810K_entries.29">table</a>),
the Retro CL plugin <strong>is not</strong> a performance bottleneck. However,
disabling retroCL reduces by <strong>2*(#user + #hosts)</strong> the number of ADD.</p>
<p>The benefit is an extra reduction of <strong>10%</strong> of the duration of the ADD.
The drawback is that is that the server will no longer be able to
syncrepl the provisioned entries.</p>
<p>This improvement is not that significant and if support of <strong>syncrepl is
a requirement</strong>, it is ok to keep <strong>RetroCL enabled</strong>.</p>
<p>The ticket <a class="reference external" href="https://fedorahosted.org/389/ticket/48812">48812</a> does
not provide a measurable performance gain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DBcache</span><span class="p">:</span> <span class="mi">100</span><span class="n">Mb</span>
<span class="n">Entrycache</span><span class="p">:</span> <span class="mi">110</span><span class="n">Mb</span>
<span class="n">DNcache</span><span class="p">:</span> <span class="mi">60</span><span class="n">Mb</span>
<span class="n">Memberof</span><span class="p">:</span>     <span class="n">disabled</span>
<span class="n">slapi</span><span class="o">-</span><span class="n">nis</span><span class="p">:</span>     <span class="n">disabled</span>
<span class="n">RetroCL</span><span class="p">:</span>     <span class="n">enabled</span>
<span class="n">Content</span><span class="p">:</span>     <span class="n">enabled</span>
</pre></div>
</div>
<table class="table">
<tbody>
<tr class="row-odd"><td><p>DS Version</p></td>
<td><p>Duration</p></td>
</tr>
<tr class="row-even"><td><p>Provisioning</p></td>
<td><p>Fixup</p></td>
</tr>
<tr class="row-odd"><td><p>1.3.4.9</p></td>
<td><p>3 min 58</p></td>
</tr>
<tr class="row-even"><td><p>1.3.5.6+<a class="reference external" href="https://fedorahosted.org/389/ticket/48812">48812</a></p></td>
<td><p>4 min 03</p></td>
</tr>
</tbody>
</table>
</section>
<section id="conclusions">
<h4>Conclusions<a class="headerlink" href="#conclusions" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p><strong>Disable</strong> memberof and run fixup. <strong>memberof</strong> plugin has a major
impact on the throughput and duration of the provisioning. Even
taking into account the provisioning and fixup tasks duration, the
overall procedure is much faster. The expected benefit is in a range
<strong>20 times faster</strong>. The
<a class="reference external" href="https://www.redhat.com/archives/freeipa-devel/2016-May/msg00226.html">discussion</a>
on freeipa-devel concluded that it is acceptable to restart DS in
order to accelerate provisioning</p></li>
<li><p><strong>Disable</strong> Schema compat during provisioning and fixup. A possible
option to <em>save</em> a restart is to enable <em>Schema compa</em> at the fixup
time.</p></li>
<li><p><strong>Keep enabled</strong> RetroCL, because the expected benefit does not worth
loosing the ability to use syncrepl</p></li>
<li><p>accelerate provisioning gives a much better user experience of
provisioning</p></li>
<li><p>slow replication of provisioned data existed before, so the situation
after improving provision is not worse than before.</p></li>
</ul>
</section>
</section>
<section id="proposed-improvements">
<h3>Proposed improvements<a class="headerlink" href="#proposed-improvements" title="Link to this heading">#</a></h3>
<section id="algorithm">
<h4>Algorithm<a class="headerlink" href="#algorithm" title="Link to this heading">#</a></h4>
<p>The CLI that will do the provisioning of a given ldif file will:</p>
<ul class="simple">
<li><p>Retrieve “cn=directory manager” credential. Using DM is required to
tune DS during provisioning and avoid ACL cost.</p></li>
<li><p>Parse ldif file to check that each provisioned entry matches one of
the condition:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">inetorgperson</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipausergroup</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipahost</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipahostgroup</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipasudorule</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipahbacrule</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Compute and set the appropriate <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#database_cache_tuning">db cache</a>
size and <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#database_locks">db locks</a></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">config</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">ldbm</span> <span class="n">database</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">dbcachesize</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">dbcachesize</span><span class="p">:</span>
<span class="o">-</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">locks</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">locks</span><span class="p">:</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Compute and set the appropriate <em>domain</em> <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Entry_cache_tuning">entry cache</a> size</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">userRoot</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">ldbm</span> <span class="n">database</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">cachememsize</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">cachememsize</span><span class="p">:</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Disable memberof</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">MemberOf</span> <span class="n">Plugin</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span><span class="p">:</span> <span class="n">off</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Disable Schema Compat</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">Schema</span> <span class="n">Compatibility</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span><span class="p">:</span> <span class="n">off</span>
</pre></div>
</div>
<ul class="simple">
<li><p>stop ipa (that will stop DS)</p></li>
<li><p><strong>start DS</strong></p></li>
<li><p>ldapadd -D “xxx” -y -f</p></li>
<li><p>Enable memberof</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">MemberOf</span> <span class="n">Plugin</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span><span class="p">:</span> <span class="n">on</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>restart DS</strong></p></li>
<li><p>Run fixup (and monitor completion) for each of the following filters
(if it existed entries in the ldif file matching the filter).</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>fixup-memberof.pl -D &quot;cn=directory manager&quot; -j ``\ `` -Z server-id -b &quot;suffix&quot; -f &quot;(objectClass=inetorgperson)&quot; -P LDAP
fixup-memberof.pl -D &quot;cn=directory manager&quot; -j ``\ `` -Z server-id -b &quot;suffix&quot; -f &quot;(objectClass=ipausergroup)&quot; -P LDAP
fixup-memberof.pl -D &quot;cn=directory manager&quot; -j ``\ `` -Z server-id -b &quot;suffix&quot; -f &quot;(objectClass=ipahost)&quot; -P LDAP
fixup-memberof.pl -D &quot;cn=directory manager&quot; -j ``\ `` -Z server-id -b &quot;suffix&quot; -f &quot;(objectClass=ipahostgroup)&quot; -P LDAP
fixup-memberof.pl -D &quot;cn=directory manager&quot; -j ``\ `` -Z server-id -b &quot;suffix&quot; -f &quot;(objectClass=ipasudorule)&quot; -P LDAP
fixup-memberof.pl -D &quot;cn=directory manager&quot; -j ``\ `` -Z server-id -b &quot;suffix&quot; -f &quot;(objectClass=ipahbacrule)&quot; -P LDAP
</pre></div>
</div>
<ul class="simple">
<li><p>Enable Schema Compat</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">Schema</span> <span class="n">Compatibility</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span><span class="p">:</span> <span class="n">on</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>stop DS</strong></p></li>
<li><p><strong>start ipa</strong></p></li>
</ul>
</section>
<section id="provisioning-constraints">
<h4>Provisioning constraints<a class="headerlink" href="#provisioning-constraints" title="Link to this heading">#</a></h4>
<p>Provisioning server is offline</p>
<p>Provisioning is done on a server where the memberof plugin is disabled.
That means <strong>memberof</strong> attribute is <strong>invalid</strong> on that server until
provisioning/fixup is completed.</p>
<p>That means that the server is considered to be
<a class="reference external" href="https://www.redhat.com/archives/freeipa-devel/2016-May/msg00424.html">offline</a>
because ldap client accessing it may receive invalid data.</p>
<p>An other
<a class="reference external" href="https://www.redhat.com/archives/freeipa-devel/2016-May/msg00416.html">option</a>
would be to run the provisioning on the IPA master and provision on
<strong>ldapi</strong>. The advantages would be to</p>
<ul class="simple">
<li><p>use autobind without the need of DM password.</p></li>
<li><p>disable ldap ports so that we are sure no ldap client can receive
invalid data</p>
<ul>
<li><p>Note that the replication to the IPA master will be stopped</p></li>
</ul>
</li>
</ul>
<p>Replication being late</p>
<p>Disabling memberof during provisioning allows a <em>faster</em> provisioning.
Actually much faster than the same update on a replica where memberof is
enabled.</p>
<p>If we are doing provisioning in a topology with single instance this is
not an issue. But if there are replicas, replication will send added
entries and on replicas the <em>replicated provisioning</em> will be processed
much slower.</p>
<p>The consequence is that replicas will be <strong>very late</strong> (and possibly may
require some tuning of the <strong>flow control</strong> of the replication)</p>
<p>For example provisioning of a <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#Medium_DB_.28100K_entries.29">medium size
DB</a>
can put replicas <strong>days behind</strong> the provisioned replica. In such case a
provision rule (hbac, sudo,…) can exist on the provisioned replica but
will not exist for a long time on the others. If that rule grants some
rights it can create security issue.</p>
<p>in conlusion:</p>
<ul class="simple">
<li><p>it is recommended to not use <em>fast</em> provisioning on a replicated
topology unless it is planed to reinitialize all replicas from the
provisioned one.</p></li>
</ul>
<p>Fixup procedure</p>
<p>Fixup is a procedure to compute the <strong>memberof</strong> attribute for a <strong>set
of entries</strong>. This set is selected with a filter so if for example we
added <em>host</em> entries, we can run the fixup command using the
<em>“(objectclass=ipaHost)”</em>.</p>
<p>A difficulty is to fixup <strong>all</strong> the provisioned entries so it is
important to identify the filters that will cover all the provisioned
entries. For example if we provision
<em>user/usergroup/host/hostgroup/sudorules/hbacrules</em> the following set of
filters will fixup all the them</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">inetorgperson</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipausergroup</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipahost</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipahostgroup</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipasudorule</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipahbacrule</span><span class="p">)</span>
</pre></div>
</div>
<p>A second difficulty is to have filters that do not overlap. Else we will
fixup several times the same entries. For example adding
<em>usergroup/hostgroup</em> the following set of filters overlaps because
<em>hostgroup</em> also match the first filter.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">groupofnames</span><span class="p">)</span>
<span class="p">(</span><span class="n">objectClass</span><span class="o">=</span><span class="n">ipahostgroup</span><span class="p">)</span>
</pre></div>
</div>
<p>A third difficulty is if provisioning is adding entries (e.g. user) in a
server where it already exists others users. In that case the filter
<em>(objectClass=inetorgperson)</em> will fixup the provisioned entries (that
need to be fixup) as well as already existing ones (that do not need
fixup).</p>
</section>
<section id="provisioning-command">
<h4>provisioning command<a class="headerlink" href="#provisioning-command" title="Link to this heading">#</a></h4>
<p>The administrator who wants to do a bulk load of a set of LDAP entries
that are contained in a ldif-file can use the command:</p>
<ul class="simple">
<li><p>ipa provision <em>ldif_entries_file</em> [–password-file <em>password_file</em>]</p></li>
</ul>
<p><em>ldif_entries_file</em> contains the entries in a ldif format</p>
<p><em>password_file</em> is a readable file that contains the <em>directory manager</em>
password</p>
</section>
</section>
<section id="detailed-descriptions-of-each-provisioning-costs">
<h3>Detailed descriptions of each provisioning costs<a class="headerlink" href="#detailed-descriptions-of-each-provisioning-costs" title="Link to this heading">#</a></h3>
<p>The objectif is to determine what makes memberof plugin so expensive
compare to memberof fixup. The following paragraphs are a summary of the
tests/results. No design or improvements are described in those
paragraphs.</p>
<section id="summary-of-the-test">
<h4>summary of the test<a class="headerlink" href="#summary-of-the-test" title="Link to this heading">#</a></h4>
<p>The provisioning adds in the following order users, groups of users,
hosts, groups of hosts, sudorules and hbacrules. The specifications
entries are:</p>
<ul class="simple">
<li><p>100 users</p></li>
<li><p>20 users groups</p>
<ul>
<li><p>10 empty groups</p></li>
<li><p>10 groups with 100 users + 1 nested group</p></li>
</ul>
</li>
<li><p>80 hosts</p></li>
<li><p>20 hosts groups</p>
<ul>
<li><p>10 empty groups</p></li>
<li><p>10 groups with 40 hosts + 1 nested group</p></li>
</ul>
</li>
<li><p>100 sudorules</p>
<ul>
<li><p>20 with 25 users and 20 hosts</p></li>
<li><p>80 with 1 host group</p></li>
</ul>
</li>
<li><p>100 hbacrules</p>
<ul>
<li><p>20 with 25 users and 20 hosts</p></li>
<li><p>80 with 1 host group</p></li>
</ul>
</li>
</ul>
<p>The overall time spent to provision all these objects</p>
<table class="table">
<tbody>
<tr class="row-odd"><td><p>Objects</p></td>
<td><p>memberof plugin</p></td>
</tr>
<tr class="row-even"><td><p>enabled</p></td>
<td><p>disabled</p></td>
</tr>
<tr class="row-odd"><td><p>add obj.</p></td>
<td><p>fixup</p></td>
</tr>
<tr class="row-even"><td><p>Users</p></td>
<td><p>3sec</p></td>
</tr>
<tr class="row-odd"><td><p>Users groups</p></td>
<td><p>7sec</p></td>
</tr>
<tr class="row-even"><td><p>Hosts</p></td>
<td><p>1sec</p></td>
</tr>
<tr class="row-odd"><td><p>Hosts groups</p></td>
<td><p>5sec</p></td>
</tr>
<tr class="row-even"><td><p>Sudorules</p></td>
<td><p>16sec</p></td>
</tr>
<tr class="row-odd"><td><p>Hbacrules</p></td>
<td><p>38sec</p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td><p>70 seconds</p></td>
</tr>
</tbody>
</table>
<p>Note these values are taken for quite <em>small</em> groups. So the ratio
with/without memberof is only <strong>6 times</strong>. The ratio found in with
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#improvement_of_the_throughput_with_admin_period">larger</a>
groups (5000) raise up to <strong>20 times</strong>. It is likely that with very
large groups (100K and above), the ratio would be <strong>much higher</strong>.</p>
<p>The comparison of the <strong>ADD</strong> when the memberof plugin is enabled vs.
disabled is <strong>15 times less</strong> and is presented in the table below</p>
<p>‘’Note the values are only for non empty groups (user/host)”</p>
<table class="table">
<tbody>
<tr class="row-odd"><td><p>Objects</p></td>
<td><p>memberof plugin</p></td>
</tr>
<tr class="row-even"><td><p>enabled</p></td>
<td><p>disabled</p></td>
</tr>
<tr class="row-odd"><td><p>Users</p></td>
<td><p>6</p></td>
</tr>
<tr class="row-even"><td><p>Users groups</p></td>
<td><p>105</p></td>
</tr>
<tr class="row-odd"><td><p>Hosts</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>Hosts groups</p></td>
<td><p>90</p></td>
</tr>
<tr class="row-odd"><td><p>Sudorules</p></td>
<td><p>47</p></td>
</tr>
<tr class="row-even"><td><p>Hbacrules</p></td>
<td><p>47</p></td>
</tr>
<tr class="row-odd"><td><p></p></td>
<td><p>297</p></td>
</tr>
</tbody>
</table>
<p>The comparison of the <strong>MOD</strong> when the memberof plugin is enabled vs.
disabled is <strong>35 times less</strong> presented in the table below</p>
<p>‘’Note the values are only for non empty groups (user/host)”</p>
<table class="table">
<tbody>
<tr class="row-odd"><td><p>Objects</p></td>
<td><p>memberof plugin</p></td>
</tr>
<tr class="row-even"><td><p>enabled</p></td>
<td><p>disabled</p></td>
</tr>
<tr class="row-odd"><td><p>Users</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-even"><td><p>Users groups</p></td>
<td><p>104</p></td>
</tr>
<tr class="row-odd"><td><p>Hosts</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-even"><td><p>Hosts groups</p></td>
<td><p>88</p></td>
</tr>
<tr class="row-odd"><td><p>Sudorules</p></td>
<td><p>45</p></td>
</tr>
<tr class="row-even"><td><p>Hbacrules</p></td>
<td><p>45</p></td>
</tr>
<tr class="row-odd"><td><p></p></td>
<td><p>286</p></td>
</tr>
</tbody>
</table>
<p>The comparison of the <strong>SRCH</strong> when the memberof plugin is enabled vs.
disabled is <strong>3.3 times less</strong> presented in the table below</p>
<p>‘’Note the values are only for non empty groups (user/host)”</p>
<table class="table">
<tbody>
<tr class="row-odd"><td><p>Objects</p></td>
<td><p>memberof plugin</p></td>
</tr>
<tr class="row-even"><td><p>enabled</p></td>
<td><p>disabled</p></td>
</tr>
<tr class="row-odd"><td><p>Users</p></td>
<td><p>22</p></td>
</tr>
<tr class="row-even"><td><p>Users groups</p></td>
<td><p>1342</p></td>
</tr>
<tr class="row-odd"><td><p>Hosts</p></td>
<td><p>7</p></td>
</tr>
<tr class="row-even"><td><p>Hosts groups</p></td>
<td><p>718</p></td>
</tr>
<tr class="row-odd"><td><p>Sudorules</p></td>
<td><p>918</p></td>
</tr>
<tr class="row-even"><td><p>Hbacrules</p></td>
<td><p>1313</p></td>
</tr>
<tr class="row-odd"><td><p></p></td>
<td><p>4320</p></td>
</tr>
</tbody>
</table>
</section>
<section id="provisioning-with-memberof-plugin">
<h4>provisioning with memberof plugin<a class="headerlink" href="#provisioning-with-memberof-plugin" title="Link to this heading">#</a></h4>
<p>add users</p>
<p>The add of <strong>one</strong> user triggers the following operations (1 direct, 31
internals): 6 ADDs, 4 MODs, 22SRCHs</p>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ADD</span> <span class="n">a</span> <span class="n">user</span>
   <span class="mi">22</span> <span class="n">SRCHs</span>
       <span class="mi">5</span> <span class="k">for</span> <span class="n">uniqueness</span> <span class="p">(</span><span class="n">ipaUniqueID</span><span class="p">,</span> <span class="n">krbPrincipalName</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">uidNumber</span><span class="p">,</span> <span class="n">gidNumber</span><span class="p">)</span>
       <span class="mi">3</span> <span class="k">for</span> <span class="n">DNA</span> <span class="n">config</span> <span class="n">update</span> <span class="p">(</span><span class="mi">2</span> <span class="n">identicals</span> <span class="p">(</span><span class="o">*</span><span class="p">))</span>
       <span class="mi">2</span> <span class="k">for</span> <span class="n">DNA</span> <span class="n">shared</span> <span class="n">config</span> <span class="p">(</span><span class="mi">2</span> <span class="n">identicals</span> <span class="p">(</span><span class="o">*</span><span class="p">))</span>
       <span class="mi">4</span> <span class="k">for</span> <span class="n">group</span> <span class="n">membership</span> <span class="n">of</span> <span class="n">the</span> <span class="n">added</span> <span class="n">user</span>  <span class="p">(</span><span class="mi">2</span> <span class="n">identicals</span> <span class="p">(</span><span class="o">*</span><span class="p">))</span>
       <span class="mi">4</span> <span class="k">for</span> <span class="n">group</span> <span class="n">membership</span> <span class="n">of</span> <span class="n">the</span> <span class="n">added</span> <span class="n">private</span> <span class="n">group</span>  <span class="p">(</span><span class="mi">2</span> <span class="n">identicals</span> <span class="p">(</span><span class="o">*</span><span class="p">))</span>
       <span class="mi">2</span> <span class="k">for</span> <span class="n">group</span> <span class="n">membership</span>
       <span class="mi">2</span> <span class="k">for</span> <span class="n">updating</span> <span class="n">the</span> <span class="n">added</span> <span class="n">user</span> <span class="k">with</span> <span class="n">its</span> <span class="n">private</span> <span class="n">group</span>
    <span class="mi">4</span> <span class="n">MODs</span>
       <span class="mi">1</span> <span class="k">for</span> <span class="n">DNA</span> <span class="n">config</span>
       <span class="mi">1</span> <span class="k">for</span> <span class="n">DNA</span> <span class="n">shared</span> <span class="n">config</span>
       <span class="mi">2</span> <span class="k">for</span> <span class="n">updating</span> <span class="n">the</span> <span class="n">added</span> <span class="n">user</span> <span class="k">with</span> <span class="n">its</span> <span class="n">private</span> <span class="n">group</span><span class="o">/</span><span class="n">entryusn</span> <span class="p">(</span><span class="n">curiously</span> <span class="n">the</span> <span class="n">first</span> <span class="n">update</span> <span class="n">fails</span> <span class="k">with</span> <span class="n">LDAP_TYPE_OR_VALUE_EXISTS</span><span class="p">)</span>
    <span class="mi">6</span> <span class="n">ADD</span>
       <span class="n">user</span> <span class="n">ADD</span>
       <span class="n">private</span> <span class="n">group</span> <span class="n">ADD</span>
       <span class="n">retroCL</span> <span class="n">log</span> <span class="n">of</span> <span class="n">ADD</span> <span class="n">user</span>
       <span class="n">retroCL</span> <span class="n">log</span> <span class="n">of</span> <span class="n">MOD</span> <span class="n">of</span> <span class="n">DNA</span> <span class="n">share</span> <span class="n">config</span>
       <span class="n">retroCL</span> <span class="n">log</span> <span class="n">of</span> <span class="n">ADD</span> <span class="n">private</span> <span class="n">group</span>
       <span class="n">retroCL</span> <span class="n">log</span> <span class="n">of</span> <span class="n">MOD</span> <span class="n">user</span> <span class="p">(</span><span class="n">adding</span> <span class="n">its</span> <span class="n">private</span> <span class="n">group</span><span class="p">)</span>
<span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">Searches</span> <span class="n">are</span> <span class="n">identicals</span>
</pre></div>
</div>
<p>add a usergroup</p>
<p>The add of <strong>one</strong> user group triggers the following operations:</p>
<ul class="simple">
<li><p>If the group is empty (1 direct, 31 internals): 3 ADDs, 2 MODs,
15SRCHs</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ADD an empty usergroup
   15 SRCHs
       3 for uniqueness (ipaUniqueID, uidNumber, gidNumber)
       3 for DNA config update (3 identicals (*))
       2 for DNA shared config (2 identicals (*))
       1 for ?? (lookup objectclass=ipantdomainattrs)
       2 for group members (2 identicals (*))
       4 for group membership of the added user group  (2 identicals (*))
    2 MODs
       1 for DNA config
       1 for DNA shared config
    3 ADD
       user group
       retroCL log of ADD user
       retroCL log of MOD of DNA share config
</pre></div>
</div>
<ul class="simple">
<li><p>If the group contains 102 members (100+2nested) (1 direct, 105ADD,
104 MOD, 1342 SRCH)</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<p>ADD usergroup with 100 user member and 2 nested groups</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>1342 SRCHs
    3 for uniqueness (ipaUniqueID, uidNumber, gidNumber)
    3 for DNA config update (3 identicals (*))
    2 for DNA shared config (2 identicals (*))
    1 for ?? (lookup objectclass=ipantdomainattrs)
    1 for group members
    202 = 2 identical searchs per direct members  (retrieve all attribute including member that are lookup below)
    101 = searchs for members of each direct member [435]
      2 = 2 indentical search per indirect members (retrieve all attribute including member that are lookup below)
      1 = searchs for members of each indirect member
    102 = search for &#39;uid&#39; of each direct/indirect members [643]
    1 for group members [847]
    202 = 2 identical searchs per direct members  (retrieve all attribute including member that are lookup below)
    101 = searchs for members of each direct member [1254] (slapi-nis ?)
      2 = 2 indentical search per indirect members (retrieve all attribute including member that are lookup below)
      1 = searchs for members of each indirect member

    1 for group members [1459]
    103 = search for members direct/indirect of the group &#39;ipaexternalmember&#39; (slapi-nis ?)
    4 search for group memberships [1665]
    for each member (total srch = 510 (102*5), 102 ADD, 102 MOD)
        1 search &quot;member memberUser memberHost&quot;
        1 search group owner of the member
        1 search group owner of the usergroup (done at each iteration)
        1 MOD + 1 ADD (see MOD/ADD)
        2 search of the member (2 identical)
104 MODs
    1 for DNA config
    1 for DNA shared config
    for each member (102)
        MOD users to add &#39;memberof&#39;

105 ADDs
    user group
    for each member (102)
            RetroCL log for above MODs (MOD member to add &#39;memberof&#39;)
</pre></div>
</div>
<p>add host</p>
<p>The add of <strong>one</strong> host triggers : 2 ADD, 7 SRCHs</p>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ADD</span> <span class="n">a</span> <span class="n">host</span>
   <span class="mi">7</span> <span class="n">SRCH</span>
       <span class="mi">2</span> <span class="n">search</span> <span class="p">(</span><span class="n">uniqueness</span> <span class="n">ipaUniqueID</span><span class="p">,</span> <span class="n">krbPrincipalName</span><span class="p">)</span>
       <span class="mi">4</span> <span class="n">membership</span> <span class="n">search</span> <span class="p">(</span><span class="mi">2</span> <span class="n">identical</span><span class="p">)</span>
       <span class="mi">1</span> <span class="n">search</span> <span class="k">for</span> <span class="n">group</span> <span class="kn">from</span> <span class="s1">&#39;ipantdomainattrs&#39;</span>
   <span class="mi">2</span> <span class="n">ADD</span>
       <span class="n">add</span> <span class="n">host</span>
       <span class="n">RetroCL</span> <span class="n">add</span>
</pre></div>
</div>
<p>add a hostgroup</p>
<p>The add of <strong>one</strong> host group triggers the following operations:</p>
<ul class="simple">
<li><p>If the group is empty (1 direct, 39 internals): 5 ADDs, 3 MODs,
32SRCHs</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ADD</span> <span class="n">empty</span> <span class="n">hostgroup</span>
   <span class="mi">32</span> <span class="n">SEARCHES</span>
       <span class="mi">1</span> <span class="n">search</span> <span class="p">(</span><span class="n">uniqueness</span> <span class="n">ipaUniqueID</span><span class="p">)</span>
       <span class="mi">4</span> <span class="n">membership</span> <span class="n">search</span> <span class="p">(</span><span class="mi">2</span> <span class="n">identical</span><span class="p">)</span>
       <span class="mi">5</span> <span class="n">search</span> <span class="n">of</span> <span class="n">the</span> <span class="n">alt</span> <span class="n">networkgroup</span> <span class="p">(</span><span class="mi">3</span> <span class="k">for</span> <span class="s1">&#39;member&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="k">for</span> <span class="s1">&#39;memberuser&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="k">for</span> <span class="s1">&#39;memberhost&#39;</span><span class="p">)</span>
       <span class="mi">6</span> <span class="n">searches</span> <span class="n">of</span> <span class="n">added</span> <span class="n">hostgroup</span> <span class="p">(</span><span class="mi">2</span> <span class="k">for</span> <span class="n">ALL</span><span class="p">,</span> <span class="mi">1</span> <span class="k">for</span> <span class="s1">&#39;memberuser&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="k">for</span> <span class="s1">&#39;memberhost, 1 for &#39;</span><span class="n">fqdn</span><span class="s1">&#39;, 1 for &quot;member memberUser  memberHost&quot;)</span>
       <span class="mi">8</span> <span class="n">searches</span> <span class="n">to</span> <span class="n">find</span> <span class="n">groups</span> <span class="n">owning</span> <span class="n">alt</span> <span class="n">networkgroup</span>
       <span class="mi">2</span> <span class="n">searches</span> <span class="n">to</span> <span class="n">find</span> <span class="n">groups</span> <span class="n">owning</span> <span class="n">hostgroup</span>
       <span class="mi">4</span> <span class="n">search</span> <span class="n">of</span> <span class="n">add</span> <span class="n">hostgroup</span> <span class="p">(</span><span class="mi">4</span> <span class="n">identical</span><span class="p">)</span> <span class="n">related</span> <span class="n">to</span> <span class="n">MODs</span>
       <span class="mi">1</span> <span class="n">search</span> <span class="k">for</span> <span class="n">group</span> <span class="kn">from</span> <span class="s1">&#39;ipantdomainattrs&#39;</span>

   <span class="mi">3</span> <span class="n">MOD</span>
       <span class="mi">1</span> <span class="n">update</span> <span class="n">hostgroup</span> <span class="n">to</span> <span class="s1">&#39;memberof&#39;</span> <span class="n">alt</span> <span class="n">networkgroup</span> <span class="p">(</span><span class="n">memberof</span> <span class="n">plugin</span><span class="p">)</span>
       <span class="mi">1</span> <span class="n">update</span> <span class="n">hostgroup</span> <span class="n">to</span> <span class="s1">&#39;mepManagedEntry&#39;</span> <span class="n">alt</span> <span class="n">networkgroup</span> <span class="p">(</span><span class="n">mep</span> <span class="n">plugin</span><span class="p">)</span> <span class="p">((</span><span class="n">curiously</span> <span class="n">the</span> <span class="n">first</span> <span class="n">update</span> <span class="n">fails</span> <span class="k">with</span> <span class="n">LDAP_TYPE_OR_VALUE_EXISTS</span><span class="p">)</span>
   <span class="mi">5</span> <span class="n">ADD</span>
       <span class="n">add</span> <span class="n">hostgroup</span>
       <span class="n">add</span> <span class="n">hostgroup</span> <span class="n">alt</span> <span class="n">networkgroup</span> <span class="p">(</span><span class="n">slapi</span><span class="o">-</span><span class="n">nis</span><span class="p">)</span>
       <span class="mi">3</span> <span class="n">retroCL</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If the hostgroup contains 42 members (40 direct, 2 nested) (1 direct,
895 internals): 90 ADDs, 88 MODs, 718 SRCHs</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``Details:``

ADD hostgroup with 42 members (nested)
   718 SRCH
       1 search (uniqueness ipaUniqueID)
       4 membership search (2 identical)
       5 search of the alt networkgroup (3 for &#39;member&#39;, 1 for &#39;memberuser&#39;, 1 for &#39;memberhost&#39;)
       for each member (42): total = 84srch
               2 search of the member entry (identical BUG)

       for each member (42): total = 84
               1 search of &#39;member&#39;
               1 search of &#39;fqdn&#39;
       10 search to find groups owning hostgroup (4 identical )
       for each member (42): total = 252srch [405-&gt;1125]
           /* related to the MOD &#39;memberof&#39; of the member */
           1 search to find the member &quot;member memberUser memberHost&quot;
           1 search to find groups owning member
           2 search to find groups owning hostgroup (identical BUG + same search for each member)
           2 search member during MOD (identical BUG ?)
       for each member (42): total = 252srch [1125-&gt;1760]
           /* related to the second &quot;BUGGY&quot; MOD &#39;memberof&#39; of the member */
           1 search to find the member &quot;member memberUser memberHost&quot;
           1 search to find groups owning member
           2 search to find groups owning hostgroup (identical BUG + same search for each member)
           2 search member during MOD (identical BUG ?)
    87 MOD
       for each host in hostgroup [418]
           update &#39;memberof&#39; for hostgroup and alt networkgroup
       for each host in hostgroup (Yes this is done twice ! BUG) [1122]
           update &#39;memberof&#39; for hostgroup and alt networkgroup
       update hostgroup for &#39;mepmanageentry&#39;

    90 ADD
      add hostgroup
      add alt networkgroup
      88 RetroCL add due to MODs
</pre></div>
</div>
<p>add sudorules</p>
<p>Adding <strong>one</strong> sudorule with 25 users/20 hosts, triggers the following
internal operations 47 ADDs, 45 MODs and 918 SRCH</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``Details:``

ADD sudorules 25 users/20 hosts
   918 SRCH
       1 search (uniqueness ipaUniqueID)
           /* Follow comes slapi-nis &#39;cn=sudoers,cn=Schema Compatibility&#39; */
               for each memberHost (20): 40
                   2 search host (2 identical BUG - objectclass=ipaHostGroup)(!(objectclass=mepOriginEntry))

               for each memberuser (25): 25
                   1 search &#39;cn&#39;
               for each memberHost (20): 20
                   1 search host ((objectclass=ipaHostGroup)(objectclass=mepOriginEntry))
               for each memberUser (25): 25
                   1 search &#39;uid&#39;
               for each memberHost (20): 20
                   1 search host (ipaNisNetgroup)
               for each memberHost (20): 20
                   1 search host (objectclass=ipaHost)
               for each memberUser (25): 50
                   2 search host (2 identical BUG - (objectclass=ipaUserGroup)(!(objectclass=posixGroup))
               for each memberUser (25):  25
                   1 search user (objectclass=ipaNisNetgroup)
       10 searchs to find if add sudorules belong to a group
       For each memberUser (25):
           /* search all groups it can belong to */
           10 search based on member &#39;memberof&#39;
   45 MOD
       for each users:
           update memberof attribute to add the &#39;ipaUniqueID=xxx,cn=sudorules,cn=sudo,``\ ``&#39; value
       for each host:
           update memberof attribute to add the &#39;ipaUniqueID=xxx,cn=sudorules,cn=sudo,``\ ``&#39; value
   47 ADD
       add sudorule
       RetroCL add sudorule + 45 updates of memberof (MODs)
</pre></div>
</div>
<p>add hbacrules</p>
<p>Adding <strong>one</strong> sudorule with 25 users/20 hosts, triggers the following
internal operations 47 ADDs, 45 MODs and 1313 SRCH</p>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ADD</span> <span class="n">hbacrule</span> <span class="mi">25</span> <span class="n">users</span><span class="o">/</span><span class="mi">20</span> <span class="n">hosts</span>
   <span class="mi">1313</span> <span class="n">SRCH</span>
       <span class="n">For</span> <span class="n">each</span> <span class="n">memberUser</span> <span class="mi">25</span><span class="p">:</span>
           <span class="n">search</span> <span class="n">the</span> <span class="n">groups</span> <span class="n">it</span> <span class="n">belongs</span> <span class="n">to</span> <span class="p">(</span><span class="mi">17</span><span class="p">)</span>
       <span class="n">For</span> <span class="n">each</span> <span class="n">memberHost</span> <span class="mi">20</span><span class="p">:</span>
           <span class="n">search</span> <span class="n">the</span> <span class="n">groups</span> <span class="n">it</span> <span class="n">belongs</span> <span class="n">to</span> <span class="p">(</span><span class="mi">40</span><span class="p">)</span>

   <span class="mi">45</span> <span class="n">MOD</span>
       <span class="k">for</span> <span class="n">each</span> <span class="n">users</span><span class="p">:</span>
           <span class="n">update</span> <span class="n">memberof</span> <span class="n">attribute</span> <span class="n">to</span> <span class="n">add</span> <span class="n">the</span> <span class="s1">&#39;ipaUniqueID=xxx,cn=hbacrules,cn=hbac,``\ ``&#39;</span> <span class="n">value</span>
       <span class="k">for</span> <span class="n">each</span> <span class="n">host</span><span class="p">:</span>
           <span class="n">update</span> <span class="n">memberof</span> <span class="n">attribute</span> <span class="n">to</span> <span class="n">add</span> <span class="n">the</span> <span class="s1">&#39;ipaUniqueID=xxx,cn=hbacrules,cn=hbac,``\ ``&#39;</span> <span class="n">value</span>
   <span class="mi">47</span> <span class="n">ADD</span>
       <span class="n">add</span> <span class="n">hbacrule</span>
       <span class="n">RetroCL</span> <span class="n">add</span> <span class="n">hbacrule</span> <span class="o">+</span> <span class="mi">45</span> <span class="n">updates</span> <span class="n">of</span> <span class="n">memberof</span> <span class="p">(</span><span class="n">MODs</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="provisioning-without-memberof-plugin">
<h4>provisioning without memberof plugin<a class="headerlink" href="#provisioning-without-memberof-plugin" title="Link to this heading">#</a></h4>
<p>add user</p>
<p>The add of <strong>one</strong> user gives same results as <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#add_users">add user with memberof
plugin</a></p>
<p>add usergroup (no memberof)</p>
<p>The add of <strong>one</strong> user group triggers the following operations:</p>
<ul class="simple">
<li><p>If the group is empty (1 direct, 19 internals): 3 ADDs, 2 MODs,
15SRCHs - this is identical results vs add an empty user group <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#add_a_usergroup">with
memberof</a></p></li>
<li><p>If the group contains 102 members (100+2nested) (1 direct, 3ADD, 2
MOD, 813 SRCH)</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>813 SRCHs
    3 for uniqueness (ipaUniqueID, uidNumber, gidNumber)
    3 for DNA config update (3 identicals (*))
    2 for DNA shared config (2 identicals (*))
    1 for ?? (lookup objectclass=ipantdomainattrs)
    A) for each group members (102): (total 204)
        2 identical base search of the member all_attr (BUG)
    B) for each group members (102): (total 102)
        base search of the member &#39;member&#39; (BUG it could reuse the A)
    C) for each group members (102): (total 102)
        base search of the member &#39;uid&#39; (BUG it could reuse the A)
    D) identical to A (total 102)
    E) identical to B (total 102)
    F) for each group members (102): (total 102)
        base search of the member &#39;ipaexternalmember&#39; (BUG it could reuse the A)
2 MODs
    1 for DNA config
    1 for DNA shared config
3 ADDs
    user group
    RetroCL for user_group and MOD DNA
</pre></div>
</div>
<p>add host</p>
<p>The add of <strong>one</strong> host gives same results as <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#add_host">add host with memberof
plugin</a></p>
<p>add hostgroup</p>
<p>The add of <strong>one</strong> hostgroup triggers the following operations:</p>
<ul class="simple">
<li><p>If the hostgroup is empty (1 direct, 34 internals): 5 ADDs, 3 MODs,
27SRCHs</p></li>
</ul>
<p>It gives results <strong>almost</strong> identical to <a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#add_a_hostgroup">add an empty hostgroup with
memberof
plugin</a>.
But memberof plugin triggers 5 more internal searches (2 membership and
3 on the added hostgroup), so running without memberof plugin <strong>saves 5
SRCHs</strong>.</p>
<ul class="simple">
<li><p>if the hostgroup contains 42 members (40 direct, 2 nested) (1 direct,
895 internals): 5 ADDs, 2 MODs, 201 SRCHs</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Details:</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ADD</span> <span class="n">hostgroup</span> <span class="k">with</span> <span class="mi">42</span> <span class="n">members</span> <span class="p">(</span><span class="n">nested</span><span class="p">)</span>
   <span class="mi">201</span> <span class="n">SRCH</span>
       <span class="mi">1</span> <span class="n">search</span> <span class="p">(</span><span class="n">uniqueness</span> <span class="n">ipaUniqueID</span><span class="p">)</span>
       <span class="mi">4</span> <span class="n">membership</span> <span class="n">search</span> <span class="n">on</span> <span class="n">netgroup</span>
       <span class="mi">4</span> <span class="n">membership</span> <span class="n">search</span> <span class="n">on</span> <span class="n">groups</span>
       <span class="mi">5</span> <span class="n">search</span> <span class="n">on</span> <span class="n">add</span> <span class="n">hostgroup</span> <span class="p">(</span><span class="mi">2</span> <span class="n">ALL</span><span class="p">,</span> <span class="mi">1</span> <span class="s1">&#39;member&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="s1">&#39;fqdn&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="s1">&#39;memberHost&#39;</span> <span class="p">,</span> <span class="mi">1</span> <span class="s1">&#39;member&#39;</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">each</span> <span class="n">member</span> <span class="p">(</span><span class="mi">42</span><span class="p">):</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">84</span><span class="n">srch</span>
               <span class="mi">2</span> <span class="n">search</span> <span class="n">of</span> <span class="n">the</span> <span class="n">member</span> <span class="n">entry</span> <span class="p">(</span><span class="n">identical</span> <span class="n">BUG</span><span class="p">)</span>

       <span class="k">for</span> <span class="n">each</span> <span class="n">member</span> <span class="p">(</span><span class="mi">42</span><span class="p">):</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">84</span>
               <span class="mi">1</span> <span class="n">search</span> <span class="n">of</span> <span class="s1">&#39;member&#39;</span>
               <span class="mi">1</span> <span class="n">search</span> <span class="n">of</span> <span class="s1">&#39;fqdn&#39;</span>
       <span class="mi">9</span> <span class="n">searches</span> <span class="n">to</span> <span class="n">find</span> <span class="n">groups</span> <span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">computers</span><span class="p">,</span> <span class="n">hostgoups</span><span class="p">)</span> <span class="n">owning</span> <span class="n">the</span> <span class="n">added</span> <span class="n">hostgroup</span>

    <span class="mi">2</span> <span class="n">MOD</span>
       <span class="mi">2</span> <span class="n">update</span> <span class="n">hostgroup</span> <span class="n">to</span> <span class="s1">&#39;mepManagedEntry&#39;</span> <span class="n">alt</span> <span class="n">networkgroup</span> <span class="p">(</span><span class="n">mep</span> <span class="n">plugin</span><span class="p">)</span> <span class="p">(</span><span class="n">the</span> <span class="n">first</span> <span class="n">MOD</span> <span class="n">fails</span> <span class="k">with</span> <span class="n">LDAP_TYPE_OR_VALUE_EXISTS</span><span class="p">)</span>

    <span class="mi">5</span> <span class="n">ADD</span>
      <span class="n">add</span> <span class="n">hostgroup</span>
      <span class="n">add</span> <span class="n">alt</span> <span class="n">networkgroup</span>
       <span class="n">RetroCL</span> <span class="n">add</span> <span class="n">due</span> <span class="n">to</span> <span class="n">MODs</span>
</pre></div>
</div>
<p>add sudorule</p>
<p>Adding <strong>one</strong> sudorule with 25 users/20 hosts, triggers the following
internal operations: 2 ADD, 0 MOD, 243 SRCH</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``Details:``

ADD sudorules 25 users/20 hosts
   243 SRCH
       1 search (uniqueness ipaUniqueID)
               for each memberHost (20): 40
                   2 search host all_attrs (2 identical BUG - objectclass=ipaHostGroup)(!(objectclass=mepOriginEntry))

               for each memberuser (25): 25
                   1 search &#39;cn&#39;
               for each memberHost (20): 20
                   1 search host &#39;cn&#39; ((objectclass=ipaHostGroup)(objectclass=mepOriginEntry))
               for each memberUser (25): 25
                   1 search &#39;uid&#39;((objectclass=posixAccount))
               for each memberHost (20): 20
                   1 search host &#39;cn&#39; ((objectclass=ipaNisNetgroup))
               for each memberHost (20): 20
                   1 search host &#39;fqdn&#39; (objectclass=ipaHost)
               for each memberUser (25): 50
                   2 search host (2 identical BUG - (objectclass=ipaUserGroup)(!(objectclass=posixGroup))
               for each memberUser (25):  25
                   1 search user (objectclass=ipaNisNetgroup)
       10 searchs to find if added sudorules belong to a group (user/ng/hostgroups/grous/computers)

       For each memberUser (25):
           /* search all groups it can belong to */
           10 search based on member &#39;memberof&#39;

   0 MOD

   2 ADD
       add sudorule
       RetroCL add sudorule
</pre></div>
</div>
<p>add hbacrules</p>
<p>Adding <strong>one</strong> sudorule with 25 users/20 hosts, triggers the following
internal operations 2ADD, 0 MOD, 13 SRCH</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``Details:``

ADD hbacrule 25 users/20 hosts
   13 SRCH
       1 search (uniqueness ipaUniqueID)
       10 searchs to find if added hbacrules belong to a group (user/ng/hostgroups/grous/computers)
       1 unindexed search in sudorules if one of them owns the added hbacrule

           (&amp;(&amp;(objectclass=ipaSudoRule)
               (!(compatVisible=FALSE))
               (!(ipaEnabledFlag=FALSE)))
             (|(memberUser=ipauniqueid=22f91e42-0d34-11e6-9927-001a4a2314dc,cn=hbac,``\ ``)
               (memberHost=ipauniqueid=22f91e42-0d34-11e6-9927-001a4a2314dc,cn=hbac,``\ ``)
               (ipaSudoRunAsGroup=ipauniqueid=22f91e42-0d34-11e6-9927-001a4a2314dc,cn=hbac,``\ ``)
               (memberAllowCmd=ipauniqueid=22f91e42-0d34-11e6-9927-001a4a2314dc,cn=hbac,``\ ``)
               (ipaSudoRunAs=ipauniqueid=22f91e42-0d34-11e6-9927-001a4a2314dc,cn=hbac,``\ ``)
               (memberDenyCmd=ipauniqueid=22f91e42-0d34-11e6-9927-001a4a2314dc,cn=hbac,``\ ``))
           )

   0 MOD

   2 ADD
       add hbacrule
       RetroCL add hbacrule
</pre></div>
</div>
<p>memberof fixup</p>
<table class="table">
<tbody>
<tr class="row-odd"><td><p>filter OC</p></td>
<td><p>Operation</p></td>
</tr>
<tr class="row-even"><td><p>ADD</p></td>
<td><p>MOD</p></td>
</tr>
<tr class="row-odd"><td><p>inetorgperson</p></td>
<td><p>100</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="hypothese">
<h3>Hypothese<a class="headerlink" href="#hypothese" title="Link to this heading">#</a></h3>
<p>The preliminary tests of <a class="reference external" href="http://www.freeipa.org/index.php?title=V4/Performance_Improvements&amp;action=submit#improvement_of_the_throughput_with_admin_period">memberof
fixup</a>,
shows that both procedures are equivalent in terms of final results but
much faster (fixup) in term of throughput.</p>
<p>A possible explanation is that each time we add a group with members, it
triggers the recomputation of the ‘memberof’ attribute. It is time
consuming (internal search) because if an entry is member of N groups
(direct or nested) and those N groups are composed of M entries. When
the entry is added to a new goup, memberof plugin recomputes ‘memberof’
attribute and needs to lookup each of the M entries to know if they are
themself groups.</p>
<p>There is a waste of time if a group/member was evaluated when adding an
entry and need to be evaluated again when adding a second entry.</p>
<p>With fixup we do this evaluation only <strong>once</strong></p>
<p>Note the 389-ds memberof <a class="reference external" href="https://fedorahosted.org/389/ticket/47963">RFE
47963</a> has no impact on
performace with the current use case. In fact, freeipa uses nested group
but perf hit is not due to nested groups.</p>
</section>
</section>
<section id="all-commands">
<h2>all commands<a class="headerlink" href="#all-commands" title="Link to this heading">#</a></h2>
<p>Caching issue described in
<a class="reference external" href="http://www.freeipa.org/page/V4/Performance_Improvements#broken_SchemaCache">1</a>
affects all IPA commands.</p>
</section>
<section id="all-commands-working-with-members-and-indirect-members">
<h2>all commands working with members and indirect members<a class="headerlink" href="#all-commands-working-with-members-and-indirect-members" title="Link to this heading">#</a></h2>
<p>Related ticket(s):
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4995">#4995</a></p>
<p>Get member and indirect members is resource consuming operation and
usually user don’t want all membership details. IPA already has hidden
option <em>–no-members</em> that can be public visible.</p>
<p>Summary: option <em>–no-members</em> is publicly visible for all commands</p>
</section>
<section id="find">
<h2>*-find<a class="headerlink" href="#find" title="Link to this heading">#</a></h2>
<section id="members-and-indirect-members-processing">
<h3>members and indirect members processing<a class="headerlink" href="#members-and-indirect-members-processing" title="Link to this heading">#</a></h3>
<p>Related ticket(s):
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4995">#4995</a></p>
<p><code class="docutils literal notranslate"><span class="pre">host-find</span> <span class="pre">(2000</span> <span class="pre">hosts):</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">76640658</span> <span class="n">function</span> <span class="n">calls</span> <span class="p">(</span><span class="mi">75069144</span> <span class="n">primitive</span> <span class="n">calls</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">227.351</span> <span class="n">seconds</span>

   <span class="n">Ordered</span> <span class="n">by</span><span class="p">:</span> <span class="n">cumulative</span> <span class="n">time</span>

   <span class="n">ncalls</span>  <span class="n">tottime</span>  <span class="n">percall</span>  <span class="n">cumtime</span>  <span class="n">percall</span> <span class="n">filename</span><span class="p">:</span><span class="n">lineno</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
   <span class="o">....</span>
        <span class="mi">1</span>    <span class="mf">0.103</span>    <span class="mf">0.103</span>  <span class="mf">227.348</span>  <span class="mf">227.348</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2015</span><span class="p">(</span><span class="n">execute</span><span class="p">)</span>
<span class="mi">73967</span><span class="o">/</span><span class="mi">73966</span>    <span class="mf">3.240</span>    <span class="mf">0.000</span>  <span class="mf">186.341</span>    <span class="mf">0.003</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipapython</span><span class="o">/</span><span class="n">ipaldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1272</span><span class="p">(</span><span class="n">find_entries</span><span class="p">)</span>
   <span class="mi">247887</span>    <span class="mf">1.882</span>    <span class="mf">0.000</span>  <span class="mf">131.877</span>    <span class="mf">0.001</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">87</span><span class="p">(</span><span class="n">_ldap_call</span><span class="p">)</span>
   <span class="mi">173920</span>    <span class="mf">0.392</span>    <span class="mf">0.000</span>  <span class="mf">127.617</span>    <span class="mf">0.001</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">472</span><span class="p">(</span><span class="n">result3</span><span class="p">)</span>
   <span class="mi">173920</span>    <span class="mf">0.953</span>    <span class="mf">0.000</span>  <span class="mf">127.225</span>    <span class="mf">0.001</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">480</span><span class="p">(</span><span class="n">result4</span><span class="p">)</span>
   <span class="mi">173920</span>  <span class="mf">123.784</span>    <span class="mf">0.001</span>  <span class="mf">123.784</span>    <span class="mf">0.001</span> <span class="p">{</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="n">method</span> <span class="n">result4</span><span class="p">}</span>
     <span class="mi">2000</span>    <span class="mf">2.283</span>    <span class="mf">0.001</span>  <span class="mf">111.509</span>    <span class="mf">0.056</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">637</span><span class="p">(</span><span class="n">convert_attribute_members</span><span class="p">)</span>
     <span class="mi">2000</span>    <span class="mf">0.014</span>    <span class="mf">0.000</span>  <span class="mf">104.078</span>    <span class="mf">0.052</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">672</span><span class="p">(</span><span class="n">get_indirect_members</span><span class="p">)</span>
     <span class="mi">2000</span>    <span class="mf">0.249</span>    <span class="mf">0.000</span>  <span class="mf">104.064</span>    <span class="mf">0.052</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">706</span><span class="p">(</span><span class="n">get_memberofindirect</span><span class="p">)</span>
    <span class="mi">77961</span>    <span class="mf">0.571</span>    <span class="mf">0.000</span>   <span class="mf">85.341</span>    <span class="mf">0.001</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">598</span><span class="p">(</span><span class="n">get_primary_key_from_dn</span><span class="p">)</span>
    <span class="mi">67965</span>    <span class="mf">0.323</span>    <span class="mf">0.000</span>   <span class="mf">79.816</span>    <span class="mf">0.001</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipapython</span><span class="o">/</span><span class="n">ipaldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1415</span><span class="p">(</span><span class="n">get_entry</span><span class="p">)</span>
   <span class="mi">173919</span>    <span class="mf">1.286</span>    <span class="mf">0.000</span>   <span class="mf">23.806</span>    <span class="mf">0.000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipapython</span><span class="o">/</span><span class="n">ipaldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">895</span><span class="p">(</span><span class="n">_convert_result</span><span class="p">)</span>
   <span class="mi">283906</span>    <span class="mf">0.407</span>    <span class="mf">0.000</span>   <span class="mf">16.624</span>    <span class="mf">0.000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipapython</span><span class="o">/</span><span class="n">dn</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1265</span><span class="p">(</span><span class="n">endswith</span><span class="p">)</span>
   <span class="mi">283906</span>    <span class="mf">0.996</span>    <span class="mf">0.000</span>   <span class="mf">16.077</span>    <span class="mf">0.000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipapython</span><span class="o">/</span><span class="n">dn</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1280</span><span class="p">(</span><span class="n">_tailmatch</span><span class="p">)</span>
   <span class="o">....</span>
</pre></div>
</div>
<p>As is show in output of profiler, the most time consuming operations are
<strong>convert_attribute_members</strong>, <strong>get_indirect_members</strong>,
<strong>get_primary_key_from_dn</strong></p>
<p>Possible solutions:</p>
<section id="do-not-fetch-members-by-default">
<h4>Do not fetch members by default<a class="headerlink" href="#do-not-fetch-members-by-default" title="Link to this heading">#</a></h4>
<p>This change is related to all *-find commands. Fetching members and
indirect members is expensive operation for find commands. By default
*-find commands will not do members processing. To get members in
*-find command option <em>–all</em> should be used.</p>
<p>Note: this changes makes output of *-find commands backward
incompatible.</p>
<p>Note: due API backward compatibility option <em>–no-members</em> must be still
present even if it has no effect on *-find commands. This option can be
hidden in CLI for *-find commands</p>
<p>Note: user-find already does not return members in result without –all
option</p>
</section>
<section id="temporal-caching-of-members-during-find-command">
<h4>Temporal caching of members during *-find command<a class="headerlink" href="#temporal-caching-of-members-during-find-command" title="Link to this heading">#</a></h4>
<p><strong>This has not been implemented in 4.4, due technical issues with cache.
Prototype of the cache does not cover corner cases, so time was not
reduced as much as listed here. There was only minor enhancement and was
decided to postpone this</strong></p>
<p>Caching may heavily reduce amount of ldapsearches and internal framework
operations.</p>
<p>Test with cache only for <strong>convert_attribute_members</strong> method reduces
total time of operation from 227.351 (111.509) to 113.474 (3.892)
seconds</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">16803443</span> <span class="n">function</span> <span class="n">calls</span> <span class="p">(</span><span class="mi">16602409</span> <span class="n">primitive</span> <span class="n">calls</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">113.474</span> <span class="n">seconds</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">Ordered</span> <span class="n">by</span><span class="p">:</span> <span class="n">cumulative</span> <span class="n">time</span>

   <span class="n">ncalls</span>  <span class="n">tottime</span>  <span class="n">percall</span>  <span class="n">cumtime</span>  <span class="n">percall</span> <span class="n">filename</span><span class="p">:</span><span class="n">lineno</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        <span class="mi">1</span>    <span class="mf">0.031</span>    <span class="mf">0.031</span>  <span class="mf">113.471</span>  <span class="mf">113.471</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2015</span><span class="p">(</span><span class="n">execute</span><span class="p">)</span>
<span class="mi">8137</span><span class="o">/</span><span class="mi">8136</span>    <span class="mf">0.512</span>    <span class="mf">0.000</span>  <span class="mf">103.554</span>    <span class="mf">0.013</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipapython</span><span class="o">/</span><span class="n">ipaldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1272</span><span class="p">(</span><span class="n">find_entries</span><span class="p">)</span>
     <span class="mi">2000</span>    <span class="mf">0.013</span>    <span class="mf">0.000</span>   <span class="mf">98.526</span>    <span class="mf">0.049</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">672</span><span class="p">(</span><span class="n">get_indirect_members</span><span class="p">)</span>
     <span class="mi">2000</span>    <span class="mf">0.254</span>    <span class="mf">0.000</span>   <span class="mf">98.513</span>    <span class="mf">0.049</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">706</span><span class="p">(</span><span class="n">get_memberofindirect</span><span class="p">)</span>
    <span class="mi">50397</span>    <span class="mf">0.342</span>    <span class="mf">0.000</span>   <span class="mf">93.376</span>    <span class="mf">0.002</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">ldapobject</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">87</span><span class="p">(</span><span class="n">_ldap_call</span><span class="p">)</span>
    <span class="o">....</span>
    <span class="mi">44123</span>    <span class="mf">0.874</span>    <span class="mf">0.000</span>    <span class="mf">4.029</span>    <span class="mf">0.000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">dn</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">56</span><span class="p">(</span><span class="n">dn2str</span><span class="p">)</span>
     <span class="mi">2000</span>    <span class="mf">0.321</span>    <span class="mf">0.000</span>    <span class="mf">3.892</span>    <span class="mf">0.002</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2120</span><span class="p">(</span><span class="n">convert_attribute_members</span><span class="p">)</span>
     <span class="mi">2000</span>    <span class="mf">0.039</span>    <span class="mf">0.000</span>    <span class="mf">3.204</span>    <span class="mf">0.002</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">util</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">293</span><span class="p">(</span><span class="n">convert_sshpubkey_post</span><span class="p">)</span>
   <span class="mi">469301</span>    <span class="mf">1.701</span>    <span class="mf">0.000</span>    <span class="mf">2.919</span>    <span class="mf">0.000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ldap</span><span class="o">/</span><span class="n">dn</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">20</span><span class="p">(</span><span class="n">escape_dn_chars</span><span class="p">)</span>
   <span class="o">....</span>
     <span class="mi">2161</span>    <span class="mf">0.012</span>    <span class="mf">0.000</span>    <span class="mf">0.233</span>    <span class="mf">0.000</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">598</span><span class="p">(</span><span class="n">get_primary_key_from_dn</span><span class="p">)</span>
     <span class="o">....</span>
</pre></div>
</div>
<p>For case when</p>
<p><code class="docutils literal notranslate"><span class="pre">number</span> <span class="pre">of</span> <span class="pre">groups/sudorules/hostgroups/hbacrules/roles</span> <span class="pre">&lt;&lt;</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">users/host</span></code></p>
<p>the cache is very effective. In other way cache can cause small slowdown
but it should not be very noticeable.</p>
<p>The cache must be invalidated after each *-find call. There is no need
for having outdated copy of ldap data.</p>
<p><strong>Indirect members</strong></p>
<p>Now the most time consumig operation is getting indirect members:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2000</span>    <span class="mf">0.013</span>    <span class="mf">0.000</span>   <span class="mf">98.526</span>    <span class="mf">0.049</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">672</span><span class="p">(</span><span class="n">get_indirect_members</span><span class="p">)</span>
<span class="mi">2000</span>    <span class="mf">0.254</span>    <span class="mf">0.000</span>   <span class="mf">98.513</span>    <span class="mf">0.049</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="mf">.7</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">ipalib</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">baseldap</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">706</span><span class="p">(</span><span class="n">get_memberofindirect</span><span class="p">)</span>
</pre></div>
</div>
<p>For indirect members, each entry currently requires 2 LDAP searches.
Implemented search are very effective, but results are not usable for
caching (because each search returns entries specific for the current
entry). The code might be rewritten to get nested entries per
group/hostgroup and store it in cache to be able reuse results. However
this change is not trivial with lot of caveats and might not bring too
much performance. For now we can keep conversion of indirect members as
it is.</p>
<p>Other possibilities are:</p>
<ul class="simple">
<li><p>just do direct membership and add option to enable
indirect-membership</p></li>
<li><p>don’t do indirect membership at all</p></li>
<li><p>try to implement cache for indirect membership</p></li>
</ul>
</section>
</section>
</section>
<section id="test-plan">
<h2>Test Plan<a class="headerlink" href="#test-plan" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="V4/Performance_Improvements/Test_Plan">Performance Improvements V4.4 test
plan</a></p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slow-user-add">Slow user-add</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#performance-slow-down-of-clis">Performance slow down of CLIs</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#authenticate">authenticate</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#control-and-ldap-searches">Control and LDAP searches</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#add-user">Add user</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#update-of-the-group-membership">Update of the group membership</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#broken-schemacache">broken SchemaCache</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#option-noprivate-is-not-efficient">option –noprivate is not efficient</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cli-framework">CLI framework</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#user-add-cli">User-add CLI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-server">Directory Server</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ui">UI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cli">CLI</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slow-user-find">Slow user-find</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#don-t-do-extra-search-for-ipasshpubkey-attribute">Don’t do extra search for ipasshpubkey attribute</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-userpassword-krbprincipalkey-attributes-from-search-results">Remove userPassword, krbPrincipalKey attributes from search results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-members">processing members</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Feature Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">UI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">CLI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#slow-host-find">Slow host-find</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Don’t do extra search for ipasshpubkey attribute</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Remove userPassword, krbPrincipalKey attributes from search results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">processing members</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Feature Management</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">UI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">CLI</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Configuration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Upgrade</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#improvements-of-other-commands">Improvements of other commands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#typical-provisioning-ldapadd-entries-migrate-ds">typical provisioning: ldapadd entries, migrate-ds…</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case">Use case</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-throughput-and-ds-tuning">Provisioning throughput and DS tuning</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#entry-cache-tuning">Entry cache tuning</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#database-cache-tuning">database cache tuning</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#database-locks">database locks</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-throughput-and-ds-plugins">Provisioning throughput and DS plugins</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#small-db-10k-entries">Small DB (10K entries)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#medium-db-100k-entries">Medium DB (100K entries)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#memberof-plugin">Memberof plugin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#schema-compat-plugin">Schema compat plugin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#retrocl-plugin">RetroCL plugin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions">Conclusions</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#proposed-improvements">Proposed improvements</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#algorithm">Algorithm</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-constraints">Provisioning constraints</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-command">provisioning command</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detailed-descriptions-of-each-provisioning-costs">Detailed descriptions of each provisioning costs</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#summary-of-the-test">summary of the test</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-with-memberof-plugin">provisioning with memberof plugin</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-without-memberof-plugin">provisioning without memberof plugin</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hypothese">Hypothese</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#all-commands">all commands</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#all-commands-working-with-members-and-indirect-members">all commands working with members and indirect members</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#find">*-find</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#members-and-indirect-members-processing">members and indirect members processing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#do-not-fetch-members-by-default">Do not fetch members by default</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-caching-of-members-during-find-command">Temporal caching of members during *-find command</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>