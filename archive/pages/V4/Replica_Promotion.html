<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="IPA server configuration" href="Replica_Setup.html" />
    <link rel="prev" title="Overview" href="Replica_Conncheck.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>The current method to install a replica requires a 2 phases approach
where an admin physically logs into a master and generates an
installation package, then transfers it to a new server and performs the
replica install procedure. This method is cumbersome, require
interaction (the ipa-replica-prepare command wants the Directory Manager
password) and is generally hard to deal with in an automated fashion. A
new method to promote a regular client to a replica and in general
simplify replica installs will make a number of maintenance operations
easier. A new replica promotion sequence will allow easier provisioning
via an external infrastructure management system, while retaining a
reasonable level of security (or increasing the security of the solution
in some areas).</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Automatic provisioning and installation of replicas (automatic load
balancing for example) will be simpler to drive, without direct
access to the <em>Directory Manager</em> credentials by the provisioning
system.</p></li>
<li><p>Admins will be able to stand up and then immediately promote servers
to replicas without having to interactively log in as root into an
existing master, a single command will be able to install a full
replica.</p></li>
</ul>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<section id="bootstrapping-problem">
<span id="id1"></span><h2>Bootstrapping problem<a class="headerlink" href="#bootstrapping-problem" title="Permalink to this heading">¶</a></h2>
<p>The only real issue in allowing a streamlined installation for a replica
is that we need “some” trusted credentials that allow to create the
chain of trust necessary to allow a “self-join” to happen. So no matter
what is the technical “transport” mechanism, eventually a secret need to
be landed in the replica before it can be joined to a domain. There are
2 possible approaches with different properties:</p>
<ul class="simple">
<li><p>A privileged account (and related credentials) that is provided to
the replica</p></li>
<li><p>A pre-created set of credentials for a specific replica (OTP or
keytab)</p></li>
</ul>
<p>The following is a pro’s and con’s tab of using a special privileged
“Replica enrollment” account versus creating short term temporary
credentials</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Privileged Account</p></th>
<th class="head"><p>Preset credentials</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Pre-install step</p></td>
<td><p>Not required</p></td>
<td><p>Required</p></td>
</tr>
<tr class="row-odd"><td><p>Orchestration access
to master</p></td>
<td><p>Not required</p></td>
<td><p>Required</p></td>
</tr>
<tr class="row-even"><td><p>Re-installation on
failure</p></td>
<td><p>Always possible</p></td>
<td><p>Requires interaction
with master to reset
OTP / Keytab</p></td>
</tr>
<tr class="row-odd"><td><p>Credentials handling</p></td>
<td><p>Long term secure
storage required</p></td>
<td><p>Short term secure
storage required</p></td>
</tr>
</tbody>
</table>
<p>The downside of using a privileged account is that it is critical to
keep these credentials locked up and disclosed exclusively to the
replica image at install time. However this also means external
provisioning software needs no access to the credentials (it merely
needs a way to make them available which could be accomplished by a
separate privileged process dedicated to this kind of operations). The
use of a OTP/Keytab prepared ad hoc for the new replica may look safer.
But it is not so, an OTP or a keytab that has been given the power to
escalate all the way to become a replica is extremely sensitive as those
credentials, if stolen, can be used to get access to all keys in the
domain. The situation is completely different from a OTP client install
where the consequence of stealing such credentials is a limited access
to the directory and no access to any important key material. On top of
this preparing an OTP requires the orchestration service to have
privileged access to an IPA server.</p>
<p>Both methods are useful, a manual installation performed by an
administrator can do all operations in one sweep, while a provisioning
system might prefer to provide only credentials that are temporarily
valid to an unattended system, so that provisioning failures do not risk
exposing long term, privileged credentials in logs or on disks.</p>
<section id="bootstrapping-workflows">
<span id="id2"></span><h3>Bootstrapping Workflows<a class="headerlink" href="#bootstrapping-workflows" title="Permalink to this heading">¶</a></h3>
<figure class="align-default" id="id23">
<img alt="Replica_bootstrap_1.svg" src="../../../_images/Replica_bootstrap_1.svg" /><figcaption>
<p><span class="caption-text">Replica_bootstrap_1.svg</span><a class="headerlink" href="#id23" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="secrets-sharing-problem">
<span id="id3"></span><h2>Secrets sharing problem<a class="headerlink" href="#secrets-sharing-problem" title="Permalink to this heading">¶</a></h2>
<p>Regardless which bootstrapping method is chosen there are a number of
secrets/keys known by an IPA server that need to be shared between all
masters.</p>
<p>Secrets that need to be shared in a safe way:</p>
<ul class="simple">
<li><p>Currently the <em>Directory Manager</em> password is shared among all
servers, this proposal will try to eliminate any reason to obtain the
domain clear text <em>Directory Manager</em> password for setting up a
replica, but it is possible that some operation will require it.</p></li>
<li><p>The RA agent and other certificates, currently are copied from master
to replica and again each time they are renewed they need to be
shared. This design document aims at eliminating private keys sharing
as much as possible, but it will still be needed in some cases.</p></li>
<li><p><a class="reference external" href="Kerberos">Kerberos</a> Master key (though this can be deferred, it
would be really nice if we could move it out of LDAP and store it in
the file system so that only the KDC/Kadmin process has access to
it).</p></li>
<li><p><a class="reference external" href="PKI">CA</a> private key (for CA replicas only)</p></li>
<li><p>DNSSEC keys (already implemented ?)</p></li>
</ul>
<p>A mechanism needs to be provide such that only legitimate replicas can
get access to private keys and other highly sensitive secrets.</p>
</section>
<section id="new-replica-install-workflow">
<span id="id4"></span><h2>New replica install workflow<a class="headerlink" href="#new-replica-install-workflow" title="Permalink to this heading">¶</a></h2>
<p>This feature may depend on a new features, like a plugin to <a class="reference external" href="V4/Manage_replication_topology">manage the
replication topology</a>. It requires
changes in the order in which tasks are performed as part of the
ipa-replica-install tool, but some changes will be conditional to the
<a class="reference external" href="V4/Domain_Levels">Domain Level</a> (a Level 0 domain will still need to
use prepare files for example).</p>
<p>Installation tools in FreeIPA are built as group of steps performed to
install a subsystem instance. Each subsystem installation is usually
self-contained but ordered such that each macro-step has all necessary
dependencies installed in previous ones.</p>
<p>The new workflow aims at simplifying replica bootstrap and reducing the
amount of data to be gathered upfront in a “prepare” step to a single
set of credentials, either a privileged admin account or a keytab.</p>
<p>Once we have credentials the ipa-replica-install tool will be employed
to install all parts as usual, but the installation order will be
substantially changed from the current one in order to harmonize
installation regardless of which type of initial credentials are
provided.</p>
<p>A key change in the workflow will be that the <a class="reference external" href="PKI">CA</a> and
<a class="reference external" href="DNS">DNS</a> (and in future Vault and other) components will be
considered optional and pushed to the end of the installation phase.
They will also not be directly integrate within the ipa-replica-install
tool per-se but rather the DNS, CA, etc.. own installer will be invoked
at the end of a fully successful and functional basic replica install.
This will allow a failure in an optional component to be remediated
separately and will not force a full reinstall of the replica.</p>
<section id="ipa-replica-conncheck">
<span id="id5"></span><h3>ipa-replica-conncheck<a class="headerlink" href="#ipa-replica-conncheck" title="Permalink to this heading">¶</a></h3>
<p>Currently, ipa-replica-conncheck is being run at the start of the
replica installation process. The goal is to verify that both
replica-server and server-replica communication works for all required
protocols. Without this check, ipa-replica-install may fail in
unexpected ways.</p>
<p>ipa-replica-conncheck tests the replica-server part by simply opening
ports to the remote server. To check the server-replica direction, it
SSH’s as <em>admin</em> to the remote server and then run the checker from the
server to replica. However, this does not run well with streamlining the
replica installation and avoiding passing additional secrets to the
installer.</p>
<p>The connection check should be instead transformed in an API call that
will check server-replica part. Note that SELinux policy will need to be
updated to allow <code class="docutils literal notranslate"><span class="pre">httpd</span></code> connecting to the remote FreeIPA ports [or a
new service that can be instantiated via the system message bus be
created]. As this is FreeIPA specific, the additional policy should be
based on <code class="docutils literal notranslate"><span class="pre">httpd_manage_ipa</span></code> conditional.</p>
</section>
<section id="ipa-client-install">
<span id="id6"></span><h3>ipa-client-install<a class="headerlink" href="#ipa-client-install" title="Permalink to this heading">¶</a></h3>
<p>The very first step will involve calling ipa-client-install (unless we
are promoting an already installed client). The final step of the client
install procedure will be to rotate the host keytab if the install
credentials were keytab based.</p>
</section>
<section id="directory-server-initialization">
<span id="id7"></span><h3>Directory Server initialization<a class="headerlink" href="#directory-server-initialization" title="Permalink to this heading">¶</a></h3>
<p>The first step of the new replica install procedure will involve
installing the Directory Server, however given the
<a class="reference external" href="Kerberos">Kerberos</a> infrastructure is already available, and a host
keytab is available, the <a class="reference external" href="Directory_Server">Directory Server</a> install
does not depend on having LDAPS available. Instead the new topology work
will be leveraged to join the 389 server directly using GSSAPI for
setting up replication agreements. This will avoid replication
agreements conversions later on. The new <a class="reference external" href="Directory_Server">Directory
Server</a> instance installation procedure will
perform the following steps:</p>
<ul>
<li><p>Retrieve ldap/fqdn keytab and drop it in /etc/dirsrv/ds.keytab</p>
<blockquote>
<div><p>Will be used to setup replication agreements</p>
</div></blockquote>
</li>
<li><p>Generate random <em>Directory Manager</em> password</p>
<blockquote>
<div><p>Will be used to perform local installation steps that may still
require a <em>Directory Manager</em> password. The random <em>Directory
Manager</em> password will be discarded when the installation is over.</p>
</div></blockquote>
</li>
<li><p>Stand up the <a class="reference external" href="Directory_Server">Directory Server</a> Instance using
the new replication topology facilities</p></li>
<li><p>Make sure that the replication agreements are set up by the Topology
plugin and initialize the tree from remote server</p>
<ul class="simple">
<li><p>When assigning a <em>replica ID</em> to the replica, make sure that the
change is done as <em>add&amp;delete</em> LDAP update and not LDAP <em>replace</em>
to make sure that there is not a race when multiple replicas are
being installed
(<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4378">#4378</a>). When
the update fails, script may retry for defined number of times
(e.g. 10). This does not cover the case when replicas are being
installed against different masters, this situation does not need
to be solved in this RFE.</p></li>
</ul>
</li>
<li><p>Finally use <a class="reference external" href="Kerberos">Kerberos</a> credentials to request a X509
cert and configure <a class="reference external" href="Directory_Server">Directory Server</a> to also
provide TLS support</p></li>
</ul>
</section>
<section id="kerberos-kdc-initialization">
<span id="id8"></span><h3>Kerberos KDC initialization<a class="headerlink" href="#kerberos-kdc-initialization" title="Permalink to this heading">¶</a></h3>
<p>The current <a class="reference external" href="Kerberos">KDC</a> instance setup will be simplified, mostly
removing code that retrieves the LDAP and host keys, which we already
have at this point.</p>
</section>
<section id="other-core-components-initialization">
<span id="id9"></span><h3>Other core components initialization<a class="headerlink" href="#other-core-components-initialization" title="Permalink to this heading">¶</a></h3>
<p>Most other core components like, the HTTP framework, memcache service,
NTP server, will need no or minor changes. For example:</p>
<ul class="simple">
<li><p>The HTTP instance will copy the preference.html file from another
master by simply fetching it via HTTPS, the configure.jar file will
also be copied or regenerated the same way. Note: configure.jar and
preferences.html are used for configuration of Kerberos of ancient
Firefox versions (&lt;10). It could be safely removed. Manual
configuration steps are provided.</p></li>
<li><p>The default.conf installed by <code class="docutils literal notranslate"><span class="pre">ipa-client-install</span></code> will need to be
updated to also contain the server settings.</p></li>
<li><p>The necessary DNS records (SRV, TXT, NS) will have to be added during
this phase too, as there is no “prepare phase” in which to add them
anymore. Note that forward (A, AAAA) DNS records are expected to be
created during ipa-client-install phase.</p></li>
<li><p>The CA server and ports will need to be detected via checking in LDAP
and probing and stored in this phase as well.</p></li>
</ul>
</section>
<section id="key-sharing-component-initialization">
<span id="id10"></span><h3>Key sharing component initialization<a class="headerlink" href="#key-sharing-component-initialization" title="Permalink to this heading">¶</a></h3>
<p>The last step of the main replica installation phase will involve
installing a new internal service that handles the management and
transfer of core key material. Fundamental installation steps for this
component:</p>
<ul class="simple">
<li><p>generate public/private key-pair for the replica (to be stored in
HSM/SoftHSM)</p></li>
<li><p>store the public key in LDAP so that all master have access to it.</p></li>
<li><p>request any necessary secrets using own key</p></li>
</ul>
<p>For example we may want to request a hash of the <em>Directory Manager</em>
password so that all servers have the same password for admins
convenience.</p>
</section>
<section id="dns-installation">
<span id="id11"></span><h3>DNS Installation<a class="headerlink" href="#dns-installation" title="Permalink to this heading">¶</a></h3>
<p>If required the normal ipa-dns-install script is executed</p>
<ul class="simple">
<li><p>changes to this script are TBD</p></li>
</ul>
</section>
<section id="ca-installation">
<span id="id12"></span><h3>CA installation<a class="headerlink" href="#ca-installation" title="Permalink to this heading">¶</a></h3>
<p>The CA installation procedure will be changed to require less secrets be
shared between clones and also avoid the need for obtaining the
<em>Directory Manager</em> password.</p>
<section id="no-clear-text-dm-password-for-the-install">
<span id="id13"></span><h4>No clear text DM password for the install<a class="headerlink" href="#no-clear-text-dm-password-for-the-install" title="Permalink to this heading">¶</a></h4>
<p>In order to set up the necessary schema and options in the replica
cn=config database the CA install scripts need access as the Directory
Manager. Most of this process is not done as the root user but rather as
the pkiuser after the tomcat VM has been bootstrapped. Options to avoid
obtaining the real <em>Directory Manager</em> password for the <a class="reference external" href="Directory_Server">Directory
Server</a> instillation step:</p>
<ul class="simple">
<li><p>Enhance <a class="reference external" href="Directory_Server">Directory Server</a> to be able to map
no-root users to the <em>Directory Manager</em>, in order to use LDAPI from
the pkiuser</p></li>
<li><p>Allow multiple <em>Directory Manager</em> password and generate a new random
one</p></li>
<li><p>Save the real password hash and temporarily replace with a new random
one</p></li>
<li><p>Externalize configuration servlet into a standalone tool that can be
run as root (LDAPI)</p></li>
</ul>
<p>Temporarily replacing the <em>Directory Manager</em> password with a random one
at CA install time is a bit hackish, but can be done todaywithout any
changes to <a class="reference external" href="Directory_Server">Directory Server</a> or <a class="reference external" href="PKI">CS</a>.</p>
</section>
<section id="multiple-admin-users">
<span id="id14"></span><h4>Multiple Admin users<a class="headerlink" href="#multiple-admin-users" title="Permalink to this heading">¶</a></h4>
<p>The ipa install scripts will create a new <a class="reference external" href="PKI">CS</a> Admin (Security
Domain User) user for each CA replica, will assign this user a random
password and add the user to the <a class="reference external" href="PKI">CS</a> Admins group. This will
avoid the current practice of assigning the <em>Directory Manager</em> password
as the Admin user password and having to share it with the clone in
order for the clone to obtain an installation token. In future we may
need to store the admin user password into the key service process, but
for now we can simply destroy the password at the end of the install
procedure as the admin user is not used for now. (It may be needed in
future to allow the creation of subCAs, but we can generate a new secret
on updates if needed).</p>
</section>
<section id="certificates-and-public-key-wrapping">
<span id="id15"></span><h4>Certificates and public key wrapping<a class="headerlink" href="#certificates-and-public-key-wrapping" title="Permalink to this heading">¶</a></h4>
<p>Given secrets will be transferred via the privileged key service, there
will be no need to use the <em>Directory Manager</em> password to wrap the p12
file containing the CA and other certs.</p>
</section>
<section id="ca-certificates">
<span id="id16"></span><h4>CA Certificates<a class="headerlink" href="#ca-certificates" title="Permalink to this heading">¶</a></h4>
<p>Currently most of the internal certificates (and their keys) used by the
CA are copied to replicas. This is not strictly necessary and from an
auditing/security point of view it may even be desirable to avoid.
Keeping keys private to replicas also makes it much easier to renew
expiring certificates and avoid the need to transfer certificates around
every time one is renewed, each replica is responsible for its own on
its own schedule.</p>
<p>The following certificates will be generated on each replica:</p>
<ul class="simple">
<li><p><strong>Subsystem certificate</strong>: this certificate is used for internal CA
communications and there can be one per replica</p></li>
<li><p><strong>Audit certificate</strong>: the audit certificate is used to sign the
audit log, having a certificate per replica will insure the auditors
can verify which replica generated each auditable event, improving
the auditability of the CA.</p></li>
<li><p><strong>Server certificate</strong>: this is already per server today, no changes</p></li>
<li><p><strong>RA Agent Certificate</strong>: A new agent user will be created on each
replica, added to the RAs group, and a new certificate per replica
will be created</p></li>
<li><p><strong>OCSP certificate</strong>: some more research needs to be done, but it
appears that multiple OCSP certificates can coexist. This certificate
is optional (necessary only when the CRL/OCSP role is transferred) so
this cert will be generated only when needed and not copied over from
the initial CA</p></li>
</ul>
<p>Certificates/keys that still need to be transferred to replicas:</p>
<ul class="simple">
<li><p><strong>CA signing key</strong>: in order to be the same CA all replicas need a
copy of the CA key</p></li>
<li><p><strong>KRA certificates</strong>: The storage certificate must be shared between
KRA/Vault servers so that all servers can encrypt/decrypt the
storage. The transport key certificate could be generate per replica
but that would make clients more complex as they would need to know
which one to use for each replica making load-balancing and fallback
clients much harder.</p></li>
</ul>
</section>
</section>
</section>
<section id="sharing-secrets-securely">
<span id="id17"></span><h2>Sharing Secrets Securely<a class="headerlink" href="#sharing-secrets-securely" title="Permalink to this heading">¶</a></h2>
<p>Requirements:</p>
<ul class="simple">
<li><p>All secrets must be encrypted so that only the target replica can get
access to them. The most straightforward way to achieve that is to
use public key crypto and a replica’s public key to wrap a package
containing secrets to be shared.</p></li>
<li><p>Replicas must be able to get a secret on demand.</p></li>
</ul>
<p>Examples:</p>
<ul class="simple">
<li><p>A replica is promoted to be a <a class="reference external" href="DNS">DNS</a> server (needs access to
the master DNSKEY for the first time)</p></li>
<li><p>A replica is promoted to be a <a class="reference external" href="PKI">CA</a> server (needs access to CA
private key)</p></li>
<li><p>A replica is promoted to be a Vault server (needs KRA storage and
transport keys)</p></li>
</ul>
<section id="secrets-sharing-service-custodia">
<span id="id18"></span><h3>Secrets Sharing Service (Custodia)<a class="headerlink" href="#secrets-sharing-service-custodia" title="Permalink to this heading">¶</a></h3>
<p>A Custodia service is needed to handle encryption/decryption and
delivery on both the sending side and the receiving side; this service
is the only component that have access to the replica’s own private
keys/secrets. (this might also be based on softHSM work already done).</p>
<p>An authenticated communication mechanism between a remote replica and
the Custodia service is required. There are two options:</p>
<ul class="simple">
<li><p>A request using a specific principal using a GSSAPI channel</p></li>
<li><p>A request package, signed by the remote replica private key [this may
be preferable given everything else in the mechanism also uses
public-key crypto]</p></li>
</ul>
<p>A good solution is to actually use both:</p>
<ul class="simple">
<li><p>one to secure/authenticate the transport layer between servers</p></li>
<li><p>the other to secure and add an additional authorization level to the
exchange</p></li>
</ul>
</section>
<section id="transport-mechanisms">
<span id="id19"></span><h3>Transport mechanisms<a class="headerlink" href="#transport-mechanisms" title="Permalink to this heading">¶</a></h3>
<p>Requirements:</p>
<ul class="simple">
<li><p>authentication and access control</p></li>
<li><p>do not expose the Custodia service directly to the network</p></li>
</ul>
<section id="external">
<h4>External<a class="headerlink" href="#external" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>HTTP API.</p></li>
</ul>
<p>The API is exposed via mod_proxy which takes care of Negotiate
authentication for additional access control and forwards requests to a
local Custodia process listening on a Unix Socket.</p>
</section>
<section id="internal">
<h4>Internal<a class="headerlink" href="#internal" title="Permalink to this heading">¶</a></h4>
<p>The Custodia daemon will listen for HTTP requests on a local Unix
Socket. Requests will be partially authenticated by the frontend
mod_proxy process, and all communication will depend on additional
signature verification on each request. The verification will be done
via public key published in IPA’s LDAP server and retrieved based on the
Kerberos Principal used to authenticate to the apache server.</p>
</section>
</section>
<section id="exchange-flow">
<span id="id20"></span><h3>Exchange Flow<a class="headerlink" href="#exchange-flow" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Requesting replica prepares a request package and signs it with the
private key.
The package is a JOSE object, signed by the client and encrypted to
the server’s public key. The payload is a JWT Claims Set with the
following claims</p>
<ul class="simple">
<li><p>A timestamp to prevent replay attacks (“exp” claim)</p></li>
<li><p>The name of the key being requested (“sub” claim)</p></li>
</ul>
</li>
<li><p>Authenticate to other master using host keytab and send package. The
key being sought determines the request path (see <a class="reference external" href="#Handlers_(reading_and_writing_keys)">#Handlers (reading
and writing keys)</a> for
details).</p></li>
<li><p>The receiver checks credentials and passes the package to the
privileged key service</p>
<ul class="simple">
<li><p>The credentials must be of a principal in the master’s group</p></li>
</ul>
</li>
<li><p>The privileged key service gathers the requested data and creates a
reply package
The package is a JOSE object that includes:</p>
<ul class="simple">
<li><p>A timestamp</p></li>
<li><p>The requested key material</p></li>
</ul>
</li>
<li><p>The package is encrypted with the replica public key and sent back</p></li>
<li><p>The replica decrypts and verifies the package and store the keys in
the local (soft)HSM or where appropriate, based on the secret type.</p></li>
</ol>
<figure class="align-default" id="id24">
<img alt="Replica_KISS_1.svg" src="../../../_images/Replica_KISS_1.svg" /><figcaption>
<p><span class="caption-text">Replica_KISS_1.svg</span><a class="headerlink" href="#id24" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="ldap-dit-layout">
<span id="id21"></span><h3>LDAP DIT Layout<a class="headerlink" href="#ldap-dit-layout" title="Permalink to this heading">¶</a></h3>
<p>Two objects for each for each IPA Server: one signing key, and one
encryption key.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="p">{</span><span class="n">sig</span><span class="p">,</span><span class="n">enc</span><span class="p">}</span><span class="o">/</span><span class="p">{</span><span class="n">fqdn</span><span class="p">},</span><span class="n">cn</span><span class="o">=</span><span class="n">custodia</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">ipa</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">etc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ipa</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">local</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">nsContainer</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">ipaKeyPolicy</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">ipaPublicKeyObject</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">groupOfPrincipals</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">top</span>
<span class="n">cn</span><span class="p">:</span> <span class="p">{</span><span class="n">sig</span><span class="p">,</span><span class="n">enc</span><span class="p">}</span><span class="o">/</span><span class="n">rhel76</span><span class="o">-</span><span class="mf">1.</span><span class="n">ipa</span><span class="o">.</span><span class="n">local</span>
<span class="n">ipaKeyUsage</span><span class="p">:</span> <span class="p">{</span><span class="n">digitalSignature</span><span class="p">,</span><span class="n">dataEncipherment</span><span class="p">}</span>
<span class="n">memberPrincipal</span><span class="p">:</span> <span class="n">host</span><span class="o">/</span><span class="p">{</span><span class="n">fqdn</span><span class="p">}</span><span class="o">@</span><span class="p">{</span><span class="n">realm</span><span class="p">}</span>
<span class="n">ipaPublicKey</span><span class="p">::</span> <span class="o">&lt;</span><span class="n">DER</span> <span class="n">encoded</span> <span class="n">SubjectPublicKeyInfo</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="handlers-reading-and-writing-keys">
<span id="id22"></span><h3>Handlers (reading and writing keys)<a class="headerlink" href="#handlers-reading-and-writing-keys" title="Permalink to this heading">¶</a></h3>
<p>In the original implementation the <code class="docutils literal notranslate"><span class="pre">ipa-custodia</span></code> server and Custodia
client code ran as root and was not properly confined by SELinux (see
<a class="reference external" href="https://pagure.io/freeipa/issue/6888">Ticket 6888</a>). As of FreeIPA
4.8.0, server and client key database handlers are run as separate
processes, as a non-root user where possible, and the <code class="docutils literal notranslate"><span class="pre">DAC_OVERRIDE</span></code>
capability is no longer required for either the main process or the
handler processes.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Request path
(/ipa/keys/…)</p></th>
<th class="head"><p>Handler
(/usr/lib/ip
a/custodia/…)</p></th>
<th class="head"><p>Purpose</p></th>
<th class="head"><p>Run as</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>dm/DMHash</p></td>
<td><p>ipa-
custodia-dmldap</p></td>
<td><p>Directory
Manager
password</p></td>
<td><p>root</p></td>
</tr>
<tr class="row-odd"><td><p>ca/{nickname}</p></td>
<td><p>ipa-cust
odia-pki-tomcat</p></td>
<td><p>CA, OCSP,
subsystem,
audit and KRA
keys</p></td>
<td><p><strong>pkiuser</strong></p></td>
</tr>
<tr class="row-even"><td><p>ca_wrappe
d/{nickname}*
<em>[/{alg-oid}]*</em></p></td>
<td><p>i
pa-custodia-pki
-tomcat-wrapped</p></td>
<td><p>Lightweight CA
(sub-CA) key
replication</p></td>
<td><p><strong>pkiuser</strong></p></td>
</tr>
<tr class="row-odd"><td><p>ra/ipaCert</p></td>
<td><p>ipa-cu
stodia-ra-agent</p></td>
<td><p>IPA RA agent
key</p></td>
<td><p>root</p></td>
</tr>
</tbody>
</table>
<p>The optional <strong>{alg-oid}</strong> parameter for Lightweight CA signing keys
requests the specified encryption algorithm be used. This was
implemented as part of <a class="reference external" href="https://pagure.io/freeipa/issue/8020">Ticket 8020 - Support AES in Lightweight CA key
replication</a>. This “parameters
as additional path components” facility is available to all handlers,
but only <code class="docutils literal notranslate"><span class="pre">ca_wrapped</span></code> uses it (as of September 2019).</p>
</section>
</section>
<section id="upgrades">
<h2>Upgrades<a class="headerlink" href="#upgrades" title="Permalink to this heading">¶</a></h2>
<p>To make sure that upgraded replicas can be used as the source servers
for spawning replicas, all necessary infrastructure will need to be
prepared during the upgrade phase, including replica private/public key
generation.</p>
</section>
<section id="backward-compatibility">
<h2>Backward Compatibility<a class="headerlink" href="#backward-compatibility" title="Permalink to this heading">¶</a></h2>
<p>Backport candidates for better compatibility with older FreeIPA or
<a class="reference external" href="Directory_Server">Directory Server</a> versions:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://fedorahosted.org/389/ticket/47667">#47667: Allow nsDS5ReplicaBindDN to be a group
DN</a></p></li>
</ul>
</section>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<p>There are no new UI or CLI features associated with replica promotion or
management of Custodia keys or secrets. The replica installation user
experience is simplified compared to the old procedure (i.e.
<code class="docutils literal notranslate"><span class="pre">ipa-replica-prepare</span></code> is not needed, nor is the replica-file option).</p>
</section>
<section id="how-to-test">
<span id="how-to-test32"></span><h1>How to Test<a class="headerlink" href="#how-to-test" title="Permalink to this heading">¶</a></h1>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading">¶</a></h2>
<p>Two machines that will become IPA masters.</p>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this heading">¶</a></h2>
<p>1. Install a first IPA server - or - upgrade an existing one to the bits
including this feature and raise the domain level to 1.</p>
<p>For better coverage install the DNS server and KRA servers too.</p>
<p>2. Join the future replica as an ipa client with the normal
ipa-client-install command</p>
<p>2.b(optional) kinit as admin and check everything works fine</p>
<p>3. Run ipa-replica-install for better coverage feel free to pass in
–setup-dns –setup-ca –setup-kra or any combination of these flags.</p>
<p>3.b(optional) kinit as a user, check the logs to verify it was
authenticated by the KDC running on the replica.</p>
<p>3.c(optional) turn off the initial master and verify every major
subsystem (KDC, DNS, CA, KRA) keeps working as expected.</p>
</section>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="http://www.freeipa.org/page/V4/Replica_Promotion/Test_plan">Test plan is
here</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/Replica_Promotion.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>