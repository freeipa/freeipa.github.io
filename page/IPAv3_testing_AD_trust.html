
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IPAv3_testing_AD_trust &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/IPAv3_testing_AD_trust';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/page/IPAv3_testing_AD_trust.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>IPAv3_testing_AD_trust</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">IPAv3_testing_AD_trust</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-trust-between-freeipa-and-ad">Testing trust between FreeIPA and AD</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-freeipa">Install FreeIPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-active-directory-domain-for-testing-purposes">Setting up Active Directory domain for testing purposes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-dns">Check DNS</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-conditional-forwarder-on-the-freeipa-side">Adding a conditional forwarder on the FreeIPA side</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-conditional-forwarder-on-the-ad-side">Adding a conditional forwarder on the AD side</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-common-forwarder">Adding a common forwarder</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-freeipa-server-for-trusts">Prepare FreeIPA server for trusts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-sanity-checks">Some sanity checks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#populating-ipantsecurityidentifier-sid-for-existing-users-and-groups">Populating ipaNTSecurityIdentifier (SID) for existing users and groups</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-trust-to-an-ad-domain">Create a trust to an AD domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-cross-realm-kerberos-configuration">Testing cross-realm Kerberos configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#validating-the-trust-from-the-windows-side">Validating the trust from the Windows side</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-ipa-client">Configure IPA client</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#allowing-individual-access-with-k5login">Allowing individual access with .k5login</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#allowing-global-access-for-a-trusted-domain">Allowing global access for a trusted domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-with-ssh">Testing with ssh</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuring-putty-for-sso">Configuring Putty for SSO</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-remote-users-to-ipa-groups">Adding remote users to IPA groups</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-an-external-group-and-adding-objects">Creating an external group and adding objects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-an-external-group-to-an-ipa-group">Adding an external group to an IPA group</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#freeipa-user-on-windows-desktop">FreeIPA user on Windows Desktop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-file-server-cifs-access">Testing File-Server (CIFS) access</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#server-side-ipa-client">Server side (IPA client)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#client-side-windows">Client side (Windows)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#faq">FAQ</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="ipav3-testing-ad-trust">
<h1>IPAv3_testing_AD_trust<a class="headerlink" href="#ipav3-testing-ad-trust" title="Link to this heading">#</a></h1>
<p>See up-to-date article <a class="reference external" href="Active_Directory_trust_setup">Active Directory trust
setup</a>.</p>
</section>
<section id="testing-trust-between-freeipa-and-ad">
<h1>Testing trust between FreeIPA and AD<a class="headerlink" href="#testing-trust-between-freeipa-and-ad" title="Link to this heading">#</a></h1>
<p>Please note that this page is in a <strong>draft</strong> stage and will change
regularly as new features are added to FreeIPA.</p>
<p><strong>NOTE: An updated howtois now
available</strong><a class="reference external" href="Active_Directory_trust_setup">here</a></p>
<section id="install-freeipa">
<h2>Install FreeIPA<a class="headerlink" href="#install-freeipa" title="Link to this heading">#</a></h2>
<p>The easiest way is to
<a class="reference external" href="http://docs.fedoraproject.org/en-US/Fedora/12/html/Deployment_Guide/sec-Configuring_Yum_and_Yum_Repositories.html">configure</a>
<a class="reference external" href="http://jdennis.fedorapeople.org/ipa-devel/">the freeipa nightly devel
repository</a> on a fully
updated Fedora 17 box. Please note that this repository will always
contain the very latest bits but may also be more unstable.</p>
<p>For Fedora 18 you need to enable updates and updates-testing
repositories and you *don’t* need to use nightly devel repository
since everything is available in Fedora 18 already.</p>
<p>List of required package versions:</p>
<ul class="simple">
<li><p>389-ds-base: at least 1.2.11.5. Earlier versions do not work with
FreeIPA.</p></li>
<li><p>samba4: For FreeIPAv3 beta2 at least samba4 4.0.0beta2 is required,
built with –without-ad-dc and –with-system-mitkrb5 options. Samba4
4.0.0beta2 has changed an API that FreeIPA cross-realm trust support
is relying on, thus the requirement. Any samba4 versions before
samba4 4.0.0beta1 also do not have proper MIT krb5 support.</p></li>
<li><p>If SELinux is in use, policy equal or greater then version
3.10.0-134.fc17 should be used.</p></li>
<li><p>MIT krb5 1.10 is required (krb5 1.10.2 or later is required)</p></li>
</ul>
<p>Run ipa-server-install with –setup-dns and you favourite options to
setup an FreeIPA server. It is preferred to use the DNS server of
FreeIPA, otherwise a couple of settings must be added manually to the
external DNS server.</p>
<p>If there is a DNS server which can route DNS traffic between the FreeIPA
and AD domain this sould be used as forwarder with the option
‘–forwarder=ip.address’. If there is no such server alternatives are
discussed in the following section.</p>
<p>Please do not forget to adjust the firewall settings as recommended by
ipa-server-install.</p>
</section>
<section id="setting-up-active-directory-domain-for-testing-purposes">
<h2>Setting up Active Directory domain for testing purposes<a class="headerlink" href="#setting-up-active-directory-domain-for-testing-purposes" title="Link to this heading">#</a></h2>
<p>Please follow article <a class="reference external" href="Setting_up_Active_Directory_domain_for_testing_purposes">Setting up Active Directory domain for testing
purposes</a></p>
</section>
<section id="check-dns">
<h2>Check DNS<a class="headerlink" href="#check-dns" title="Link to this heading">#</a></h2>
<p>Is is important the both domains, FreeIPA and AD, can resolve names and
especially service records of the other domain. Please add the needed
configurations and test e.g. with</p>
<ul class="simple">
<li><p>dig SRV _ldap._tcp.ipa.domain</p></li>
<li><p>dig SRV _ldap._tcp.ad.domain</p></li>
</ul>
<p>If DNS fails against the AD domain you can try to add a special
configuration to your named.conf.</p>
</section>
<section id="adding-a-conditional-forwarder-on-the-freeipa-side">
<h2>Adding a conditional forwarder on the FreeIPA side<a class="headerlink" href="#adding-a-conditional-forwarder-on-the-freeipa-side" title="Link to this heading">#</a></h2>
<p>If FreeIPA is configured with DNS, you can use following command:</p>
<blockquote>
<div><p>ipa dnszone-add ad.domain –name-server=$AD_DC
–admin-email=”<a class="reference external" href="mailto:hostmaster&#37;&#52;&#48;ad&#46;domain">hostmaster<span>&#64;</span>ad<span>&#46;</span>domain</a>” –force –forwarder=$AD_DC_IP
–forward-policy=only</p>
</div></blockquote>
<p>alternatively you can define it manually in named.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zone</span> <span class="s2">&quot;ad.domain&quot;</span> <span class="n">IN</span> <span class="p">{</span>
  <span class="nb">type</span> <span class="n">forward</span><span class="p">;</span>
  <span class="n">forwarders</span> <span class="p">{</span> <span class="n">ip</span><span class="o">-</span><span class="n">address</span><span class="o">.</span><span class="n">of</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="ow">or</span><span class="o">-</span><span class="n">more</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">domain_controllers</span><span class="p">;</span> <span class="p">};</span>
  <span class="n">forward</span> <span class="n">only</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>As result, the FreeIPA DNS server will send all DNS request for the
domain ad.domain to the specified forwarders.</p>
</section>
<section id="adding-a-conditional-forwarder-on-the-ad-side">
<h2>Adding a conditional forwarder on the AD side<a class="headerlink" href="#adding-a-conditional-forwarder-on-the-ad-side" title="Link to this heading">#</a></h2>
<p>If DNS resolution does not work on the AS side, e.g. ‘ping
server.ipa.domain’ does not work on the command prompt a conditional
forwarder can be added to the AD DNS.</p>
<ul class="simple">
<li><p>Open Start-&gt;Administrative Tools-&gt;DNS</p></li>
<li><p>make a right-click on ‘Conditional Forwarders’ in the left column of
the window</p></li>
<li><p>select ‘New Conditional Forwarder…’</p></li>
<li><p>add the DNS domain name of your FreeIPA domain name and the IP
adresses of one or more DNS servers of your FreeIPA domain</p></li>
</ul>
<p>You can also check out <a class="reference external" href="http://people.redhat.com/ssorce/freeipa/ad-dns-forwarder.webm">this
video</a>
on how to set up the forwarders via the Windows GUI.</p>
<p>To test the new configuration you can try to ping your FreeIPA server
again. It might be necessary to call ‘ipconfig /flushdns’ to removed any
cached results.</p>
<p>Alternatively you can use command line utility dnscmd to configure the
forwarder:</p>
<ul class="simple">
<li><p>Open Start -&gt; Command Prompt</p></li>
<li><p>Enter: dnscmd 127.0.0.1 /ZoneAdd FreeIPA.Domain /Forwarder
IP.AD.DR.ESS</p></li>
</ul>
<p>The command should report that zone FreeIPA.Domain was successfully
added.</p>
</section>
<section id="adding-a-common-forwarder">
<h2>Adding a common forwarder<a class="headerlink" href="#adding-a-common-forwarder" title="Link to this heading">#</a></h2>
<p>As an alternative to add conditional forwarders to the configuration of
the FreeIPA and AD servers a common forwarder can be used which routes
the DNS request between the different domains. If there are more than
two domains this might be the preferred solution because otherwise each
domain controller needs to know the DNS servers of all other domains.</p>
<p>One way to create a common forwarder is to run dnsmasq on a separate
server/VM like</p>
<p>`` dnsmasq –no-dhcp-interface=eth0,eth1 –server=/ipa.domain/10.16.10.10 - -server=/ad.domain/192.168.10.10``</p>
<p>DHCP is not needed so all interfaces on the server should be listed in
‘–no-dhcp-interface’. If you want to monitor the DNS traffic you can
add ‘-d -q’ so that dnsmasq runs in the foreground and prints debugging
messages.</p>
<p>This server/VM now can be used as the default forwarder on the FreeIPA
and AD servers.</p>
</section>
<section id="prepare-freeipa-server-for-trusts">
<h2>Prepare FreeIPA server for trusts<a class="headerlink" href="#prepare-freeipa-server-for-trusts" title="Link to this heading">#</a></h2>
<p>Please note that currently SELinux denies winbind to access the Kerberos
credential file of the smbd
(<a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=828619">https://bugzilla.redhat.com/show_bug.cgi?id=828619</a>). Until there is an
updated SELinux policy available SELinux should be set into the
permissive more by calling ‘setenforce 0’.</p>
<p>Call ‘kinit admin’ and call ‘ipa-adtrust-install -p
directory_manager_password’ to create all the needed objects in the
FreeIPA server.</p>
<p>Please set ‘dns_lookup_kdc = true’ in /etc/krb5.conf
(<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/2515">https://fedorahosted.org/freeipa/ticket/2515</a>).</p>
<p>ipa-adtrust-install configures new services and extended operations on
the FreeIPA directory server. To make sure everything is started
properly you can call ‘ipactl restart’.</p>
<p>Now you should call</p>
<ul class="simple">
<li><p>‘kinit admin’ again, because the new TGT will now contain the PAC
data</p></li>
<li><p>the following two steps are not needed if FreeIPA 3.0beta2 or a newer
version is used:</p>
<ul>
<li><p>‘ipa passwd admin’, to create the needed data so that the admin
account can be use in NTLM authentication</p></li>
<li><p>if the password change fails with ‘Constraint violation: Too soon
to change password’ you can wait one hour or change the password
policy with ‘ipa pwpolicy-mod –minlife=0’</p></li>
</ul>
</li>
</ul>
</section>
<section id="some-sanity-checks">
<h2>Some sanity checks<a class="headerlink" href="#some-sanity-checks" title="Link to this heading">#</a></h2>
<p>The following commands can be used to check that smbd and winbindd are
basically working:</p>
<ul class="simple">
<li><p>‘smbclient -L server.ipa-domain -k’</p></li>
<li><p>‘wbinfo –online-status’</p></li>
</ul>
</section>
<section id="populating-ipantsecurityidentifier-sid-for-existing-users-and-groups">
<h2>Populating ipaNTSecurityIdentifier (SID) for existing users and groups<a class="headerlink" href="#populating-ipantsecurityidentifier-sid-for-existing-users-and-groups" title="Link to this heading">#</a></h2>
<p>After running ipa-adtrust-install new users and groups will
automatically get the needed attributes and objectclasses to be used
with trust. This mainly means the SID which is stored in the
ipaNTSecurityIdentifier LDAP attribute.</p>
<p>If an existing IPA installation is upgrade a SID must be assigned to
existing users and groups. A directory server task was added for this
purpose. Since this task can cause some replication traffic in setups
with multiple IPA servers and many users and groups, is is not run
automatically during the update or while running ipa-adtrust-install. To
start the task the following LDIF file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">sidgen</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">ipa</span><span class="o">-</span><span class="n">sidgen</span><span class="o">-</span><span class="n">task</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">tasks</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">add</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">top</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">extensibleObject</span>
<span class="n">cn</span><span class="p">:</span> <span class="n">sidgen</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">basedn</span><span class="p">:</span> <span class="n">dc</span><span class="o">=</span><span class="n">YOUR</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">BASEDN</span>
<span class="n">delay</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
<p>must be loaded with</p>
<blockquote>
<div><p>ldapmodify -H ldapi://%2fvar%2frun%2fslapd-YOUR-REALM.socket -f
ipa-sidgen-task-start.ldif</p>
</div></blockquote>
<p>as root or with directory manager credentials. There are two parameters,
nsslapd-basedn sould be set to your base DN. delay is the time between
two modifications in nano seconds. It can be used to spread the
replication traffic over a longer period of time.</p>
<p>In the logs a message like</p>
<blockquote>
<div><p>sidgen_task_thread - [file ipa_sidgen_task.c, line 191]: Sidgen task
starts …</p>
</div></blockquote>
<p>is shown when the task starts and</p>
<blockquote>
<div><p>sidgen_task_thread - [file ipa_sidgen_task.c, line 196]: Sidgen task
finished [0].</p>
</div></blockquote>
<p>when the task finished successfully.</p>
</section>
<section id="create-a-trust-to-an-ad-domain">
<h2>Create a trust to an AD domain<a class="headerlink" href="#create-a-trust-to-an-ad-domain" title="Link to this heading">#</a></h2>
<p>Currently it is not possible to create a trust from the AD side, because
AD expect a directory server with an AD layout on the other side. We
have to investigate further what can be done to let AD create a trust
with FreeIPA. But since there are no plans to create a directory
structure similar to AD it might be possible that a trust can only be
created from the FreeIPA side.</p>
<p>The following command can be used to create a trust:</p>
<blockquote>
<div><p>ipa trust-add –type=ad ad.domain –admin Administrator –password</p>
</div></blockquote>
<p>You will be asked for the password of the AD Administrator.</p>
<p>Check out <a class="reference external" href="http://people.redhat.com/ssorce/freeipa/setup-ad-ipa-trust.webm">this
video</a>
to see the whole process of setting up a trust, incuding a quick test
that it is working (Note: the video was taken before we changed the
command format from “ipa trust-add-ad” to “ipa trust-add –type=ad”, the
latter is the correct command now).</p>
</section>
<section id="testing-cross-realm-kerberos-configuration">
<h2>Testing cross-realm Kerberos configuration<a class="headerlink" href="#testing-cross-realm-kerberos-configuration" title="Link to this heading">#</a></h2>
<p>If you request a TGT for a FreeIPA user with</p>
<blockquote>
<div><p>kinit <a class="reference external" href="mailto:ipauser&#37;&#52;&#48;IPA&#46;TEST">ipauser<span>&#64;</span>IPA<span>&#46;</span>TEST</a></p>
</div></blockquote>
<p>You should be able to request service tickets for services form the
FreeIPA domain:</p>
<blockquote>
<div><p>kvno <a class="reference external" href="mailto:host/other-host&#46;ipa&#46;test&#37;&#52;&#48;IPA&#46;TEST">host/other-host<span>&#46;</span>ipa<span>&#46;</span>test<span>&#64;</span>IPA<span>&#46;</span>TEST</a></p>
</div></blockquote>
<p>and also for services from the AD domain</p>
<blockquote>
<div><p>kvno <a class="reference external" href="mailto:cifs/ad-dom-member&#46;ad&#46;test&#37;&#52;&#48;AD&#46;TEST">cifs/ad-dom-member<span>&#46;</span>ad<span>&#46;</span>test<span>&#64;</span>AD<span>&#46;</span>TEST</a></p>
</div></blockquote>
<p>If you successful request a service ticket from the AD domain you should
also find a cross-realm TGT <a class="reference external" href="mailto:'krbtgt/AD&#46;TEST&#37;&#52;&#48;IPA&#46;TEST">‘krbtgt/AD<span>&#46;</span>TEST<span>&#64;</span>IPA<span>&#46;</span>TEST</a>’.</p>
</section>
<section id="validating-the-trust-from-the-windows-side">
<h2>Validating the trust from the Windows side<a class="headerlink" href="#validating-the-trust-from-the-windows-side" title="Link to this heading">#</a></h2>
<p>With recent versions of the samba4 package (newer than 2011-12-21) it is
possible to validate the trust from the windows side. To do this open
the ‘Active Directory Domains and Trusts’ tool. Open the Properties of
your local domain, jump to the Trust tab and open the properties of the
FreeIPA trusted domain. Now you can hit the validate button. After a few
second you will be asked if you want to validate the incoming trust as
well. For the you have to use the admin user and must provide the admin
password.</p>
</section>
<section id="configure-ipa-client">
<h2>Configure IPA client<a class="headerlink" href="#configure-ipa-client" title="Link to this heading">#</a></h2>
<p>To allow sssd to look for users in trusted domains</p>
<blockquote>
<div><p>subdomains_provider = ipa</p>
</div></blockquote>
<p>has to be added to the domain section in sssd.conf. Additionally you
might want to add ‘subdomain_homedir = /home/%d/%u’ or similar to define
home directories for users from trusted domains.</p>
<p>To evaluate data from the PAC
(<a class="reference external" href="http://tools.ietf.org/html/draft-brezak-win2k-krb-authz-01">http://tools.ietf.org/html/draft-brezak-win2k-krb-authz-01</a>) the PAC
responder must be started as well. To do this add ‘pac’ to the services
list to the sssd section in sssd.conf, e.g.</p>
<blockquote>
<div><p>services = nss, pam, ssh, pac</p>
</div></blockquote>
<p>Currently the PAC is mainly used to add the remote user to additional
groups of the IPA domain.</p>
</section>
<section id="allowing-individual-access-with-k5login">
<h2>Allowing individual access with .k5login<a class="headerlink" href="#allowing-individual-access-with-k5login" title="Link to this heading">#</a></h2>
<p>If only a few users from a trusted domain shall be allowed to access the
client or if users from the trusted domain shall access the client as a
user from the IPA domain a .k5login (please note the dot as the first
character of the name) file can be used. For the first case the Kerberos
principal name of the user from the trusted domain
(<a class="reference external" href="mailto:username&#37;&#52;&#48;TRUSTED&#46;DOMAIN">username<span>&#64;</span>TRUSTED<span>&#46;</span>DOMAIN</a>) has to be put into the .k5login file in the
home directory of the trusted user. For the second case the same content
has to be put into the .k5login file in the home directory of the IPA
user.</p>
</section>
<section id="allowing-global-access-for-a-trusted-domain">
<h2>Allowing global access for a trusted domain<a class="headerlink" href="#allowing-global-access-for-a-trusted-domain" title="Link to this heading">#</a></h2>
<p>If all users from a trusted domain should be allowed to access the
client the .k5login approach will not scale. Here the following line can
be added to the section for the local realm in /etc/krb5.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>auth_to_local = RULE:[1:$1@$0](^.*@TRUSTED.DOMAIN$)s/@TRUSTED.DOMAIN/@trusted.domain/
auth_to_local = DEFAULT
</pre></div>
</div>
<p>See ‘info krb5-admin “Configuration Files” “krb5.conf” “realms
(krb5.conf)”’ for more details and examples for auth_to_local.</p>
</section>
<section id="testing-with-ssh">
<h2>Testing with ssh<a class="headerlink" href="#testing-with-ssh" title="Link to this heading">#</a></h2>
<p>A GSSAPI aware Windows ssh client must be installed on the windows
server. I used the putty from Quest <a class="reference external" href="http://rc.quest.com/topics/putty/">http://rc.quest.com/topics/putty/</a>,
but recently GSSAPI support was also added to the “standard” putty
<a class="reference external" href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html</a>. If you
now log on to the windows server as the test use abc and use putty to
connect with GSSAPI to the FreeIPA server it should just work without
asking for a password.</p>
</section>
<section id="configuring-putty-for-sso">
<h2>Configuring Putty for SSO<a class="headerlink" href="#configuring-putty-for-sso" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>In <em>Connection - Data</em>, set Auto-login username to “<a class="reference external" href="mailto:user&#37;&#52;&#48;ad&#46;realm">user<span>&#64;</span>ad<span>&#46;</span>realm</a>”.
Be cautious, this field is case sensitive. To configure
<em>Administrator</em> user in AD domain <em>ad.test</em>, configure the field to
<em>Administrator&#64;ad.test</em></p></li>
<li><p>In <em>Connection - SSH - Auth - GSSAPI</em>, make sure that <em>Allow GSSAPI
credential delegation</em> checkbox is checked</p></li>
<li><p>In <em>Session</em>, set your FreeIPA managed machine <em>Host name</em>, save the
session and connect</p></li>
</ol>
</section>
<section id="adding-remote-users-to-ipa-groups">
<h2>Adding remote users to IPA groups<a class="headerlink" href="#adding-remote-users-to-ipa-groups" title="Link to this heading">#</a></h2>
<p>Users of trusted domains can be added to groups of the IPA domain in two
steps. First an “external” group has to be created to hold the
identifiers of remote objects. Then is group can be added to a group of
the IPA domain.</p>
</section>
<section id="creating-an-external-group-and-adding-objects">
<h2>Creating an external group and adding objects<a class="headerlink" href="#creating-an-external-group-and-adding-objects" title="Link to this heading">#</a></h2>
<p>To create an external group the ‘–external’ option was added to ‘ipa
group-add’</p>
<blockquote>
<div><p>ipa group-add –desc=”External test group” –external ext_test</p>
</div></blockquote>
<p>To add remote objects to the external group from the command line the
SID of the object must be known:</p>
<blockquote>
<div><p>ipa group-add-member ext_test –external
S-1-5-21-2324474119-2878384365-2573063092-513</p>
</div></blockquote>
</section>
<section id="adding-an-external-group-to-an-ipa-group">
<h2>Adding an external group to an IPA group<a class="headerlink" href="#adding-an-external-group-to-an-ipa-group" title="Link to this heading">#</a></h2>
<p>External groups can a added like local groups to other groups:</p>
<blockquote>
<div><p>ipa group-add-member –groups=ext_test local_ipa_group</p>
</div></blockquote>
<p>If now the the KDC receives a TGS request from a trusted domain, i.e a
user from the trusted domain wants to access a service from the IPA
domain, it will extract all SIDs from the PAC in the request. If one or
more of these SIDs are members of external groups and the external
groups are members of IPA groups the SIDs of the IPA groups will be
added to the PAC before sending the service ticket back.</p>
<p>The remote machine will now send the service ticket to the IPA client
where the requested service is running. If the PAC responder is
configured on this client (see <a class="reference external" href="#Configure_IPA_client">Configure IPA
client</a>) the remote user is added to IPA
groups on the client.</p>
</section>
<section id="freeipa-user-on-windows-desktop">
<h2>FreeIPA user on Windows Desktop<a class="headerlink" href="#freeipa-user-on-windows-desktop" title="Link to this heading">#</a></h2>
<p>An FreeIPA user can log in to a Windows Desktop from the trusted domain.
The domain part of the user name must be the REALM of the IPA domain,
e.g. ‘IPA.TESTipauser’.</p>
</section>
<section id="testing-file-server-cifs-access">
<h2>Testing File-Server (CIFS) access<a class="headerlink" href="#testing-file-server-cifs-access" title="Link to this heading">#</a></h2>
<p>Please note, although the following step can be done on the IPA server
as on any IPA client, it is not recommended to run a file-serve in the
IPA server.</p>
</section>
<section id="server-side-ipa-client">
<h2>Server side (IPA client)<a class="headerlink" href="#server-side-ipa-client" title="Link to this heading">#</a></h2>
<p>One or more share have to be created in the samba configuration by
either adding them to /etc/smb.conf or by using ‘net conf addshare’ for
registry based configurations. (To add a share on the IPA server for
quick testing use ‘net conf addshare test /tmp’, please do not forget to
call ‘net conf delshare test’ after testing).</p>
<p>Since samba isn’t very flexible in searching for local user names SSSD
has to be configured to use fully qualified names like
SHORTDOMAINNAMEusername instead of the default
<a class="reference external" href="mailto:username&#37;&#52;&#48;LONG&#46;DOMAIN&#46;NAME">username<span>&#64;</span>LONG<span>&#46;</span>DOMAIN<span>&#46;</span>NAME</a>. The following regular expression must be
added to the appropriate domain section or to the sssd section</p>
<blockquote>
<div><p>re_expression = (?P[^\]*?)\?(?P[^\]+$)</p>
</div></blockquote>
<p>The following regular expression can be used to support both types of
fully qualified names at the same time</p>
<blockquote>
<div><p>re_expression =
(((?P[^\]+)\(?P.+$))|((?P[^&#64;]+)&#64;(?P.+$))|(^(?P[^&#64;\]+)$))</p>
</div></blockquote>
<p>Please note that a very recent version of sssd is needed (currently only
available in the ipa-devel repository) to allow the short (NetBIOS)
domain names to be used.</p>
</section>
<section id="client-side-windows">
<h2>Client side (Windows)<a class="headerlink" href="#client-side-windows" title="Link to this heading">#</a></h2>
<p>To access the share on the IPA client either</p>
<blockquote>
<div><p>net use * \ipa.clientsharename</p>
</div></blockquote>
<p>or use ‘Map network drive…’ available e.g. with a right-click on the
Computer object in the Windows explorer.</p>
</section>
<section id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Link to this heading">#</a></h2>
<p>Section listing quick gotchas to help you setup a trust.</p>
<p>Q1&gt; Why do I get the following error when running ipa trust-add
–type=ad</p>
<p>“ipa: ERROR: Cannot find specified domain or server name”</p>
<p>A: Because your IPA server can’t see the keberos or LDAP records that
tell it where the target DC is. To troubleshoot which records your
system is having an issue with. Add the following log level = 11 to
/usr/share/ipa/smb.conf.empty. When you check /var/log/httpd/error_log
you will see which SVR records IPA is having an issue resolving.</p>
<p>If per chance your records are fine. It could be the case you just
edited your /etc/resolv.conf file and simply restarting the IPA stack
will resolve your issue. (restart using ipactl restart )</p>
<p><a class="reference external" href="Category:Obsolete">Category:Obsolete</a></p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">IPAv3_testing_AD_trust</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-trust-between-freeipa-and-ad">Testing trust between FreeIPA and AD</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-freeipa">Install FreeIPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-active-directory-domain-for-testing-purposes">Setting up Active Directory domain for testing purposes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-dns">Check DNS</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-conditional-forwarder-on-the-freeipa-side">Adding a conditional forwarder on the FreeIPA side</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-conditional-forwarder-on-the-ad-side">Adding a conditional forwarder on the AD side</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-common-forwarder">Adding a common forwarder</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-freeipa-server-for-trusts">Prepare FreeIPA server for trusts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#some-sanity-checks">Some sanity checks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#populating-ipantsecurityidentifier-sid-for-existing-users-and-groups">Populating ipaNTSecurityIdentifier (SID) for existing users and groups</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-trust-to-an-ad-domain">Create a trust to an AD domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-cross-realm-kerberos-configuration">Testing cross-realm Kerberos configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#validating-the-trust-from-the-windows-side">Validating the trust from the Windows side</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-ipa-client">Configure IPA client</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#allowing-individual-access-with-k5login">Allowing individual access with .k5login</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#allowing-global-access-for-a-trusted-domain">Allowing global access for a trusted domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-with-ssh">Testing with ssh</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuring-putty-for-sso">Configuring Putty for SSO</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-remote-users-to-ipa-groups">Adding remote users to IPA groups</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-an-external-group-and-adding-objects">Creating an external group and adding objects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-an-external-group-to-an-ipa-group">Adding an external group to an IPA group</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#freeipa-user-on-windows-desktop">FreeIPA user on Windows Desktop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-file-server-cifs-access">Testing File-Server (CIFS) access</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#server-side-ipa-client">Server side (IPA client)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#client-side-windows">Client side (Windows)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#faq">FAQ</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>