
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IPA_Client_in_Active_Directory_DNS_domain &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/IPA_Client_in_Active_Directory_DNS_domain';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/IPA_Client_in_Active_Directory_DNS_domain.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>IPA_Client_in_Active_Directory_DNS_domain</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#user-story">User Story</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#details">Details</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theory-and-practice-of-a-forest-trust-interaction">Theory and practice of a forest trust interaction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-subdomain-of-ad-that-only-has-ipa-machines">A subdomain of AD that only has IPA machines</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enrolling-to-freeipa-realm">Enrolling to FreeIPA realm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#possible-solutions">Possible solutions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#no-single-sign-on-required">No single sign-on required</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-of-ssl-certificates">Handling of SSL certificates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#single-sign-on-required">Single sign-on required</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Handling of SSL certificates</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="ipa-client-in-active-directory-dns-domain">
<h1>IPA_Client_in_Active_Directory_DNS_domain<a class="headerlink" href="#ipa-client-in-active-directory-dns-domain" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>In the ideal world, FreeIPA clients should be deployed in DNS zones
owned by FreeIPA. However, in many environments where FreeIPA is being
deployed, Active Directory is the dominant identity management solution
owning not only the identities, but also the DNS domains. Currently, the
only solution how to migrate a Linux client in such AD owned DNS domain
to FreeIPA was to move it to FreeIPA owned domain. While this procedure
works well when migrating 10 client systems, it is less desirable when
migrating 10k client systems.</p>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h2>
</section>
<section id="user-story">
<h2>User Story<a class="headerlink" href="#user-story" title="Link to this heading">#</a></h2>
<p>As an Administrator with a big number of Linux machines in a DNS domain
controlled by Active Directory, I want to join them to the IdM Server so
that they can benefit from it’s Linux focused features.</p>
</section>
<section id="details">
<h2>Details<a class="headerlink" href="#details" title="Link to this heading">#</a></h2>
<p>Allow FreeIPA client to respond a host name in a DNS domain belonging to
a domain from a trusted Active Directory forest.</p>
<p>If Active Directory forest example.com uses DNS zone <em>example.com</em>, and
FreeIPA is deployed at <em>ipa.example.com</em>, then it is desirable to have
some FreeIPA machines accessible as machine-foo.example.com, not just
<em>machine-foo.ipa.example.com</em>.</p>
<p>In many cases FreeIPA client machines are used as servers for hosting
applications in the same DNS name space as existing Active Directory
environment. While Active Directory enforces ownership of resources (DNS
domain is owned by corresponding Active Directory domain) and FreeIPA
cannot be part of the Active Directory forest by itself, it should be
possible to have a DNS host name for FreeIPA client as a part of a DNS
domain of existing Active Directory domain and still allow single
sign-on operations.</p>
</section>
<section id="theory-and-practice-of-a-forest-trust-interaction">
<h2>Theory and practice of a forest trust interaction<a class="headerlink" href="#theory-and-practice-of-a-forest-trust-interaction" title="Link to this heading">#</a></h2>
<p>There are several concepts needs to be understood for the setup when
FreeIPA machine is a part of the DNS zone belonging to the domain of
Active Directory forest:</p>
<ul class="simple">
<li><p>Active Directory has a concept of relationship between the domain and
DNS zones. An Active Directory domain <em>owns</em> DNS zone of the same
name and no other Active Directory domain may claim the same DNS
zone.</p></li>
<li><p>When forest trust is established between FreeIPA and an Active
Directory forest, Active Directory Domain Controller enforces
non-conflict check of the DNS name spaces claimed by FreeIPA. If
there is any conflict between what FreeIPA claims to own and what the
Active Directory Domain Controller knows to belong to any of the
Active Directory domain in the same forest, a link between FreeIPA
and AD would be disabled and no authentication would be possible
across the trust link.</p></li>
<li><p>FreeIPA automatically adds DNS domains it manages to the list of DNS
domains associated with FreeIPA realm. This list is then presented to
Active Directory when trust is established to allow proper routing of
authentication requests when talking to servers in these DNS domains.</p></li>
</ul>
<p>As a consequence, Active Directory will never refer authentication
request to FreeIPA domain controller for a Kerberos service principal on
a host within DNS zone owned by Active Directory. This means no Kerberos
authentication is possible against such FreeIPA machines from Windows
systems.</p>
</section>
<section id="a-subdomain-of-ad-that-only-has-ipa-machines">
<h2>A subdomain of AD that only has IPA machines<a class="headerlink" href="#a-subdomain-of-ad-that-only-has-ipa-machines" title="Link to this heading">#</a></h2>
<p>What if there is a subdomain of Active Directory that only contains
Linux machines enrolled into FreeIPA realm? In such case Active
Directory needs to be told that this DNS domain belongs to FreeIPA. This
is done with the help of `ipa realmdomains-mod
–add-domain=sub.ad.domain` and re-establishing trust to AD.</p>
</section>
<section id="enrolling-to-freeipa-realm">
<h2>Enrolling to FreeIPA realm<a class="headerlink" href="#enrolling-to-freeipa-realm" title="Link to this heading">#</a></h2>
<p>When FreeIPA client <em>ipa-client.ipa.domain</em> is enrolled into FreeIPA
realm, following is done:</p>
<ol class="arabic simple">
<li><p>Host object <em>ipa-client.ipa.domain</em> is created in FreeIPA to hold
references to the new FreeIPA client</p></li>
<li><p>Kerberos principal is created based on the host object,
<em>host/ipa-client.ipa.domain&#64;IPA.DOMAIN</em></p></li>
<li><p>Keys for this principal retrieved and stored in <em>/etc/krb5.keytab</em> on
the FreeIPA client</p></li>
<li><p>Kerberos configuration is added to <em>/etc/krb5.conf</em> to refer
<em>IPA.DOMAIN</em> Kerberos realm to FreeIPA KDC and map <em>ipa.domain</em> DNS
zone to <em>IPA.DOMAIN</em> Kerberos realm</p></li>
<li><p>SSSD daemon on FreeIPA will attempt to update DNS record for
<em>ipa-client.ipa.domain</em> using the host Kerberos principal created
above.</p></li>
</ol>
<p>Host object in FreeIPA is decoupled from the corresponding DNS record.
Creating the host object with host name from non-FreeIPA DNS zone does
not cause adding that DNS zone to the list of DNS zones associated with
FreeIPA realm.</p>
<p>The way how Kerberos configuration for FreeIPA realm in <em>/etc/krb5.conf</em>
is added depends on the way how <em>ipa-client-install</em> tool discovered the
FreeIPA realm. When automated discovery via DNS SRV records was
successful, no explicit configuration for the FreeIPA realm would be
added. Instead, DNS-based realm and KDC discovery will be activated.</p>
<p>If FreeIPA client is placed in a DNS domain of Active Directory,
automated discovery would be run against Active Directory’s DNS domain
and FreeIPA would not be discovered. To aid the proper discovery,
<em>–domain</em> option has to be passed to <em>ipa-client-install</em> tool.</p>
<p>A mapping between DNS domain and Kerberos realm is created where the
FreeIPA client’s domain is explicitly mapped to point to the FreeIPA
realm.</p>
<p>To sum up, for FreeIPA realm IPA.EXAMPLE.COM and Active Directory
EXAMPLE.COM, when FreeIPA client has host name ipa-client.example.com,
following configuration would be written if <em>ipa-client-install –domain
ipa.example.com</em> was used to configure the FreeIPA client (abbreviated):</p>
<p>/etc/krb5.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[libdefaults]
dns_lookup_realm = true
dns_lookup_kdc = true

[realms]
IPA.EXAMPLE.COM = {
    pkinit_anchors = ``\ ```FILE:/etc/ipa/ca.crt`` &lt;FILE:/etc/ipa/ca.crt&gt;`__
}

[domain_realm]
.ipa.example.com = IPA.EXAMPLE.COM
ipa.example.com = IPA.EXAMPLE.COM
.example.com = IPA.EXAMPLE.COM
example.com = IPA.EXAMPLE.COM
</pre></div>
</div>
<p>As can be seen above, look up for any service principal on the hosts in
DNS zone <em>example.com</em> will be forced to belong to realm
<em>IPA.EXAMPLE.COM</em>. This means the client will not be able correctly
communicate with services enrolled into Active Directory because all
Kerberos requests for <em>EXAMPLE.COM</em> realm would be instead sent to the
KDC of <em>IPA.EXAMPLE.COM</em>.</p>
<p>It is, however, possible to change</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">IPA</span><span class="o">.</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">IPA</span><span class="o">.</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
</pre></div>
</div>
<p>to explicit configuration for the FreeIPA hostname:</p>
<p>``   ipa-client.example.com = IPA.EXAMPLE.COM``</p>
<p>and leave out any other explicit mapping for <em>.example.com</em> to have it
discovered via DNS SRV record lookups.</p>
<p>Note that the setup above will not allow machines from realm
<em>EXAMPLE.COM</em> to properly obtain a service ticket towards
<em>ipa-client.example.com</em> because they will be thinking
<em>ipa-client.example.com</em> belongs to realm <em>EXAMPLE.COM</em>. On Linux
machines it would be possible to extend <em>[domain_realm]</em> mapping the
same way to force a single machine to map to the right realm but in
Active Directory it is not possible to do so.</p>
<p>For Kerberos-based authentication and access to services running on
FreeIPA machines to work, two conditions must be satisfied:</p>
<ol class="arabic simple">
<li><p>Client A must be able to talk to the KDC of its own realm to request
a service ticket to server B or a cross-realm TGT for realm of the
server B and then request a service ticket to server B</p></li>
<li><p>Server B must be able to talk to the KDC of its own realm</p></li>
</ol>
<p>Condition (1) is needed so that client A could present the service
ticket to the service running on the server B to mutually authenticate.
Condition (2) is needed for SSSD on server B to be able to transform an
incoming Kerberos principal identity to an identity understood by the
underlying POSIX environment.</p>
<p>As result, KDC of the client’s realm must know either Kerberos principal
for a service on the server B, or should be able to issue a cross-realm
referral ticket to the KDC of the realm where the Kerberos principal is
located. In practice, this means that either server B is enrolled to
Active Directory domain, or it is enrolled to FreeIPA domain _and_ a
cross-forest trust is established between the FreeIPA and the Active
Directory forest root domain.</p>
<p>However, if server B is enrolled to the FreeIPA domain, its DNS host
name cannot be part of the <em>example.com</em> DNS zone because this is
prohibited by MS-ADTS specification, <a class="reference external" href="https://msdn.microsoft.com/en-us/library/cc223787.aspx">section 6.1.6.9.3.2 “Building
Well-Formed msDS-TrustForestTrustInfo
Message”</a>. An
abridged version of these rules is available in MS-LSAD, <a class="reference external" href="https://msdn.microsoft.com/en-us/library/cc234372.aspx">section
3.1.4.7.16.1 “Forest Trust Collision
Generation”</a>:</p>
<p>The rules for top-level name entries are as follows:</p>
<ul class="simple">
<li><p>An enabled (that is, non-conflict) top-level name record must not be
equal to an enabled top-level name for another trusted domain object
or to any of the DNS tree names within the current forest. Equality
is computed using case-insensitive string comparison. If the strings
differ only by one trailing ‘.’ character, the difference is ignored.</p></li>
<li><p>The top-level name must not be subordinate to an enabled top-level
name for another trusted domain object, unless the other trusted
domain object has a corresponding exclusion record.</p></li>
<li><p>A top-level name must not be superior to an enabled top-level name
for another trusted domain object, unless the current trusted domain
object has a corresponding exclusion record.</p></li>
</ul>
<p>If any of these rules are violated, a top-level name is considered in
conflict.</p>
<p>The solution for Kerberos-based authentication and access to resources
in DNS zone owned by an Active Directory domain relies on the fact that
Kerberos libraries use a specific logic to discover actual service
principal for host- based services.</p>
<p>MIT Kerberos as an implementation of Kerberos protocol follow <a class="reference external" href="http://web.mit.edu/Kerberos/krb5-latest/doc/admin/princ_dns.html">these
rules</a>:
MIT Kerberos clients currently always do forward resolution (looking up
the IPv4 and possibly IPv6 addresses using getaddrinfo()) of the
hostname part of a host-based service principal to canonicalize the
hostname. They obtain the “canonical” name of the host when doing so.</p>
<p>In practice this also means any CNAME record will be resolved to the
corresponding A/AAAA record and the result is then used to construct
host- based Kerberos principal (e.g. <em>nfs/ipa-client.example.com</em>).</p>
<p>The same logic is used by Active Directory:</p>
<ul class="simple">
<li><p>If FreeIPA client is enrolled as <em>ipa-client.ipa.example.com</em> (A/AAA
records set using this hostname) and</p></li>
<li><p>there is CNAME record <em>ipa-client.example.com</em> pointing to
<em>ipa-client.ipa.example.com</em>,</p></li>
<li><p>then Windows client will attempt to request a Kerberos service ticket
for a host-based service on the host <em>ipa-client.ipa.example.com</em></p></li>
</ul>
<p>As result, no machine with A/AAAA DNS record <em>ipa-client.example.com</em>
can operate properly with Kerberos in Active Directory while being part
of a Kerberos realm different to <em>EXAMPLE.COM</em> but a CNAME record
<em>ipa-client.example.com</em> can point to A/AAAA DNS record
<em>ipa-client.ipa.example.com</em> to allow Kerberos authentication.</p>
</section>
<section id="possible-solutions">
<h2>Possible solutions<a class="headerlink" href="#possible-solutions" title="Link to this heading">#</a></h2>
<p>Depending on what is required to achieve, there are two solutions
possible. In both cases we assume proper enrollment of the client to
FreeIPA by means of <em>ipa-client-install</em> tool which would set up SSSD
with ‘ipa’ identity provider.</p>
</section>
<section id="no-single-sign-on-required">
<h2>No single sign-on required<a class="headerlink" href="#no-single-sign-on-required" title="Link to this heading">#</a></h2>
<p>When no single sign-on (Kerberos authentication) required, we still
should make sure Kerberos configuration is set up to allow SSSD to
communicate with FreeIPA masters.</p>
<p>FreeIPA client should be configured with <em>ipa-client-install
–domain=ipa.example.com</em> so that auto-detection of Active Directory
domain via SRV records in DNS domain <em>example.com</em> will not be done.</p>
<p>Kerberos configuration in <em>/etc/krb5.conf</em> should be modified to add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">domain_realm</span><span class="p">]</span>
  <span class="n">ipa</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">IPA</span><span class="o">.</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
</pre></div>
</div>
<p>This configuration change will ensure that the host itself is associated
with FreeIPA realm on this machine.</p>
<p>Only password-based logon will work for accessing resources on this
machine. Any Kerberos or GSSAPI based access will fail from both other
FreeIPA machines or Active Directory clients as long as originating
machines have no mapping in their Kerberos configuration for
<em>ipa-client.example.com</em> to <em>IPA.EXAMPLE.COM</em> realm. As described in the
previous sections, on Active Directory side it is not possible to add
such configuration.</p>
<p>If AD users logged in with password using SSH session or GNOME Desktop
manager, they might get valid Kerberos credentials in their credentials
cache. To use these credentials against any other Active
Directory-enrolled Windows resources one needs to remove Kerberos
domain-realm mapping that forces <em>.example.com</em> to be associated with
<em>IPA.EXAMPLE.COM</em> realm:</p>
<p>/etc/krb5.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">domain_realm</span><span class="p">]</span>
<span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">IPA</span><span class="o">.</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">ipa</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">IPA</span><span class="o">.</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
</pre></div>
</div>
<p>Once <em>.example.com</em> is associated with <em>EXAMPLE.COM</em> realm, actual
Kerberos credentials obtained on the FreeIPA client as part of the
OpenSSH logon can be used to authenticate against other Active Directory
resources.</p>
<section id="handling-of-ssl-certificates">
<h3>Handling of SSL certificates<a class="headerlink" href="#handling-of-ssl-certificates" title="Link to this heading">#</a></h3>
<p>For SSL-based service protection (HTTPS, IMAPS, etc), a certificate with
dNSName extension records covering all system hostnames is required due
to the fact that both original (A/AAAA) and CNAME record names need to
be in the certificate.</p>
<p>Currently FreeIPA only issues certificates to host objects presenting in
FreeIPA database. For the case when single sign-on is not required, it
is assumed that the host <em>ipa-client.example.com</em> is enrolled into
FreeIPA realm.</p>
<p>This means there is already a host object for <em>ipa-client.example.com</em>
in FreeIPA and Certmonger can already request for the certificate in its
name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ipa-getcert request -r \
   -f /etc/httpd/alias/server.crt \
   -k /etc/httpd/alias/server.key \
   -N CN=`hostname --fqdn` \\`
   -D `hostname --fqdn` \\`
   -K host/ipa-client.example.com@IPA.EXAMPLE.COM \
   -U id-kp-serverAuth
</pre></div>
</div>
<p>This example allows to request an SSL certificate from FreeIPA CA to
store it in <em>server.crt</em> (public key) and <em>server.key</em> (private key)
files.</p>
<p>Certmonger uses default host key stored in <em>/etc/krb5.keytab</em> to
authenticate against FreeIPA CA. This means Kerberos authentication
against <em>IPA.EXAMPLE.COM</em> realm should be properly working which is why
<em>ipa-client.example.com = IPA.EXAMPLE.COM</em> was added to <em>[domain_realm]</em>
mapping in <em>/etc/krb5.conf</em> above.</p>
</section>
</section>
<section id="single-sign-on-required">
<h2>Single sign-on required<a class="headerlink" href="#single-sign-on-required" title="Link to this heading">#</a></h2>
<p>When single sign-on is required, moving FreeIPA client outside DNS zone
<em>example.com</em> is the pre-requisite. A CNAME record
<em>ipa-client.example.com</em> can then be created to point to the A/AAAA
record of the FreeIPA client. E.g., <em>ipa-client.ipa.example.com</em>.</p>
<p>For Kerberos-based application servers MIT Kerberos supports a method to
allow accept any host-based principal available in the application’s
keytab. When Kerberos client would connect to a Kerberos application
server, such server typically does strict check on what Kerberos
principal was used to target it (so-called, ‘acceptor check’). This can
be relaxed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">libdefaults</span><span class="p">]</span>
 <span class="n">ignore_acceptor_hostname</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<p>For OpenSSH server there is a specific option <em>GSSAPIStrictAcceptorCheck
no</em> to achieve the same.</p>
<section id="id1">
<h3>Handling of SSL certificates<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>For SSL-based service protection (HTTPS, IMAPS, etc), a certificate with
dNSName extension records covering all system hostnames is required due
to the fact that both original (A/AAAA) and CNAME record names need to
be in the certificate.</p>
<p>Currently FreeIPA only issues certificates to host objects presenting in
FreeIPA database. This means one would need to create host object for
<em>ipa-client.example.com</em> in FreeIPA and make sure the real FreeIPA
machine’s host object is able to manage this host:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span> <span class="n">host</span><span class="o">-</span><span class="n">add</span> <span class="n">ipa</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">force</span>
<span class="n">ipa</span> <span class="n">host</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">managedby</span> <span class="n">ipa</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">hosts</span><span class="o">=</span><span class="n">ipa</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>We have to use <em>–force</em> option here because <em>ipa-client.example.com</em> is
a CNAME, not an A/AAAA DNS record as required by FreeIPA.</p>
<p>With this setup <em>ipa-client.ipa.example.com</em> would be able to request an
SSL certificate with dNSName extension record for
<em>ipa-client.example.com</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ipa-getcert request -r \
    -f /etc/httpd/alias/server.crt \
    -k /etc/httpd/alias/server.key \
    -N CN=`hostname --fqdn` \\`
    -D `hostname --fqdn` \\`
    -D ipa-client.example.com \
    -K host/ipa-client.ipa.example.com@IPA.EXAMPLE.COM \
    -U id-kp-serverAuth
</pre></div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#user-story">User Story</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#details">Details</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theory-and-practice-of-a-forest-trust-interaction">Theory and practice of a forest trust interaction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-subdomain-of-ad-that-only-has-ipa-machines">A subdomain of AD that only has IPA machines</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enrolling-to-freeipa-realm">Enrolling to FreeIPA realm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#possible-solutions">Possible solutions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#no-single-sign-on-required">No single sign-on required</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-of-ssl-certificates">Handling of SSL certificates</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#single-sign-on-required">Single sign-on required</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Handling of SSL certificates</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>