<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>How to debug FreeIPA privilege separation issues &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Procedure in current IPA" href="../Using_3rd_part_certificates_for_HTTP/LDAP.html" />
    <link rel="prev" title="IPA won’t start, expired certificates" href="PKI.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="how-to-debug-freeipa-privilege-separation-issues">
<span id="id1"></span><h1>How to debug FreeIPA privilege separation issues<a class="headerlink" href="#how-to-debug-freeipa-privilege-separation-issues" title="Permalink to this heading">¶</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>FreeIPA 4.5 implements privilege separation between different components
of its management framework. To understand what changed, first let’s
look at how the FreeIPA management framework is built.</p>
<p>The FreeIPA management framework is a web application served via
Apache’s mod_wsgi module. Any user accessing the FreeIPA management
framework is supposed to have a Kerberos principal associated with the
user’s account. The framework itself talks to the FreeIPA LDAP server
and needs to authenticate to it. When a user connects to the framework
over HTTPS, it either needs to authenticate with Kerberos or present a
cookie from a previous authentication. For clients that don’t support
Kerberos, a special end point is available for password-based
authentication. It produces a cookie that can be presented in subsequent
requests.</p>
<p>For each service, the FreeIPA framework, the LDAP server Kerberos
authentication is required. In Kerberos users obtain an initial ticket
granting ticket (TGT) from a Kerberos KDC. This is used to obtain
per-service authentication tickets and is never transferred over the
network. A new, service ticket is obtained from the KDC and then
presented to that service when authentication is required. The service
ticket cannot be re-used by the target service to impersonate a user to
another service unless the KDC allows it.</p>
<p>A Kerberos protocol extension called S4U2Proxy (or
constrained-delegation) was developed by Microsoft to allow trusted
services to impersonate Kerberos principals when performing operations
on their behalf. The key word here is <strong>trusted</strong>, the ultimate decision
point belongs to the KDC itself.</p>
<p>The FreeIPA management framework uses S4U2Proxy to authenticate to the
LDAP server, therefore it is a <strong>trusted</strong> service and sits in a very
valuable (for an attacker) position; it can impersonate any user that
authenticated to the service against the LDAP server. Any security
breach in the framework code could allow an attacker to sift through the
authentication tokens received by the framework, find administrator
credentials, steal them, and then use them against the LDAP server. This
is especially bad when password-based authentication is performed,
because in that case the framework does have access to a locally stored
TGT.</p>
<p>The only way to prevent this exposure is to deny the FreeIPA framework
direct access to the tickets and service credentials. But this
effectively means inability to perform any Kerberos authentication on
behalf of the user by the service itself.</p>
<p>To solve this problem GSS-Proxy was developed. GSS-Proxy is a service
comprised of a special “interposer” plugin for the GSSAPI library and a
separate daemon. The GSS-Proxy plugin intercepts all GSSAPI operations
and diverts their execution to the GSS-Proxy daemon. The daemon performs
these operations and returns encrypted structures which are them stored
in a credential cache used by the client application. The client
application cannot decode these structures by itself. This approach
allows GSS-Proxy to implement privilege separation on a per ticket
level.</p>
<p>With the help of GSS-Proxy the FreeIPA management framework is denied
direct access to its own Kerberos keys. Any intruder running under
Apache privileges will not be able to steal the service keys.
Technically an intruder would be able to request a ticket but would not
be able to retrieve actual credentials.</p>
<p>Session management was also changed. Instead of managing sessions in the
framework and storing tickets in a cache, session are now manage by the
mod_auth_gssapi module and tickets are stored on the filesystem, their
contents encrypted by GSS-Proxy. Additionally the framework has been
changed to run as a separate user named “ipaapi”, it does not have the
same privilegese the Apache server has. This, in combination with
GSS-Proxy allows to prevent attacks that would result in stealing any
keys and perform an attack from a remote system. The attack surface is
seriously reduced.</p>
<p>FreeIPA 4.5 introduces also client certificate authentication support.
In fact, it was possible to set up client certificate authentication
since FreeIPA 4.4 but with version 4.5 the whole setup was streamlined
and integrated with the rest of the framework.</p>
<p>Client certificate authentication is handled by <code class="docutils literal notranslate"><span class="pre">mod_nss</span></code>, an Apache
module, but authentication is managed via the <code class="docutils literal notranslate"><span class="pre">mod_auth_gssapi</span></code> module
in all cases to establish a session and to obtain Kerberos credentials.
In fact <code class="docutils literal notranslate"><span class="pre">mod_auth_gssapi</span></code> has been enhanced to use another kerberos
protocol extension called S4U2Self (or protocol-transition) to obtain
tickets for users that were successfully authenticated by <code class="docutils literal notranslate"><span class="pre">mod_nss</span></code>.
With this extension a <strong>trusted</strong> service (application) can request to
the KDC a service ticket to itself on behalf of the user.</p>
<p>If the KDC trusts a service for both S4U2Self and S4U2Proxy operations,
a service can fully impersonate any user to the target services (i this
case the LDAP server). To prevent a breach in the framework to allow it
to impersonate arbitrary users, the GSS-Proxy allow the
protocol-transition operation for the HTTP service only if the request
comes from the Apache user. This privilege separation mechanism prevents
a breach of the framework code from allowing direct privilege escalation
via impersonation, because the framework code runs as a different user
in the system. Likewise constrained-delegation to obtain a ticket to the
LDAP server is permitted only to the <code class="docutils literal notranslate"><span class="pre">ipaapi</span></code> user.</p>
<p>The consequence of privilege separation enhancements is that the FreeIPA
management framework does not handle sessions directly and handles user
authentication only for forms-based authentication, but does not retain
access to user’s TGTs in that case. Due to this change separate URLs for
session and non-session based access are not necessary anymore,
applications that present a cookie to the Apache server have immediate
access regardless of the endpoint and lack of a cookie results in
automatic GSSAPI negotiation. The session cookie is effectively just an
optimization.</p>
</section>
<section id="logging-in-freeipa-management-framework">
<span id="id2"></span><h2>Logging in FreeIPA management framework<a class="headerlink" href="#logging-in-freeipa-management-framework" title="Permalink to this heading">¶</a></h2>
<p>With multiple components involved in a user request processing, it is
important to enable logging properly in all relevant components. There
are several layers of logging available:</p>
<section id="freeipa-framework-s-python-code-logging">
<span id="freeipa-frameworks-python-code-logging"></span><h3>FreeIPA framework’s Python code logging<a class="headerlink" href="#freeipa-framework-s-python-code-logging" title="Permalink to this heading">¶</a></h3>
<p>FreeIPA has a global configuration file in <code class="docutils literal notranslate"><span class="pre">/etc/ipa/default.conf</span></code>.
Settings in this file apply to all instances of the FreeIPA python code,
be it client or server. However, a specific context, that has its own
configuration file in <code class="docutils literal notranslate"><span class="pre">/etc/ipa/server.conf</span></code>, is used to specify
options to the server side of the framework. This allows to avoid
excessive debug information on the command line when debugging problems
on IPA servers.</p>
<p>Add a <code class="docutils literal notranslate"><span class="pre">debug</span> <span class="pre">=</span> <span class="pre">True</span></code> option to the <code class="docutils literal notranslate"><span class="pre">[global]</span></code> section to enable
debug logs. For the server side of the framework a restart of the
<code class="docutils literal notranslate"><span class="pre">httpd.service</span></code> is required. Logs will appear in
<code class="docutils literal notranslate"><span class="pre">/var/log/httpd/error_log</span></code> and will be intermixed with other log
entries from other Apache modules.</p>
</section>
<section id="logging-the-activity-of-apache-modules">
<span id="id3"></span><h3>Logging the activity of Apache modules<a class="headerlink" href="#logging-the-activity-of-apache-modules" title="Permalink to this heading">¶</a></h3>
<p>FreeIPA does only uses the logging functionality available in Apache.
Its documentation is available at the <a class="reference external" href="https://httpd.apache.org/docs/current/logs.html">Apache
website</a>.</p>
</section>
<section id="logging-of-samba-client-operations">
<span id="id4"></span><h3>Logging of Samba client operations<a class="headerlink" href="#logging-of-samba-client-operations" title="Permalink to this heading">¶</a></h3>
<p>FreeIPA utilizes Python bindings to Samba libraries to set-up trusts to
Active Directory. These libraries have their own logging facility. The
FreeIPA code initializes Samba bindings with a special configuration
file named <code class="docutils literal notranslate"><span class="pre">/usr/share/ipa/smb.conf.empty</span></code>. It is an empty
configuration file that forces Samba bindings to ignore system-wide
settings. In order to debug what the FreeIPA management framework does
during trust to Active Directory operations, add the
<code class="docutils literal notranslate"><span class="pre">log</span> <span class="pre">level</span> <span class="pre">=</span> <span class="pre">&lt;LEVEL&gt;</span></code> option to <code class="docutils literal notranslate"><span class="pre">/usr/share/ipa/smb.conf.empty</span></code>. Log
levels aren’t really standardized and different parts of Samba use
different levels but for trust operations it is useful to set the log
level to <code class="docutils literal notranslate"><span class="pre">10</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="k">global</span><span class="p">]</span>
  <span class="n">log</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<p>This will allow Samba Python bindings to print all low level information
and dump details of network packets in a human readable form. For DCE
RPC operations both input and output structures will be decoded and
printed. This is very useful to see what’s wrong with a request or a
response.</p>
<p>The configuration file <code class="docutils literal notranslate"><span class="pre">smb.conf.empty</span></code> is read every time a request
that requires using Samba Python libraries is processed. Therefore a
change of the log level does not require a restart of the
<code class="docutils literal notranslate"><span class="pre">httpd.service</span></code>.</p>
<p>The same configuration file is used by an oddjobd helper that performs
retrieval of the trusted forest topology. Since the helper is executed
by the FreeIPA management framework via a D-BUS request, its output is
returned back to the framework and is logged into Apache’a <code class="docutils literal notranslate"><span class="pre">error_log</span></code>
along the other log entries of the framework.</p>
</section>
</section>
<section id="logging-of-gss-proxy">
<span id="id5"></span><h2>Logging of GSS-Proxy<a class="headerlink" href="#logging-of-gss-proxy" title="Permalink to this heading">¶</a></h2>
<p>GSS-Proxy’s configuration is defined in the <code class="docutils literal notranslate"><span class="pre">/etc/gssproxy</span></code> directory.
It has series of files for each GSSAPI service and also a general
<code class="docutils literal notranslate"><span class="pre">/etc/gssproxy/gssproxy.conf</span></code>. To enable a reasonable level of debug
information use the following options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">gssproxy</span><span class="p">]</span>
  <span class="n">debug</span> <span class="o">=</span> <span class="n">true</span>
  <span class="n">debug_level</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
<p>To apply configuration changes, reload or restart the
<code class="docutils literal notranslate"><span class="pre">gssproxy.service</span></code>. Logs will be stored in the system journal and can
be viewed with the help of <code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">gssproxy</span></code> command.</p>
<p>GSS-Proxy logs every incoming request and the result of its processing.
This information includes dates in UTC, so there are two dates displayed
by <code class="docutils literal notranslate"><span class="pre">journalctl</span></code>: a date in local time zone and UTC, the latter is part
of the string that GSS-Proxy logged to <code class="docutils literal notranslate"><span class="pre">journald</span></code>.</p>
<p>Below is a typical session that starts from an <code class="docutils literal notranslate"><span class="pre">httpd</span></code> process
connecting to GSS-Proxy and asking to acquire credentials for the HTTP
service. A log is redacted to remove a common date and hostname prefix
displayed by <code class="docutils literal notranslate"><span class="pre">journalctl</span></code> utility:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span> <span class="n">Logs</span> <span class="n">begin</span> <span class="n">at</span> <span class="n">Fri</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">27</span> <span class="mi">16</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">43</span> <span class="n">CET</span><span class="p">,</span> <span class="n">end</span> <span class="n">at</span> <span class="n">Fri</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">21</span> <span class="mi">18</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">10</span> <span class="n">CEST</span><span class="o">.</span> <span class="o">--</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span> <span class="p">[</span><span class="mi">2017</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">21</span> <span class="mi">11</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">]:</span> <span class="n">Client</span> <span class="n">connected</span> <span class="p">(</span><span class="n">fd</span> <span class="o">=</span> <span class="mi">18</span><span class="p">)</span>
                <span class="p">[</span><span class="mi">2017</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">21</span> <span class="mi">11</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">]:</span>  <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="mi">25925</span><span class="p">)</span> <span class="p">(</span><span class="n">uid</span> <span class="o">=</span> <span class="mi">48</span><span class="p">)</span> <span class="p">(</span><span class="n">gid</span> <span class="o">=</span> <span class="mi">48</span><span class="p">)</span>
                <span class="p">[</span><span class="mi">2017</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">21</span> <span class="mi">11</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">]:</span>  <span class="p">(</span><span class="n">context</span> <span class="o">=</span> <span class="n">system_u</span><span class="p">:</span><span class="n">system_r</span><span class="p">:</span><span class="n">httpd_t</span><span class="p">:</span><span class="n">s0</span><span class="p">)</span>
                <span class="p">[</span><span class="mi">2017</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">21</span> <span class="mi">11</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">]:</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span> <span class="p">[</span><span class="mi">2017</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">21</span> <span class="mi">11</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">]:</span> <span class="n">gp_rpc_execute</span><span class="p">:</span> <span class="n">executing</span> <span class="mi">6</span> <span class="p">(</span><span class="n">GSSX_ACQUIRE_CRED</span><span class="p">)</span> <span class="k">for</span> <span class="n">service</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">ipa</span><span class="o">-</span><span class="n">httpd</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="n">euid</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span><span class="n">socket</span><span class="p">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span>     <span class="n">GSSX_ARG_ACQUIRE_CRED</span><span class="p">(</span> <span class="n">call_ctx</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">}</span> <span class="n">input_cred_handle</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="n">BOTH</span> <span class="mi">86400</span> <span class="mi">86400</span> <span class="p">}</span> <span class="p">]</span> <span class="p">[</span> <span class="o">...........</span><span class="n">L</span><span class="o">..</span><span class="n">N</span><span class="o">....</span> <span class="p">]</span> <span class="mi">0</span> <span class="p">}</span> <span class="n">add_cred</span><span class="p">:</span> <span class="mi">0</span> <span class="n">desired_name</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Null</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">time_req</span><span class="p">:</span> <span class="mi">4294967295</span> <span class="n">desired_mechs</span><span class="p">:</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">}</span> <span class="n">cred_usage</span><span class="p">:</span> <span class="n">BOTH</span> <span class="n">initiator_time_req</span><span class="p">:</span> <span class="mi">0</span> <span class="n">acceptor_time_req</span><span class="p">:</span> <span class="mi">0</span> <span class="p">)</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span>     <span class="n">GSSX_RES_ACQUIRE_CRED</span><span class="p">(</span> <span class="n">status</span><span class="p">:</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="mi">0</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">}</span> <span class="n">output_cred_handle</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="n">BOTH</span> <span class="mi">86400</span> <span class="mi">86400</span> <span class="p">}</span> <span class="p">]</span> <span class="p">[</span> <span class="o">.</span><span class="n">h</span><span class="o">..</span><span class="n">LWMJ</span><span class="o">...</span><span class="n">k</span><span class="o">.......</span> <span class="p">]</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>Lines with <code class="docutils literal notranslate"><span class="pre">GSSX_ARG_</span></code> show arguments passed for this operation. Lines
with <code class="docutils literal notranslate"><span class="pre">GSSX_RES_</span></code> show the results of the operation. In the example
above the application asks to acquire credential for the Kerberos
principal <code class="docutils literal notranslate"><span class="pre">HTTP/nyx.xs.ipa.cool&#64;XS.IPA.COOL</span></code>. The sequence
<code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">1</span> <span class="pre">2</span> <span class="pre">840</span> <span class="pre">113554</span> <span class="pre">1</span> <span class="pre">2</span> <span class="pre">2</span> <span class="pre">}</span></code> is the OID of Kerberos V5:
1.2.840.113554.1.2.2.</p>
<p>Kerberos service accepts incoming connections by using the
<code class="docutils literal notranslate"><span class="pre">gss_accept_sec_context()</span></code> API call. This can be seen in the following
example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span> <span class="p">[</span><span class="mi">2017</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">21</span> <span class="mi">11</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">]:</span> <span class="n">gp_rpc_execute</span><span class="p">:</span> <span class="n">executing</span> <span class="mi">9</span> <span class="p">(</span><span class="n">GSSX_ACCEPT_SEC_CONTEXT</span><span class="p">)</span> <span class="k">for</span> <span class="n">service</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">ipa</span><span class="o">-</span><span class="n">httpd</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="n">euid</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span><span class="n">socket</span><span class="p">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span>     <span class="n">GSSX_ARG_ACCEPT_SEC_CONTEXT</span><span class="p">(</span> <span class="n">call_ctx</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">}</span> <span class="n">context_handle</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Null</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">cred_handle</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="n">BOTH</span> <span class="mi">86400</span> <span class="mi">86400</span> <span class="p">}</span> <span class="p">]</span> <span class="p">[</span> <span class="o">.</span><span class="n">h</span><span class="o">..</span><span class="n">LWMJ</span><span class="o">...</span><span class="n">k</span><span class="o">.......</span> <span class="p">]</span> <span class="mi">0</span> <span class="p">}</span> <span class="n">input_token</span><span class="p">:</span> <span class="p">[</span> <span class="o">...</span><span class="n">i</span><span class="o">....</span><span class="n">H</span><span class="o">..........</span> <span class="p">]</span> <span class="n">input_cb</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Null</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">ret_deleg_cred</span><span class="p">:</span> <span class="mi">1</span> <span class="p">)</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span>     <span class="n">GSSX_RES_ACCEPT_SEC_CONTEXT</span><span class="p">(</span> <span class="n">status</span><span class="p">:</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="mi">0</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">}</span> <span class="n">context_handle</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span> <span class="o">......</span><span class="n">H</span><span class="o">............</span> <span class="p">]</span> <span class="p">[</span>  <span class="p">]</span> <span class="mi">0</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="mi">86692</span> <span class="mi">443</span> <span class="mi">0</span> <span class="mi">1</span> <span class="p">}</span> <span class="n">output_token</span><span class="p">:</span> <span class="p">[</span> <span class="o">.......</span><span class="n">H</span><span class="o">...........</span> <span class="p">]</span> <span class="n">delegated_cred_handle</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="n">INITIATE</span> <span class="mi">86392</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">]</span> <span class="p">[</span> <span class="n">l</span><span class="o">.</span><span class="n">P</span><span class="o">..</span><span class="mf">.8</span><span class="n">H</span><span class="o">......</span><span class="n">T</span><span class="o">....</span> <span class="p">]</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">httpd</span></code> service asks to perform a <code class="docutils literal notranslate"><span class="pre">gss_accept_sec_context()</span></code>
call and requires that delegated credential are returned
(<code class="docutils literal notranslate"><span class="pre">ret_deleg_cred:</span> <span class="pre">1</span></code>). The result of running
<code class="docutils literal notranslate"><span class="pre">gss_accept_sec_context()</span></code> is an output token. Note that the delegated
credential describes the Kerberos principal of the user that performed
the access, <code class="docutils literal notranslate"><span class="pre">admin&#64;XS.IPA.COOL</span></code> in this case.</p>
<p>After the user is authenticated, its cookie is parsed and the Kerberos
credential is located. Note that the operation is performed by a
different process, actual FreeIPA framework instance running under the
<code class="docutils literal notranslate"><span class="pre">ipaapi</span></code> user identity:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span> <span class="p">[</span><span class="mi">2017</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">21</span> <span class="mi">11</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">]:</span> <span class="n">gp_rpc_execute</span><span class="p">:</span> <span class="n">executing</span> <span class="mi">6</span> <span class="p">(</span><span class="n">GSSX_ACQUIRE_CRED</span><span class="p">)</span> <span class="k">for</span> <span class="n">service</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">ipa</span><span class="o">-</span><span class="n">api</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="n">euid</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span><span class="n">socket</span><span class="p">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span>     <span class="n">GSSX_ARG_ACQUIRE_CRED</span><span class="p">(</span> <span class="n">call_ctx</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">}</span> <span class="n">input_cred_handle</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="n">INITIATE</span> <span class="mi">86392</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">]</span> <span class="p">[</span> <span class="n">l</span><span class="o">.</span><span class="n">P</span><span class="o">..</span><span class="mf">.8</span><span class="n">H</span><span class="o">......</span><span class="n">T</span><span class="o">....</span> <span class="p">]</span> <span class="mi">0</span> <span class="p">}</span> <span class="n">add_cred</span><span class="p">:</span> <span class="mi">0</span> <span class="n">desired_name</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Null</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">time_req</span><span class="p">:</span> <span class="mi">4294967295</span> <span class="n">desired_mechs</span><span class="p">:</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">}</span> <span class="n">cred_usage</span><span class="p">:</span> <span class="n">INITIATE</span> <span class="n">initiator_time_req</span><span class="p">:</span> <span class="mi">0</span> <span class="n">acceptor_time_req</span><span class="p">:</span> <span class="mi">0</span> <span class="p">)</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span>     <span class="n">GSSX_RES_ACQUIRE_CRED</span><span class="p">(</span> <span class="n">status</span><span class="p">:</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="mi">0</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">}</span> <span class="n">output_cred_handle</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="n">INITIATE</span> <span class="mi">86392</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">]</span> <span class="p">[</span> <span class="n">l</span><span class="o">.</span><span class="n">P</span><span class="o">..</span><span class="mf">.8</span><span class="n">H</span><span class="o">......</span><span class="n">T</span><span class="o">....</span> <span class="p">]</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>This process has no access to the keytab used by <code class="docutils literal notranslate"><span class="pre">httpd</span></code> but can ask
GSS-Proxy to return a ticket for a user that was authenticated. Once the
ticket is obtained, it can be used to talk to a different service, in
our case the IPA LDAP server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span> <span class="p">[</span><span class="mi">2017</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">21</span> <span class="mi">11</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">]:</span> <span class="n">gp_rpc_execute</span><span class="p">:</span> <span class="n">executing</span> <span class="mi">8</span> <span class="p">(</span><span class="n">GSSX_INIT_SEC_CONTEXT</span><span class="p">)</span> <span class="k">for</span> <span class="n">service</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">ipa</span><span class="o">-</span><span class="n">api</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;,</span> <span class="n">euid</span><span class="p">:</span> <span class="mi">384</span><span class="p">,</span><span class="n">socket</span><span class="p">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span>     <span class="n">GSSX_ARG_INIT_SEC_CONTEXT</span><span class="p">(</span> <span class="n">call_ctx</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">}</span> <span class="n">context_handle</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Null</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">cred_handle</span><span class="p">:</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="n">INITIATE</span> <span class="mi">86392</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">]</span> <span class="p">[</span> <span class="n">l</span><span class="o">.</span><span class="n">P</span><span class="o">..</span><span class="mf">.8</span><span class="n">H</span><span class="o">......</span><span class="n">T</span><span class="o">....</span> <span class="p">]</span> <span class="mi">0</span> <span class="p">}</span> <span class="n">target_name</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">ldap</span><span class="nd">@nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="n">mech_type</span><span class="p">:</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="n">req_flags</span><span class="p">:</span> <span class="mi">58</span> <span class="n">time_req</span><span class="p">:</span> <span class="mi">0</span> <span class="n">input_cb</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Null</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">input_token</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">Null</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="p">[</span> <span class="p">{</span> <span class="p">[</span> <span class="n">sync</span><span class="o">.</span><span class="n">modified</span><span class="o">.</span><span class="n">cr</span><span class="o">...</span> <span class="p">]</span> <span class="p">[</span> <span class="mi">64656661756</span><span class="n">c740</span> <span class="p">]</span> <span class="p">}</span> <span class="p">]</span> <span class="p">)</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span> <span class="p">[</span><span class="mi">2017</span><span class="o">/</span><span class="mi">04</span><span class="o">/</span><span class="mi">21</span> <span class="mi">11</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">]:</span> <span class="n">Credentials</span> <span class="n">allowed</span> <span class="n">by</span> <span class="n">configuration</span>
<span class="n">gssproxy</span><span class="p">[</span><span class="mi">7186</span><span class="p">]:</span>     <span class="n">GSSX_RES_INIT_SEC_CONTEXT</span><span class="p">(</span> <span class="n">status</span><span class="p">:</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="mi">0</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">The</span> <span class="n">routine</span> <span class="n">must</span> <span class="n">be</span> <span class="n">called</span> <span class="n">again</span> <span class="n">to</span> <span class="n">complete</span> <span class="n">its</span> <span class="n">function</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="p">[</span>  <span class="p">]</span> <span class="p">}</span> <span class="n">context_handle</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span> <span class="o">......</span><span class="n">H</span><span class="o">............</span> <span class="p">]</span> <span class="p">[</span>  <span class="p">]</span> <span class="mi">0</span> <span class="p">{</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">840</span> <span class="mi">113554</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">}</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span> <span class="mi">0</span> <span class="mi">314</span> <span class="mi">1</span> <span class="mi">0</span> <span class="p">}</span> <span class="n">output_token</span><span class="p">:</span> <span class="p">[</span> <span class="o">...</span><span class="n">A</span><span class="o">....</span><span class="n">H</span><span class="o">..........</span> <span class="p">]</span> <span class="p">[</span> <span class="p">{</span> <span class="p">[</span> <span class="mf">73796e635</span><span class="n">f63726564730</span> <span class="p">]</span> <span class="p">[</span> <span class="o">....</span><span class="n">admin</span><span class="o">.</span><span class="n">XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">...</span> <span class="p">]</span> <span class="p">}</span> <span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
<p>To receive a proper ticket a few more exchanges are required, this can
be seen by the response from GSS-Proxy telling that “The routine must be
called again to complete its function”. This is a normal flow for GSSAPI
exchanges.</p>
<section id="logging-of-kdc-operations">
<span id="id6"></span><h3>Logging of KDC operations<a class="headerlink" href="#logging-of-kdc-operations" title="Permalink to this heading">¶</a></h3>
<p>Each Kerberos request to obtain an initial (TGT) or a service ticket
will be reflected in the KDC logs. The KDC writes its log in the
<code class="docutils literal notranslate"><span class="pre">/var/log/krb5kdc.log</span></code> file. Below is an example of how the KDC log
looks like with common date and hostname information removed. In the
original log file timestamps are in local time zone format.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">krb5kdc</span><span class="p">[</span><span class="mi">15953</span><span class="p">](</span><span class="n">info</span><span class="p">):</span> <span class="n">TGS_REQ</span> <span class="p">(</span><span class="mi">8</span> <span class="n">etypes</span> <span class="p">{</span><span class="mi">18</span> <span class="mi">17</span> <span class="mi">20</span> <span class="mi">19</span> <span class="mi">16</span> <span class="mi">23</span> <span class="mi">25</span> <span class="mi">26</span><span class="p">})</span> <span class="n">IP</span><span class="o">.</span><span class="n">AD</span><span class="o">.</span><span class="n">DR</span><span class="o">.</span><span class="n">ES</span><span class="p">:</span> <span class="n">ISSUE</span><span class="p">:</span> <span class="n">authtime</span> <span class="mi">1492775177</span><span class="p">,</span> <span class="n">etypes</span> <span class="p">{</span><span class="n">rep</span><span class="o">=</span><span class="mi">18</span> <span class="n">tkt</span><span class="o">=</span><span class="mi">18</span> <span class="n">ses</span><span class="o">=</span><span class="mi">18</span><span class="p">},</span> <span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span> <span class="k">for</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span>
<span class="n">krb5kdc</span><span class="p">[</span><span class="mi">15953</span><span class="p">](</span><span class="n">info</span><span class="p">):</span> <span class="n">closing</span> <span class="n">down</span> <span class="n">fd</span> <span class="mi">11</span>
<span class="n">krb5kdc</span><span class="p">[</span><span class="mi">15954</span><span class="p">](</span><span class="n">info</span><span class="p">):</span> <span class="n">AS_REQ</span> <span class="p">(</span><span class="mi">8</span> <span class="n">etypes</span> <span class="p">{</span><span class="mi">18</span> <span class="mi">17</span> <span class="mi">16</span> <span class="mi">23</span> <span class="mi">25</span> <span class="mi">26</span> <span class="mi">20</span> <span class="mi">19</span><span class="p">})</span> <span class="n">IP</span><span class="o">.</span><span class="n">AD</span><span class="o">.</span><span class="n">DR</span><span class="o">.</span><span class="n">ES</span><span class="p">:</span> <span class="n">NEEDED_PREAUTH</span><span class="p">:</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span> <span class="k">for</span> <span class="n">krbtgt</span><span class="o">/</span><span class="n">XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="p">,</span> <span class="n">Additional</span> <span class="n">pre</span><span class="o">-</span><span class="n">authentication</span> <span class="n">required</span>
<span class="n">krb5kdc</span><span class="p">[</span><span class="mi">15954</span><span class="p">](</span><span class="n">info</span><span class="p">):</span> <span class="n">closing</span> <span class="n">down</span> <span class="n">fd</span> <span class="mi">11</span>
<span class="n">krb5kdc</span><span class="p">[</span><span class="mi">15954</span><span class="p">](</span><span class="n">info</span><span class="p">):</span> <span class="n">AS_REQ</span> <span class="p">(</span><span class="mi">8</span> <span class="n">etypes</span> <span class="p">{</span><span class="mi">18</span> <span class="mi">17</span> <span class="mi">16</span> <span class="mi">23</span> <span class="mi">25</span> <span class="mi">26</span> <span class="mi">20</span> <span class="mi">19</span><span class="p">})</span> <span class="n">IP</span><span class="o">.</span><span class="n">AD</span><span class="o">.</span><span class="n">DR</span><span class="o">.</span><span class="n">ES</span><span class="p">:</span> <span class="n">ISSUE</span><span class="p">:</span> <span class="n">authtime</span> <span class="mi">1492775180</span><span class="p">,</span> <span class="n">etypes</span> <span class="p">{</span><span class="n">rep</span><span class="o">=</span><span class="mi">18</span> <span class="n">tkt</span><span class="o">=</span><span class="mi">18</span> <span class="n">ses</span><span class="o">=</span><span class="mi">18</span><span class="p">},</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span> <span class="k">for</span> <span class="n">krbtgt</span><span class="o">/</span><span class="n">XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span>
<span class="n">krb5kdc</span><span class="p">[</span><span class="mi">15954</span><span class="p">](</span><span class="n">info</span><span class="p">):</span> <span class="n">closing</span> <span class="n">down</span> <span class="n">fd</span> <span class="mi">11</span>
<span class="n">krb5kdc</span><span class="p">[</span><span class="mi">15953</span><span class="p">](</span><span class="n">info</span><span class="p">):</span> <span class="n">TGS_REQ</span> <span class="p">(</span><span class="mi">8</span> <span class="n">etypes</span> <span class="p">{</span><span class="mi">18</span> <span class="mi">17</span> <span class="mi">20</span> <span class="mi">19</span> <span class="mi">16</span> <span class="mi">23</span> <span class="mi">25</span> <span class="mi">26</span><span class="p">})</span> <span class="n">IP</span><span class="o">.</span><span class="n">AD</span><span class="o">.</span><span class="n">DR</span><span class="o">.</span><span class="n">ES</span><span class="p">:</span> <span class="n">ISSUE</span><span class="p">:</span> <span class="n">authtime</span> <span class="mi">1492775177</span><span class="p">,</span> <span class="n">etypes</span> <span class="p">{</span><span class="n">rep</span><span class="o">=</span><span class="mi">18</span> <span class="n">tkt</span><span class="o">=</span><span class="mi">18</span> <span class="n">ses</span><span class="o">=</span><span class="mi">18</span><span class="p">},</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span> <span class="k">for</span> <span class="n">ldap</span><span class="o">/</span><span class="n">nyx</span><span class="o">.</span><span class="n">xs</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">cool</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span>
<span class="n">krb5kdc</span><span class="p">[</span><span class="mi">15953</span><span class="p">](</span><span class="n">info</span><span class="p">):</span> <span class="o">...</span> <span class="n">CONSTRAINED</span><span class="o">-</span><span class="n">DELEGATION</span> <span class="n">s4u</span><span class="o">-</span><span class="n">client</span><span class="o">=</span><span class="n">admin</span><span class="nd">@XS</span><span class="o">.</span><span class="n">IPA</span><span class="o">.</span><span class="n">COOL</span>
<span class="n">krb5kdc</span><span class="p">[</span><span class="mi">15953</span><span class="p">](</span><span class="n">info</span><span class="p">):</span> <span class="n">closing</span> <span class="n">down</span> <span class="n">fd</span> <span class="mi">11</span>
</pre></div>
</div>
<p>A log entry includes the type of operation (AS_REQ or TGS_REQ), the list
of requested encryption types, the IP address of the client and the
result of the operation. We can see that an administrator requested a
service ticket to the <code class="docutils literal notranslate"><span class="pre">HTTP/..</span></code> service to perform Kerberos
authentication as requested by <code class="docutils literal notranslate"><span class="pre">mod_auth_gssapi</span></code>. On the server side
the <code class="docutils literal notranslate"><span class="pre">HTTP/..</span></code> service needs to obtain its own initial ticket (a
request for service ticket to <code class="docutils literal notranslate"><span class="pre">krbtgt/..</span></code>). After the FreeIPA
framework got to actually process the user’s request, it needed to
obtain a service ticket to the <code class="docutils literal notranslate"><span class="pre">LDAP/..</span></code> service. The KDC recorded in
the log that this request was actually done as a S4U2Proxy operation,
performing constrained delegation for the client <code class="docutils literal notranslate"><span class="pre">admin&#64;..</span></code> which is
the original user Kerberos principal.</p>
</section>
</section>
<section id="ccache-storage">
<span id="id7"></span><h2>ccache storage<a class="headerlink" href="#ccache-storage" title="Permalink to this heading">¶</a></h2>
<p>The ccaches are stored by mod_auth_gssapi in /run/ipa/ccaches. This
directory is managed by <code class="docutils literal notranslate"><span class="pre">/usr/lib/tmpfiles.d/ipa.conf</span></code>. If the
permissions or ownership are incorrect then one may get the error: &lt;code
ipa: ERROR: cannot connect to
‘<a class="reference external" href="https://ipa.example.test/ipa/session/json">https://ipa.example.test/ipa/session/json</a>’: Exceeded number of tries to
forward a request.</p>
<p>To re-apply the tmpfiles configuration run (in this case fixing bad
permissions on /run/ipa/ccaches):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># SYSTEMD_LOG_LEVEL=7 systemd-tmpfiles --create  /usr/lib/tmpfiles.d/ipa.conf
Looking for configuration files in (higher priority first):
        /etc/tmpfiles.d
        /run/tmpfiles.d
        /usr/local/lib/tmpfiles.d
        /usr/lib/tmpfiles.d
Successfully loaded SELinux database in 1.514ms, size on heap is 329K.
Reading config file &quot;/usr/lib/tmpfiles.d/ipa.conf&quot;…
Running create action for entry d /run/ipa
Found existing directory &quot;/run/ipa&quot;.
&quot;/run/ipa&quot; has correct mode 40711 already.
Running create action for entry d /run/ipa/ccaches
Found existing directory &quot;/run/ipa/ccaches&quot;.
Changing &quot;/run/ipa/ccaches&quot; to mode 6770.
Running create action for entry a /run/ipa/ccaches
Setting access ACL u::rwx,g::rwx,g:apache:rwx,m::rwx,o::--- on /run/ipa/ccaches.
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/Troubleshooting/PrivilegeSeparation.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>