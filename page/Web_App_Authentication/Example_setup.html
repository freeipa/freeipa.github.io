
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Example_setup &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/Web_App_Authentication/Example_setup';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/Web_App_Authentication/Example_setup.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Example_setup</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-application">Example application</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enrolling-the-web-machine-to-ipa-server">Enrolling the web machine to IPA server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kerberos">Kerberos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#successful-negotiate">Successful Negotiate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#failed-negotiate">Failed Negotiate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-yum-repo">Additional yum repo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#host-and-service-based-access-control-for-kerberos">Host (and service) based access control for Kerberos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-control-with-user-groups-using-pam-access">Access control with user groups using pam_access</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#external-identities-for-login-form">External identities for login form</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-external-users-in-internal-databases">Storing external users in internal databases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-attributes">Additional attributes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#application-level-roles">Application-level roles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#passing-information-to-applications">Passing information to applications</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#web-framework-configurations">Web framework configurations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="example-setup">
<h1>Example_setup<a class="headerlink" href="#example-setup" title="Link to this heading">#</a></h1>
<p>In this text we will assume the identity provider used is IPA server and
we will look at the setup and modifications that might be needed in
typical web application to be able to use these central identities. We
will explore how Kerberos authentication can be added, how IPA
server-backed host-based access control (HBAC) can be configured for the
Kerberos authentication on per-service basis, how the user identity (and
its password) in the IPA server can be used for application’s login-form
validation while preserving application’s standard look and feel, and
how the application can obtain additional information about the
externally-authenticated user.</p>
<section id="example-application">
<h2>Example application<a class="headerlink" href="#example-application" title="Link to this heading">#</a></h2>
<p>Let us assume we have an existing web application which uses HTTP
cookie-based sessions to preserve authentication results across request.
An example can be found at
<a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/tree/?id=start">fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/tree/?id=start</a>.
It is plain CGI application written in Perl. Assuming you have the
Apache HTTP Server, perl, and the CGI module installed with command like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">httpd</span> <span class="n">perl</span><span class="o">-</span><span class="n">CGI</span> <span class="o">-</span><span class="n">y</span>
</pre></div>
</div>
<p>you can retrieve the example application for testing using curl:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">Lo</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">cgi</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/plain/app.cgi?id=start&#39;</span>
</pre></div>
</div>
<p>Make sure it is executable as CGI script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="n">a</span><span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">cgi</span>
<span class="n">yum</span> <span class="n">install</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">semanage</span> <span class="o">-</span><span class="n">y</span>
<span class="n">semanage</span> <span class="n">fcontext</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">t</span> <span class="n">httpd_sys_script_exec_t</span> <span class="s1">&#39;/var/www/app\.cgi&#39;</span>
<span class="n">restorecon</span> <span class="o">-</span><span class="n">rvv</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">cgi</span>
</pre></div>
</div>
<p>Configure it to “live” in /application location (for example,
<a class="reference external" href="http://wikiapp.example.com/application">http://wikiapp.example.com/application</a>) via ScriptAlias directive in
/etc/httpd/conf/httpd.conf or in some configuration file in
/etc/httpd/conf.d/*.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ScriptAlias</span> <span class="o">/</span><span class="n">application</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">cgi</span>
</pre></div>
</div>
<p>Then restart the Apache HTTP daemon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">httpd</span> <span class="n">restart</span>
</pre></div>
</div>
<p>The application when deployed at <strong>wikiapp.example.com/application</strong> and
accessed from browser will show a very simple page:</p>
<p>Application</p>
<p>This is a test application; public view, not much to see.</p>
<hr class="docutils" />
<p>Log in</p>
<p>You can also use command line tools to test the application:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">wikiapp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">application</span>
</pre></div>
</div>
<p>or locally</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -i http://$( hostname )/application
</pre></div>
</div>
<p>The link <strong>Log in</strong> leads to <strong>wikiapp.example.com/application/login</strong>
which will display a login-form:</p>
<p>Log in to application</p>
<p>Login: [ … … … ]</p>
<p>Password: [ * * * * * * * ]</p>
<p>&lt; Log in &gt;</p>
<hr class="docutils" />
<p>Back to application</p>
<p>Login-form submission leads back to the page
<strong>wikiapp.example.com/application/login</strong> and upon success (we just test
that the password is the login name reversed) it will set HTTP cookie
<strong>the-test-cookie</strong> to contain the name of the user (the cookie value
when <strong>bob</strong> logs in in the example bellow will be <strong>ok:bob</strong>) and then
redirect to the main page:</p>
<p>Logged in as bob</p>
<p>You will be redirected to the home page</p>
<hr class="docutils" />
<p>Back to application</p>
<p>Application authenticated (bob)</p>
<p>Test application; logged in as user bob. There is much more content for
authenticated users. There is much more content for authenticated users.
There is much more content for authenticated users. There is much more
content for authenticated users. There is much more content for
authenticated users. There is much more content for authenticated users.
There is much more content for authenticated users. There is much more
content for authenticated users. There is much more content for
authenticated users. There is much more content for authenticated users.</p>
<hr class="docutils" />
<p>Log out</p>
<p>Real applications will probably do a lookup of the user and password in
the database and create session record in the database and store that
session’s key in the cookie. Or at the least they would store the
identity of the user in the cookie together with some cryptographical
signature to prevent user to impersonate someone else. Remember: this is
just an example to show additional setups later.</p>
<p>Clicking <strong>Log out</strong> will just set the cookie value to <strong>xx</strong> meaning no
active user, and redirect back to <strong>wikiapp.example.com/application</strong>.</p>
</section>
<section id="enrolling-the-web-machine-to-ipa-server">
<h2>Enrolling the web machine to IPA server<a class="headerlink" href="#enrolling-the-web-machine-to-ipa-server" title="Link to this heading">#</a></h2>
<p>We assume that the machine on which the wikiapp is hosted is enrolled to
an IPA server. The commands</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ipa</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">install</span> <span class="o">-</span><span class="n">y</span>
<span class="n">ipa</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">install</span>
</pre></div>
</div>
<p>can be used to achieve the enrollment – <code class="docutils literal notranslate"><span class="pre">ipa-client-install</span></code> will
configure sssd and other components of the system to know about the IPA
server. It will ask questions about the name of the IPA server and other
parameters, or you can explore its <code class="docutils literal notranslate"><span class="pre">--help</span></code> option and man page.</p>
</section>
<section id="kerberos">
<h2>Kerberos<a class="headerlink" href="#kerberos" title="Link to this heading">#</a></h2>
<p>The IPA server serves as a Kerberos Key Distribution Center, among
others. Users that have access to the Kerberos server for the
<strong>example.com</strong> domain can use</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kinit</span>
</pre></div>
</div>
<p>to obtain their ticket-granting ticket which can then be used by
applications to obtain tickets to authenticate against other services.
Our goal will be to Kerberize <strong>wikiapp.example.com/application</strong>. In
typical setup, the tickets are in a realm matching the domain name,
usually written in upper case, in our case <strong>EXAMPLE.COM</strong>.</p>
<p>We will need Apache module <strong>mod_auth_gssapi</strong> or <strong>mod_auth_kerb</strong>
installed and configured. We will also need to obtain keytab from the
IPA server for our HTTP service. On the IPA server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kinit</span> <span class="n">admin</span>  <span class="c1"># or other user with permissions to create new service for wikiapp.example.com</span>
<span class="n">ipa</span> <span class="n">service</span><span class="o">-</span><span class="n">add</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">wikiapp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>On our web application machine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kinit admin   # or other user with permissions to retrieve the keytab
ipa-getkeytab -s $( awk &#39;/^server/ { print $3 }&#39; /etc/ipa/default.conf ) -k /etc/http.keytab -p HTTP/wikiapp.example.com
chown apache /etc/http.keytab
chmod 600 /etc/http.keytab
yum install mod_auth_gssapi -y
# or yum install mod_auth_kerb -y
</pre></div>
</div>
<p>We then configure <strong>mod_auth_gssapi</strong> or <strong>mod_auth_kerb</strong> to require
Negotiate authentication for <strong>wikiapp.example.com/application/login</strong>:
<a class="reference external" href="https://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/commit/?h=negotiate-mod_auth_gssapi">wikiapp_kerb.conf for
mod_auth_gssapi</a>,
retrieve with curl using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">Lo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">wikiapp_kerb</span><span class="o">.</span><span class="n">conf</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/plain/auth_kerb.conf?id=negotiate-mod_auth_gssapi&#39;</span>
</pre></div>
</div>
<p>or <a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/commit/?id=negotiate">wikiapp_kerb.conf for
mod_auth_kerb</a>,
retrieve with curl using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">Lo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">wikiapp_kerb</span><span class="o">.</span><span class="n">conf</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/plain/auth_kerb.conf?id=negotiate&#39;</span>
</pre></div>
</div>
</section>
<section id="successful-negotiate">
<h2>Successful Negotiate<a class="headerlink" href="#successful-negotiate" title="Link to this heading">#</a></h2>
<p>We can restart the Apache now</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">httpd</span> <span class="n">restart</span>
</pre></div>
</div>
<p>and try to access the login page either from browser or via command line</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -i --negotiate -u : http://$( hostname )/application/login
</pre></div>
</div>
<p>When the user has valid Kerberos ticket in the EXAMPLE.COM realm and
clicks the <strong>Log in</strong> link leading to
<strong>wikiapp.example.com/application/login</strong>, mod_auth_gssapi/mod_auth_kerb
will return with status 401 and header <code class="docutils literal notranslate"><span class="pre">WWW-Authenticate:</span> <span class="pre">Negotiate</span></code>.
The browser will try to obtain the ticket for
<strong>HTTP/wikiapp.example.com&#64;EXAMPLE.COM</strong> and resubmit the request with
appropriate <code class="docutils literal notranslate"><span class="pre">Authorization</span></code> header. In the
<strong>/var/log/httpd/access_log</strong> will see that we have authenticated
correctly</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">192.168.89.2</span> <span class="o">-</span> <span class="o">-</span> <span class="p">[</span><span class="mi">08</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2014</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">30</span> <span class="o">-</span><span class="mi">0500</span><span class="p">]</span> <span class="s2">&quot;GET /application/login HTTP/1.1&quot;</span> <span class="mi">401</span> <span class="mi">127</span> <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/5.0 (X11; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0&quot;</span>
<span class="mf">192.168.89.2</span> <span class="o">-</span> <span class="n">bob</span><span class="nd">@EXAMPLE</span><span class="o">.</span><span class="n">COM</span> <span class="p">[</span><span class="mi">08</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2014</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">32</span> <span class="o">-</span><span class="mi">0500</span><span class="p">]</span> <span class="s2">&quot;GET /application/login HTTP/1.1&quot;</span> <span class="mi">200</span> <span class="mi">1980</span> <span class="s2">&quot;-&quot;</span> <span class="s2">&quot;Mozilla/5.0 (X11; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0&quot;</span>
</pre></div>
</div>
<p>However, the application will still show the same login form, rather
than understanding that the user has already authenticated using
Kerberos. To achieve that, we need to change the application to
understand the <strong>REMOTE_USER</strong> environment variable which is set by
Apache authentication modules when their authentication attempt passes:
<a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/commit/?id=trust-REMOTE_USER">trust
REMOTE_USER</a>,
apply with curl using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/patch/app.cgi?id=trust-REMOTE_USER&#39;</span> <span class="o">|</span> <span class="n">patch</span> <span class="o">-</span><span class="n">p1</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">cgi</span>
</pre></div>
</div>
<p>With the above changes in place, application will consult the
<strong>REMOTE_USER</strong> environment variable and it will skip any attempt of
internal validation of login and password and just consider the user
logged-in:</p>
<p>Logged in as <a class="reference external" href="mailto:bob&#37;&#52;&#48;EXAMPLE&#46;COM">bob<span>&#64;</span>EXAMPLE<span>&#46;</span>COM</a></p>
<p>You will be redirected to the home page</p>
<hr class="docutils" />
<p>Back to application</p>
<p>Application authenticated (<a class="reference external" href="mailto:bob&#37;&#52;&#48;EXAMPLE&#46;COM">bob<span>&#64;</span>EXAMPLE<span>&#46;</span>COM</a>)</p>
<p>Test application; logged in as user <a class="reference external" href="mailto:bob&#37;&#52;&#48;EXAMPLE&#46;COM">bob<span>&#64;</span>EXAMPLE<span>&#46;</span>COM</a>. There is much more
content for authenticated users. There is much more content for
authenticated users. […]</p>
<hr class="docutils" />
<p>Log out</p>
<p>No login form will be shown.</p>
</section>
<section id="failed-negotiate">
<h2>Failed Negotiate<a class="headerlink" href="#failed-negotiate" title="Link to this heading">#</a></h2>
<p>Note the ErrorDocument client-side redirect to <strong>/application/login2</strong>
– it is there as a fallback to the login form in case the user has no
valid ticket:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kdestroy -A
curl -i --negotiate -u : http://$( hostname )/application/login
</pre></div>
</div>
<p>or click using browser.</p>
<p>With the application now, the <strong>wikiapp.example.com/application/login2</strong>
will display</p>
<p>Application</p>
<p>This is a test application; public view, not much to see.</p>
<hr class="docutils" />
<p>Log in</p>
<p>This is not right. Clearly, the application does not know that the
<strong>login2</strong> location is also supposed to display a login page.</p>
<p>For the fallback to work, we need to make sure
<strong>wikiapp.example.com/application/login2</strong> is location for the same
logon-form logic as <strong>wikiapp.example.com/application/login</strong>. In our
case, we just modify the application to consider any path starting with
<strong>login</strong> as login application: <a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/commit/?id=login2">support
login2</a>,
apply with curl using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/patch/app.cgi?id=login2&#39;</span> <span class="o">|</span> <span class="n">patch</span> <span class="o">-</span><span class="n">p1</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">cgi</span>
</pre></div>
</div>
<p>In real applications, this part can either go to the application code,
application/framework mapping, or to the Apache configuration.</p>
<p>With the change applied, if the browser cannot obtain the ticket, it
will just show the content of the document with we’ve configured with
the ErrorDocument directive to be a redirect to <strong>/application/login2</strong>.
After a short message</p>
<p>Kerberos authentication did not pass.</p>
<p>the login form will be displayed from
<strong>wikiapp.example.com/application/login2</strong> and the user can log in as
usual, with their login and password.</p>
</section>
<section id="additional-yum-repo">
<h2>Additional yum repo<a class="headerlink" href="#additional-yum-repo" title="Link to this heading">#</a></h2>
<p>The following sections of this document describe software which is
already part of Fedora and RHEL/CentOS 6. The upstream repositories with
packages for popular OSes (namely RHEL 7) are at
<a class="reference external" href="http://copr.fedoraproject.org/coprs/adelton/identity_demo/">http://copr.fedoraproject.org/coprs/adelton/identity_demo/</a> – click on
the <strong>adelton-identity_demo*.repo</strong> link in the line matching your OS
and version and store the .repo file in <strong>/etc/yum.repos.d</strong>.</p>
<p>You can also retrieve the .repo file via curl: for example, for RHEL 7:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">Lo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">identity_demo</span><span class="o">.</span><span class="n">repo</span> <span class="s1">&#39;http://copr.fedoraproject.org/coprs/adelton/identity_demo/repo/epel-7/adelton-identity_demo-epel-7.repo&#39;</span>
</pre></div>
</div>
</section>
<section id="host-and-service-based-access-control-for-kerberos">
<h2>Host (and service) based access control for Kerberos<a class="headerlink" href="#host-and-service-based-access-control-for-kerberos" title="Link to this heading">#</a></h2>
<p>The module
<a class="reference external" href="http://www.adelton.com/apache/mod_authnz_pam/">mod_authnz_pam</a> can
be used to run PAM access check for a particular service. Together with
sssd and IPA server, this allows fine-granular control over access to
various services.</p>
<p>We have the host wikiapp.example.com IPA-enrolled but in the default
setup, the IPA server has just one generic <strong>allow_all</strong> HBAC rule. You
need to <a class="reference external" href="http://www.freeipa.org/page/Howto/HBAC_and_allow_all">disable that rule and replace it with more granular
configuration, creating for example PAM service wikiapp for our
application</a>.
You should see</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span> <span class="n">hbactest</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">bob</span> <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">wikiapp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">service</span><span class="o">=</span><span class="n">wikiapp</span>
</pre></div>
</div>
<p>not matching any rule and after adding the host to the <strong>allow_wikiapp</strong>
HBAC rule, see it match:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span> <span class="n">hbacrule</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">host</span> <span class="n">allow_wikiapp</span> <span class="o">--</span><span class="n">hosts</span><span class="o">=</span><span class="n">wikiapp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">ipa</span> <span class="n">hbacrule</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">user</span> <span class="n">allow</span><span class="o">-</span><span class="n">wikiapp</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">bob</span>
<span class="n">ipa</span> <span class="n">hbactest</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">bob</span> <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">wikiapp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">service</span><span class="o">=</span><span class="n">wikiapp</span>
</pre></div>
</div>
<p>Configure PAM service wikiapp. Create <strong>/etc/pam.d/wikiapp</strong> with the
following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">auth</span>    <span class="n">required</span>   <span class="n">pam_sss</span><span class="o">.</span><span class="n">so</span>
<span class="n">account</span> <span class="n">required</span>   <span class="n">pam_sss</span><span class="o">.</span><span class="n">so</span>
</pre></div>
</div>
<p>Note that the <strong>wikiapp</strong> HBAC service name needs to match the PAM
service name but it’s just a string, it does not need to match the
hostname. We could have used <strong>wiki</strong> or <strong>test</strong> instead.</p>
<p>Install the mod_authnz_pam</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">mod_authnz_pam</span> <span class="o">-</span><span class="n">y</span>
</pre></div>
</div>
<p>Our current wikiapp_kerb.conf needs to be amended to load mod_authnz_pam
and <code class="docutils literal notranslate"><span class="pre">require</span> <span class="pre">pam-account</span> <span class="pre">wikiapp</span></code>: for mod_auth_gssapi
<a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/commit/?id=mod_authnz_pam-pam-account-mod_auth_gssapi">mod_authnz_pam-pam-account-mod_auth_gssapi</a>,
apply with curl using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/patch/auth_kerb.conf?id=mod_authnz_pam-pam-account-mod_auth_gssapi&#39;</span> <span class="o">|</span> <span class="n">patch</span> <span class="o">-</span><span class="n">p1</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">wikiapp_kerb</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>and for mod_auth_kerb
<a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/commit/?id=mod_authnz_pam-pam-account">mod_authnz_pam-pam-account</a>,
apply with curl using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/patch/auth_kerb.conf?id=mod_authnz_pam-pam-account&#39;</span> <span class="o">|</span> <span class="n">patch</span> <span class="o">-</span><span class="n">p1</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">wikiapp_kerb</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Enable Apache to use the PAM stack and restart it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setsebool</span> <span class="o">-</span><span class="n">P</span> <span class="n">allow_httpd_mod_auth_pam</span> <span class="mi">1</span>
<span class="n">service</span> <span class="n">httpd</span> <span class="n">restart</span>
</pre></div>
</div>
<p>After restarting Apache, we can check that the access works and if we
remove either the machine or the user from the HBAC rule</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span> <span class="n">hbacrule</span><span class="o">-</span><span class="n">remove</span><span class="o">-</span><span class="n">host</span> <span class="n">allow_wikiapp</span> <span class="o">--</span><span class="n">hosts</span><span class="o">=</span><span class="n">wikiapp</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">ipa</span> <span class="n">hbacrule</span><span class="o">-</span><span class="n">remove</span><span class="o">-</span><span class="n">user</span> <span class="n">allow_wikiapp</span> <span class="o">--</span><span class="n">users</span><span class="o">=</span><span class="n">bob</span>
</pre></div>
</div>
<p>or perhaps indirectly from host/user-group, the Kerberos authentication
will still fail and logon form will be shown.</p>
</section>
<section id="access-control-with-user-groups-using-pam-access">
<h2>Access control with user groups using pam_access<a class="headerlink" href="#access-control-with-user-groups-using-pam-access" title="Link to this heading">#</a></h2>
<p>The host-based access control (HBAC) in IPA can control access of users
to services running on various hosts. The HBAC rules can use user groups
in IPA. Sometimes, the admin might not want to manage the access
centrally and might prefer to locally set the list of groups that can
access the web application. Eventually, sssd will provide way to set up
access control on per-PAM service basis. For now, with mod_authnz_pam,
we have all the PAM modules at our disposal, including pam_access. For
example, adding line</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">account</span> <span class="n">required</span>   <span class="n">pam_access</span><span class="o">.</span><span class="n">so</span> <span class="n">accessfile</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">http</span><span class="o">-</span><span class="n">access</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>to <strong>/etc/pam.d/wikiapp</strong> will enable the access control using file
<strong>/etc/http-access.conf</strong>. If the content of that file is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+</span> <span class="p">:</span> <span class="p">(</span><span class="n">wiki</span><span class="o">-</span><span class="n">group</span><span class="o">-</span><span class="n">test</span><span class="p">)</span> <span class="p">:</span> <span class="n">ALL</span>
<span class="o">-</span> <span class="p">:</span> <span class="n">ALL</span> <span class="p">:</span> <span class="n">ALL</span>
</pre></div>
</div>
<p>only users in the wiki-group-test group will be granted access. Both
local groups from <strong>/etc/group</strong> and the IPA-managed groups are
considered for this access control check.</p>
</section>
<section id="external-identities-for-login-form">
<h2>External identities for login form<a class="headerlink" href="#external-identities-for-login-form" title="Link to this heading">#</a></h2>
<p>With module
<a class="reference external" href="http://www.adelton.com/apache/mod_intercept_form_submit/">mod_intercept_form_submit</a>,
the same PAM service <strong>wikiapp</strong> that we used to run access check for
the Kerberos authentication can be used to silently try authentication
against the IPA server (via PAM and sssd) whenever the user submits the
login form. The module needs to be installed</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">mod_intercept_form_submit</span> <span class="o">-</span><span class="n">y</span>
</pre></div>
</div>
<p>and configured:
<a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/commit/?id=intercept-form-submit">intercept-form-submit</a>,
apply with curl using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">Lo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">wikiapp_form_submit</span><span class="o">.</span><span class="n">conf</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/plain/intercept_form_submit.conf?id=intercept-form-submit&#39;</span>
<span class="n">service</span> <span class="n">httpd</span> <span class="n">restart</span>
</pre></div>
</div>
<p>With <strong>/etc/pam.d/wikiapp</strong> in place and <strong>mod_intercept_form_submit</strong>,
the application will see <strong>REMOTE_USER</strong> populated whenever the
authentication via the PAM stack succeeds.</p>
<p>If it fails, the application will still have a chance to run local
authentication.</p>
<p>Test with <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">hbacrule-remove-user</span></code> and <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">hbacrule-add-user</span></code>
that the authentication using the <strong>mod_intercept_form_submit</strong>,
observes the access control just like <strong>mod_authnz_pam</strong> does for
Kerberos. In fact, <strong>mod_intercept_form_submit</strong> is calling
<strong>mod_authnz_pam</strong> internally.</p>
<p>Note that we configure the module on <strong>/application/login2</strong> because
with Kerberos on <strong>/application/login</strong>, that is where the for
submission will run. If we omitted the Kerberos configuration, we would
want <strong>mod_intercept_form_submit</strong> configured on <strong>/application/login</strong>.</p>
</section>
<section id="storing-external-users-in-internal-databases">
<h2>Storing external users in internal databases<a class="headerlink" href="#storing-external-users-in-internal-databases" title="Link to this heading">#</a></h2>
<p>Our example CGI script does not use any database and it simulates the
users by accepting any reasonable login name and matching password. For
externally authenticated users, it accepts whatever value is set in
REMOTE_USER.</p>
<p>Real application would have users stored in the database and even for
externally authenticated users, it will probably want to store these
external users in its database, albeit with some “external” flag, for
referential integrity to work. So in reality, the change of application
code to process REMOTE_USER would probably create the user in the
database first and then create session for this new user.</p>
</section>
<section id="additional-attributes">
<h2>Additional attributes<a class="headerlink" href="#additional-attributes" title="Link to this heading">#</a></h2>
<p>Applications expect not just the login name of a user to be present –
they might need their email address to send them notifications, they
might want to know their full name just to make the user interface less
cryptic. When the user is created and stored by the application, the
application has full control over what fields (attributes) it will
require to be present – without it the user record will not be allowed.</p>
<p>However, when the user authentication happens against external identity
provider, asking user for their email address and name that they already
have correctly filled in the central server might not be ideal. It would
not only slow user’s work down, it could also lead to inconsistencies,
and in some enterprises, only dedicated departments can modify the
personnel information in the central identity store.</p>
<p>With module
<a class="reference external" href="http://www.adelton.com/apache/mod_lookup_identity/">mod_lookup_identity</a>
and sssd-dbus package, sssd can retrieve additional attributes from the
IPA server and make them available to the to the module and thus to the
application during authentication using Apache module.</p>
<p>We start with configuring sssd: install sssd-dbus</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">sssd</span><span class="o">-</span><span class="n">dbus</span> <span class="o">-</span><span class="n">y</span>
</pre></div>
</div>
<p>and enable and configure its <strong>ifp</strong> subsystem:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sssd</span><span class="o">/</span><span class="n">sssd</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">orig</span>    <span class="mi">2013</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">10</span> <span class="mi">03</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mf">20.751552952</span> <span class="o">-</span><span class="mi">0500</span>
<span class="o">+++</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sssd</span><span class="o">/</span><span class="n">sssd</span><span class="o">.</span><span class="n">conf</span>    <span class="mi">2013</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">12</span> <span class="mi">00</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mf">30.791240631</span> <span class="o">-</span><span class="mi">0500</span>
<span class="o">@@</span> <span class="o">-</span><span class="mi">11</span><span class="p">,</span><span class="mi">8</span> <span class="o">+</span><span class="mi">11</span><span class="p">,</span><span class="mi">10</span> <span class="o">@@</span>
 <span class="n">chpass_provider</span> <span class="o">=</span> <span class="n">ipa</span>
 <span class="n">ipa_server</span> <span class="o">=</span> <span class="n">_srv_</span><span class="p">,</span> <span class="n">ipa</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
 <span class="n">dns_discovery_domain</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="o">+</span><span class="n">ldap_user_extra_attrs</span> <span class="o">=</span> <span class="n">mail</span><span class="p">,</span> <span class="n">givenname</span><span class="p">,</span> <span class="n">sn</span>
<span class="o">+</span>
 <span class="p">[</span><span class="n">sssd</span><span class="p">]</span>
<span class="o">-</span><span class="n">services</span> <span class="o">=</span> <span class="n">nss</span><span class="p">,</span> <span class="n">pam</span><span class="p">,</span> <span class="n">ssh</span>
<span class="o">+</span><span class="n">services</span> <span class="o">=</span> <span class="n">nss</span><span class="p">,</span> <span class="n">pam</span><span class="p">,</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">ifp</span>

 <span class="n">domains</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="o">@@</span> <span class="o">-</span><span class="mi">28</span><span class="p">,</span><span class="mi">3</span> <span class="o">+</span><span class="mi">30</span><span class="p">,</span><span class="mi">7</span> <span class="o">@@</span>

 <span class="p">[</span><span class="n">pac</span><span class="p">]</span>

<span class="o">+</span><span class="p">[</span><span class="n">ifp</span><span class="p">]</span>
<span class="o">+</span><span class="n">allowed_uids</span> <span class="o">=</span> <span class="n">apache</span><span class="p">,</span> <span class="n">root</span>
<span class="o">+</span><span class="n">user_attributes</span> <span class="o">=</span> <span class="o">+</span><span class="n">mail</span><span class="p">,</span> <span class="o">+</span><span class="n">givenname</span><span class="p">,</span> <span class="o">+</span><span class="n">sn</span>
<span class="o">+</span>
</pre></div>
</div>
<p>Restart sssd and attempt to retrieve some information using
<strong>dbus-send</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">sssd</span> <span class="n">restart</span>
<span class="n">dbus</span><span class="o">-</span><span class="n">send</span> <span class="o">--</span><span class="nb">print</span><span class="o">-</span><span class="n">reply</span> <span class="o">--</span><span class="n">system</span> <span class="o">--</span><span class="n">dest</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">sssd</span><span class="o">.</span><span class="n">infopipe</span> <span class="o">/</span><span class="n">org</span><span class="o">/</span><span class="n">freedesktop</span><span class="o">/</span><span class="n">sssd</span><span class="o">/</span><span class="n">infopipe</span> <span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">sssd</span><span class="o">.</span><span class="n">infopipe</span><span class="o">.</span><span class="n">GetUserAttr</span> <span class="n">string</span><span class="p">:</span><span class="n">bob</span> <span class="n">array</span><span class="p">:</span><span class="n">string</span><span class="p">:</span><span class="n">gecos</span><span class="p">,</span><span class="n">mail</span>
<span class="n">dbus</span><span class="o">-</span><span class="n">send</span> <span class="o">--</span><span class="nb">print</span><span class="o">-</span><span class="n">reply</span> <span class="o">--</span><span class="n">system</span> <span class="o">--</span><span class="n">dest</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">sssd</span><span class="o">.</span><span class="n">infopipe</span> <span class="o">/</span><span class="n">org</span><span class="o">/</span><span class="n">freedesktop</span><span class="o">/</span><span class="n">sssd</span><span class="o">/</span><span class="n">infopipe</span> <span class="n">org</span><span class="o">.</span><span class="n">freedesktop</span><span class="o">.</span><span class="n">sssd</span><span class="o">.</span><span class="n">infopipe</span><span class="o">.</span><span class="n">GetUserGroups</span> <span class="n">string</span><span class="p">:</span><span class="n">bob</span>
</pre></div>
</div>
<p>You may need to set <code class="docutils literal notranslate"><span class="pre">setenforce</span> <span class="pre">0</span></code> for the above part to work. For
dbus calls from httpd which we will do below,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setenforce</span> <span class="mi">1</span>
<span class="n">setsebool</span> <span class="o">-</span><span class="n">P</span> <span class="n">httpd_dbus_sssd</span> <span class="n">on</span>
</pre></div>
</div>
<p>should work provided you have recent enough selinux-policy.</p>
<p>If we are able to retrieve information using dbus, we can proceed to
install and configure mod_lookup_identity:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">mod_lookup_identity</span> <span class="o">-</span><span class="n">y</span>
</pre></div>
</div>
<p>and configure it: <a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/tree/lookup_identity.conf?id=additional-attributes">additional-attributes,
lookup_identity.conf</a>,
use curl to retrieve:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">Lo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">wikiapp_lookup</span><span class="o">.</span><span class="n">conf</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/plain/lookup_identity.conf?id=additional-attributes&#39;</span>
</pre></div>
</div>
<p>When you then restart Apache</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">httpd</span> <span class="n">restart</span>
</pre></div>
</div>
<p>and connect in authenticated manner to it, you will see variables
populated by the module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kinit bob
curl -i --negotiate -u : http://$( hostname )/application/login | grep REMOTE_USER
</pre></div>
</div>
<p>The grep should list something like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">REMOTE_USER</span><span class="o">=</span><span class="n">bob</span><span class="nd">@EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">REMOTE_USER_EMAIL</span><span class="o">=</span><span class="n">bob</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span>
<span class="n">REMOTE_USER_FIRSTNAME</span><span class="o">=</span><span class="n">Robert</span>
<span class="n">REMOTE_USER_GECOS</span><span class="o">=</span><span class="n">Robert</span> <span class="n">Puk</span>
<span class="n">REMOTE_USER_LASTNAME</span><span class="o">=</span><span class="n">Puk</span>
</pre></div>
</div>
<p>– the web page actually contains (commented out in HTML) list of all
environment variables that were passed to our application.</p>
<p>The last needed step is to teach the application to use the additional
attributes: <a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/diff/app.cgi?id=additional-attributes">additional-attributes, application
change</a>,
apply with curl using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="s1">&#39;http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/patch/app.cgi?id=additional-attributes&#39;</span> <span class="o">|</span> <span class="n">patch</span> <span class="o">-</span><span class="n">p1</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">cgi</span>
</pre></div>
</div>
<p>In our simple application, we just store the values in the cookie to
show later.</p>
<p>Application authenticated (Robert Puk (bob: <a class="reference external" href="mailto:bob&#37;&#52;&#48;example&#46;com">bob<span>&#64;</span>example<span>&#46;</span>com</a>))</p>
<p>Test application; logged in as user Robert Puk (<a class="reference external" href="mailto:bob&#37;&#52;&#48;example&#46;com">bob<span>&#64;</span>example<span>&#46;</span>com</a>). There
is much more content for authenticated users. There is much more content
for authenticated users. There is much more content for authenticated
users. There is much more content for authenticated users. There is much
more content for authenticated users. There is much more content for
authenticated users. There is much more content for authenticated users.
There is much more content for authenticated users. There is much more
content for authenticated users. There is much more content for
authenticated users.</p>
<hr class="docutils" />
<p>Log out</p>
<p>Please note that the additional attributes are retrieved by Apache
modules and it does not matter if the user has authenticated using
Kerberos (mod_auth_gssapi or mod_auth_kerb) or via
mod_intercept_form_submit – the mod_lookup_identity module takes the
authentication result and uses it to get the values.</p>
<p>Real applications can use these attributes from central identity
provider to have the same set of information as their internal users,
typically storing the attributes in their internal user databases when
populating the record for the externally authenticated users. Typical
list of attributes that the applications might be interested in is
proposed at
<a class="reference external" href="http://www.freeipa.org/page/Environment_Variables#Proposed_Additional_Variables">http://www.freeipa.org/page/Environment_Variables#Proposed_Additional_Variables</a>.</p>
</section>
<section id="application-level-roles">
<h2>Application-level roles<a class="headerlink" href="#application-level-roles" title="Link to this heading">#</a></h2>
<p>Web applications make it very easy to handle and add new users but most
applications will sooner or later need to start distinguishing different
roles for different users. As with user identities themselves,
applications will typically store them in a database, and as with
external authentication, even application-level roles may need to be
partially managed.</p>
<p>In IPA server, the easiest way to assign quality to a user is via
groups. The mod_lookup_identity module makes it easy to retrieve group
membership into REMOTE_USER_GROUPS or similar environment variable. The
group membership can then be expanded into roles that the applications
uses. Admin of the application will need to set the initial mapping of
groups to roles but after then, upon each login, roles can be updated
from the central identity provider.</p>
<p>That means, that if a company hires new sysadmin and they set their
group membership in sysadmin’s group correctly in the central IPA
server, system management tools across the company can retrieve this
group memebership on the fly and make the new employee no only able to
log in to the system management tools but also assign correct roles and
permissions to them.</p>
</section>
<section id="passing-information-to-applications">
<h2>Passing information to applications<a class="headerlink" href="#passing-information-to-applications" title="Link to this heading">#</a></h2>
<p>In this example application, we have used CGI script and environment
variables that are populated by Apache modules and then inherited by the
CGI script when it is forked and run.</p>
<p>In real deployments, CGI scripts are rarely used these days, primarily
for performance reasons. Typically, the applications are either loaded
in the context of the Apache server, or they run in daemon fashion in
parallel to Apache and control is handed over to them over sockets or
via other means.</p>
<p>Many of these frameworks will pass environment variables behind the
scenes and applications can consult them just like they would in the CGI
scenario.</p>
<p>In some cases, only the REMOTE_USER information (or the internal value
<code class="docutils literal notranslate"><span class="pre">r-&gt;user</span></code> of the Apache request) is passed by the framework and
additional attributes need to be handled separately. For example, when
mod_proxy_ajp is used to hand over the request from Apache to tomcat,
only REMOTE_USER and then environment variables that start with AJP_
are passed. So the environment variables populated by
mod_lookup_identity need to be prefixed with AJP_. In Apache
configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LookupUserAttr</span> <span class="n">mail</span> <span class="n">AJP_REMOTE_USER_EMAIL</span> <span class="s2">&quot; &quot;</span>
</pre></div>
</div>
<p>In application code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">email</span> <span class="o">=</span> <span class="n">String</span><span class="p">(((</span><span class="n">String</span><span class="p">)</span> <span class="n">request</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;REMOTE_USER_EMAIL&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">getBytes</span><span class="p">(</span><span class="s2">&quot;ISO8859-1&quot;</span><span class="p">),</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>In case of deployments that use mod_proxy_balancer where no out-of-band
information passing is available, headers of the HTTP request can be
used. Of course, caution is needed to properly clear any headers of the
same name in the incoming HTTP request to prevent the end user from
breaching the authentication/access control:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RequestHeader</span> <span class="n">unset</span> <span class="n">X</span><span class="o">-</span><span class="n">THE</span><span class="o">-</span><span class="n">USER</span>
<span class="n">RequestHeader</span> <span class="nb">set</span> <span class="n">X</span><span class="o">-</span><span class="n">THE</span><span class="o">-</span><span class="n">USER</span> <span class="o">%</span><span class="p">{</span><span class="n">REMOTE_USER</span><span class="p">}</span><span class="n">e</span> <span class="n">env</span><span class="o">=</span><span class="n">REMOTE_USER</span>
<span class="n">RequestHeader</span> <span class="n">unset</span> <span class="n">X</span><span class="o">-</span><span class="n">THE</span><span class="o">-</span><span class="n">USER</span><span class="o">-</span><span class="n">EMAIL</span>
<span class="n">RequestHeader</span> <span class="nb">set</span> <span class="n">X</span><span class="o">-</span><span class="n">THE</span><span class="o">-</span><span class="n">USER</span><span class="o">-</span><span class="n">EMAIL</span> <span class="o">%</span><span class="p">{</span><span class="n">REMOTE_USER_EMAIL</span><span class="p">}</span><span class="n">e</span> <span class="n">env</span><span class="o">=</span><span class="n">REMOTE_USER_EMAIL</span>
</pre></div>
</div>
<p>On the application end, in case of CGI script, the incoming HTTP request
headers are presented as environment variables prefixed with HTTP_, with
dashes turned into underscores, so the application code would need to be
along the lines of</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if (defined $ENV{HTTP_X_THE_USER}) {
        $login = $ENV{HTTP_X_THE_USER};
[...]
</pre></div>
</div>
<p>See
<a class="reference external" href="http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/commit/?id=proxy-setup">http://fedorapeople.org/cgit/adelton/public_git/CGI-sessions.git/commit/?id=proxy-setup</a>
for a frontend proxy configuration and application patch to read the
HTTP headers.</p>
<p>Of course, the application or its framework might also have other means
to get values of the HTTP headers of the request more directly.</p>
</section>
<section id="web-framework-configurations">
<h2>Web framework configurations<a class="headerlink" href="#web-framework-configurations" title="Link to this heading">#</a></h2>
<p>For tomcat, the Connectors need to be set with
<code class="docutils literal notranslate"><span class="pre">tomcatAuthentication=&quot;false&quot;</span></code> to accept the REMOTE_USER information
from Apache:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">Connector</span> <span class="n">port</span><span class="o">=</span><span class="s2">&quot;8009&quot;</span> <span class="n">protocol</span><span class="o">=</span><span class="s2">&quot;AJP/1.3&quot;</span> <span class="n">redirectPort</span><span class="o">=</span><span class="s2">&quot;8443&quot;</span> <span class="n">URIEncoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span> <span class="n">address</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span> <span class="n">tomcatAuthentication</span><span class="o">=</span><span class="s2">&quot;false&quot;</span> <span class="o">/&gt;</span>
</pre></div>
</div>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>On a simple example CGI application, we have shown how relatively small
changes to the application code can make use of the REMOTE_USER
environment variable and additional variables with extended attributes,
making it possible to use central identity provider like IPA server for
Kerberos and login/password authentication. We have also shown the
configuration of mod_auth_gssapi/mod_auth_kerb and of new modules,
mod_authnz_pam, mod_intercept_form_submit, and mod_lookup_identity can
can together form flexible solution to meet the needs of web
applications deployed in environments with central user management.</p>
<p>In the section below, links to changes that went to real-life projects
to make some of these changes possible are shown.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-application">Example application</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#enrolling-the-web-machine-to-ipa-server">Enrolling the web machine to IPA server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kerberos">Kerberos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#successful-negotiate">Successful Negotiate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#failed-negotiate">Failed Negotiate</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-yum-repo">Additional yum repo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#host-and-service-based-access-control-for-kerberos">Host (and service) based access control for Kerberos</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-control-with-user-groups-using-pam-access">Access control with user groups using pam_access</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#external-identities-for-login-form">External identities for login form</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-external-users-in-internal-databases">Storing external users in internal databases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-attributes">Additional attributes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#application-level-roles">Application-level roles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#passing-information-to-applications">Passing information to applications</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#web-framework-configurations">Web framework configurations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>