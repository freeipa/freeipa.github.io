
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Active_Directory_trust_setup &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/Active_Directory_trust_setup';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/page/Active_Directory_trust_setup.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Active_Directory_trust_setup</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Active_Directory_trust_setup</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#description">Description</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipv6-stack-usage">IPv6 stack usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trusts-and-windows-server-2003-r2">Trusts and Windows Server 2003 R2</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#assumptions">Assumptions</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#install-and-configure-ipa-server">Install and configure IPA server</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-sure-all-packages-are-up-to-date">Make sure all packages are up to date</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-required-packages">Install required packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-host-name">Configure host name</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-ipa-server">Install IPA server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#login-as-admin">Login as admin</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-sure-ipa-users-are-available-to-the-system-services">Make sure IPA users are available to the system services</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-ipa-server-for-cross-forest-trusts">Configure IPA server for cross-forest trusts</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-forest-trust-checklist">Cross-forest trust checklist</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#date-time-settings">Date/time settings</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#firewall-configuration">Firewall configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#on-ad-dc">On AD DC</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#on-ipa-server">On IPA server</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#firewalld">Firewalld</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iptables">iptables</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dns-configuration">DNS configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-dns-forwarders">Conditional DNS forwarders</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#if-ad-is-subdomain-of-ipa">If AD is subdomain of IPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#if-ipa-is-subdomain-of-ad">If IPA is subdomain of AD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-dns-configuration">Verify DNS configuration</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#establish-and-verify-cross-forest-trust">Establish and verify cross-forest trust</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-trust-with-ad-domain">Add trust with AD domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-ad-administrator-credentials-are-available">When AD administrator credentials are available</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-ad-administrator-credentials-aren-t-available">When AD administrator credentials aren’t available</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edit-etc-krb5-conf">Edit /etc/krb5.conf</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#allow-access-for-users-from-ad-domain-to-protected-resources">Allow access for users from AD domain to protected resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-external-and-posix-groups-for-trusted-domain-users">Create external and POSIX groups for trusted domain users</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-trusted-domain-users-to-the-external-group">Add trusted domain users to the external group</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-external-group-to-posix-group">Add external group to POSIX group</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#test-cross-forest-trust">Test cross-forest trust</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-ssh">Using SSH</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-samba-shares">Using Samba shares</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-kerberized-web-applications">Using Kerberized web applications</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-trust">Debugging trust</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#general-debugging-guidelines">General debugging guidelines</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#failures-due-to-exhausted-dna-range-on-replica">Failures due to exhausted DNA range on replica</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="active-directory-trust-setup">
<h1>Active_Directory_trust_setup<a class="headerlink" href="#active-directory-trust-setup" title="Link to this heading">#</a></h1>
</section>
<section id="description">
<h1>Description<a class="headerlink" href="#description" title="Link to this heading">#</a></h1>
<p>This page explains how to setup and configure cross-forest trust between
an IPA domain and an AD (Active Directory) domain.</p>
</section>
<section id="prerequisites">
<h1>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>FreeIPA 3.3.3 or later is recommended</p></li>
<li><p>Windows Server 2008 R2 or later with configured AD DC and DNS
installed locally on the DC</p></li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
<div class="line">If you need to install and configure AD DC for testing purposes, you
can follow article <a class="reference external" href="Setting_up_Active_Directory_domain_for_testing_purposes">Setting up Active Directory domain for testing
purposes</a>.</div>
</div>
<section id="ipv6-stack-usage">
<h2>IPv6 stack usage<a class="headerlink" href="#ipv6-stack-usage" title="Link to this heading">#</a></h2>
<p>Recommended way for contemporary networking applications is to only open
IPv6 sockets for listening because IPv4 and IPv6 share the same port
range locally. FreeIPA uses Samba as part of its Active Directory
integration and Samba <strong>requires enabled IPv6 stack</strong> on the machine.</p>
<p>Adding <code class="docutils literal notranslate"><span class="pre">ipv6.disable=1</span></code> to the kernel command line disables the
whole IPv6 stack</p>
<p>Adding <code class="docutils literal notranslate"><span class="pre">ipv6.disable_ipv6=1</span></code> will keep the IPv6 stack functional
but will not assign IPv6 addresses to any of your network devices. This
is recommended approach for cases when you don’t use IPv6 networking.</p>
<p>Creating and adding to for example /etc/sysctl.d/ipv6.conf will avoid
assigning IPv6 addresses to a specific network interface</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Disable IPv6
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.``\ ``.disable_ipv6 = 1
</pre></div>
</div>
<p>where <em>interface0</em> is your specialized interface.</p>
<p><strong>Note that all we are requiring is that IPv6 stack is enabled at the
kernel level</strong> and this is recommended way to develop networking
applications for a long time already.</p>
</section>
<section id="trusts-and-windows-server-2003-r2">
<h2>Trusts and Windows Server 2003 R2<a class="headerlink" href="#trusts-and-windows-server-2003-r2" title="Link to this heading">#</a></h2>
<p>As noted above, the requirement for trusts is Windows Server 2008 R2.
While cross-forest trusts were added to forest functional level Windows
Server 2003, there are additional requirements imposed by use of AES
encryption types which require domain functional level Windows Server
2008. It is possible to establish a trust between a FreeIPA server and
Windows Server 2003 R2, with limited functionality with only RC4 and DES
encryption types. Next paragraph describes the actions needed in order
to do this. Please note, however, that this is unsupported, highly
experimental and of very limited value because of the weak encryption
types for trusted domain objects which can be reasonably easy cracked
with current advances in technology.</p>
<p>In order to establish a trust between a FreeIPA server and a Windows
Server 2003 R2, you need to raise the forest functional level to Windows
Server 2003. To do this, open ‘Active Directory Domains and Trusts’
snap-in and right-click on ‘Active Directory Domains and Trusts’ root in
the left pane. Then select ‘Raise forest functional level …’ and use
‘Windows Server 2003’ as the level to raise.</p>
<p>Make sure you perform this action before establishing a trust with the
‘ipa trust-add’ command. The rest of the setup is identical to that of
Windows Server 2008 R2.</p>
</section>
</section>
<section id="assumptions">
<h1>Assumptions<a class="headerlink" href="#assumptions" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>IPA server IP address: <em>ipa_ip_address</em> (e.g. 10.16.78.61)</p></li>
<li><p>IPA server hostname: <em>ipa_hostname</em> (e.g.
ipaserver.ipadomain.example.com)</p></li>
<li><p>IPA domain: <em>ipa_domain</em> (e.g. ipadomain.example.com)</p></li>
<li><p>IPA NetBIOS: <em>ipa_netbios</em> (e.g. IPADOMAIN)</p></li>
<li><p>IPA Kerberos realm, IPA_DOMAIN, is equal to IPA domain (e.g.
IPADOMAIN.EXAMPLE.COM and ipadomain.example.com)</p></li>
<li><p>AD DC IP address: <em>ad_ip_address</em> (e.g. 10.16.79.150)</p></li>
<li><p>AD DC hostname: <em>ad_hostname</em> (e.g. adserver)</p></li>
<li><p>AD domain: <em>ad_domain</em> (e.g. addomain.example.com)</p></li>
<li><p>AD NetBIOS: <em>ad_netbios</em> (e.g. ADDOMAIN)</p></li>
<li><p>AD admins group SID: <em>ad_admins_sid</em> (e.g.
S-1-5-21-16904141-148189700-2149043814-512)</p></li>
</ul>
<p><strong>NOTE</strong>: AD domain and IPA domain must be different, this is very basic
requirement for any Active Directory cross-forest trust.</p>
<p><strong>NOTE</strong>: italicized text should be replaced with real values. E.g. if
IPA domain is <code class="docutils literal notranslate"><span class="pre">ipadomain.example.com</span></code>, and the IP address of IPA
server is <code class="docutils literal notranslate"><span class="pre">10.16.78.61</span></code>, the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">dnscmd</span> <span class="mf">127.0.0.1</span> <span class="o">/</span><span class="n">ZoneAdd</span> <span class="n">ipa_domain</span> <span class="o">/</span><span class="n">Forwarder</span> <span class="n">ipa_ip_address</span>
</pre></div>
</div>
<p>should look like this:</p>
<p><code class="docutils literal notranslate"><span class="pre">C:\&gt;</span> <span class="pre">dnscmd</span> <span class="pre">127.0.0.1</span> <span class="pre">/ZoneAdd</span> <span class="pre">ipadomain.example.com</span> <span class="pre">/Forwarder</span> <span class="pre">10.16.78.61</span></code></p>
<p><strong>NOTE</strong>: NetBIOS name is the leading component of the domain name. E.g.
if the domain name is <code class="docutils literal notranslate"><span class="pre">ipadomain.example.com</span></code>, the NetBIOS name is
<code class="docutils literal notranslate"><span class="pre">IPADOMAIN</span></code>. NetBIOS namespace is flat, there should be no conflicts
between all NetBIOS names. NetBIOS names of the IPA domain and AD domain
must be different. In addtion, NetBIOS names of the IPA server and AD DC
server must be different.</p>
</section>
<section id="install-and-configure-ipa-server">
<h1>Install and configure IPA server<a class="headerlink" href="#install-and-configure-ipa-server" title="Link to this heading">#</a></h1>
<section id="make-sure-all-packages-are-up-to-date">
<h2>Make sure all packages are up to date<a class="headerlink" href="#make-sure-all-packages-are-up-to-date" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">yum</span> <span class="pre">update</span> <span class="pre">-y</span></code></p>
</section>
<section id="install-required-packages">
<h2>Install required packages<a class="headerlink" href="#install-required-packages" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">yum</span> <span class="pre">install</span> <span class="pre">-y</span> <span class="pre">&quot;*ipa-server&quot;</span> <span class="pre">&quot;*ipa-server-trust-ad&quot;</span> <span class="pre">bind</span> <span class="pre">bind-dyndb-ldap</span></code></p>
</section>
<section id="configure-host-name">
<h2>Configure host name<a class="headerlink" href="#configure-host-name" title="Link to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># hostnamectl set-hostname ipa_hostname</span>
</pre></div>
</div>
</section>
<section id="install-ipa-server">
<h2>Install IPA server<a class="headerlink" href="#install-ipa-server" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa-server-install</span> <span class="pre">-a</span> <span class="pre">mypassword1</span> <span class="pre">-p</span> <span class="pre">mypassword2</span> <span class="pre">--domain=ipa_domain</span> <span class="pre">--realm=IPA_DOMAIN</span> <span class="pre">--setup-dns</span> <span class="pre">--no-forwarders</span> <span class="pre">-U</span></code></p>
</section>
<section id="login-as-admin">
<h2>Login as admin<a class="headerlink" href="#login-as-admin" title="Link to this heading">#</a></h2>
<p>To obtain a ticket-granting ticket, run the follwing command:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">kinit</span> <span class="pre">admin</span></code></p>
<p>The password is your admin user’s password (from <code class="docutils literal notranslate"><span class="pre">-a</span></code> option in the
<code class="docutils literal notranslate"><span class="pre">ipa-server-install</span></code> comand).</p>
</section>
<section id="make-sure-ipa-users-are-available-to-the-system-services">
<h2>Make sure IPA users are available to the system services<a class="headerlink" href="#make-sure-ipa-users-are-available-to-the-system-services" title="Link to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># id admin</span>
<span class="c1"># getent passwd admin</span>
</pre></div>
</div>
<p>Both above commands should return information about the admin user. If
above commands fail, restart the <code class="docutils literal notranslate"><span class="pre">sssd</span></code> service
(<code class="docutils literal notranslate"><span class="pre">service</span> <span class="pre">sssd</span> <span class="pre">restart</span></code>), and try them again.</p>
</section>
<section id="configure-ipa-server-for-cross-forest-trusts">
<h2>Configure IPA server for cross-forest trusts<a class="headerlink" href="#configure-ipa-server-for-cross-forest-trusts" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa-adtrust-install</span> <span class="pre">--netbios-name=ipa_netbios</span> <span class="pre">-a</span> <span class="pre">mypassword1</span></code></p>
<p>When planning access of AD users to IPA clients, make sure to run
ipa-adtrust-install on every IPA master these IPA clients will be
connecting to.</p>
</section>
</section>
<section id="cross-forest-trust-checklist">
<h1>Cross-forest trust checklist<a class="headerlink" href="#cross-forest-trust-checklist" title="Link to this heading">#</a></h1>
<p>Before establishing a cross-forest trust, some additional configuration
must be performed.</p>
<section id="date-time-settings">
<h2>Date/time settings<a class="headerlink" href="#date-time-settings" title="Link to this heading">#</a></h2>
<p>Make sure both timezone settings and date/time settings on both servers
match.</p>
</section>
<section id="firewall-configuration">
<h2>Firewall configuration<a class="headerlink" href="#firewall-configuration" title="Link to this heading">#</a></h2>
</section>
<section id="on-ad-dc">
<h2>On AD DC<a class="headerlink" href="#on-ad-dc" title="Link to this heading">#</a></h2>
<p>Windows Firewall configuration (to be added).</p>
</section>
<section id="on-ipa-server">
<h2>On IPA server<a class="headerlink" href="#on-ipa-server" title="Link to this heading">#</a></h2>
<p>IPA uses the following ports to communicate with its services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TCP</span> <span class="n">ports</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">443</span><span class="p">,</span> <span class="mi">389</span><span class="p">,</span> <span class="mi">636</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">464</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">445</span><span class="p">,</span> <span class="mi">1024</span><span class="o">-</span><span class="mi">1300</span>
<span class="n">UDP</span> <span class="n">ports</span><span class="p">:</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">464</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">389</span><span class="p">,</span> <span class="mi">445</span>
</pre></div>
</div>
<p>These ports must be open and available; they cannot be in use by another
service or blocked by a firewall. Especially ports 88/udp, 88/tcp,
389/udp are important to keep open on IPA servers to allow AD clients to
obtain cross-realm ticket granting tickets or otherwise single sign-on
between AD clients and IPA services will not work.</p>
<p>Ports 135, 1024-1300 are needed to get DCE RPC end-point mapper to work.
End-point mapper is a key component to accessLSA and SAMR pipes which
are used to establish trust and access authentication and identity
information in Active Directory.</p>
<p>Previously we recommended that you should make sure that IPA LDAP server
is not reachable by AD DC by closing down TCP ports 389 and 636 for AD
DC. Our current tests lead to the assumption that this is not necessary
anymore. During the early development stage we tried to create a trust
between IPA and AD with both IPA and AD tools. It turned out that the AD
tools expect an AD like LDAP schema and layout to create a trust. Since
the IPA LDAP server does not meet those requirements it is not possible
to create a trust between IPA and AD with AD tools only with the ‘ipa
trust-add’ command. By blocking the LDAP ports for the AD DC we tried to
force the AD tools to fall back to other means to get the needed
information with no success. But we kept the recommendation to block
those ports because it was not clear at this time if AD will check the
LDAP layout of a trust partner during normal operation as well. Since we
have not observed those request the recommendation can be dropped.</p>
<p>Below are instructions on how to configure the firewall using
<code class="docutils literal notranslate"><span class="pre">iptables</span></code>.</p>
<section id="firewalld">
<h3>Firewalld<a class="headerlink" href="#firewalld" title="Link to this heading">#</a></h3>
<p>Fedora 18 introduced a new firewall manager: <code class="docutils literal notranslate"><span class="pre">firewalld</span></code>. However,
<code class="docutils literal notranslate"><span class="pre">firewalld</span></code> does not yet support allowing and blocking services for
specific hosts. For this reason, we recommend disabling <code class="docutils literal notranslate"><span class="pre">firewalld</span></code>,
enabling <code class="docutils literal notranslate"><span class="pre">iptables</span></code> and using the sample configuration listed in
section <a class="reference external" href="#iptables">#iptables</a>.</p>
<p>To disable <code class="docutils literal notranslate"><span class="pre">firewalld</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># chkconfig firewalld off</span>
<span class="c1"># service firewalld stop</span>
</pre></div>
</div>
<p>To enable <code class="docutils literal notranslate"><span class="pre">iptables</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># yum install -y iptables-services</span>
<span class="c1"># chkconfig iptables on</span>
</pre></div>
</div>
<p>Make sure <code class="docutils literal notranslate"><span class="pre">iptables</span></code> configuration file is located at
<code class="docutils literal notranslate"><span class="pre">/etc/sysconfig/iptables</span></code> and contains the desired configuration, and
then (re)start the <code class="docutils literal notranslate"><span class="pre">iptables</span></code> service:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">service</span> <span class="pre">iptables</span> <span class="pre">restart</span></code></p>
</section>
<section id="iptables">
<h3>iptables<a class="headerlink" href="#iptables" title="Link to this heading">#</a></h3>
<p>Make sure that <code class="docutils literal notranslate"><span class="pre">iptables</span></code> is configured to start whenever the system
is booted:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">chkconfig</span> <span class="pre">iptables</span> <span class="pre">on</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">iptables</span></code> configuration file is <code class="docutils literal notranslate"><span class="pre">/etc/sysconfig/iptables</span></code>. Taking
into account the rules that must be applied in order for IPA to work
properly, here is a sample configuration.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="nb">filter</span>
<span class="p">:</span><span class="n">INPUT</span> <span class="n">ACCEPT</span> <span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span>
<span class="p">:</span><span class="n">FORWARD</span> <span class="n">ACCEPT</span> <span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span>
<span class="p">:</span><span class="n">OUTPUT</span> <span class="n">ACCEPT</span> <span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span><span class="p">,</span><span class="n">RELATED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">lo</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
  <span class="c1"># -A INPUT -s ad_ip_address -p tcp -m multiport --dports 389,636 -m state --state NEW,ESTABLISHED -j REJECT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">m</span> <span class="n">multiport</span> <span class="o">--</span><span class="n">dports</span> <span class="mi">80</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">443</span><span class="p">,</span><span class="mi">389</span><span class="p">,</span><span class="mi">636</span><span class="p">,</span><span class="mi">88</span><span class="p">,</span><span class="mi">464</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">445</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">-</span><span class="n">m</span> <span class="n">multiport</span> <span class="o">--</span><span class="n">dports</span> <span class="mi">88</span><span class="p">,</span><span class="mi">464</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">123</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">139</span><span class="p">,</span><span class="mi">389</span><span class="p">,</span><span class="mi">445</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">-</span><span class="n">j</span> <span class="n">REJECT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">j</span> <span class="n">REJECT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">j</span> <span class="n">REJECT</span> <span class="o">--</span><span class="n">reject</span><span class="o">-</span><span class="k">with</span> <span class="n">icmp</span><span class="o">-</span><span class="n">host</span><span class="o">-</span><span class="n">prohibited</span>
<span class="n">COMMIT</span>
</pre></div>
</div>
<p>Please note that the line containing “ad_ip_address” is not needed
anymore (see comments above). If you still want to use it please make
sure you replace <em>ad_ip_address</em> in the above configuration, with the IP
address of AD DC.</p>
<p>Any changes to the <code class="docutils literal notranslate"><span class="pre">iptables</span></code> configuration file will require a
restart of the <code class="docutils literal notranslate"><span class="pre">iptables</span></code> service:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">service</span> <span class="pre">iptables</span> <span class="pre">restart</span></code></p>
</section>
</section>
<section id="dns-configuration">
<h2>DNS configuration<a class="headerlink" href="#dns-configuration" title="Link to this heading">#</a></h2>
<p><strong>NOTE</strong>: Any changes to <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> file will require a
restart of <code class="docutils literal notranslate"><span class="pre">krb5kdc</span></code>, <code class="docutils literal notranslate"><span class="pre">sssd</span></code> and <code class="docutils literal notranslate"><span class="pre">httpd</span></code> services.</p>
<p>Both AD and IPA domains need to be visible to each other. In normal DNS
configuration, no changes are required. When the testing DNS domains are
not part of shared DNS tree visible to both IPA and AD, customer DNS
zone forwarders can be created:</p>
</section>
<section id="conditional-dns-forwarders">
<h2>Conditional DNS forwarders<a class="headerlink" href="#conditional-dns-forwarders" title="Link to this heading">#</a></h2>
<p>On AD DC, add conditional forwarder for IPA domain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">dnscmd</span> <span class="mf">127.0.0.1</span> <span class="o">/</span><span class="n">ZoneAdd</span> <span class="n">ipa_domain</span> <span class="o">/</span><span class="n">Forwarder</span> <span class="n">ipa_ip_address</span>
</pre></div>
</div>
<p>On IPA server, add conditional forwarder for AD domain. The command in
IPA version 3 and 4 are different.</p>
<ul class="simple">
<li><p>IPA v3.x:</p></li>
</ul>
<p># ipa dnszone-add ad_domain –name-server=ad_hostname.ad_domain <a class="reference external" href="mailto:--admin-email='hostmaster&#37;&#52;&#48;ad_domain">–admin-email=’hostmaster<span>&#64;</span>ad_domain</a>’ –force –forwarder=ad_ip_address –forward-policy=only –ip-address=ad_ip_address</p>
<ul class="simple">
<li><p>IPA v4.x:</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">dnsforwardzone-add</span> <span class="pre">ad_domain</span> <span class="pre">--forwarder=ad_ip_address</span> <span class="pre">--forward-policy=only</span></code></p>
</section>
<section id="if-ad-is-subdomain-of-ipa">
<h2>If AD is subdomain of IPA<a class="headerlink" href="#if-ad-is-subdomain-of-ipa" title="Link to this heading">#</a></h2>
<p>If the AD domain is a subdomain of the IPA domain (e.g. AD domain is
<code class="docutils literal notranslate"><span class="pre">addomain.ipadomain.example.com</span></code> and IPA domain is
<code class="docutils literal notranslate"><span class="pre">ipadomain.example.com</span></code>), configure DNS as follows.</p>
<p>On IPA server, add an A record and a NS record for the AD domain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ipa dnsrecord-add ipa_domain ad_hostname.ad_netbios --a-ip-address=ad_ip_address``</span>
<span class="c1"># ipa dnsrecord-add ipa_domain ad_netbios --ns-hostname=ad_hostname.ad_netbios``</span>
</pre></div>
</div>
<p>On AD DC, there two options.</p>
<p>The first one is to configure a global forwarder to forward DNS queries
to the IPA domain:</p>
<p><code class="docutils literal notranslate"><span class="pre">C:\&gt;</span> <span class="pre">dnscmd</span> <span class="pre">127.0.0.1</span> <span class="pre">/ResetForwarders</span> <span class="pre">ipa_ip_address</span> <span class="pre">/Slave</span></code></p>
<p>The second option is to configure a DNS zone for master-slave
replication. The data for this zone will then be periodically copied
from master (IPA server) to slave (AD server).</p>
<p>To do this, first explicitly allow the transfer of the zone on IPA
server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ipa dnszone-mod ipa_domain --allow-transfer=ad_ip_address</span>
</pre></div>
</div>
<p>And second, add the DNS zone for the IPA domain on the AD DC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">dnscmd</span> <span class="mi">127</span> <span class="mf">0.0.1</span> <span class="o">/</span><span class="n">ZoneAdd</span> <span class="n">ipa_domain</span> <span class="o">/</span><span class="n">Secondary</span> <span class="n">ipa_ip_address</span>
</pre></div>
</div>
</section>
<section id="if-ipa-is-subdomain-of-ad">
<h2>If IPA is subdomain of AD<a class="headerlink" href="#if-ipa-is-subdomain-of-ad" title="Link to this heading">#</a></h2>
<p>If the IPA domain is a subdomain of the AD domain (e.g. IPA domain is
ipadomain.addomain.example.com and AD domain is
addomain.example.com), configure DNS as follows.</p>
<p>On AD DC, add an A record and a NS record for the IPA domain:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">dnscmd</span> <span class="mf">127.0.0.1</span> <span class="o">/</span><span class="n">RecordAdd</span> <span class="n">ad_domain</span> <span class="n">ipa_hostname</span><span class="o">.</span><span class="n">ipa_domain</span> <span class="n">A</span> <span class="n">ipa_ip_address</span>
<span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">dnscmd</span> <span class="mf">127.0.0.1</span> <span class="o">/</span><span class="n">RecordAdd</span> <span class="n">ad_domain</span> <span class="n">ipa_domain</span> <span class="n">NS</span> <span class="n">ipa_hostname</span><span class="o">.</span><span class="n">ipa_domain</span>
</pre></div>
</div>
</section>
<section id="verify-dns-configuration">
<h2>Verify DNS configuration<a class="headerlink" href="#verify-dns-configuration" title="Link to this heading">#</a></h2>
<p>To make sure both AD and IPA servers can see each other, check if SRV
records are being properly resolved.</p>
<p>On AD DC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>C:\&gt; nslookup
&gt; set type=srv
 &gt; _ldap._tcp.ad_domain``
 &gt; _ldap._tcp.ipa_domain``
&gt; quit
</pre></div>
</div>
<p>On IPA server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># dig SRV _ldap._tcp.ipa_domain``</span>
<span class="c1"># dig SRV _ldap._tcp.ad_domain``</span>
</pre></div>
</div>
</section>
</section>
<section id="establish-and-verify-cross-forest-trust">
<h1>Establish and verify cross-forest trust<a class="headerlink" href="#establish-and-verify-cross-forest-trust" title="Link to this heading">#</a></h1>
<section id="add-trust-with-ad-domain">
<h2>Add trust with AD domain<a class="headerlink" href="#add-trust-with-ad-domain" title="Link to this heading">#</a></h2>
</section>
<section id="when-ad-administrator-credentials-are-available">
<h2>When AD administrator credentials are available<a class="headerlink" href="#when-ad-administrator-credentials-are-available" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">trust-add</span> <span class="pre">--type=ad</span> <span class="pre">ad_domain</span> <span class="pre">--admin</span> <span class="pre">Administrator</span> <span class="pre">--password</span></code></p>
<p>Enter the Administrator’s password when prompted. If everything was set
up correctly, a trust with AD domain will be established.</p>
<p>The user account used when creating a trust (the argument to the
<code class="docutils literal notranslate"><span class="pre">--admin</span></code> option in the <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">trust-add</span></code> command) must be a member of
the <code class="docutils literal notranslate"><span class="pre">Domain</span> <span class="pre">Admins</span></code> group.</p>
<p>At this point IPA will create one-way forest trust on IPA side, will
create one-way forest trust on AD side, and initiate validation of the
trust from AD side. For two-way trust one needs to add
<code class="docutils literal notranslate"><span class="pre">--two-way=true</span></code> option.</p>
<p>Note that there is currently an issue in creating a one-way trust to
Active Directory with a shared secret instead of using administrative
credentials. This is due to lack of privileges to kick off a trust
validation from AD side in such situation. The issue is being tracked in
<a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1345975">this bug</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">trust-add</span></code> command uses the following method calls on the AD
server:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">`CreateTrustedDomainEx2</span></code> &lt;<a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc234380.aspx">http://msdn.microsoft.com/en-us/library/cc234380.aspx</a>&gt;`__
to create the trust between the two domains</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">`QueryTrustedDomainInfoByName</span></code> &lt;<a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc234376.aspx">http://msdn.microsoft.com/en-us/library/cc234376.aspx</a>&gt;`__
to check if the trust is already added</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">`SetInformationTrustedDomain</span></code> &lt;<a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc234385.aspx">http://msdn.microsoft.com/en-us/library/cc234385.aspx</a>&gt;`__
to tell the AD server that the IPA server can handle AES encryption</p></li>
</ul>
</section>
<section id="when-ad-administrator-credentials-aren-t-available">
<h2>When AD administrator credentials aren’t available<a class="headerlink" href="#when-ad-administrator-credentials-aren-t-available" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">trust-add</span> <span class="pre">--type=ad</span> <span class="pre">&quot;ad_domain&quot;</span> <span class="pre">--trust-secret</span></code></p>
<p>Enter the trust shared secret when prompted. At this point IPA will
create two-way forest trust on IPA side. Second leg of the trust need to
be created manually and validated on AD side. Following GIF sequence
shows how trust with shared secret is created:</p>
<figure class="align-default" id="id1">
<img alt="Trust-ad-demo-shared-secret.gif" src="../_images/Trust-ad-demo-shared-secret.gif" />
<figcaption>
<p><span class="caption-text">Trust-ad-demo-shared-secret.gif</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Once trust leg on AD side is established, one needs to retrieve the list
of trusted forest domains from AD side. This is done using following
command:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">trust-fetch-domains</span> <span class="pre">&quot;ad_domain&quot;</span></code></p>
<p>With this command running successfuly, IPA will get information about
trusted domains and will create all needed identity ranges for them.</p>
<p>Use “trustdomain-find” to see list of the trusted domains from a trusted
forest:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">trustdomain-find</span> <span class="pre">&quot;ad_domain&quot;</span></code></p>
</section>
<section id="edit-etc-krb5-conf">
<h2>Edit /etc/krb5.conf<a class="headerlink" href="#edit-etc-krb5-conf" title="Link to this heading">#</a></h2>
<p>Many applications ask Kerberos library to verify that Kerberos principal
can be mapped to some POSIX account. Additionally, there are some
applications that perform additional check by asking the OS for the
canonical name of the POSIX account returned by Kerberos library. Note
that OpenSSH compares the name of principal unchanged but SSSD low-cases
the realm part, thus real user name is <a class="reference external" href="mailto:Administrator&#37;&#52;&#48;realm">Administrator<span>&#64;</span>realm</a>, not
<a class="reference external" href="mailto:administrator&#37;&#52;&#48;realm">administrator<span>&#64;</span>realm</a>, when trying to logon with Kerberos ticket over SSH.</p>
<p>We have several factors in play here:</p>
<ul class="simple">
<li><p>Kerberos principals use form <a class="reference external" href="mailto:name&#37;&#52;&#48;REALM">name<span>&#64;</span>REALM</a> where REALM has to be upper
case in Linux</p></li>
<li><p>SSSD provides POSIX accounts to AD users always fully qualified
(<a class="reference external" href="mailto:name&#37;&#52;&#48;domain">name<span>&#64;</span>domain</a>)</p></li>
<li><p>SSSD normalizes all POSIX accounts to lower case (<a class="reference external" href="mailto:name&#37;&#52;&#48;domain">name<span>&#64;</span>domain</a>) on
requests which involve returning POSIX account names.</p></li>
</ul>
<p>Thus, we need to define rules for mapping Kerberos principals to system
user names. If MIT Kerberos 1.12+ is in use and SSSD 1.12.1+ is in use,
you can skip the rest of this section because they implement a localauth
plugin that automatically does this translation and is set up by
ipa-client-install.</p>
<p>If no SSSD support for localauth plugin is available, we need to specify
auth_to_local rules that map REALM to a low-cased version. auth_to_local
rules are needed to map a successfully authenticated Kerberos principal
to some existing POSIX account.</p>
<p>For the time being, a manual configuration of <code class="docutils literal notranslate"><span class="pre">/etc/krb5.conf</span></code> on the
IPA server is needed, to allow Kerberos authentication.</p>
<p>Add these two lines to <code class="docutils literal notranslate"><span class="pre">/etc/krb5.conf</span></code> on every machine that is going
to see AD users:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[realms]
 IPA_DOMAIN = {
 ....
    auth_to_local = RULE:[1:$1@$0](^.*@AD_DOMAIN$)s/@AD_DOMAIN/@ad_domain/
  auth_to_local = DEFAULT
}
</pre></div>
</div>
<p>Restart KDC and sssd</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># service krb5kdc restart</span>
<span class="c1"># service sssd restart</span>
</pre></div>
</div>
</section>
<section id="allow-access-for-users-from-ad-domain-to-protected-resources">
<h2>Allow access for users from AD domain to protected resources<a class="headerlink" href="#allow-access-for-users-from-ad-domain-to-protected-resources" title="Link to this heading">#</a></h2>
<p>Before users from trusted domain can access protected resources in the
IPA realm, they have to be explicitly mapped to the IPA groups. The
mapping is performed in two steps:</p>
<ul class="simple">
<li><p>Add users and groups from trusted domain to an external group in IPA.
External group serves as a container to reference trusted domain
users and groups by their security identifiers</p></li>
<li><p>Map external group to an existing POSIX group in IPA. This POSIX
group will be assigned proper group id (gid) that will be used as
default group for all incoming trusted domain users mapped to this
group</p></li>
</ul>
</section>
<section id="create-external-and-posix-groups-for-trusted-domain-users">
<h2>Create external and POSIX groups for trusted domain users<a class="headerlink" href="#create-external-and-posix-groups-for-trusted-domain-users" title="Link to this heading">#</a></h2>
<p>Create external group in IPA for trusted domain admins:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">group-add</span> <span class="pre">--desc='ad_domain</span> <span class="pre">admins</span> <span class="pre">external</span> <span class="pre">map'</span> <span class="pre">ad_admins_external</span> <span class="pre">--external</span></code></p>
<p>Create POSIX group for external <code class="docutils literal notranslate"><span class="pre">ad_admins_external</span></code> group:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">group-add</span> <span class="pre">--desc='ad_domain</span> <span class="pre">admins'</span> <span class="pre">ad_admins</span></code></p>
</section>
<section id="add-trusted-domain-users-to-the-external-group">
<h2>Add trusted domain users to the external group<a class="headerlink" href="#add-trusted-domain-users-to-the-external-group" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">group-add-member</span> <span class="pre">ad_admins_external</span> <span class="pre">--external</span> <span class="pre">'ad_netbios\Domain</span> <span class="pre">Admins'</span></code></p>
<p>When asked for member user and member group, just leave it blank and hit
Enter.</p>
<p><strong>NOTE</strong>: Since arguments in above command contain backslashes,
whitespace, etc, make sure to either use non-interpolation quotes (’) or
to escape any specials characters with a backslash ().</p>
</section>
<section id="add-external-group-to-posix-group">
<h2>Add external group to POSIX group<a class="headerlink" href="#add-external-group-to-posix-group" title="Link to this heading">#</a></h2>
<p>Allow members of <code class="docutils literal notranslate"><span class="pre">ad_admins_external</span></code> group to be associated with
<code class="docutils literal notranslate"><span class="pre">ad_admins</span></code> POSIX group:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">group-add-member</span> <span class="pre">ad_admins</span> <span class="pre">--groups</span> <span class="pre">ad_admins_external</span></code></p>
</section>
</section>
<section id="test-cross-forest-trust">
<h1>Test cross-forest trust<a class="headerlink" href="#test-cross-forest-trust" title="Link to this heading">#</a></h1>
<section id="using-ssh">
<h2>Using SSH<a class="headerlink" href="#using-ssh" title="Link to this heading">#</a></h2>
<p>AD users should now be able to login into IPA domain via SSH. putty SSH
client for Windows
(<a class="reference external" href="http://the.earth.li/~sgtatham/putty/latest/x86/putty.exe">http://the.earth.li/~sgtatham/putty/latest/x86/putty.exe</a>) can be used
to test this. When trying to connect to the IPA domain, make sure you
use <em>ad_user</em>&#64;<em>ad_domain</em> as username. Note that <em>ad_domain</em> must be
lower-case. Also, make sure you preserve the case of the username, i.e.
if username is Administrator, log in as Administrator&#64;<em>ad_domain</em>, not
administrator&#64;<em>ad_domain</em>.</p>
</section>
<section id="using-samba-shares">
<h2>Using Samba shares<a class="headerlink" href="#using-samba-shares" title="Link to this heading">#</a></h2>
<p>To create a Samba share on IPA server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># net conf setparm &#39;share&#39; &#39;comment&#39; &#39;Trust test share&#39;</span>
<span class="c1"># net conf setparm &#39;share&#39; &#39;read only&#39; &#39;no&#39;</span>
  <span class="c1"># net conf setparm &#39;share&#39; &#39;valid users&#39; &#39;ad_admins_sid&#39;</span>
  <span class="c1"># net conf setparm &#39;share&#39; &#39;path&#39; &#39;/path/to/share&#39;</span>
</pre></div>
</div>
<p><strong>NOTE</strong>: To obtain the SID (Security Identifier) of the AD admins
group, run:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">wbinfo</span> <span class="pre">-n</span> <span class="pre">'ad_netbios\Domain</span> <span class="pre">Admins'</span></code></p>
<p>It is a string that looks like this:
S-1-5-21-16904141-148189700-2149043814-512. <code class="docutils literal notranslate"><span class="pre">wbinfo</span></code> executable is
contained in <code class="docutils literal notranslate"><span class="pre">samba-winbind-clients</span></code> package which is optional to
FreeIPA.</p>
<p>To access the share from a Windows machine:</p>
<ul class="simple">
<li><p>Start -&gt; right click on Network -&gt; Map Network Drive</p></li>
<li><p>‘Drive’: choose a drive letter for the share</p></li>
<li><p>‘Folder’: \\<em>ipa_hostname.ipa_domain</em>\share</p></li>
<li><p>The share should now be mounted under the drive letter that you chose</p></li>
</ul>
<p><strong>NOTE</strong>: This method can be used for testing purposes only, as file
sharing is not yet supported in RHEL 6.4.</p>
</section>
<section id="using-kerberized-web-applications">
<h2>Using Kerberized web applications<a class="headerlink" href="#using-kerberized-web-applications" title="Link to this heading">#</a></h2>
<p>If you need to install and configure a web application for the purposes
of testing Kerberos authentication,
<a class="reference external" href="http://www.mediawiki.org/wiki/Manual:Running_MediaWiki_on_GNU/Linux">MediaWiki</a>
can be used.</p>
<p>To add Kerberos authentication to an existing web application, the
following Apache configuration is needed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">Location</span> <span class="s2">&quot;/mywebapp&quot;</span><span class="o">&gt;</span>
   <span class="n">AuthType</span> <span class="n">Kerberos</span>
   <span class="n">AuthName</span> <span class="s2">&quot;IPA Kerberos authentication&quot;</span>
   <span class="n">KrbMethodNegotiate</span> <span class="n">on</span>
   <span class="n">KrbMethodK5Passwd</span> <span class="n">on</span>
   <span class="n">KrbServiceName</span> <span class="n">HTTP</span>
    <span class="n">KrbAuthRealms</span> <span class="n">IPA_DOMAIN</span>
   <span class="n">Krb5Keytab</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">ipa</span><span class="o">.</span><span class="n">keytab</span>
   <span class="n">KrbSaveCredentials</span> <span class="n">off</span>
   <span class="n">Require</span> <span class="n">valid</span><span class="o">-</span><span class="n">user</span>
</pre></div>
</div>
<p>Make sure you replace <em>IPA_DOMAIN</em> in the above configuration with your
actual IPA domain (in caps) and to restart the apache service:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">service</span> <span class="pre">httpd</span> <span class="pre">restart</span></code></p>
</section>
</section>
<section id="debugging-trust">
<h1>Debugging trust<a class="headerlink" href="#debugging-trust" title="Link to this heading">#</a></h1>
<section id="general-debugging-guidelines">
<h2>General debugging guidelines<a class="headerlink" href="#general-debugging-guidelines" title="Link to this heading">#</a></h2>
<p>What you can do is following (assumes Fedora 20+ or RHEL 7+):</p>
<ul class="simple">
<li><p>Check that IPv6 module is not disabled on the Linux side as Samba and
CLDAP module in IPA require it. See <a class="reference external" href="Active_Directory_trust_setup#IPv6_stack_usage">instructions
above</a>.</p></li>
<li><p>Check firewall rules: AD DCs should be able to contact IdM smbd over
138/139/445 TCP and UDP ports, 389 UDP port.</p></li>
<li><p>Stop smb and winbind services on IdM server</p></li>
</ul>
<p>``   systemctl stop smb winbind``</p>
<ul class="simple">
<li><p>Set log level to increased debug so that packets smbd/winbindd
receive get printed fully in the logs:</p></li>
</ul>
<p>``    net conf setparm global ‘log level’ 100``</p>
<ul class="simple">
<li><p>Set log level to increased debug so that communication done by IPA
when establishing trust is printed fully in the logs. Change
/usr/share/ipa/smb.conf.empty:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="k">global</span><span class="p">]</span>
<span class="n">log</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Remove old /var/log/samba/log.*</p></li>
<li><p>Start smb and winbind services</p></li>
</ul>
<p>``   systemctl start smb winbind``</p>
<ul class="simple">
<li><p>Re-add trust</p></li>
</ul>
<p>``    ipa trust-add <code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">``</span> <span class="pre">...</span></code></p>
<ul class="simple">
<li><p>If trust-add command was used with shared secret instead of explicit
AD administrator credentials, after validation was performed from AD
side, run</p></li>
</ul>
<p>``    ipa trust-fetch-domains ``</p>
<ul class="simple">
<li><p>Package following logs and attach them to a bug or send directly to a
member of FreeIPA development team who requested the logs. Please do
not send logs to the public mailing lists – logs are often quite
large and would contain information specific to your AD deployment
that general public shouldn’t have access to. The logs we are
interested in are following:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">error_log</span>
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">samba</span><span class="o">/</span><span class="n">log</span><span class="o">.*</span>
</pre></div>
</div>
</section>
<section id="failures-due-to-exhausted-dna-range-on-replica">
<h2>Failures due to exhausted DNA range on replica<a class="headerlink" href="#failures-due-to-exhausted-dna-range-on-replica" title="Link to this heading">#</a></h2>
<p>It may happen that the <code class="docutils literal notranslate"><span class="pre">trust-add</span></code> command fails with the generic
<code class="docutils literal notranslate"><span class="pre">ipa:</span> <span class="pre">ERROR:</span> <span class="pre">communication</span> <span class="pre">with</span> <span class="pre">CIFS</span> <span class="pre">server</span> <span class="pre">was</span> <span class="pre">unsuccessful</span></code> message
displayed in the console and Apache error log containing the following
message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">SNIP</span><span class="o">&gt;</span>
<span class="n">s4_tevent</span><span class="p">:</span> <span class="n">Run</span> <span class="n">immediate</span> <span class="n">event</span> <span class="s2">&quot;tstream_smbXcli_np_readv_trans_next&quot;</span><span class="p">:</span> <span class="mh">0x7f6e603b7f60</span>
<span class="n">s4_tevent</span><span class="p">:</span> <span class="n">Schedule</span> <span class="n">immediate</span> <span class="n">event</span> <span class="s2">&quot;tevent_req_trigger&quot;</span><span class="p">:</span> <span class="mh">0x7f6e603b6be0</span>
<span class="n">s4_tevent</span><span class="p">:</span> <span class="n">Run</span> <span class="n">immediate</span> <span class="n">event</span> <span class="s2">&quot;tevent_req_trigger&quot;</span><span class="p">:</span> <span class="mh">0x7f6e603b6be0</span>
<span class="n">s4_tevent</span><span class="p">:</span> <span class="n">Destroying</span> <span class="n">timer</span> <span class="n">event</span> <span class="mh">0x7f6e6038db50</span> <span class="s2">&quot;dcerpc_timeout_handler&quot;</span>
<span class="n">s4_tevent</span><span class="p">:</span> <span class="n">Schedule</span> <span class="n">immediate</span> <span class="n">event</span> <span class="s2">&quot;tevent_req_trigger&quot;</span><span class="p">:</span> <span class="mh">0x7f6e603b7d20</span>
<span class="n">s4_tevent</span><span class="p">:</span> <span class="n">Run</span> <span class="n">immediate</span> <span class="n">event</span> <span class="s2">&quot;tevent_req_trigger&quot;</span><span class="p">:</span> <span class="mh">0x7f6e603b7d20</span>
     <span class="n">lsa_CreateTrustedDomainEx2</span><span class="p">:</span> <span class="n">struct</span> <span class="n">lsa_CreateTrustedDomainEx2</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">struct</span> <span class="n">lsa_CreateTrustedDomainEx2</span>
            <span class="n">trustdom_handle</span>          <span class="p">:</span> <span class="o">*</span>
                <span class="n">trustdom_handle</span><span class="p">:</span> <span class="n">struct</span> <span class="n">policy_handle</span>
                    <span class="n">handle_type</span>              <span class="p">:</span> <span class="mh">0x00000000</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">uuid</span>                     <span class="p">:</span> <span class="mi">00000000</span><span class="o">-</span><span class="mi">0000</span><span class="o">-</span><span class="mi">0000</span><span class="o">-</span><span class="mi">0000</span><span class="o">-</span><span class="mi">000000000000</span>
            <span class="n">result</span>                   <span class="p">:</span> <span class="n">NT_STATUS_UNSUCCESSFUL</span>
<span class="n">rpc</span> <span class="n">reply</span> <span class="n">data</span><span class="p">:</span>
<span class="p">[</span><span class="mi">0000</span><span class="p">]</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>   <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>   <span class="o">........</span> <span class="o">........</span>
<span class="p">[</span><span class="mi">0010</span><span class="p">]</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="n">C0</span>                             <span class="o">........</span>
<span class="p">[</span><span class="n">Thu</span> <span class="n">Dec</span> <span class="mi">01</span> <span class="mi">11</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">21.424668</span> <span class="mi">2016</span><span class="p">]</span> <span class="p">[</span><span class="n">wsgi</span><span class="p">:</span><span class="n">error</span><span class="p">]</span> <span class="p">[</span><span class="n">pid</span> <span class="mi">50403</span><span class="p">]</span> <span class="n">ipa</span><span class="p">:</span> <span class="n">INFO</span><span class="p">:</span> <span class="p">[</span><span class="n">jsonserver_session</span><span class="p">]</span> <span class="n">admin</span><span class="nd">@IPA</span><span class="o">.</span><span class="n">REALM</span><span class="p">:</span> <span class="n">trust_add</span><span class="o">/</span><span class="mi">1</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;ad.realm&#39;</span><span class="p">,</span> <span class="n">realm_admin</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;Administrator&#39;</span><span class="p">,</span> <span class="n">realm_passwd</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;********&#39;</span><span class="p">,</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;2.215&#39;</span><span class="p">):</span> <span class="n">RemoteRetrieveError</span>
</pre></div>
</div>
<p>This error may be caused by exhaustion of DNA range on replica caused
e.g. by hastily decommissioning malfunctioning master without
transferring remaining posix ID ranges to replicas. During trust setup
Trusted Domain Object with allocated UID/GID must be created on FreeIPA
server. Since UID/GID allocation fails, the whole trust creation process
ends with error.</p>
<p>You may search for <code class="docutils literal notranslate"><span class="pre">dnaRemainingValues</span></code> attribute in
<code class="docutils literal notranslate"><span class="pre">cn=posix-ids,cn=dna,cn=ipa,cn=etc,$SUFFIX</span></code> subtree to confirm this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#  ldapsearch -Y EXTERNAL -H &#39;ldapi://%2Fvar%2Frun%2Fslapd-IPA-REALM.socket&#39; -b &#39;cn=posix-ids,cn=dna,cn=ipa,cn=etc,dc=ipa,dc=realm&#39; &#39;(objectClass=dnaSharedConfig)&#39; dnaRemainingValues</span>
<span class="n">SASL</span><span class="o">/</span><span class="n">EXTERNAL</span> <span class="n">authentication</span> <span class="n">started</span>
<span class="n">SASL</span> <span class="n">username</span><span class="p">:</span> <span class="n">gidNumber</span><span class="o">=</span><span class="mi">0</span><span class="o">+</span><span class="n">uidNumber</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">peercred</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">external</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">auth</span>
<span class="n">SASL</span> <span class="n">SSF</span><span class="p">:</span> <span class="mi">0</span>
<span class="c1"># extended LDIF</span>
<span class="c1">#</span>
<span class="c1"># LDAPv3</span>
<span class="c1"># base &lt;cn=posix-ids,cn=dna,cn=ipa,cn=etc,dc=dom-204,dc=ipa,dc=realm&gt; with scope subtree</span>
<span class="c1"># filter: (objectClass=dnaSharedConfig)</span>
<span class="c1"># requesting: dnaRemainingValues</span>
<span class="c1">#</span>

<span class="c1"># replica.ipa.realm + 389, posix-ids, dna, ipa, etc, ipa.realm</span>
<span class="n">dn</span><span class="p">:</span> <span class="n">dnaHostname</span><span class="o">=</span><span class="n">replica</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">realm</span><span class="o">+</span><span class="n">dnaPortNum</span><span class="o">=</span><span class="mi">389</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">posix</span><span class="o">-</span>
 <span class="n">ids</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">dna</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">ipa</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">etc</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ipa</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">realm</span>
<span class="n">dnaRemainingValues</span><span class="p">:</span> <span class="mi">0</span> <span class="o">&lt;--</span> <span class="n">no</span> <span class="n">UIDs</span><span class="o">/</span><span class="n">GIDs</span> <span class="n">left</span>

<span class="c1"># search result</span>
<span class="n">search</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">result</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Success</span>

<span class="c1"># numResponses: 2</span>
<span class="c1"># numEntries: 1</span>
</pre></div>
</div>
<p>If this is the case, then follow <a class="reference external" href="V3/Recover_DNA_Ranges">this guide</a>
to re-create POSIX ranges on the replica. Then try to re-establish
trust; it should complete successfuly now.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Active_Directory_trust_setup</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#description">Description</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipv6-stack-usage">IPv6 stack usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#trusts-and-windows-server-2003-r2">Trusts and Windows Server 2003 R2</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#assumptions">Assumptions</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#install-and-configure-ipa-server">Install and configure IPA server</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-sure-all-packages-are-up-to-date">Make sure all packages are up to date</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-required-packages">Install required packages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-host-name">Configure host name</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-ipa-server">Install IPA server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#login-as-admin">Login as admin</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-sure-ipa-users-are-available-to-the-system-services">Make sure IPA users are available to the system services</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-ipa-server-for-cross-forest-trusts">Configure IPA server for cross-forest trusts</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#cross-forest-trust-checklist">Cross-forest trust checklist</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#date-time-settings">Date/time settings</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#firewall-configuration">Firewall configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#on-ad-dc">On AD DC</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#on-ipa-server">On IPA server</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#firewalld">Firewalld</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iptables">iptables</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dns-configuration">DNS configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conditional-dns-forwarders">Conditional DNS forwarders</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#if-ad-is-subdomain-of-ipa">If AD is subdomain of IPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#if-ipa-is-subdomain-of-ad">If IPA is subdomain of AD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verify-dns-configuration">Verify DNS configuration</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#establish-and-verify-cross-forest-trust">Establish and verify cross-forest trust</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-trust-with-ad-domain">Add trust with AD domain</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-ad-administrator-credentials-are-available">When AD administrator credentials are available</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-ad-administrator-credentials-aren-t-available">When AD administrator credentials aren’t available</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#edit-etc-krb5-conf">Edit /etc/krb5.conf</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#allow-access-for-users-from-ad-domain-to-protected-resources">Allow access for users from AD domain to protected resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#create-external-and-posix-groups-for-trusted-domain-users">Create external and POSIX groups for trusted domain users</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-trusted-domain-users-to-the-external-group">Add trusted domain users to the external group</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#add-external-group-to-posix-group">Add external group to POSIX group</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#test-cross-forest-trust">Test cross-forest trust</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-ssh">Using SSH</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-samba-shares">Using Samba shares</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-kerberized-web-applications">Using Kerberized web applications</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#debugging-trust">Debugging trust</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#general-debugging-guidelines">General debugging guidelines</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#failures-due-to-exhausted-dna-range-on-replica">Failures due to exhausted DNA range on replica</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>