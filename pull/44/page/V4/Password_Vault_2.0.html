
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Notice - Design Document &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/Password_Vault_2.0';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/Password_Vault_2.0.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Notice - Design Document</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Notice - Design Document</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#secret">Secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault">Vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#standard-vault">Standard Vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetric-vault">Symmetric Vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#asymmetric-vault">Asymmetric Vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#container">Container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-control">Access Control</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#installation">Installation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#container-managerment">Container Managerment</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#listing-available-containers">Listing available containers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#displaying-container-info">Displaying container info</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-container">Adding a container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-a-container">Modifying a container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-a-container">Removing a container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-container-member">Adding container member</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-container-member">Removing container member</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-container-owner">Adding container owner</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-container-owner">Removing container owner</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-management">Vault Management</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#listing-available-vaults">Listing available vaults</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#displaying-vault-info">Displaying vault info</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-new-vault">Creating a new vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#archiving-data">Archiving data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-data">Retrieving data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copying-a-vault">Copying a vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-a-vault">Modifying a vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-a-vault">Removing a vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-vault-password">Changing vault password</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-vault-member">Adding vault member</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-vault-member">Removing vault member</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-vault-owner">Adding vault owner</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-vault-owner">Removing vault owner</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#secret-management">Secret Management</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#listing-secrets-in-a-vault">Listing secrets in a vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-secret">Adding a secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-a-secret">Retrieving a secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copying-a-secret">Copying a secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-secret-attributes">Modifying secret attributes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-a-secret">Deleting a secret</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#escrow-operations">Escrow Operations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-vault-with-escrow">Creating a vault with escrow</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#escrowing-an-existing-vault">Escrowing an existing vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recovering-an-escrowed-secret">Recovering an escrowed secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-escrowed-vault-password">Changing escrowed vault password</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#service-operations">Service Operations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-service-vault-password">Creating service vault password</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-service-vault-password-for-service-instance">Provisioning service vault password for service instance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-service-vault-password-for-service-instance">Retrieving service vault password for service instance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-service-vault-password">Changing service vault password</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-management">Configuration Management</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#displaying-global-vault-configuration">Displaying global vault configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-global-vault-configuration">Modifying global vault configuration</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#crypto-library">Crypto Library</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-salt">Generating salt</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-password-based-symmetric-encryption-key">Generating password-based symmetric encryption key</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-asymmetric-key-pair">Generating asymmetric key pair</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#encryption-with-symmetric-algorithm">Encryption with symmetric algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#encryption-with-asymmetric-algorithm">Encryption with asymmetric algorithm</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#client-api">Client API</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipaconnection-class">IPAConnection class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-class">Vault class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#secret-class">Secret class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultclient-class">VaultClient class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultcontianer-find">vaultcontianer_find()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultcontainer-get">vaultcontainer_get()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultcontainer-add">vaultcontainer_add()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultcontainer-del">vaultcontainer_del()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-find">vault_find()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-get">vault_get()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-add">vault_add()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-update">vault_update()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-change-type">vault_change_type()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-change-escrow">vault_change_escrow()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-del">vault_del()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-archive">vault_archive()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-retrieve">vault_retrieve()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultsecret-archive">vaultsecret_archive()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultsecret-retrieve">vaultsecret_retrieve()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-change-password">vault_change_password()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-reset-password">vault_reset_password()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#approve-vault-password-reset">approve_vault_password_reset()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reject-vault-password-reset">reject_vault_password_reset()</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#web-services">Web Services</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#container-resource">Container resource</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#put-ipa-rest-vaults">PUT /ipa/rest/vaults/</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-ipa-rest-vaults">GET /ipa/rest/vaults/</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-resource">Vault resource</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">GET /ipa/rest/vaults//</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#post-ipa-rest-vaults">POST /ipa/rest/vaults/</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">POST /ipa/rest/vaults//</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#delete-ipa-rest-vaults">DELETE /ipa/rest/vaults/</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">DELETE /ipa/rest/vaults//</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#secret-resource">Secret resource</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-ipa-rest-vaults-secrets">GET /ipa/rest/vaults///secrets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#put-ipa-rest-vaults-secrets">PUT /ipa/rest/vaults///secrets</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ldap-directory">LDAP Directory</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-structure">Directory Structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ldap-schema">LDAP Schema</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-control-attributes">Access Control Attributes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#kra-service">KRA Service</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-kra-service">Installing KRA service</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#uninstalling-kra-service">Uninstalling KRA service</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kra-authentication">KRA authentication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-a-vault-into-kra">Mapping a vault into KRA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#archiving-secrets-in-kra">Archiving secrets in KRA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-secrets-from-kra">Retrieving secrets from KRA</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencies">Dependencies</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">Testing</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#frequently-asked-questions">Frequently Asked Questions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-use-python-cryptography-instead-of-python-nss">Why use Python Cryptography instead of Python NSS?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#can-different-vault-members-use-different-vault-passwords">Can different vault members use different vault passwords?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#can-the-secrets-in-the-same-vault-be-archived-with-different-passwords">Can the secrets in the same vault be archived with different passwords?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#will-the-secrets-in-the-same-vault-encrypted-with-different-encryption-keys">Will the secrets in the same vault encrypted with different encryption keys?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#can-a-vault-have-more-than-one-escrow-officer">Can a vault have more than one escrow officer?</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#to-do">To Do</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="notice-design-document">
<h1>Notice - Design Document<a class="headerlink" href="#notice-design-document" title="Link to this heading">#</a></h1>
<p>This document is a design document for a <strong>future</strong> version of Password
Vault.</p>
<p>For existing deployments, please see <a class="reference external" href="https://www.freeipa.org/page/V4/Password_Vault_1.2">the current
implementation’s</a>
page instead.</p>
</section>
<section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h1>
<p>This page describes the full implementation of <a class="reference external" href="V4/Password_Vault/Design">Password
Vault</a>. The content may still change due to
an active development.</p>
<section id="secret">
<h2>Secret<a class="headerlink" href="#secret" title="Link to this heading">#</a></h2>
<p>Secret is an information that should only be known by a limited number
of people. IPA provides a mechanism to archive, retrieve, share, and
recover secrets, and manage the access control. The secret itself will
actually be stored securely in the KRA backend.</p>
<p>A secret is a binary data, so anything can be stored as a secret, but
there will be a limit imposed by the server. A secret ID is a unique
name to identify a secret within a vault (e.g. email, pin).</p>
<p>During archival, the client will generate a random session key and use
it to encrypt the secret, then send both the encrypted secret and the
session key wrapped with KRA’s transport public key to KRA. KRA will
unwrap the session key with the transport private key, then use it to
decrypt the secret. Then KRA will encrypt the secret with the storage
key and store it in the LDAP backend.</p>
<p>During retrieval, the client will generate a random session key and send
it to the server wrapped with KRA’s transport public key. KRA will
decrypt the secret stored in the LDAP backend using the storage key,
return the secret encrypted using the session key.</p>
</section>
<section id="vault">
<h2>Vault<a class="headerlink" href="#vault" title="Link to this heading">#</a></h2>
<p>Vault is a secure place to store data or a collection of secrets. A
vault may be privately owned by a user, or shared among users, groups,
or services. A user may have multiple vaults.</p>
<p>Vault name is an identifier for the vault that is unique within a vault
container (e.g. PrivateVault is unique within /users/testuser). Vault ID
is a globally unique identifier which consists of vault name and the
container ID (e.g. /users/testuser/PrivateVault).</p>
<p>There are three types of vault which may offer additional level of
security:</p>
</section>
<section id="standard-vault">
<h2>Standard Vault<a class="headerlink" href="#standard-vault" title="Link to this heading">#</a></h2>
<p>A standard vault will use the KRA’s standard transport and storage
encryption as described above. Any authorized vault members, vault
owners, or escrow officers can read and write the secrets without having
to use a password/keys.</p>
</section>
<section id="symmetric-vault">
<h2>Symmetric Vault<a class="headerlink" href="#symmetric-vault" title="Link to this heading">#</a></h2>
<p>With symmetric vault the secrets are additionally protected with a
symmetric key generated from a vault password. The client will encrypt
secrets before sending them to the server and decrypt them after
receiving them from the server. Any authorized vault members, vault
owners, or escrow officers can read and write the secrets, but they will
have to use a shared vault password.</p>
</section>
<section id="asymmetric-vault">
<h2>Asymmetric Vault<a class="headerlink" href="#asymmetric-vault" title="Link to this heading">#</a></h2>
<p>With asymmetric vault (drop box) the secrets are additionally protected
with asymmetric keys. The client will archive the secrets using the
public key, and retrieve using the private key. The public key is
available to all vault members, but the private key is only available to
vault owners. This way vault members can archive secrets, but only vault
owners/escrow officers can retrieve them.</p>
</section>
<section id="container">
<h2>Container<a class="headerlink" href="#container" title="Link to this heading">#</a></h2>
<p>Container is a hierarchical collection of vaults and other containers.
Container name is an identifier for the container that is unique within
the parent container (e.g. testuser is unique within /users). Container
ID is a globally unique identifier that consists of the container name
and the parent container ID (e.g. /users/testuser).</p>
<p>There are several built-in vault containers:</p>
<ul class="simple">
<li><p>root container: /</p></li>
<li><p>container for user’s private vaults: /users</p></li>
<li><p>container for group’s private vaults: /groups</p></li>
<li><p>container for shared vaults: /shared</p></li>
<li><p>container for service vaults: /services</p></li>
</ul>
<p>The root container is owned by the admins group.</p>
<p>The /users container is owned by the admins group. When a user is added,
a private container (/users/) will be created automatically for this
user. The user will own the container and be able to create private
vaults (/users//) in it. When the user is removed, the private container
and its contents will be removed automatically.</p>
<p>The /shared container is owned by the admins group. The container has
ipausers as a member so all users can access shared vaults. Only the
admins can create shared vaults (/shared/).</p>
<p>The /services container is owned by the service admins group so any
service administrator can create sub-containers for the servers
(/services/) and the service vaults in it (/services//).</p>
</section>
<section id="access-control">
<h2>Access Control<a class="headerlink" href="#access-control" title="Link to this heading">#</a></h2>
<p>User’s role in determines the operations that it can execute:</p>
<ul class="simple">
<li><p>A non-member cannot access the container or vault.</p></li>
<li><p>A container member can list sub-containers and vaults in the
container.</p></li>
<li><p>A container owner can create and remove sub-containers and vaults in
the container, and manage the members and owners of the container,
but it cannot remove the container itself.</p></li>
<li><p>A vault member can list, archive, and retrieve the secrets in a
standard vault. With symmetric vault the member will need a vault
password in order to archive and retrieve secrets. With asymmetric
vault the member can only archive the secrets but not retrieve them
since it only has the public key and not the private key.</p></li>
<li><p>A vault owner can list, archive, and retrieve the secrets like vault
members, but it has the private key so it can retrieve secrets from
asymmetric vault. The owner can also manage the list of members and
owners of the vault, and change the vault password/keys.</p></li>
<li><p>An escrow officer can recover secrets and reset the vault password.</p></li>
<li><p>An administrator can do everything except accessing the secrets in
symmetric or asymmetric vaults and change/reset the password/keys.</p></li>
</ul>
</section>
</section>
<section id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Link to this heading">#</a></h1>
<p>First install IPA server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa-server-install
...
</pre></div>
</div>
<p>Then install KRA component:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa-kra-install
...
</pre></div>
</div>
<p>Authenticate as an IPA user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kinit testuser
Password for testuser@EXAMPLE.COM: ********
</pre></div>
</div>
<p>The vault is ready to use.</p>
</section>
<section id="container-managerment">
<h1>Container Managerment<a class="headerlink" href="#container-managerment" title="Link to this heading">#</a></h1>
<section id="listing-available-containers">
<h2>Listing available containers<a class="headerlink" href="#listing-available-containers" title="Link to this heading">#</a></h2>
<p>Any user can list the sub-containers within a specified container using
the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-find [parent ID] [OPTIONS]
</pre></div>
</div>
<p>If the parent ID is not specified, it will return the user’s private
containers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-find
--------------------------
2 vault containers matched
--------------------------
  Container name: personal
  Container ID: /users/testuser/personal/
  Description: Personal vaults

  Container name: work
  Container ID: /users/testuser/work/
  Description: Work vaults
----------------------------
Number of entries returned 2
----------------------------
</pre></div>
</div>
<p>If the parent ID is specified, it will return the sub-containers within
that container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-find /services
--------------------------
2 vault containers matched
--------------------------
  Container name: server1.example.com
  Container ID: /services/server1.example.com/
  Description: Vaults of services on server1.example.com

  Container name: server2.example.com
  Container ID: /services/server2.example.com/
  Description: Vaults of services on server2.example.com
----------------------------
Number of entries returned 2
----------------------------
</pre></div>
</div>
<p>Top-level containers can be listed by searching from the root container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-find /
--------------------------
3 vault containers matched
--------------------------
  Container name: users
  Container ID: /users/
  Description: Users vault container

  Container name: shared
  Container ID: /shared/
  Description: Shared vault container

  Container name: services
  Container ID: /services/
  Description: Services vault container
----------------------------
Number of entries returned 3
----------------------------
</pre></div>
</div>
</section>
<section id="displaying-container-info">
<h2>Displaying container info<a class="headerlink" href="#displaying-container-info" title="Link to this heading">#</a></h2>
<p>Any user can display the container info using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-show &lt;container ID&gt; [OPTIONS]
</pre></div>
</div>
<p>To display user’s private container’s info:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-show personal
  Container name: personal
  Container ID: /users/testuser/personal/
  Description: Personal vault container
</pre></div>
</div>
<p>To display a public container’s info:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-show /services/server.example.com
  Container name: server.example.com
  Container ID: /services/server.example.com/
  Description: Services vault container for server.example.com
</pre></div>
</div>
</section>
<section id="adding-a-container">
<h2>Adding a container<a class="headerlink" href="#adding-a-container" title="Link to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-add &lt;container ID&gt; [OPTIONS]
</pre></div>
</div>
<p>To add a private container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-add personal
--------------------------------
Added vault container &quot;personal&quot;
--------------------------------
  Container name: personal
  Container ID: /users/testuser/personal/
</pre></div>
</div>
<p>To add a public container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-add /services/server.example.com
------------------------------------------
Added vault container &quot;server.example.com&quot;
------------------------------------------
  Container name: server.example.com
  Container ID: /services/server.example.com/
</pre></div>
</div>
</section>
<section id="modifying-a-container">
<h2>Modifying a container<a class="headerlink" href="#modifying-a-container" title="Link to this heading">#</a></h2>
<p>The container owner can modify a container using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-mod &lt;container ID&gt; [OPTIONS]
</pre></div>
</div>
<p>For example, to change container description:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-show /services/server.example.com
  Container name: server.example.com
  Container ID: /services/server.example.com/

$ ipa vaultcontainer-mod /services/server.example.com --desc &quot;Services vault container for server.example.com&quot;
---------------------------------------------
Modified vault container &quot;server.example.com&quot;
---------------------------------------------
  Container name: server.example.com
  Container ID: /services/server.example.com/
  Description: Services vault container for server.example.com
</pre></div>
</div>
</section>
<section id="removing-a-container">
<h2>Removing a container<a class="headerlink" href="#removing-a-container" title="Link to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-del &lt;container ID&gt; [OPTIONS]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-del /services/server.example.com
--------------------------------------------
Deleted vault container &quot;server.example.com&quot;
--------------------------------------------
</pre></div>
</div>
</section>
<section id="adding-container-member">
<h2>Adding container member<a class="headerlink" href="#adding-container-member" title="Link to this heading">#</a></h2>
<p>A container owner can add a member to the container with the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-add-member &lt;container ID&gt; --users &lt;member ID&gt; [OPTIONS]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-add-member /services/server.example.com --users testmember
  Container name: server.example.com
  Container ID: /services/server.example.com/
  Member users: testmember
-------------------------
Number of members added 1
-------------------------
</pre></div>
</div>
</section>
<section id="removing-container-member">
<h2>Removing container member<a class="headerlink" href="#removing-container-member" title="Link to this heading">#</a></h2>
<p>A container owner can remove a member from the container with the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-remove-member &lt;container ID&gt; --users &lt;member ID&gt; [OPTIONS]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-remove-member /services/server.example.com --users testmember
  Container name: server.example.com
  Container ID: /services/server.example.com/
---------------------------
Number of members removed 1
---------------------------
</pre></div>
</div>
</section>
<section id="adding-container-owner">
<h2>Adding container owner<a class="headerlink" href="#adding-container-owner" title="Link to this heading">#</a></h2>
<p>A container owner can add another owner to the container with the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-add-owner &lt;container ID&gt; --users &lt;owner ID&gt; [OPTIONS]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-add-owner /services/server.example.com --users testowner
  Container name: server.example.com
  Container ID: /services/server.example.com/
-------------------------
Number of members added 1
-------------------------
</pre></div>
</div>
</section>
<section id="removing-container-owner">
<h2>Removing container owner<a class="headerlink" href="#removing-container-owner" title="Link to this heading">#</a></h2>
<p>A container owner can remove another owner from the container with the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-remove-owner &lt;container ID&gt; --users &lt;owner ID&gt; [OPTIONS]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-remove-owner /services/server.example.com --users testowner
  Container name: server.example.com
  Container ID: /services/server.example.com/
---------------------------
Number of members removed 1
---------------------------
</pre></div>
</div>
</section>
</section>
<section id="vault-management">
<h1>Vault Management<a class="headerlink" href="#vault-management" title="Link to this heading">#</a></h1>
<section id="listing-available-vaults">
<h2>Listing available vaults<a class="headerlink" href="#listing-available-vaults" title="Link to this heading">#</a></h2>
<p>A user can search the vaults that it owns or it’s a member of using the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-find [container ID] [OPTIONS]
</pre></div>
</div>
<p>By default the command will list the vaults in the user’s private
container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-find
---------------
1 entries found
---------------
  Vault name: PrivateVault
  Vault ID: /users/testuser/PrivateVault
  Description: Private vault
  Type: standard
----------------------------
Number of entries returned 1
----------------------------
</pre></div>
</div>
<p>To find shared vaults, specify -shared:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-find --shared
---------------
1 entries found
---------------
  Vault name: IPA
  Vault ID: /shared/projects/IPA
  Description: IPA project
  Type: standard
----------------------------
Number of entries returned 1
----------------------------
</pre></div>
</div>
<p>To find service vaults, specify –services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-find --services
---------------
1 entries found
---------------
  Vault name: HTTP
  Vault ID: /services/server.example.com/HTTP
  Description: HTTP service on server.example.com
  Type: standard
----------------------------
Number of entries returned 1
----------------------------
</pre></div>
</div>
</section>
<section id="displaying-vault-info">
<h2>Displaying vault info<a class="headerlink" href="#displaying-vault-info" title="Link to this heading">#</a></h2>
<p>A user can view a particular vault info using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-show &lt;vault ID&gt; [OPTIONS]
</pre></div>
</div>
<p>To display the basic vault info:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-show /shared/SymmetricVault
  Vault name: SymmetricVault
  Vault ID: /shared/SymmetricVault
  Description: Symmetric vault
  Type: standard
</pre></div>
</div>
<p>To display the complete vault info:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-show /shared/SymmetricVault --all
  Vault name: SymmetricVault
  Vault ID: /shared/SymmetricVault
  Description: Symmetric vault
  Type: symmetric
  Secret salt: ....
</pre></div>
</div>
</section>
<section id="creating-a-new-vault">
<h2>Creating a new vault<a class="headerlink" href="#creating-a-new-vault" title="Link to this heading">#</a></h2>
<p>A container member can create a vault using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add &lt;vault ID&gt; [OPTIONS]
</pre></div>
</div>
<p>Private vaults can be created by specifying a relative vault ID:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add PrivateVault --desc &quot;Private vault&quot;
--------------------------
Added vault &quot;PrivateVault&quot;
--------------------------
  Vault name: PrivateVault
  Vault ID: /users/testuser/PrivateVault
  Description: Private vault
  Type: standard
</pre></div>
</div>
<p>Non-private vaults can be created by specifying an absolute vault ID:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add /shared/SharedVault --desc &quot;Shared vault&quot;
---------------------------------
Added vault &quot;SharedVault&quot;
---------------------------------
  Vault name: SharedVault
  Vault ID: /shared/SharedVault
  Description: Shared vault
  Type: standard
</pre></div>
</div>
<p>Symmetric vaults can be created by specifying the type and the password.
The password can be provided interactively, specified in the command
option, or specified in a file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add SymmetricVault --desc &quot;Symmetric vault&quot; --type symmetric
New password: ********
Verify password: ********
----------------------------
Added vault &quot;SymmetricVault&quot;
----------------------------
  Vault name: SymmetricVault
  Vault ID: /users/testuser/SymmetricVault
  Description: Symmetric vault
  Type: symmetric

$ ipa vault-add SymmetricVault --desc &quot;Symmetric vault&quot; --type symmetric --password mypassword
----------------------------
Added vault &quot;SymmetricVault&quot;
----------------------------
  Vault name: SymmetricVault
  Vault ID: /users/testuser/SymmetricVault
  Description: Symmetric vault
  Type: symmetric

$ ipa vault-add SymmetricVault --desc &quot;Symmetric vault&quot; --type symmetric -password-file password.txt
----------------------------
Added vault &quot;SymmetricVault&quot;
----------------------------
  Vault name: SymmetricVault
  Vault ID: /users/testuser/SymmetricVault
  Description: Symmetric vault
  Type: symmetric
</pre></div>
</div>
<p>Asymmetric vaults can be created by specifying the type and the public
key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add AsymmetricVault --desc &quot;Asymmetric vault&quot; --type asymmetric --public-key-file public.pem
-----------------------------
Added vault &quot;AsymmetricVault&quot;
-----------------------------
  Vault name: AsymmetricVault
  Vault ID: /users/testuser/AsymmetricVault
  Description: Asymmetric vault
  Type: asymmetric
</pre></div>
</div>
</section>
<section id="archiving-data">
<h2>Archiving data<a class="headerlink" href="#archiving-data" title="Link to this heading">#</a></h2>
<p>A vault member/owner can archive data using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-archive &lt;vault ID&gt; [--in &lt;input file&gt; | --text &lt;text&gt; | --data &lt;base-64 encoded data&gt; | --stdin] [OPTIONS]
</pre></div>
</div>
<p>With a standard vault the operation can be done directly.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-archive StandardVault --in secret.txt
----------------------------------------
Archived data into vault &quot;StandardVault&quot;
----------------------------------------

$ ipa vault-archive StandardVault --text &quot;secret&quot;
----------------------------------------
Archived data into vault &quot;StandardVault&quot;
----------------------------------------

$ ipa vault-archive StandardVault --data c2VjcmV0Cg==
----------------------------------------
Archived data into vault &quot;StandardVault&quot;
----------------------------------------

$ echo secret | ipa vault-archive StandardVault --stdin
----------------------------------------
Archived data into vault &quot;StandardVault&quot;
----------------------------------------
</pre></div>
</div>
<p>With a symmetric vault the operation requires a password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-archive SymmetricVault --in secret.txt
Password: ********
-----------------------------------------
Archived data into vault &quot;SymmetricVault&quot;
-----------------------------------------
</pre></div>
</div>
<p>With an asymmetric vault the operation does not require anything since
the vault public key is stored in one of vault attributes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-archive AsymmetricVault --in secret.txt
------------------------------------------
Archived data into vault &quot;AsymmetricVault&quot;
------------------------------------------
</pre></div>
</div>
</section>
<section id="retrieving-data">
<h2>Retrieving data<a class="headerlink" href="#retrieving-data" title="Link to this heading">#</a></h2>
<p>A vault member/owner can be retrieve data using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-retrieve &lt;vault ID&gt; [--out &lt;output file&gt; | --stdout] [OPTIONS]
</pre></div>
</div>
<p>With a standard vault the operation can be done directly.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-retrieve StandardVault --out secret.txt
-----------------------------------------
Retrieved data from vault &quot;StandardVault&quot;
-----------------------------------------

$ ipa vault-retrieve StandardVault --stdout
secret
</pre></div>
</div>
<p>With a symmetric vault the operation requires a password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-retrieve SymmetricVault --out secret.txt
Password: ********
------------------------------------------
Retrieved data from vault &quot;SymmetricVault&quot;
------------------------------------------
</pre></div>
</div>
<p>With an asymmetric vault the operation requires a private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-retrieve AsymmetricVault --out secret.txt --private-key-file private.pem
-------------------------------------------
Retrieved data from vault &quot;AsymmetricVault&quot;
-------------------------------------------
</pre></div>
</div>
</section>
<section id="copying-a-vault">
<h2>Copying a vault<a class="headerlink" href="#copying-a-vault" title="Link to this heading">#</a></h2>
<p>A container member can copy a vault that it has access to using the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add &lt;vault ID&gt; --source-vault-id &lt;source vault ID&gt; [OPTIONS]
</pre></div>
</div>
<p>Password or private of the source vault is not required to copy, but it
is still required to access the secrets.</p>
<p>To copy a private vault into a new private vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add NewPrivateVault --source-vault-id PrivateVault
-----------------------------
Added vault &quot;NewPrivateVault&quot;
-----------------------------
  Vault name: NewPrivateVault
  Vault ID: /users/testuser/NewPrivateVault
  Type: standard
</pre></div>
</div>
<p>To copy a private vault into a new shared vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add /shared/NewSharedVault --source-vault-id PrivateVault
----------------------------
Added vault &quot;NewSharedVault&quot;
----------------------------
  Vault name: NewSharedVault
  Vault ID: /shared/NewSharedVault
  Type: standard
</pre></div>
</div>
</section>
<section id="modifying-a-vault">
<h2>Modifying a vault<a class="headerlink" href="#modifying-a-vault" title="Link to this heading">#</a></h2>
<p>The vault owner can modify a vault using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-mod &lt;vault ID&gt; [OPTIONS]
</pre></div>
</div>
<p>For example, to change vault description:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-show PrivateVault
  Vault name: PrivateVault
  Vault ID: /users/testuser/PrivateVault
  Description: Private vault
  Type: standard

$ ipa vault-mod PrivateVault --desc &quot;This is a private vault&quot;
-----------------------------
Modified vault &quot;PrivateVault&quot;
-----------------------------
  Vault name: PrivateVault
  Vault ID: /users/testuser/PrivateVault
  Description: This is a private vault
  Type: standard
</pre></div>
</div>
<p>To convert a symmetric vault into an asymmetric vault the old password
and the new public key must be specified:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-show PrivateVault
  Vault name: PrivateVault
  Vault ID: /users/testuser/PrivateVault
  Description: Private vault
  Type: symmetric

$ ipa vault-mod PrivateVault --type asymmetric --public-key-file public.pem
Password: ********
-----------------------------
Modified vault &quot;PrivateVault&quot;
-----------------------------
  Vault name: PrivateVault
  Vault ID: /users/testuser/PrivateVault
  Description: Private vault
  Type: asymmetric
</pre></div>
</div>
<p>To convert an asymmetric vault into a symmetric vault the old private
key and the new password must be specified:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-show PrivateVault
  Vault name: PrivateVault
  Vault ID: /users/testuser/PrivateVault
  Description: Private vault
  Type: asymmetric

$ ipa vault-mod PrivateVault --type symmetric --private-key-file private.pem
Password: ********
Verify password: ********
-----------------------------
Modified vault &quot;PrivateVault&quot;
-----------------------------
  Vault name: PrivateVault
  Vault ID: /users/testuser/PrivateVault
  Description: Private vault
  Type: symmetric
</pre></div>
</div>
</section>
<section id="removing-a-vault">
<h2>Removing a vault<a class="headerlink" href="#removing-a-vault" title="Link to this heading">#</a></h2>
<p>To remove a vault the owner can execute the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-del &lt;vault ID&gt; [OPTIONS]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-del PrivateVault
----------------------------
Deleted vault &quot;PrivateVault&quot;
----------------------------
</pre></div>
</div>
</section>
<section id="changing-vault-password">
<h2>Changing vault password<a class="headerlink" href="#changing-vault-password" title="Link to this heading">#</a></h2>
<p>An owner can change the vault password or keys using the following
command.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-password &lt;vault ID&gt; [OPTIONS]
</pre></div>
</div>
<p>An owner can change the password of a symmetric vault by providing the
old password and the new password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-password SymmetricVault
Password: ********
New password: ********
Verify new password: ********
---------------------------------------
Changed &quot;SymmetricVault&quot; vault password
---------------------------------------
</pre></div>
</div>
<p>An owner can change the keys of an asymmetric vault by providing the old
private key and the new public key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-password AsymmetricVault --private-key-file private.pem --new-public-key-file new-public.pem
------------------------------------
Changed &quot;AsymmetricVault&quot; vault keys
------------------------------------
</pre></div>
</div>
</section>
<section id="adding-vault-member">
<h2>Adding vault member<a class="headerlink" href="#adding-vault-member" title="Link to this heading">#</a></h2>
<p>A vault owner can add members to the vault with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add-member &lt;vault ID&gt; [--users &lt;list of user IDs&gt;] [--groups &lt;list of group IDs&gt;]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add-member MyVault --users testmember
---------------------------------
Added members to &quot;MyVault &quot; vault
---------------------------------
</pre></div>
</div>
</section>
<section id="removing-vault-member">
<h2>Removing vault member<a class="headerlink" href="#removing-vault-member" title="Link to this heading">#</a></h2>
<p>A vault owner can remove a member from the vault with the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-remove-member &lt;vault ID&gt; [--users &lt;list of user IDs&gt;] [--groups &lt;list of group IDs&gt;]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-remove-member MyVault --users testmember
-------------------------------------
Removed members from &quot;MyVault &quot; vault
-------------------------------------
</pre></div>
</div>
</section>
<section id="adding-vault-owner">
<h2>Adding vault owner<a class="headerlink" href="#adding-vault-owner" title="Link to this heading">#</a></h2>
<p>An owner can add another owner to the vault with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add-owner &lt;vault ID&gt; [--users &lt;list of user IDs&gt;] [--groups &lt;list of group IDs&gt;]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add-owner MyVault --users testowner
----------------------------------
Added owners from &quot;MyVault &quot; vault
----------------------------------
</pre></div>
</div>
</section>
<section id="removing-vault-owner">
<h2>Removing vault owner<a class="headerlink" href="#removing-vault-owner" title="Link to this heading">#</a></h2>
<p>An owner can remove another owner from the vault with the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-remove-owner &lt;vault ID&gt; [--users &lt;list of user IDs&gt;] [--groups &lt;list of group IDs&gt;]
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-remove-owner MyVault --users testowner
------------------------------------
Removed owners from &quot;MyVault &quot; vault
------------------------------------
</pre></div>
</div>
</section>
</section>
<section id="secret-management">
<h1>Secret Management<a class="headerlink" href="#secret-management" title="Link to this heading">#</a></h1>
<section id="listing-secrets-in-a-vault">
<h2>Listing secrets in a vault<a class="headerlink" href="#listing-secrets-in-a-vault" title="Link to this heading">#</a></h2>
<p>A vault member/owner can list the secrets in a vault using the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-find &lt;vault ID&gt; [OPTIONS]
</pre></div>
</div>
<p>With a standard vault the secrets can be listed directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-find StandardVault
---------------
2 entries found
---------------
  Secret ID: gmail
  Description: Gmail password

  Secret ID: yahoo
  Description: Yahoo! Mail password
----------------------------
Number of entries returned 2
----------------------------
</pre></div>
</div>
<p>With a symmetric vault the operation requires a password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-find SymmetricVault
Password: ********
---------------
2 entries found
---------------
  Secret ID: gmail
  Description: Gmail password

  Secret ID: yahoo
  Description: Yahoo! Mail password
----------------------------
Number of entries returned 2
----------------------------
</pre></div>
</div>
<p>A vault owner can list the secrets in an asymmetric vault by providing
the vault private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-find AsymmetricVault --private-key-file private.pem
---------------
2 entries found
---------------
  Secret ID: gmail
  Description: Gmail password

  Secret ID: yahoo
  Description: Yahoo! Mail password
----------------------------
Number of entries returned 2
----------------------------
</pre></div>
</div>
</section>
<section id="adding-a-secret">
<h2>Adding a secret<a class="headerlink" href="#adding-a-secret" title="Link to this heading">#</a></h2>
<p>A vault member/owner can add a secret using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add &lt;vault ID&gt; &lt;secret ID&gt; [OPTIONS]
</pre></div>
</div>
<p>With a standard vault the operation can be done directly. The secret can
be provided interactively, via an input file, or via standard input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add StandardVault MySecret
Secret: ********
Verify secret: ********
-----------------------------
Added vault secret &quot;MySecret&quot;
-----------------------------
  Secret name: MySecret
  Data: c2VjcmV0

$ ipa vaultsecret-add StandardVault MySecret --in secret.txt
-----------------------------
Added vault secret &quot;MySecret&quot;
-----------------------------
  Secret name: MySecret
  Data: c2VjcmV0

$ echo secret | ipa vaultsecret-add StandardVault MySecret --stdin
-----------------------------
Added vault secret &quot;MySecret&quot;
-----------------------------
  Secret name: MySecret
  Data: c2VjcmV0
</pre></div>
</div>
<p>With a symmetric vault the operation requires a password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add SymmetricVault MySecret --in secret.txt
Password: ********
-----------------------------
Added vault secret &quot;MySecret&quot;
-----------------------------
  Secret name: MySecret
  Data: c2VjcmV0
</pre></div>
</div>
<p>With an asymmetric vault the operation requires a private key.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add AsymmetricVault MySecret --in secret.txt --private-key private-key.pem
-----------------------------
Added vault secret &quot;MySecret&quot;
-----------------------------
  Secret name: MySecret
  Data: c2VjcmV0
</pre></div>
</div>
</section>
<section id="retrieving-a-secret">
<h2>Retrieving a secret<a class="headerlink" href="#retrieving-a-secret" title="Link to this heading">#</a></h2>
<p>A vault member/owner can be retrieve a secret using the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-show &lt;vault ID&gt; &lt;secret ID&gt; [OPTIONS]
</pre></div>
</div>
<p>With a standard vault the operation can be done directly. The secret can
be stored in an output file or directed to standard output.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-show StandardVault MySecret
  Secret name: MySecret
  Data: c2VjcmV0

$ ipa vaultsecret-show StandardVault MySecret --out secret.txt

$ ipa vaultsecret-show StandardVault MySecret --stdout
secret
</pre></div>
</div>
<p>With a symmetric vault the operation requires a password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-show SymmetricVault MySecret --out secret.txt
Password: ********
</pre></div>
</div>
<p>With an asymmetric vault the operation requires a private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-show AsymmetricVault MySecret --out secret.txt --private-key-file private.pem
</pre></div>
</div>
</section>
<section id="copying-a-secret">
<h2>Copying a secret<a class="headerlink" href="#copying-a-secret" title="Link to this heading">#</a></h2>
<p>Secret can be copied using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add &lt;vault ID&gt; &lt;secret ID&gt; [--source-vault &lt;source vault ID&gt;] [--source-secret &lt;source secret ID&gt;] [OPTIONS]
</pre></div>
</div>
<p>The copy operation will be done using the retrieval and archival
operations, so depending on the vault types, it may require the
password/key of all vaults involved.</p>
<p>To copy a secret into another secret in the same vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add StandardVault NewSecret --source-secret MySecret
------------------------------
Added vault secret &quot;NewSecret&quot;
------------------------------
</pre></div>
</div>
<p>To copy a secret from a vault into another vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add /shared/SharedVault MySecret --source-vault PrivateVault
-----------------------------
Added vault secret &quot;MySecret&quot;
-----------------------------
</pre></div>
</div>
<p>To copy a secret into another vault with a different name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add /shared/SharedVault NewSecret --source-vault PrivateVault --source-secret MySecret
------------------------------
Added vault secret &quot;NewSecret&quot;
------------------------------
</pre></div>
</div>
<p>To copy a secret from a symmetric vault into an asymmetric vault (this
will replace all secrets in the asymmetric vault):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add AsymmetricVault MySecret --source-vault SymmetricVault
Source Password: ********
-----------------------------
Added vault secret &quot;MySecret&quot;
-----------------------------
</pre></div>
</div>
<p>To copy a secret from an asymmetric vault into a symmetric vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-add SymmetricVault MySecret --source-vault AsymmetricVault --source-private-key private-key.pem
Password: ********
-----------------------------
Added vault secret &quot;MySecret&quot;
-----------------------------
</pre></div>
</div>
</section>
<section id="modifying-secret-attributes">
<h2>Modifying secret attributes<a class="headerlink" href="#modifying-secret-attributes" title="Link to this heading">#</a></h2>
<p>Secret attributes can be modified using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-mod &lt;vault ID&gt; &lt;secret ID&gt; [OPTIONS]
</pre></div>
</div>
<p>For example, to modify secret description:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-mod StandardVault MySecret --desc &quot;My secret&quot;
--------------------------------
Modified vault secret &quot;MySecret&quot;
--------------------------------
  Secret name: MySecret
  Description: My secret
  Data: c2VjcmV0
</pre></div>
</div>
</section>
<section id="deleting-a-secret">
<h2>Deleting a secret<a class="headerlink" href="#deleting-a-secret" title="Link to this heading">#</a></h2>
<p>A secret can be removed using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-del &lt;vault ID&gt; &lt;secret ID&gt; [OPTIONS]
</pre></div>
</div>
<p>With a standard vault the operation can be done directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-del StandardVault MySecret
-------------------------------
Deleted vault secret &quot;MySecret&quot;
-------------------------------
</pre></div>
</div>
<p>With a symmetric vault the operation requires a vault password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-del SymmetricVault secret
Password: ********
-------------------------------
Deleted vault secret &quot;MySecret&quot;
-------------------------------
</pre></div>
</div>
<p>With an asymmetric vault the operation requires a vault private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultsecret-del AsymmetricVault secret --private-key private-key.pem
-------------------------------
Deleted vault secret &quot;MySecret&quot;
-------------------------------
</pre></div>
</div>
</section>
</section>
<section id="escrow-operations">
<h1>Escrow Operations<a class="headerlink" href="#escrow-operations" title="Link to this heading">#</a></h1>
<p>Vault encryption key can be escrowed such that if needed the escrow
officer can recover the secrets.</p>
<section id="creating-a-vault-with-escrow">
<h2>Creating a vault with escrow<a class="headerlink" href="#creating-a-vault-with-escrow" title="Link to this heading">#</a></h2>
<p>An escrowed symmetric vault can be created with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add EscrowedSymmetricVault --type symmetric --escrow-public-key-file escrow-public.pem
New password: ********
Verify password: ********
------------------------------------
Added vault &quot;EscrowedSymmetricVault&quot;
------------------------------------
  Vault name: EscrowedSymmetricVault
  Vault ID: /users/testuser/EscrowedSymmetricVault
  Vault type: symmetric
</pre></div>
</div>
<p>An escrowed asymmetric vault can be created with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add EscrowedAsymmetricVault --type asymmetric --public-key-file public.pem --escrow-public-key-file escrow-public.pem
-------------------------------------
Added vault &quot;EscrowedAsymmetricVault&quot;
-------------------------------------
  Vault name: EscrowedAsymmetricVault
  Vault ID: /users/testuser/EscrowedAsymmetricVault
  Vault type: asymmetric
</pre></div>
</div>
</section>
<section id="escrowing-an-existing-vault">
<h2>Escrowing an existing vault<a class="headerlink" href="#escrowing-an-existing-vault" title="Link to this heading">#</a></h2>
<p>A vault owner can escrow an existing symmetric vault by providing the
escrow public key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-mod SymmetricVault --escrow true --escrow-public-key-file escrow-public.pem
Password: ********
-------------------------------
Modified vault &quot;SymmetricVault&quot;
-------------------------------
</pre></div>
</div>
<p>A vault owner can escrow an existing asymmetric vault by providing the
vault private key and the escrow public key</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-mod AsymmetricVault --escrow true --private-key-file private.pem --escrow-public-key-file escrow-public.pem
--------------------------------
Modified vault &quot;AsymmetricVault&quot;
--------------------------------
</pre></div>
</div>
<p>A vault owner can unescrow a vault box as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-mod Vault --escrow-public-key NONE
----------------------
Modified vault &quot;Vault&quot;
----------------------
</pre></div>
</div>
</section>
<section id="recovering-an-escrowed-secret">
<h2>Recovering an escrowed secret<a class="headerlink" href="#recovering-an-escrowed-secret" title="Link to this heading">#</a></h2>
<p>An escrow officer can recover the secret by specifying the escrow
private key to decrypt the secret key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-retrieve EscrowedVault --escrow-private-key-file escrow-private.pem --out secret.txt
-----------------------------------------
Retrieved data from vault &quot;EscrowedVault&quot;
-----------------------------------------
</pre></div>
</div>
</section>
<section id="changing-escrowed-vault-password">
<h2>Changing escrowed vault password<a class="headerlink" href="#changing-escrowed-vault-password" title="Link to this heading">#</a></h2>
<p>If the current symmetric vault password is known, the owner can change
it by providing the old password and the new password. The new secret
key will automatically be escrowed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-password EscrowedSymmetricVault
Password: *********
New password: *********
Verify password: ********
-------------------------
Password change completed
-------------------------
</pre></div>
</div>
<p>If the current password is unknown, the owner can request password
reset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-password EscrowedSymmetricVault --reset
New password: *********
Verify password: ********
-----------------------
Password change pending
-----------------------
</pre></div>
</div>
<p>The escrow officer can approve the request as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-password /users/testuser/EscrowedSymmetricVault --approve --escrow-private-key-file escrow-private.pem
-------------------------
Password change completed
-------------------------
</pre></div>
</div>
<p>If necessary, the escrow officer can reject the request as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-password /users/testuser/EscrowedSymmetricVault --reject
------------------------
Password change canceled
------------------------
</pre></div>
</div>
</section>
</section>
<section id="service-operations">
<h1>Service Operations<a class="headerlink" href="#service-operations" title="Link to this heading">#</a></h1>
<section id="creating-service-vault-password">
<h2>Creating service vault password<a class="headerlink" href="#creating-service-vault-password" title="Link to this heading">#</a></h2>
<p>A service administrator can create a service vault password by archiving
a new secret into a private vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-add ldap_password --in password.txt
---------------------------
Added vault &quot;ldap_password&quot;
---------------------------
  Vault name: ldap_password
  Vault ID: /users/admin/ldap_password
  Type: standard
</pre></div>
</div>
</section>
<section id="provisioning-service-vault-password-for-service-instance">
<h2>Provisioning service vault password for service instance<a class="headerlink" href="#provisioning-service-vault-password-for-service-instance" title="Link to this heading">#</a></h2>
<p>A service administrator can provision the service vault password to a
specific service instance using a service vault. To create a service
vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-add /services/&lt;server name&gt;
$ ipa vault-add /services/&lt;server name&gt;/&lt;service name&gt; --type asymmetric --public-key &lt;service public key&gt;
</pre></div>
</div>
<p>To copy the service vault password into the service vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-archive /services/&lt;server name&gt;/&lt;service name&gt; --source-vault-id &lt;vault ID&gt;
</pre></div>
</div>
<p>The command will retrieve the service vault password already archived
earlier, then encrypt it with the service instance’s public key. The
public key will be obtained from the service certificate that’s already
generated previously on the server.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vaultcontainer-add /services/server.example.com
------------------------------------------
Added vault container &quot;server.example.com&quot;
------------------------------------------
  Container name: server.example.com
  Container ID: /services/server.example.com/

$ ipa vault-add /services/server.example.com/LDAP --type asymmetric --public-key-file service-public.pem
------------------
Added vault &quot;LDAP&quot;
------------------
  Vault name: LDAP
  Vault ID: /services/server.example.com/LDAP
  Type: asymmetric

$ ipa vault-archive /services/server.example.com/LDAP --source-vault-id ldap_password
-------------------------------
Archived data into vault &quot;LDAP&quot;
-------------------------------
  Vault name: LDAP
  Vault ID: /services/server.example.com/LDAP
  Type: asymmetric
</pre></div>
</div>
</section>
<section id="retrieving-service-vault-password-for-service-instance">
<h2>Retrieving service vault password for service instance<a class="headerlink" href="#retrieving-service-vault-password-for-service-instance" title="Link to this heading">#</a></h2>
<p>A service instance can retrieve the service vault password using the
service private key stored locally:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-retrieve /services/server.example.com/LDAP --private-key-file service-private.pem --out password.txt
--------------------------------
Retrieved data from vault &quot;LDAP&quot;
--------------------------------
  Vault name: LDAP
  Vault ID: /services/server.example.com/LDAP
  Type: asymmetric
</pre></div>
</div>
</section>
<section id="changing-service-vault-password">
<h2>Changing service vault password<a class="headerlink" href="#changing-service-vault-password" title="Link to this heading">#</a></h2>
<p>The service administrator can change the service vault password by
archiving a new secret:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-archive ldap_password --in new_password.txt
----------------------------------------
Archived data into vault &quot;ldap_password&quot;
----------------------------------------
  Vault name: ldap_password
  Vault ID: /users/admin/ldap_password
  Type: standard
</pre></div>
</div>
<p>The service administrator will need to re-provision the new service
vault password to each service instance using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-archive /services/server.example.com/LDAP --source-vault-id ldap_password
-------------------------------
Archived data into vault &quot;LDAP&quot;
-------------------------------
  Vault name: LDAP
  Vault ID: /services/server.example.com/LDAP
  Type: asymmetric
</pre></div>
</div>
<p>This way if there’s a compromised instance the service administrator can
isolate it by changing the service vault password and re-provisioning it
to non-compromised instances only.</p>
</section>
</section>
<section id="configuration-management">
<h1>Configuration Management<a class="headerlink" href="#configuration-management" title="Link to this heading">#</a></h1>
<section id="displaying-global-vault-configuration">
<h2>Displaying global vault configuration<a class="headerlink" href="#displaying-global-vault-configuration" title="Link to this heading">#</a></h2>
<p>A user can view the global vault configuration using the following
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-config-show
  Maximum secret size: 1024 bytes
  Maximum vault size: 10 secrets
</pre></div>
</div>
</section>
<section id="modifying-global-vault-configuration">
<h2>Modifying global vault configuration<a class="headerlink" href="#modifying-global-vault-configuration" title="Link to this heading">#</a></h2>
<p>An administrator can modify the global vault configuration using the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-config-mod [OPTIONS]
</pre></div>
</div>
<p>Note that configuration changes will only affect operations executed
after the change.</p>
<p>For example, to change the maximum secret size:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa vault-config-mod --max-secret-size 1024
</pre></div>
</div>
</section>
</section>
<section id="crypto-library">
<h1>Crypto Library<a class="headerlink" href="#crypto-library" title="Link to this heading">#</a></h1>
<p>A crypto libray is needed to generate encryption keys and salts, and
encrypt/decrypt the secrets in vault. On the server side IPA and Dogtag
use the NSS library. On the client side the IPA client will use Python
NSS for transport encryption and Python Cryptography for additional
client-side encryption.</p>
<p>The <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Python_binding_for_NSS">Python
NSS</a>
is a Python interface for NSS. IPA already has a dependency on Python
NSS on both client and server.</p>
<p>The <a class="reference external" href="http://pki.fedoraproject.org/wiki/Python_Cryptography">Python
Cryptography</a>
provides a generic interface for various crypto libraries such as
OpenSSL and CommonCrypto as backends. Currently it does not support NSS
backend, but it may be added in the future.</p>
<p>Currently Python Cryptography is only available in Fedora via
<a class="reference external" href="https://cryptography.io/en/latest/installation/">pip</a>. <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1114267">Ticket
#1114267</a> will
add the package to Fedora.</p>
<p>The <a class="reference external" href="https://github.com/pyca/cryptography/issues/1036">X.509 certificate
support</a> is
supposed to be added in version 0.6.</p>
<section id="generating-salt">
<h2>Generating salt<a class="headerlink" href="#generating-salt" title="Link to this heading">#</a></h2>
<p>Python NSS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">salt</span> <span class="o">=</span> <span class="n">nss</span><span class="o">.</span><span class="n">generate_random</span><span class="p">(</span><span class="n">salt_length</span><span class="p">)</span>
</pre></div>
</div>
<p>Python Cryptography:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">salt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="n">salt_length</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="generating-password-based-symmetric-encryption-key">
<h2>Generating password-based symmetric encryption key<a class="headerlink" href="#generating-password-based-symmetric-encryption-key" title="Link to this heading">#</a></h2>
<p>Symmetric encryption key can be generated using a key derivation
algorithm such as <a class="reference external" href="http://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> which
takes a vault password and a randomly generated salt. In order to
generate the same key from the same password, the same salt must be used
again.</p>
<p>In NSS the PBKDF2 can be invoked using the following C code. However,
currently Python NSS does not provide an interface to call these NSS
functions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SECItem</span> <span class="n">password</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">siBuffer</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="n">password</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="n">password</span> <span class="n">length</span><span class="o">&gt;</span>
<span class="p">};</span>

<span class="n">SECItem</span> <span class="n">salt</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">siBuffer</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="n">salt</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="n">salt</span> <span class="n">length</span><span class="o">&gt;</span>
<span class="p">};</span>

<span class="n">void</span> <span class="o">*</span><span class="n">nullptr</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>

<span class="n">SECAlgorithmID</span> <span class="o">*</span><span class="n">algID</span> <span class="o">=</span> <span class="n">PK11_CreatePBEV2AlgorithmID</span><span class="p">(</span>
    <span class="n">SEC_OID_PKCS5_PBKDF2</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="nb">hash</span> <span class="n">function</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="n">pseudo</span> <span class="n">random</span> <span class="n">function</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="n">key</span> <span class="n">length</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="o">&lt;</span><span class="n">iteration</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">salt</span><span class="p">);</span>

<span class="n">PK11SlotInfo</span> <span class="o">*</span><span class="n">slot</span> <span class="o">=</span> <span class="n">PK11_GetBestSlot</span><span class="p">(</span><span class="n">SEC_OID_PKCS5_PBKDF2</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>

<span class="n">PK11SymKey</span> <span class="o">*</span><span class="n">symKey</span> <span class="o">=</span> <span class="n">PK11_PBEKeyGen</span><span class="p">(</span>
    <span class="n">slot</span><span class="p">,</span>
    <span class="n">algID</span><span class="p">,</span>
    <span class="o">&amp;</span><span class="n">password</span><span class="p">,</span>
    <span class="n">PR_FALSE</span><span class="p">,</span>
    <span class="n">nullptr</span><span class="p">);</span>

<span class="n">SECOID_DestroyAlgorithmID</span><span class="p">(</span><span class="n">algID</span><span class="p">,</span> <span class="n">PR_TRUE</span><span class="p">);</span>
</pre></div>
</div>
<p>Python Cryptography
(<a class="reference external" href="https://cryptography.io/en/latest/hazmat/primitives/key-derivation-functions/">docs</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kdf</span> <span class="o">=</span> <span class="n">PBKDF2HMAC</span><span class="p">(</span>
    <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
    <span class="n">length</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
    <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span>
    <span class="n">iterations</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">symmetric_key</span> <span class="o">=</span> <span class="n">kdf</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">vault_password</span><span class="p">)</span>
</pre></div>
</div>
<p>If FIPS certification is not required, the
<a class="reference external" href="https://github.com/ricmoo/pyscrypt">scrypt</a> might be a better
option.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">symmetric_key</span> <span class="o">=</span> <span class="n">pyscrypt</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span>
    <span class="n">vault_password</span><span class="p">,</span>
    <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span>
    <span class="n">N</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
    <span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">dkLen</span><span class="o">=</span><span class="mi">256</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Web Crypto
(<a class="reference external" href="https://dvcs.w3.org/hg/webcrypto-api/raw-file/tip/spec/Overview.html#pbkdf2">spec</a>,
<a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1021607">implementation</a>,
<a class="reference external" href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=25819">example</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">enc_salt</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">var</span> <span class="n">deriveBitsOp</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">subtle</span><span class="o">.</span><span class="n">deriveBits</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">name</span> <span class="p">:</span> <span class="s2">&quot;PBKDF2&quot;</span><span class="p">,</span>
        <span class="n">salt</span><span class="p">:</span> <span class="n">salt</span><span class="p">,</span>
        <span class="n">iterations</span><span class="p">:</span> <span class="mi">100000</span><span class="p">,</span>
        <span class="nb">hash</span><span class="p">:</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;SHA-256&quot;</span> <span class="p">}</span>
    <span class="p">},</span>
    <span class="n">vault_password</span><span class="p">,</span>
    <span class="mi">256</span>
<span class="p">);</span>

<span class="n">deriveBitsOp</span><span class="o">.</span><span class="n">oncomplete</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">symmetric_key</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">result</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="generating-asymmetric-key-pair">
<h2>Generating asymmetric key pair<a class="headerlink" href="#generating-asymmetric-key-pair" title="Link to this heading">#</a></h2>
<p>The asymmetric key pair can be generated using OpenSSL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ openssl genrsa -out private.pem 2048
$ openssl rsa -in private.pem -out public.pem -pubout
</pre></div>
</div>
<p>Then the above PEM files can be loaded into Python Cryptography:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public_key</span> <span class="o">=</span> <span class="n">load_pem_public_key</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">public_pem</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">private_key</span> <span class="o">=</span> <span class="n">load_pem_private_key</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">private_pem</span><span class="p">,</span>
    <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<p>PyCrypto:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">private_key</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
<span class="n">private_pem</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">exportKey</span><span class="p">(</span><span class="s1">&#39;PEM&#39;</span><span class="p">)</span>
<span class="n">public_pem</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">publickey</span><span class="p">()</span><span class="o">.</span><span class="n">exportKey</span><span class="p">(</span><span class="s1">&#39;PEM&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="encryption-with-symmetric-algorithm">
<h2>Encryption with symmetric algorithm<a class="headerlink" href="#encryption-with-symmetric-algorithm" title="Link to this heading">#</a></h2>
<p>In a symmetric vault the secrets will be encrypted/decrypted using
symmetric-key algorithm.</p>
<p>Python NSS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iv_si</span> <span class="o">=</span> <span class="n">nss</span><span class="o">.</span><span class="n">SecItem</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>
<span class="n">iv_param</span> <span class="o">=</span> <span class="n">nss</span><span class="o">.</span><span class="n">param_from_iv</span><span class="p">(</span><span class="n">mechanism</span><span class="p">,</span> <span class="n">iv_si</span><span class="p">)</span>

<span class="n">encryptor</span> <span class="o">=</span> <span class="n">nss</span><span class="o">.</span><span class="n">create_context_by_sym_key</span><span class="p">(</span>
    <span class="n">mechanism</span><span class="p">,</span>
    <span class="n">nss</span><span class="o">.</span><span class="n">CKA_ENCRYPT</span><span class="p">,</span>
    <span class="n">symmetric_key</span><span class="p">,</span>
    <span class="n">iv_param</span><span class="p">)</span>

<span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">cipher_op</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">digest_final</span><span class="p">()</span>

<span class="n">decryptor</span> <span class="o">=</span> <span class="n">nss</span><span class="o">.</span><span class="n">create_context_by_sym_key</span><span class="p">(</span>
    <span class="n">mechanism</span><span class="p">,</span>
    <span class="n">nss</span><span class="o">.</span><span class="n">CKA_DECRYPT</span><span class="p">,</span>
    <span class="n">symmetric_key</span><span class="p">,</span>
    <span class="n">iv_param</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">cipher_op</span><span class="p">(</span><span class="n">encrypted_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">digest_final</span><span class="p">()</span>
</pre></div>
</div>
<p>Python Cryptography
(<a class="reference external" href="https://cryptography.io/en/latest/hazmat/primitives/symmetric-encryption/">docs</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">symmetric_key</span><span class="p">)</span>
<span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_data</span><span class="p">)</span>

<span class="n">cipher</span> <span class="o">=</span> <span class="n">Cipher</span><span class="p">(</span><span class="n">algorithms</span><span class="o">.</span><span class="n">AES</span><span class="p">(</span><span class="n">symmetric_key</span><span class="p">),</span> <span class="n">modes</span><span class="o">.</span><span class="n">CBC</span><span class="p">(</span><span class="n">iv</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">())</span>
<span class="n">encryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encryptor</span><span class="p">()</span>
<span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

<span class="n">decryptor</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">decryptor</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">encrypted_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">decryptor</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
</pre></div>
</div>
<p>Web Crypto
(<a class="reference external" href="https://dvcs.w3.org/hg/webcrypto-api/raw-file/tip/spec/Overview.html#aes-cbc">spec</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">encryptOp</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">subtle</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">name</span> <span class="p">:</span> <span class="s2">&quot;AES-CBC&quot;</span><span class="p">,</span>
        <span class="n">iv</span><span class="p">:</span> <span class="o">...</span>
    <span class="p">},</span>
    <span class="n">symmetric_key</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">);</span>

<span class="n">encryptOp</span><span class="o">.</span><span class="n">oncomplete</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">var</span> <span class="n">decryptOp</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">subtle</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">name</span> <span class="p">:</span> <span class="s2">&quot;AES-CBC&quot;</span><span class="p">,</span>
        <span class="n">iv</span><span class="p">:</span> <span class="o">...</span>
    <span class="p">},</span>
    <span class="n">symmetric_key</span><span class="p">,</span>
    <span class="n">encrypted_data</span>
<span class="p">);</span>

<span class="n">decryptOp</span><span class="o">.</span><span class="n">oncomplete</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">result</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="encryption-with-asymmetric-algorithm">
<h2>Encryption with asymmetric algorithm<a class="headerlink" href="#encryption-with-asymmetric-algorithm" title="Link to this heading">#</a></h2>
<p>In an asymmetric vault the secrets will be encrypted/decrypted using
asymmetric algorithm:</p>
<p>Python NSS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>encryrpted_data = nss.pub_wrap_sym_key(mechanism, public_key, data)

data = ... encrypted_data  ...?
</pre></div>
</div>
<p>Python Cryptography
(<a class="reference external" href="https://cryptography.io/en/latest/hazmat/primitives/asymmetric/">docs</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">public_key</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">.</span><span class="n">OAEP</span><span class="p">(</span>
        <span class="n">mgf</span><span class="o">=</span><span class="n">padding</span><span class="o">.</span><span class="n">MGF1</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA1</span><span class="p">()),</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA1</span><span class="p">(),</span>
        <span class="n">label</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">private_key</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span>
    <span class="n">encrypted_data</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">.</span><span class="n">OAEP</span><span class="p">(</span>
        <span class="n">mgf</span><span class="o">=</span><span class="n">padding</span><span class="o">.</span><span class="n">MGF1</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA1</span><span class="p">()),</span>
        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA1</span><span class="p">(),</span>
        <span class="n">label</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Web Crypto
(<a class="reference external" href="https://dvcs.w3.org/hg/webcrypto-api/raw-file/tip/spec/Overview.html#rsa-oaep">spec</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">encryptOp</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">subtle</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">name</span> <span class="p">:</span> <span class="s2">&quot;RSA-OAEP&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">public_key</span><span class="p">,</span>
    <span class="n">data</span>
<span class="p">);</span>

<span class="n">encryptOp</span><span class="o">.</span><span class="n">oncomplete</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">var</span> <span class="n">decryptOp</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">crypto</span><span class="o">.</span><span class="n">subtle</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">name</span> <span class="p">:</span> <span class="s2">&quot;RSA-OAEP&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">private_key</span><span class="p">,</span>
    <span class="n">encrypted_data</span>
<span class="p">);</span>

<span class="n">decryptOp</span><span class="o">.</span><span class="n">oncomplete</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">result</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
</section>
<section id="client-api">
<h1>Client API<a class="headerlink" href="#client-api" title="Link to this heading">#</a></h1>
<p>The Client API provides the client interface to access the vault
services. The client API will be primarily used to implement the CLI,
but it can also be used by custom client application.</p>
<section id="ipaconnection-class">
<h2>IPAConnection class<a class="headerlink" href="#ipaconnection-class" title="Link to this heading">#</a></h2>
<p>The IPAConnection class represents a connection to the IPA server. It
will be used internally by the client API to wrap the <a class="reference external" href="#Web_Services">Web
Services</a>.</p>
</section>
<section id="vault-class">
<h2>Vault class<a class="headerlink" href="#vault-class" title="Link to this heading">#</a></h2>
<p>The Vault class represents a vault. It contains vault attributes
accessible to the client.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Vault</span><span class="p">:</span>
    <span class="n">d</span>

        <span class="c1"># basic attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s2">&quot;standard&quot;</span>

        <span class="c1"># access control attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">members</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># secret attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secrets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret_salt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># escrow attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">escrow</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">escrow_public_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">escrowed_secret_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">escrowed_private_key</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># password reset attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_secret_salt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_public_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_escrowed_secret_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_escrowed_private_key</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</section>
<section id="secret-class">
<h2>Secret class<a class="headerlink" href="#secret-class" title="Link to this heading">#</a></h2>
<p>The Secret class represents a secret. It contains secret attributes
accessible to the client.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Secret</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</pre></div>
</div>
</section>
<section id="vaultclient-class">
<h2>VaultClient class<a class="headerlink" href="#vaultclient-class" title="Link to this heading">#</a></h2>
<p>VaultClient class provides a client interface to access vaults. It uses
an IPAConnection object to communicate with the server.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VaultClient</span><span class="p">:</span>
    <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">connection</span> <span class="o">=</span> <span class="o">...</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">IPA</span> <span class="n">server</span> <span class="o">...</span>
<span class="n">vault_client</span> <span class="o">=</span> <span class="n">VaultClient</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vaultcontianer-find">
<h2>vaultcontianer_find()<a class="headerlink" href="#vaultcontianer-find" title="Link to this heading">#</a></h2>
<p>This method returns a list of subcontainers within the provided
container. By default each list element will contain the basic
attributes of the subcontainer, but additional attributes can be
requested as well.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vaultcontianer_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vaultcontianer_find</span><span class="p">(</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vaultcontainer-get">
<h2>vaultcontainer_get()<a class="headerlink" href="#vaultcontainer-get" title="Link to this heading">#</a></h2>
<p>This method returns the attributes of the container specified by the ID.
By default it will return the basic attributes, but additional
attributes can be requested as well.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vaultcontainer_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container_id</span><span class="p">,</span>
        <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vaultcontainer_get</span><span class="p">(</span><span class="n">container_id</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vaultcontainer-add">
<h2>vaultcontainer_add()<a class="headerlink" href="#vaultcontainer-add" title="Link to this heading">#</a></h2>
<p>This method creates a new container.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vaultcontainer_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container_id</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vaultcontainer_add</span><span class="p">(</span><span class="n">container_id</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vaultcontainer-del">
<h2>vaultcontainer_del()<a class="headerlink" href="#vaultcontainer-del" title="Link to this heading">#</a></h2>
<p>This method removes an existing vault.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vaultcontainer_del</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container_id</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vaultcontainer_del</span><span class="p">(</span><span class="n">container_id</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vault-find">
<h2>vault_find()<a class="headerlink" href="#vault-find" title="Link to this heading">#</a></h2>
<p>This method returns a list of available vaults within the provided
container. By default each list element will contain the basic
attributes of the vault, but additional attributes can be requested as
well.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vault_find</span><span class="p">(</span><span class="n">container_id</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vaults</span> <span class="o">=</span> <span class="n">vault_find</span><span class="p">()</span>
<span class="k">for</span> <span class="n">vault</span> <span class="ow">in</span> <span class="n">vaults</span><span class="p">:</span>
    <span class="nb">print</span> <span class="n">vault</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">vault</span><span class="o">.</span><span class="n">description</span>
</pre></div>
</div>
</section>
<section id="vault-get">
<h2>vault_get()<a class="headerlink" href="#vault-get" title="Link to this heading">#</a></h2>
<p>This method returns the attributes of the vault specified by the ID. By
default it will return the basic attributes, but additional attributes
can be requested as well.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vault_id</span><span class="p">,</span>
        <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vault_get</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault</span> <span class="o">=</span> <span class="n">vault_get</span><span class="p">(</span><span class="s2">&quot;PrivateVault&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;members&quot;</span><span class="p">])</span>
<span class="nb">print</span> <span class="s2">&quot;ID: &quot;</span> <span class="o">+</span> <span class="n">vault</span><span class="o">.</span><span class="n">id</span>
<span class="nb">print</span> <span class="s2">&quot;Description: &quot;</span> <span class="o">+</span> <span class="n">vault</span><span class="o">.</span><span class="n">description</span>

<span class="nb">print</span> <span class="s2">&quot;Members:&quot;</span>
<span class="n">members</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">members</span>
<span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="n">member</span>
</pre></div>
</div>
</section>
<section id="vault-add">
<h2>vault_add()<a class="headerlink" href="#vault-add" title="Link to this heading">#</a></h2>
<p>This method creates a new vault on the server.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vault_id</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_public_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">escrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">escrow_public_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">vault</span> <span class="o">=</span> <span class="n">Vault</span><span class="p">(</span><span class="n">vault_id</span><span class="p">)</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">vault_public_key</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">escrow</span> <span class="o">=</span> <span class="n">escrow</span>

    <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>

        <span class="c1"># generate secret key and salt</span>
        <span class="n">vault</span><span class="o">.</span><span class="n">secret_salt</span> <span class="o">=</span> <span class="n">generate_salt</span><span class="p">()</span>
        <span class="n">vault_secret_key</span> <span class="o">=</span> <span class="n">generate_key</span><span class="p">(</span><span class="n">vault_password</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">secret_salt</span><span class="p">)</span>

        <span class="c1"># encrypt data with vault secret key</span>
        <span class="n">vault</span><span class="o">.</span><span class="n">secrets</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vault_secret_key</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;asymmetric&quot;</span><span class="p">:</span>
        <span class="c1"># encrypt data with vault public key</span>
        <span class="n">vault</span><span class="o">.</span><span class="n">secrets</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">public_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow</span><span class="p">:</span>

        <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span> <span class="o">=</span> <span class="n">escrow_public_key</span>

        <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>
            <span class="c1"># encrypt vault secret key with escrow public key</span>
            <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_secret_key</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">vault_secret_key</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;asymmetric&quot;</span><span class="p">:</span>
            <span class="c1"># encrypt vault private key with escrow public key</span>
            <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_private_key</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">vault_private_key</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vault_add</span><span class="p">(</span><span class="n">vault</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vault</span>
</pre></div>
</div>
<p>A standard vault can be created without specifying a password/key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault</span> <span class="o">=</span> <span class="n">vault_add</span><span class="p">(</span><span class="s2">&quot;StandardVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Standard vault&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A symmetric vault can be created by specifying the type and the vault
password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault</span> <span class="o">=</span> <span class="n">vault_add</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Symmetric vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;symmetric&quot;</span><span class="p">,</span>
    <span class="n">vault_password</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An escrowed symmetric vault can be created by specifying the type, the
vault password, and the escrow public key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault</span> <span class="o">=</span> <span class="n">vault_add</span><span class="p">(</span><span class="s2">&quot;EscrowedSymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Escrowed vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;symmetric&quot;</span><span class="p">,</span>
    <span class="n">vault_password</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">escrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">escrow_public_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An asymmetric vault can be created by specifying the type and the vault
public key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault</span> <span class="o">=</span> <span class="n">vault_add</span><span class="p">(</span><span class="s2">&quot;AsymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Asymmetric vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;asymmetric&quot;</span><span class="p">,</span>
    <span class="n">vault_public_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An escrowed asymmetric vault can be created by specifying the type, the
vault public and private keys, and the escrow public key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault</span> <span class="o">=</span> <span class="n">vault_add</span><span class="p">(</span><span class="s2">&quot;EscrowedAsymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Escrowed asymmetric vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;asymmetric&quot;</span><span class="p">,</span>
    <span class="n">vault_public_key</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">vault_private_key</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">escrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">escrow_public_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vault-update">
<h2>vault_update()<a class="headerlink" href="#vault-update" title="Link to this heading">#</a></h2>
<p>This method stores changes to the vault object to the server.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vault</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vault_update</span><span class="p">(</span><span class="n">vault</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vault-change-type">
<h2>vault_change_type()<a class="headerlink" href="#vault-change-type" title="Link to this heading">#</a></h2>
<p>This method modifies the type of an existing vault.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_change_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_public_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_vault</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="c1"># retrieve existing data based on the old type</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">vault_retrieve</span><span class="p">(</span>
        <span class="n">vault</span><span class="o">=</span><span class="n">vault</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="n">vault_password</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="n">vault_private_key</span><span class="p">)</span>

    <span class="c1"># change the type</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>

    <span class="c1"># re-archive the data based on the new type</span>
    <span class="n">vault_archive</span><span class="p">(</span>
        <span class="n">vault</span><span class="o">=</span><span class="n">vault</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="n">vault_password</span><span class="p">,</span>
        <span class="n">vault_public_key</span><span class="o">=</span><span class="n">vault_public_key</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="n">vault_private_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vault_id</span><span class="p">:</span>
        <span class="n">vault_update</span><span class="p">(</span><span class="n">vault</span><span class="p">)</span>
</pre></div>
</div>
<p>To convert a standard vault into a symmetric vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_change_type</span><span class="p">(</span><span class="s2">&quot;Vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;symmetric&quot;</span><span class="p">,</span>
    <span class="n">vault_password</span><span class="o">=</span><span class="n">new_vault_password</span><span class="p">)</span>
</pre></div>
</div>
<p>To convert a symmetric vault into an asymmetric vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_change_type</span><span class="p">(</span><span class="s2">&quot;Vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;asymmetric&quot;</span><span class="p">,</span>
    <span class="n">vault_password</span><span class="o">=</span><span class="n">vault_password</span><span class="p">,</span>
    <span class="n">vault_public_key</span><span class="o">=</span><span class="n">new_vault_public_key</span><span class="p">,</span>
    <span class="n">vault_private_key</span><span class="o">=</span><span class="n">new_vault_private_key</span><span class="p">)</span>
</pre></div>
</div>
<p>To convert an asymmetric vault into a standard vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_change_type</span><span class="p">(</span><span class="s2">&quot;Vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="n">vault_private_key</span><span class="o">=</span><span class="n">vault_private_key</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vault-change-escrow">
<h2>vault_change_escrow()<a class="headerlink" href="#vault-change-escrow" title="Link to this heading">#</a></h2>
<p>This method modifies the escrow info of an existing vault.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_change_escrow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">escrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">escrow_public_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="n">vault_get</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="n">vault</span><span class="o">.</span><span class="n">escrow</span> <span class="o">=</span> <span class="n">escrow</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span> <span class="o">=</span> <span class="n">escrow_public_key</span>

    <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>

            <span class="c1"># generate secret key</span>
            <span class="n">vault_secret_key</span> <span class="o">=</span> <span class="n">generate_key</span><span class="p">(</span><span class="n">vault_password</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">secret_salt</span><span class="p">)</span>

            <span class="c1"># encrypt vault secret key with escrow public key</span>
            <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_secret_key</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">vault_secret_key</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;asymmetric&quot;</span><span class="p">:</span>
            <span class="c1"># encrypt vault private key with escrow public key</span>
            <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_private_key</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">vault_private_key</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_secret_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_private_key</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">vault_id</span><span class="p">:</span>
        <span class="n">vault_update</span><span class="p">(</span><span class="n">vault</span><span class="p">)</span>
</pre></div>
</div>
<p>To escrow a standard vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_change_escrow</span><span class="p">(</span><span class="s2">&quot;StandardVault&quot;</span><span class="p">,</span>
    <span class="n">escrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>To escrow a symmetric vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_change_escrow</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">escrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">vault_password</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>To escrow an asymmetric vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_change_escrow</span><span class="p">(</span><span class="s2">&quot;AsymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">escrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">vault_public_key</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">vault_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>To unescrow a vault:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_change_escrow</span><span class="p">(</span><span class="s2">&quot;Vault&quot;</span><span class="p">,</span> <span class="n">escrow</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vault-del">
<h2>vault_del()<a class="headerlink" href="#vault-del" title="Link to this heading">#</a></h2>
<p>This method removes an existing vault on the server.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_del</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vault_id</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">vault_del</span><span class="p">(</span><span class="n">vault_id</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vault-archive">
<h2>vault_archive()<a class="headerlink" href="#vault-archive" title="Link to this heading">#</a></h2>
<p>This method archives a blob of data into a vault replacing existing
data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_secret_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">escrow_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_vault</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vault_secret_key</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">vault_password</span><span class="p">:</span>
                <span class="c1"># generate vault secret key from vault password and secret salt</span>
                <span class="n">vault_secret_key</span> <span class="o">=</span> <span class="n">generate_key</span><span class="p">(</span><span class="n">vault_password</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">secret_salt</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">escrow_private_key</span><span class="p">:</span>
                <span class="c1"># decrypt vault secret key with escrow private key</span>
                <span class="n">vault_secret_key</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">vault</span><span class="o">.</span><span class="n">escrowed_secret_key</span><span class="p">,</span> <span class="n">escrow_private_key</span><span class="p">)</span>

        <span class="c1"># encrypt secrets with vault secret key</span>
        <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vault_secret_key</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;asymmetric&quot;</span><span class="p">:</span>

        <span class="c1"># encrypt secrets with vault public key</span>
        <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">public_key</span><span class="p">)</span>

    <span class="n">vault_send_data</span><span class="p">(</span><span class="n">vult_id</span><span class="p">,</span> <span class="n">encrypted_data</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can archive data into a standard vault without any password or
key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_client</span><span class="o">.</span><span class="n">archive_secrets</span><span class="p">(</span><span class="s2">&quot;StandardVault&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;mydata&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can archive data into a symmetric vault by providing a vault
password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_client</span><span class="o">.</span><span class="n">archive_secrets</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;mydata&quot;</span><span class="p">,</span>
    <span class="n">vault_password</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can archive data into a symmetric vault by providing a
pre-generated vault secret key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_client</span><span class="o">.</span><span class="n">archive_secrets</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;mydata&quot;</span><span class="p">,</span>
    <span class="n">vault_secret_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An escrow officer can archive data into a symmetric vault by providing
an escrow private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_client</span><span class="o">.</span><span class="n">archive_secrets</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;mydata&quot;</span><span class="p">,</span>
    <span class="n">escrow_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can archive data into an asymmetric vault without any password
or key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_client</span><span class="o">.</span><span class="n">archive_secrets</span><span class="p">(</span><span class="s2">&quot;AsymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;mydata&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vault-retrieve">
<h2>vault_retrieve()<a class="headerlink" href="#vault-retrieve" title="Link to this heading">#</a></h2>
<p>This method retrieves a blob of data stored in a vault and decrypt it
based on the vault type.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_secret_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">escrow_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_vault</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">vault_get_data</span><span class="p">(</span><span class="n">vault</span><span class="o">.</span><span class="n">id</span><span class="p">);</span>

    <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">encrypted_data</span>

    <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">vault_secret_key</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">vault_password</span><span class="p">:</span>
                <span class="c1"># generate vault secret key from vault password and secret salt</span>
                <span class="n">vault_secret_key</span> <span class="o">=</span> <span class="n">generate_key</span><span class="p">(</span><span class="n">vault_password</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">secret_salt</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">escrow_private_key</span><span class="p">:</span>
                <span class="c1"># decrypt vault secret key with escrow private key</span>
                <span class="n">vault_secret_key</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">vault</span><span class="o">.</span><span class="n">escrowed_secret_key</span><span class="p">,</span> <span class="n">escrow_private_key</span><span class="p">)</span>

        <span class="c1"># decrypt secrets with vault secret key</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_data</span><span class="p">,</span> <span class="n">vault_secret_key</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;asymmetric&quot;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">escrow_private_key</span><span class="p">:</span>
            <span class="c1"># decrypt vault private key with escrow private key</span>
            <span class="n">vault_private_key</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">vault</span><span class="o">.</span><span class="n">escrowed_private_key</span><span class="p">,</span> <span class="n">escrow_private_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vault_private_key</span><span class="p">:</span>
            <span class="c1"># decrypt secrets with vault private key</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_data</span><span class="p">,</span> <span class="n">vault_private_key</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># return empty data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>A member can retrieve data from a standard vault without any password or
key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">vault_client</span><span class="o">.</span><span class="n">vault_retrieve</span><span class="p">(</span><span class="s2">&quot;StandardVault&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can retrieve data from a symmetric vault by providing the vault
password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">vault_client</span><span class="o">.</span><span class="n">vault_retrieve</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span> <span class="n">vault_password</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can retrieve data from a symmetric vault by providing the vault
secret key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">vault_client</span><span class="o">.</span><span class="n">vault_retrieve</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span> <span class="n">vault_secret_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An escrow officer can recover data from an escrowed symmetric vault by
providing the escrow private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">vault_client</span><span class="o">.</span><span class="n">vault_retrieve</span><span class="p">(</span><span class="s2">&quot;EscrowedSymmetricVault&quot;</span><span class="p">,</span> <span class="n">escrow_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An owner can retrieve secrets from an asymmetric vault by providing the
vault private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">vault_client</span><span class="o">.</span><span class="n">vault_retrieve</span><span class="p">(</span><span class="s2">&quot;AsymmetricVault&quot;</span><span class="p">,</span> <span class="n">vault_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An escrow officer can recover secrets from an escrowed asymmetric vault
by providing the escrow private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">vault_client</span><span class="o">.</span><span class="n">vault_retrieve</span><span class="p">(</span><span class="s2">&quot;EscrowedAsymmetricVault&quot;</span><span class="p">,</span> <span class="n">escrow_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vaultsecret-archive">
<h2>vaultsecret_archive()<a class="headerlink" href="#vaultsecret-archive" title="Link to this heading">#</a></h2>
<p>This method encrypt a secret based on the vault type and archive it into
a collection of secrets in the vault.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vaultsecret_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">secret_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_secret_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">escrow_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1"># retrieve vault info</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="n">vault_get</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="c1"># retrieve existing secrets</span>
    <span class="n">json_encoded_secrets</span> <span class="o">=</span> <span class="n">vault_retrieve</span><span class="p">(</span>
        <span class="n">vault</span><span class="o">=</span><span class="n">vault</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="n">vault_password</span><span class="p">,</span>
        <span class="n">vault_secret_key</span><span class="o">=</span><span class="n">vault_secret_key</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="n">vault_private_key</span><span class="p">)</span>
        <span class="n">escrow_private_key</span><span class="o">=</span><span class="n">escrow_private_key</span><span class="p">)</span>

    <span class="n">secrets</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">json_encoded_secrets</span><span class="p">)</span>

    <span class="c1"># add the new secret</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">secret_id</span><span class="p">,</span>
        <span class="n">description</span><span class="p">:</span> <span class="n">description</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">data</span>
    <span class="p">}</span>
    <span class="n">secrets</span><span class="p">[</span><span class="n">secret_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">secrets</span>

    <span class="c1"># re-archive secrets</span>
    <span class="n">json_encoded_secrets</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">secrets</span><span class="p">)</span>

    <span class="n">vault_archive</span><span class="p">(</span>
        <span class="n">vault</span><span class="o">=</span><span class="n">vault</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json_encoded_secrets</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="n">vault_password</span><span class="p">,</span>
        <span class="n">vault_secret_key</span><span class="o">=</span><span class="n">vault_secret_key</span><span class="p">,</span>
        <span class="n">escrow_private_key</span><span class="o">=</span><span class="n">escrow_private_key</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can archive a secret into a standard vault without any password
or key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vaultsecret_archive</span><span class="p">(</span><span class="s2">&quot;StandardVault&quot;</span><span class="p">,</span>
    <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;My secret&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;secret data&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can archive a secret into a symmetric vault by providing a
vault password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vaultsecret_archive</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;My secret&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;secret data&quot;</span><span class="p">,</span>
    <span class="n">vault_password</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can archive a secret into a symmetric vault by providing a
pre-generated vault secret key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vaultsecret_archive</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;My secret&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;secret data&quot;</span><span class="p">,</span>
    <span class="n">vault_secret_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An escrow officer can archive a secret into a symmetric vault by
providing an escrow private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vaultsecret_archive</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;My secret&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;secret data&quot;</span><span class="p">,</span>
    <span class="n">escrow_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An owner can archive a secret into an asymmetric vault by providing a
vault private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vaultsecret_archive</span><span class="p">(</span><span class="s2">&quot;AsymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;My secret&quot;</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="s2">&quot;secret data&quot;</span><span class="p">,</span>
    <span class="n">vault_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vaultsecret-retrieve">
<h2>vaultsecret_retrieve()<a class="headerlink" href="#vaultsecret-retrieve" title="Link to this heading">#</a></h2>
<p>This method retrieves a secret from a collection of secrets in a vault
and decrypt it based on the vault type.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vaultsecret_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">secret_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_secret_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">escrow_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="n">vault_get</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="c1"># retrieve secrets</span>
    <span class="n">json_encoded_secrets</span> <span class="o">=</span> <span class="n">vault_retrieve</span><span class="p">(</span>
        <span class="n">vault</span><span class="o">=</span><span class="n">vault</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="n">vault_password</span><span class="p">,</span>
        <span class="n">vault_secret_key</span><span class="o">=</span><span class="n">vault_secret_key</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="n">vault_private_key</span><span class="p">)</span>
        <span class="n">escrow_private_key</span><span class="o">=</span><span class="n">escrow_private_key</span><span class="p">)</span>

    <span class="n">secrets</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">json_encoded_secrets</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">secrets</span><span class="p">[</span><span class="n">secret_id</span><span class="p">]</span>
</pre></div>
</div>
<p>A member can retrieve a secret from a standard vault without any
password or key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span> <span class="o">=</span> <span class="n">vaultsecret_retrieve</span><span class="p">(</span><span class="s2">&quot;StandardVault&quot;</span><span class="p">,</span> <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can retrieve a secret from a symmetric vault by providing the
vault password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span> <span class="o">=</span> <span class="n">vaultsecret_retrieve</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span> <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span> <span class="n">vault_password</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>A member can retrieve a secret from a symmetric vault by providing the
vault secret key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span> <span class="o">=</span> <span class="n">vaultsecret_retrieve</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span> <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span> <span class="n">vault_secret_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An escrow officer can recover a secret from an escrowed symmetric vault
by providing the escrow private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span> <span class="o">=</span> <span class="n">vaultsecret_retrieve</span><span class="p">(</span><span class="s2">&quot;EscrowedSymmetricVault&quot;</span><span class="p">,</span> <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span> <span class="n">escrow_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An owner can retrieve a secret from an asymmetric vault by providing the
vault private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span> <span class="o">=</span> <span class="n">vault_retrieve</span><span class="p">(</span><span class="s2">&quot;AsymmetricVault&quot;</span><span class="p">,</span> <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span> <span class="n">vault_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An escrow officer can recover a secret from an escrowed asymmetric vault
by providing the escrow private key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">secret</span> <span class="o">=</span> <span class="n">vault_retrieve</span><span class="p">(</span><span class="s2">&quot;EscrowedAsymmetricVault&quot;</span><span class="p">,</span> <span class="n">secret_id</span><span class="o">=</span><span class="s2">&quot;mysecret&quot;</span><span class="p">,</span> <span class="n">escrow_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vault-change-password">
<h2>vault_change_password()<a class="headerlink" href="#vault-change-password" title="Link to this heading">#</a></h2>
<p>This method will change the vault password if the current password is
known, or change the vault private key if the current vault private key
is known.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">new_vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">new_vault_public_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">new_vault_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="n">vault_get</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="c1"># retrieve secrets with old vault password or private key</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">vault_retrieve</span><span class="p">(</span>
        <span class="n">vault</span><span class="o">=</span><span class="n">vault</span><span class="p">,</span>
        <span class="n">vault_password</span><span class="o">=</span><span class="n">vault_password</span><span class="p">,</span>
        <span class="n">vault_private_key</span><span class="o">=</span><span class="n">vault_private_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>

        <span class="c1"># generate vault secret salt</span>
        <span class="n">vault</span><span class="o">.</span><span class="n">secret_salt</span> <span class="o">=</span> <span class="n">generate_salt</span><span class="p">()</span>

        <span class="c1"># generate vault secret key from vault password and secret salt</span>
        <span class="n">new_vault_secret_key</span> <span class="o">=</span> <span class="n">generate_key</span><span class="p">(</span><span class="n">new_vault_password</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">secret_salt</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;asymmetric&quot;</span><span class="p">:</span>

        <span class="c1"># store vault public key</span>
        <span class="n">vault</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">new_vault_public_key</span>

    <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>
            <span class="c1"># encrypt vault secret key with escrow public key</span>
            <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_secret_key</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">new_vault_secret_key</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;asymmetric&quot;</span><span class="p">:</span>
            <span class="c1"># encrypt vault private key with escrow public key</span>
            <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_private_key</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">new_vault_private_key</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span><span class="p">)</span>

    <span class="c1"># archive data with new vault password or public key</span>
    <span class="n">vault_archive</span><span class="p">(</span>
        <span class="n">vault</span><span class="o">=</span><span class="n">vault</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">vault_secret_key</span><span class="o">=</span><span class="n">new_vault_secret_key</span><span class="p">)</span>

    <span class="n">vault_update</span><span class="p">(</span><span class="n">vault</span><span class="p">)</span>
</pre></div>
</div>
<p>An owner can change the vault password of a symmetric vault as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_client</span><span class="o">.</span><span class="n">change_vault_password</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">vault_password</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">new_vault_password</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An owner can change the keys of an asymmetric vault as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_client</span><span class="o">.</span><span class="n">change_vault_password</span><span class="p">(</span><span class="s2">&quot;AsymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">vault_private_key</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">new_vault_public_key</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">new_vault_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="vault-reset-password">
<h2>vault_reset_password()<a class="headerlink" href="#vault-reset-password" title="Link to this heading">#</a></h2>
<p>This method will request a vault password reset in case the current
password or private key is lost. Password reset will only work if the
vault is escrowed. The request must be approved by the escrow officer
before it will become effective.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">vault_reset_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">new_vault_password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">new_vault_public_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">new_vault_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="n">vault_get</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>

        <span class="c1"># generate vault secret salt</span>
        <span class="n">vault</span><span class="o">.</span><span class="n">new_secret_salt</span> <span class="o">=</span> <span class="n">generate_salt</span><span class="p">()</span>

        <span class="c1"># generate vault secret key from vault password and secret salt</span>
        <span class="n">new_vault_secret_key</span> <span class="o">=</span> <span class="n">generate_key</span><span class="p">(</span><span class="n">new_vault_password</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">new_secret_salt</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;asymmetric&quot;</span><span class="p">:</span>

        <span class="c1"># store vault public key</span>
        <span class="n">vault</span><span class="o">.</span><span class="n">new_public_key</span> <span class="o">=</span> <span class="n">new_vault_public_key</span>

    <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span>
            <span class="c1"># encrypt vault secret key with escrow public key</span>
            <span class="n">vault</span><span class="o">.</span><span class="n">new_escrowed_secret_key</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">new_vault_secret_key</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">vault</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;asymmetric&quot;</span><span class="p">:</span>
            <span class="c1"># encrypt vault private key with escrow public key</span>
            <span class="n">vault</span><span class="o">.</span><span class="n">new_escrowed_private_key</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">new_vault_private_key</span><span class="p">,</span> <span class="n">vault</span><span class="o">.</span><span class="n">escrow_public_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vault_id</span><span class="p">:</span>
        <span class="n">vault_update</span><span class="p">(</span><span class="n">vault</span><span class="p">)</span>
</pre></div>
</div>
<p>An owner can request a password reset for a symmetric vault as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_reset_password</span><span class="p">(</span><span class="s2">&quot;SymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">new_vault_password</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
<p>An owner can request a key reset for an asymmetric vault as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vault_reset_password</span><span class="p">(</span><span class="s2">&quot;AsymmetricVault&quot;</span><span class="p">,</span>
    <span class="n">new_vault_public_key</span><span class="o">=...</span><span class="p">,</span>
    <span class="n">new_vault_private_key</span><span class="o">=...</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="approve-vault-password-reset">
<h2>approve_vault_password_reset()<a class="headerlink" href="#approve-vault-password-reset" title="Link to this heading">#</a></h2>
<p>This method can be used by an escrow officer to reset vault password.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">approve_vault_password_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">escrow_private_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_vault</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="c1"># recover secrets</span>
    <span class="n">secrets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve_secrets</span><span class="p">(</span><span class="n">vault</span><span class="o">=</span><span class="n">vault</span><span class="p">,</span> <span class="n">escrow_private_key</span><span class="o">=</span><span class="n">escrow_private_key</span><span class="p">)</span>

    <span class="n">vault</span><span class="o">.</span><span class="n">secret_salt</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">new_secret_salt</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_secret_key</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">new_escrowed_secret_key</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">public_key</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">new_public_key</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">escrowed_private_key</span> <span class="o">=</span> <span class="n">vault</span><span class="o">.</span><span class="n">new_escrowed_private_key</span>

    <span class="n">vault</span><span class="o">.</span><span class="n">new_secret_salt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">new_escrowed_secret_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">new_public_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">new_escrowed_private_key</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># re-archive secrets</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">archive_secrets</span><span class="p">(</span><span class="n">vault</span><span class="o">=</span><span class="n">vault</span><span class="p">,</span> <span class="n">secrets</span><span class="o">=</span><span class="n">secrets</span><span class="p">,</span> <span class="n">escrow_private_key</span><span class="o">=</span><span class="n">escrow_private_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vault_id</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">update_vault</span><span class="p">(</span><span class="n">vault</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="reject-vault-password-reset">
<h2>reject_vault_password_reset()<a class="headerlink" href="#reject-vault-password-reset" title="Link to this heading">#</a></h2>
<p>This method can be used by an escrow officer to reject password reset
request.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">reject_vault_password_reject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">vault_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">vault</span><span class="p">:</span>
        <span class="n">vault</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_vault</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>

    <span class="c1"># clear request</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">new_secret_salt</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">new_escrowed_secret_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">new_public_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vault</span><span class="o">.</span><span class="n">new_escrowed_private_key</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">vault_id</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">update_vault</span><span class="p">(</span><span class="n">vault</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="web-services">
<h1>Web Services<a class="headerlink" href="#web-services" title="Link to this heading">#</a></h1>
<p>The vault web services initially may be implemented using the existing
IPA’s XML/JSON RPC framework. In the future it may be converted to use
REST API as follows.</p>
<section id="container-resource">
<h2>Container resource<a class="headerlink" href="#container-resource" title="Link to this heading">#</a></h2>
</section>
<section id="put-ipa-rest-vaults">
<h2>PUT /ipa/rest/vaults/<a class="headerlink" href="#put-ipa-rest-vaults" title="Link to this heading">#</a></h2>
<p>An admin can use this operation to create a container. This operation
will be wrapped in IPAConnection.create_container().</p>
</section>
<section id="get-ipa-rest-vaults">
<h2>GET /ipa/rest/vaults/<a class="headerlink" href="#get-ipa-rest-vaults" title="Link to this heading">#</a></h2>
<p>A user can use this operation to return the container attributes and the
list of vaults in the container. This operation will be wrappped in
IPAConnection.find_vaults().</p>
<p>Response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;/users/testuser&quot;</span><span class="p">,</span>
    <span class="o">...</span>
    <span class="n">vaults</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;/users/testuser/PrivateVault&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;Private vault&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;/shared/SharedVault&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;Shared vault&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="n">totalVaults</span><span class="p">:</span> <span class="mi">2</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="vault-resource">
<h2>Vault resource<a class="headerlink" href="#vault-resource" title="Link to this heading">#</a></h2>
</section>
<section id="id1">
<h2>GET /ipa/rest/vaults//<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>A member can use this operation to get the vault info. This operation
will be wrappped in IPAConnection.get_vault().</p>
<p>The client can specify the attributes to return in the query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">attributes</span><span class="o">=&lt;</span><span class="n">comma</span><span class="o">-</span><span class="n">separated</span> <span class="n">attribute</span> <span class="nb">list</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;/users/testuser/PrivateVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;Private vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="n">secret_salt</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>
    <span class="n">owners</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;testuser&quot;</span><span class="p">,</span> <span class="s2">&quot;testowner&quot;</span> <span class="p">],</span>
    <span class="n">members</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;testmember&quot;</span> <span class="p">],</span>
    <span class="n">public_key</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="n">escrow_public_key</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="n">escrowed_secret_key</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="n">escrowed_private_key</span><span class="p">:</span> <span class="n">null</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="post-ipa-rest-vaults">
<h2>POST /ipa/rest/vaults/<a class="headerlink" href="#post-ipa-rest-vaults" title="Link to this heading">#</a></h2>
<p>A user can use this operation to add a vault into a container. This
operation will be wrappped in IPAConnection.create_vault().</p>
<p>Request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;PrivateVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;Private vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The server will return the normalized values of the vault attributes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;/users/testuser/PrivateVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;Private vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2>POST /ipa/rest/vaults//<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>An owner can use this operation to modify a vault. This operation will
be wrapped in IPAConnection.update_vault().</p>
<p>The client will send the attributes to be modified:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;PrivateVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;Private vault&quot;</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The server will return the normalized vault attributes after
modification:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;/users/testuser/PrivateVault&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;Private vault&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;standard&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="delete-ipa-rest-vaults">
<h2>DELETE /ipa/rest/vaults/<a class="headerlink" href="#delete-ipa-rest-vaults" title="Link to this heading">#</a></h2>
<p>An admin can use this operation to remove a container and all vaults in
it. This operation will be wrapped in IPAConnection.remove_container().</p>
</section>
<section id="id3">
<h2>DELETE /ipa/rest/vaults//<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>An owner can use this operation will remove a vault. This operation will
be wrapped in IPAConnection.remove_vault().</p>
</section>
<section id="secret-resource">
<h2>Secret resource<a class="headerlink" href="#secret-resource" title="Link to this heading">#</a></h2>
<p>The secrets are accessible under the following URL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">ipa</span><span class="o">/</span><span class="n">rest</span><span class="o">/</span><span class="n">vaults</span><span class="o">/&lt;</span><span class="n">container</span><span class="o">&gt;/&lt;</span><span class="n">vault</span> <span class="n">name</span><span class="o">&gt;/</span><span class="n">secrets</span>
</pre></div>
</div>
<p>The secrets are stored as base-64 encoded of encrypted JSON collection.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;secret1&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;First secret&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;Secret data&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;secret2&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Second secret&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;Secret data&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="get-ipa-rest-vaults-secrets">
<h2>GET /ipa/rest/vaults///secrets<a class="headerlink" href="#get-ipa-rest-vaults-secrets" title="Link to this heading">#</a></h2>
<p>A member can use this operation to return the encrypted secrets as
base-64 encoded data. This operation will be wrapped in
IPAConnection.get_secrets().</p>
<p>Response:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ewogICAg</span><span class="o">...</span><span class="n">Qp9Cg</span><span class="o">==</span>
</pre></div>
</div>
<p>To retrieve the secrets, the data needs to be base-64 decoded, then
decrypted using the vault secret key or vault private key, then
deserialized using JSON.</p>
</section>
<section id="put-ipa-rest-vaults-secrets">
<h2>PUT /ipa/rest/vaults///secrets<a class="headerlink" href="#put-ipa-rest-vaults-secrets" title="Link to this heading">#</a></h2>
<p>A member can use this operation to store base-64 encoded encrypted
secrets. This operation will be wrapped in
IPAConnection.update_vault_secrets().</p>
<p>Request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ewogICAg</span><span class="o">...</span><span class="n">Qp9Cg</span><span class="o">==</span>
</pre></div>
</div>
<p>To store the secrets, the secret collection needs to be serialized into
JSON, then encrypted using the vault secret key or the vault public key,
then base-64 encoded.</p>
</section>
</section>
<section id="ldap-directory">
<h1>LDAP Directory<a class="headerlink" href="#ldap-directory" title="Link to this heading">#</a></h1>
<section id="directory-structure">
<h2>Directory Structure<a class="headerlink" href="#directory-structure" title="Link to this heading">#</a></h2>
<p>The containers and vaults are represented as LDAP entries in a subtree
in the IPA directory. The root container is represented by the root
entry of the subtree. Sub-containers are represented by entries directly
under the parent container. Vaults are represented by entries stored
under the container.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">suffix</span><span class="o">&gt;</span>
<span class="o">+</span> <span class="n">cn</span><span class="o">=</span><span class="n">vaults</span>
   <span class="o">+</span> <span class="n">cn</span><span class="o">=</span><span class="n">users</span>
      <span class="o">+</span> <span class="n">cn</span><span class="o">=&lt;</span><span class="n">user</span> <span class="n">ID</span><span class="o">&gt;</span>
         <span class="o">+</span> <span class="n">cn</span><span class="o">=&lt;</span><span class="n">private</span> <span class="n">vault</span> <span class="n">name</span><span class="o">&gt;</span>
         <span class="o">+</span> <span class="o">...</span>
   <span class="o">+</span> <span class="n">cn</span><span class="o">=</span><span class="n">shared</span>
      <span class="o">+</span> <span class="n">cn</span><span class="o">=&lt;</span><span class="n">shared</span> <span class="n">vault</span> <span class="n">name</span><span class="o">&gt;</span>
      <span class="o">+</span> <span class="o">...</span>
   <span class="o">+</span> <span class="n">cn</span><span class="o">=</span><span class="n">services</span>
      <span class="o">+</span> <span class="n">cn</span><span class="o">=&lt;</span><span class="n">server</span> <span class="n">name</span><span class="o">&gt;</span>
          <span class="o">+</span> <span class="n">cn</span><span class="o">=&lt;</span><span class="n">service</span> <span class="n">vault</span> <span class="n">name</span><span class="o">&gt;</span>
          <span class="o">+</span> <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="ldap-schema">
<h2>LDAP Schema<a class="headerlink" href="#ldap-schema" title="Link to this heading">#</a></h2>
<p>See also <a class="reference external" href="http://www.freeipa.org/page/V4/PKCS11_in_LDAP/Schema">LDAP schema for PKCS#11
data</a>.</p>
<p>Container entry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=&lt;</span><span class="n">container</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">parent</span> <span class="n">container</span> <span class="n">DN</span><span class="o">&gt;</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">top</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">ipaVaultContainer</span>
<span class="n">cn</span><span class="p">:</span> <span class="o">...</span>
<span class="n">description</span><span class="p">:</span> <span class="o">...</span>
<span class="n">owner</span><span class="p">:</span> <span class="o">...</span>
<span class="n">member</span><span class="p">:</span> <span class="o">...</span>
<span class="n">maxSecretSize</span><span class="p">:</span> <span class="o">...</span>
<span class="n">maxVaultSize</span><span class="p">:</span> <span class="o">...</span>
</pre></div>
</div>
<p>Vault entry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=&lt;</span><span class="n">vault</span> <span class="n">name</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">container</span> <span class="n">DN</span><span class="o">&gt;</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">top</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">ipaVault</span>
<span class="n">cn</span><span class="p">:</span> <span class="o">...</span>
<span class="n">description</span><span class="p">:</span> <span class="o">...</span>
<span class="n">owner</span><span class="p">:</span> <span class="o">...</span>
<span class="n">member</span><span class="p">:</span> <span class="o">...</span>
<span class="n">ipaVaultType</span><span class="p">:</span> <span class="o">...</span>
<span class="n">ipaVaultSalt</span><span class="p">::</span> <span class="o">...</span>
<span class="n">ipaVaultPublicKey</span><span class="p">::</span> <span class="o">...</span>
<span class="n">ipaVaultEscrowPublicKey</span><span class="p">::</span> <span class="o">...</span>
<span class="n">ipaVaultPendingSalt</span><span class="p">::</span> <span class="o">...</span>
<span class="n">ipaVaultPendingPublicKey</span><span class="p">::</span> <span class="o">...</span>
<span class="n">ipaVaultPendingEscrowedSecretKey</span><span class="p">::</span> <span class="o">...</span>
<span class="n">ipaVaultPendingEscrowedPrivateKey</span><span class="p">::</span> <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="access-control-attributes">
<h2>Access Control Attributes<a class="headerlink" href="#access-control-attributes" title="Link to this heading">#</a></h2>
<p>The LDAP ACI attributes are used to control the access to the LDAP
entries representing the vaults and the containers. The secrets
themselves are stored in KRA and accessed by IPA as KRA agent on behalf
of IPA users. The IPA user’s access to the secrets will be determined by
IPA framework based on the user’s membership or ownership of the vaults
and containers, not by LDAP ACI.</p>
<p>The ACI attributes are defined in the root entry of the vault subtree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">vaults</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">suffix</span><span class="o">&gt;</span>
<span class="o">...</span>

<span class="c1">################################################################################</span>
<span class="c1"># Vault Container ACLs</span>
<span class="c1">################################################################################</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="s2">&quot;ldap:///cn=*,cn=users,cn=vaults,&lt;suffix&gt;&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Allow users to create private container&quot;</span><span class="p">;</span>
   <span class="n">allow</span> <span class="p">(</span><span class="n">add</span><span class="p">)</span> <span class="n">userdn</span> <span class="o">=</span> <span class="s2">&quot;ldap:///uid=($attr.cn),cn=users,cn=accounts,&lt;suffix&gt;&quot;</span><span class="p">;)</span>

<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVaultContainer)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Container members can access the container&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;member#USERDN&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVaultContainer)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Indirect container members can access the container&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;member#GROUPDN&quot;</span><span class="p">;)</span>

<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVaultContainer)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Container members can access sub-containers&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;parent[1].member#USERDN&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVaultContainer)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Indirect container members can access sub-containers&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;parent[1].member#GROUPDN&quot;</span><span class="p">;)</span>

<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVaultContainer)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Container owners can modify the container&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">write</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;owner#USERDN&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVaultContainer)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Indirect container owners can modify the container&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">write</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;owner#GROUPDN&quot;</span><span class="p">;)</span>

<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVaultContainer)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Container owners can manage sub-containers&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;parent[1].owner#USERDN&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVaultContainer)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Indirect container owners can manage sub-containers&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;parent[1].owner#GROUPDN&quot;</span><span class="p">;)</span>

<span class="c1">################################################################################</span>
<span class="c1"># Vault ACLs</span>
<span class="c1">################################################################################</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Container members can access vaults in the container&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;parent[1].member#USERDN&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Indirect container members can access vaults in the container&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;parent[1].member#GROUPDN&quot;</span><span class="p">;)</span>

<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Container owners can manage vaults in the container&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;parent[1].owner#USERDN&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Indirect container owners can manage vaults in the container&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">delete</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;parent[1].owner#GROUPDN&quot;</span><span class="p">;)</span>

<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Vault members can access the vault&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;member#USERDN&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Indirect vault members can access the vault&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;member#GROUPDN&quot;</span><span class="p">;)</span>

<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Vault owners can manage the vault&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">write</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;owner#USERDN&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Indirect vault owners can manage the vault&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">,</span> <span class="n">write</span><span class="p">)</span> <span class="n">userattr</span><span class="o">=</span><span class="s2">&quot;owner#GROUPDN&quot;</span><span class="p">;)</span>

<span class="c1">################################################################################</span>
<span class="c1"># Security Officer ACLs</span>
<span class="c1">################################################################################</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVaultContainer)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Security officers can access all container&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">groupdn</span><span class="o">=</span><span class="s2">&quot;ldap:///cn=security officers,cn=groups,cn=accounts,&lt;suffix&gt;&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Security officers can access all vaults&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">search</span><span class="p">,</span> <span class="n">compare</span><span class="p">)</span> <span class="n">groupdn</span><span class="o">=</span><span class="s2">&quot;ldap:///cn=security officers,cn=groups,cn=accounts,&lt;suffix&gt;&quot;</span><span class="p">;)</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetfilter</span><span class="o">=</span><span class="s2">&quot;(objectClass=ipaVault)&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="s2">&quot;ipaVaultEncSalt || ipaVaultPublicKey || ipaVaultEscrowPublicKey || ipaVaultEscrowedEncKey</span>
   <span class="o">||</span> <span class="n">ipaVaultEscrowedPublicKey</span> <span class="o">||</span> <span class="n">ipaVaultNewSecretSalt</span> <span class="o">||</span> <span class="n">ipaVaultNewPublicKey</span> <span class="o">||</span> <span class="n">ipaVaultNewEscrowedSecretKey</span> <span class="o">||</span> <span class="n">ipaVaultNewEscrowedPublicKey</span><span class="s2">&quot;)</span>
  <span class="p">(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span> <span class="n">acl</span> <span class="s2">&quot;Security officer can reset/change vault password/keys&quot;</span><span class="p">;</span>
   <span class="n">allow</span><span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="n">groupdn</span><span class="o">=</span><span class="s2">&quot;ldap:///cn=security officers,cn=groups,cn=accounts,&lt;suffix&gt;&quot;</span><span class="p">;)</span>
</pre></div>
</div>
</section>
</section>
<section id="kra-service">
<h1>KRA Service<a class="headerlink" href="#kra-service" title="Link to this heading">#</a></h1>
<section id="installing-kra-service">
<h2>Installing KRA service<a class="headerlink" href="#installing-kra-service" title="Link to this heading">#</a></h2>
<p>The KRA service must be installed on each replica before the vault
services can be used properly using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa-kra-install -p &lt;Directory Manager password&gt;
</pre></div>
</div>
</section>
<section id="uninstalling-kra-service">
<h2>Uninstalling KRA service<a class="headerlink" href="#uninstalling-kra-service" title="Link to this heading">#</a></h2>
<p>If the vault functionality is no longer needed, it can be removed using
the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ipa-kra-uninstall -p &lt;Directory Manager password&gt; --uninstall
</pre></div>
</div>
</section>
<section id="kra-authentication">
<h2>KRA authentication<a class="headerlink" href="#kra-authentication" title="Link to this heading">#</a></h2>
<p>IPA is currently accessing CA services as a user that belongs into CA
agents group, so this user needs to be added into KRA agents group as
well during installation.</p>
<p>All operations against the KRA will be executed as KRA agent using KRA
Python client, so the client certificate needs to be stored on IPA
server file system with the appropriate file protection.</p>
<p>IPA user’s access to the secrets stored in KRA will be determined by IPA
framework based on the user’s membership or ownership of the vaults and
containers.</p>
</section>
<section id="mapping-a-vault-into-kra">
<h2>Mapping a vault into KRA<a class="headerlink" href="#mapping-a-vault-into-kra" title="Link to this heading">#</a></h2>
<p>The encrypted secrets in a vault will be stored as a blob in KRA as a
key under the following client key ID:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">namespace</span><span class="o">&gt;/&lt;</span><span class="n">vault</span> <span class="n">ID</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The namespace is used to distinguish secrets from different applications
stored in the same KRA. For IPA the namespace will be “ipa”.</p>
</section>
<section id="archiving-secrets-in-kra">
<h2>Archiving secrets in KRA<a class="headerlink" href="#archiving-secrets-in-kra" title="Link to this heading">#</a></h2>
<p>Regardless of the vault type, the client will transmit the (possibly)
encrypted secrets as generic data to IPA server. The data will be
encrypted with a session key that is unique for each transmission. The
session key itself will be wrapped with KRA transport public key. The
encrypted data and wrapped session key will be sent to IPA server.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VaultClient</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">archive_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vault_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">encrypted_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wrapped_session_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nonce_iv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">transport_cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_transport_cert</span><span class="p">()</span>
            <span class="n">session_key</span> <span class="o">=</span> <span class="n">generate_session_key</span><span class="p">()</span>
            <span class="n">nonce_iv</span> <span class="o">=</span> <span class="n">generate_nonce_iv</span><span class="p">()</span>

            <span class="n">encrypted_data</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">session_key</span><span class="p">,</span>
                <span class="n">nonce_iv</span><span class="p">)</span>

            <span class="n">wrapped_session_key</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span>
                <span class="n">session_key</span><span class="p">,</span>
                <span class="n">transport_cert</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vault_service</span><span class="o">.</span><span class="n">archive_data</span><span class="p">(</span>
            <span class="n">vault_id</span><span class="p">,</span>
            <span class="n">encrypted_data</span><span class="p">,</span>
            <span class="n">wrapped_session_key</span><span class="p">,</span>
            <span class="n">nonce_iv</span><span class="p">)</span>
</pre></div>
</div>
<p>The IPA server will then forward the encrypted data to KRA:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VaultService</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">archive_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vault_id</span><span class="p">,</span> <span class="n">encrypted_data</span><span class="p">,</span> <span class="n">wrapped_session_key</span><span class="p">,</span> <span class="n">nonce_iv</span><span class="p">):</span>

        <span class="n">vault</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vault</span><span class="p">(</span><span class="n">vault_id</span><span class="p">)</span>

        <span class="c1"># verify access rights</span>
        <span class="n">user</span> <span class="o">=</span> <span class="o">...</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="n">get_user_roles</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="n">is_member</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">vault</span><span class="o">.</span><span class="n">members</span>
        <span class="n">is_owner</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">vault</span><span class="o">.</span><span class="n">owners</span>
        <span class="n">is_escrow_officer</span> <span class="o">=</span> <span class="s2">&quot;Security Officers&quot;</span> <span class="ow">in</span> <span class="n">roles</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_member</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_owner</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_escrow_officer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unauthorized access&quot;</span><span class="p">)</span>

        <span class="c1"># archive data as KRA agent</span>
        <span class="n">key_client</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Backend</span><span class="o">.</span><span class="n">kra</span><span class="o">.</span><span class="n">get_key_client</span><span class="p">()</span>
        <span class="n">client_key_id</span> <span class="o">=</span> <span class="s2">&quot;ipa/&quot;</span> <span class="o">+</span> <span class="n">vault_id</span>

        <span class="n">key_client</span><span class="o">.</span><span class="n">archive_encrypted_data</span><span class="p">(</span>
            <span class="n">client_key_id</span><span class="p">,</span>
            <span class="n">encrypted_data</span><span class="p">,</span>
            <span class="n">wrapped_session_key</span><span class="p">,</span>
            <span class="n">nonce_iv</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="retrieving-secrets-from-kra">
<h2>Retrieving secrets from KRA<a class="headerlink" href="#retrieving-secrets-from-kra" title="Link to this heading">#</a></h2>
<p>Regardless of the vault type, the client will send the vault ID to IPA
server to retrieve the encrypted secrets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VaultClient</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">retrieve_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vault_id</span><span class="p">,</span> <span class="n">wrapped_session_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">wrapped_session_key</span><span class="p">:</span>
            <span class="n">transport_cert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">get_transport_cert</span><span class="p">()</span>
            <span class="n">session_key</span> <span class="o">=</span> <span class="n">generate_session_key</span><span class="p">()</span>

            <span class="n">wrapped_session_key</span> <span class="o">=</span> <span class="n">wrap</span><span class="p">(</span>
                <span class="n">session_key</span><span class="p">,</span>
                <span class="n">transport_cert</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vault_service</span><span class="o">.</span><span class="n">retrieve_data</span><span class="p">(</span><span class="n">vault_id</span><span class="p">,</span> <span class="n">wrapped_session_key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
<p>When IPA server receives this call, it will retrieve the encrypted
secrets from KRA and then return it to the client:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VaultService</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">retrieve_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vault_id</span><span class="p">,</span> <span class="n">wrapped_session_key</span><span class="p">):</span>

        <span class="n">vault</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vault</span><span class="p">(</span><span class="n">vault_id</span><span class="p">)</span>

        <span class="c1"># verify access rights</span>
        <span class="n">user</span> <span class="o">=</span> <span class="o">...</span>
        <span class="n">roles</span> <span class="o">=</span> <span class="n">get_user_roles</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="n">is_member</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">vault</span><span class="o">.</span><span class="n">members</span>
        <span class="n">is_owner</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">vault</span><span class="o">.</span><span class="n">owners</span>
        <span class="n">is_escrow_officer</span> <span class="o">=</span> <span class="s2">&quot;Security Officers&quot;</span> <span class="ow">in</span> <span class="n">roles</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_member</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_owner</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_escrow_officer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unauthorized access&quot;</span><span class="p">)</span>

        <span class="c1"># retrieve data as KRA agent</span>
        <span class="n">key_client</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Backend</span><span class="o">.</span><span class="n">kra</span><span class="o">.</span><span class="n">get_key_client</span><span class="p">()</span>
        <span class="n">client_key_id</span> <span class="o">=</span> <span class="s2">&quot;ipa/&quot;</span> <span class="o">+</span> <span class="n">vault_id</span>

        <span class="n">key_info</span> <span class="o">=</span> <span class="n">key_client</span><span class="o">.</span><span class="n">get_active_key_info</span><span class="p">(</span><span class="n">client_key_id</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">key_client</span><span class="o">.</span><span class="n">retrieve_key</span><span class="p">(</span><span class="n">key_info</span><span class="o">.</span><span class="n">key_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</section>
</section>
<section id="dependencies">
<h1>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://fedorahosted.org/389/ticket/47904">Ticket #47904 - RFE: new ACI to limit new entry
RDN</a></p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4638">NSSConnection shutting down existing
database</a></p></li>
<li><p><a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1159462">Missing PBKDF2
support</a></p></li>
<li><p><a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1159463">Missing public/private key encryption
support</a></p></li>
<li><p><a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1114267">python-cryptography</a></p></li>
</ul>
</section>
<section id="testing">
<h1>Testing<a class="headerlink" href="#testing" title="Link to this heading">#</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./make-test ipatests.test_xmlrpc.test_vault_plugin
</pre></div>
</div>
</section>
<section id="frequently-asked-questions">
<h1>Frequently Asked Questions<a class="headerlink" href="#frequently-asked-questions" title="Link to this heading">#</a></h1>
<section id="why-use-python-cryptography-instead-of-python-nss">
<h2>Why use Python Cryptography instead of Python NSS?<a class="headerlink" href="#why-use-python-cryptography-instead-of-python-nss" title="Link to this heading">#</a></h2>
<p>Although IPA and Dogtag have been using Python NSS, the Python
Cryptography is simpler to use and it can support various crypto
backends. Since there is no strict requirement to use NSS, it’s
recommended to use Python Cryptography for new development.</p>
</section>
<section id="can-different-vault-members-use-different-vault-passwords">
<h2>Can different vault members use different vault passwords?<a class="headerlink" href="#can-different-vault-members-use-different-vault-passwords" title="Link to this heading">#</a></h2>
<p>No. There is only one vault password per vault, and it has to be shared
with all members.</p>
</section>
<section id="can-the-secrets-in-the-same-vault-be-archived-with-different-passwords">
<h2>Can the secrets in the same vault be archived with different passwords?<a class="headerlink" href="#can-the-secrets-in-the-same-vault-be-archived-with-different-passwords" title="Link to this heading">#</a></h2>
<p>No. There’s only one vault password per vault and it will be used to
encrypt all secrets.</p>
</section>
<section id="will-the-secrets-in-the-same-vault-encrypted-with-different-encryption-keys">
<h2>Will the secrets in the same vault encrypted with different encryption keys?<a class="headerlink" href="#will-the-secrets-in-the-same-vault-encrypted-with-different-encryption-keys" title="Link to this heading">#</a></h2>
<p>No. All secrets in the same vault are encrypted with a single encryption
key which is generated from the vault password and the secret salt.</p>
</section>
<section id="can-a-vault-have-more-than-one-escrow-officer">
<h2>Can a vault have more than one escrow officer?<a class="headerlink" href="#can-a-vault-have-more-than-one-escrow-officer" title="Link to this heading">#</a></h2>
<p>Yes. A vault can be assigned a pair of escrow public and private keys.
The escrow public key will be stored as an attribute in the vault such
that the owners can use it to encrypt the vault secret/private key to be
escrowed. The escrow private key will be stpred by the escrow officers,
but it can be shared by multiple escrow officers, so any of the escrow
officers will be able to decrypt the vault secret/private key to recover
the secrets.</p>
</section>
</section>
<section id="to-do">
<h1>To Do<a class="headerlink" href="#to-do" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Merge vault and vault container</p></li>
<li><p>Add support for renaming users.</p></li>
<li><p>Add support for symmetric/asymmetric vault without KRA transport
encryption.</p></li>
<li><p>Add attribute to indicate single secret / multiple secrets in a
vault.</p></li>
<li><p>Clarify how the services container is supposed to be used.</p></li>
<li><p>Online escrow: need a vault to store escrow private key.</p></li>
<li><p>Add option to generate public &amp; private keys automatically and
archive it in KRA.</p></li>
</ul>
</section>
<section id="references">
<h1>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="V4/Password_Vault">Password Vault</a></p></li>
<li><p><a class="reference external" href="http://www-archive.mozilla.org/projects/security/pki/nss/tech-notes/tn5.html">Using NSS to perform miscellaneous cryptographic
operations</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=r_Pj__qjBvA">The State of Crypto in Python - PyCon
2014</a></p></li>
<li><p><a class="reference external" href="https://dvcs.w3.org/hg/webcrypto-api/raw-file/tip/spec/Overview.html">Web Cryptography
API</a></p></li>
<li><p><a class="reference external" href="https://bugzilla.mozilla.org/show_bug.cgi?id=865789">Bug 865789 - (web-crypto) Implement W3C Web Crypto
API</a></p></li>
<li><p><a class="reference external" href="https://docs.google.com/spreadsheet/ccc?key=0AiAcidBZRLxndE9LWEs2R1oxZ0xidUVoU3FQbFFobkE&amp;usp=sharing">WebCrypto Feature
Matrix</a></p></li>
<li><p><a class="reference external" href="https://access.redhat.com/documentation/en-US/Red_Hat_Directory_Server/9.0/html/Administration_Guide/Managing_Access_Control.html">RHDS 9.0 Administration Guilde - Managing Access
Control</a></p></li>
<li><p><a class="reference external" href="http://pki.fedoraproject.org/wiki/Using-the-Python-Key-Client">Using the Python Key
Client</a></p></li>
<li><p><a class="reference external" href="http://pki.fedoraproject.org/wiki/PKI_ReST_API_-_Introduction">PKI REST API -
Introduction</a></p></li>
<li><p><a class="reference external" href="http://security.stackexchange.com/questions/211/how-to-securely-hash-passwords/31846">How to securely hash
passwords?</a></p></li>
<li><p><a class="reference external" href="https://www.dlitz.net/software/pycrypto/">PyCrypto</a></p></li>
</ul>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Notice - Design Document</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#secret">Secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault">Vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#standard-vault">Standard Vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#symmetric-vault">Symmetric Vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#asymmetric-vault">Asymmetric Vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#container">Container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-control">Access Control</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#installation">Installation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#container-managerment">Container Managerment</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#listing-available-containers">Listing available containers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#displaying-container-info">Displaying container info</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-container">Adding a container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-a-container">Modifying a container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-a-container">Removing a container</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-container-member">Adding container member</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-container-member">Removing container member</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-container-owner">Adding container owner</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-container-owner">Removing container owner</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-management">Vault Management</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#listing-available-vaults">Listing available vaults</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#displaying-vault-info">Displaying vault info</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-new-vault">Creating a new vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#archiving-data">Archiving data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-data">Retrieving data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copying-a-vault">Copying a vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-a-vault">Modifying a vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-a-vault">Removing a vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-vault-password">Changing vault password</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-vault-member">Adding vault member</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-vault-member">Removing vault member</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-vault-owner">Adding vault owner</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#removing-vault-owner">Removing vault owner</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#secret-management">Secret Management</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#listing-secrets-in-a-vault">Listing secrets in a vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-a-secret">Adding a secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-a-secret">Retrieving a secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copying-a-secret">Copying a secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-secret-attributes">Modifying secret attributes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deleting-a-secret">Deleting a secret</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#escrow-operations">Escrow Operations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-a-vault-with-escrow">Creating a vault with escrow</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#escrowing-an-existing-vault">Escrowing an existing vault</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recovering-an-escrowed-secret">Recovering an escrowed secret</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-escrowed-vault-password">Changing escrowed vault password</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#service-operations">Service Operations</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-service-vault-password">Creating service vault password</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#provisioning-service-vault-password-for-service-instance">Provisioning service vault password for service instance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-service-vault-password-for-service-instance">Retrieving service vault password for service instance</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-service-vault-password">Changing service vault password</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-management">Configuration Management</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#displaying-global-vault-configuration">Displaying global vault configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#modifying-global-vault-configuration">Modifying global vault configuration</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#crypto-library">Crypto Library</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-salt">Generating salt</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-password-based-symmetric-encryption-key">Generating password-based symmetric encryption key</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-asymmetric-key-pair">Generating asymmetric key pair</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#encryption-with-symmetric-algorithm">Encryption with symmetric algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#encryption-with-asymmetric-algorithm">Encryption with asymmetric algorithm</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#client-api">Client API</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipaconnection-class">IPAConnection class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-class">Vault class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#secret-class">Secret class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultclient-class">VaultClient class</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultcontianer-find">vaultcontianer_find()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultcontainer-get">vaultcontainer_get()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultcontainer-add">vaultcontainer_add()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultcontainer-del">vaultcontainer_del()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-find">vault_find()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-get">vault_get()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-add">vault_add()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-update">vault_update()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-change-type">vault_change_type()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-change-escrow">vault_change_escrow()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-del">vault_del()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-archive">vault_archive()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-retrieve">vault_retrieve()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultsecret-archive">vaultsecret_archive()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vaultsecret-retrieve">vaultsecret_retrieve()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-change-password">vault_change_password()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-reset-password">vault_reset_password()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#approve-vault-password-reset">approve_vault_password_reset()</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reject-vault-password-reset">reject_vault_password_reset()</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#web-services">Web Services</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#container-resource">Container resource</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#put-ipa-rest-vaults">PUT /ipa/rest/vaults/</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-ipa-rest-vaults">GET /ipa/rest/vaults/</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#vault-resource">Vault resource</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">GET /ipa/rest/vaults//</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#post-ipa-rest-vaults">POST /ipa/rest/vaults/</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">POST /ipa/rest/vaults//</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#delete-ipa-rest-vaults">DELETE /ipa/rest/vaults/</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">DELETE /ipa/rest/vaults//</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#secret-resource">Secret resource</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-ipa-rest-vaults-secrets">GET /ipa/rest/vaults///secrets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#put-ipa-rest-vaults-secrets">PUT /ipa/rest/vaults///secrets</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ldap-directory">LDAP Directory</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#directory-structure">Directory Structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ldap-schema">LDAP Schema</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-control-attributes">Access Control Attributes</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#kra-service">KRA Service</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installing-kra-service">Installing KRA service</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#uninstalling-kra-service">Uninstalling KRA service</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kra-authentication">KRA authentication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mapping-a-vault-into-kra">Mapping a vault into KRA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#archiving-secrets-in-kra">Archiving secrets in KRA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieving-secrets-from-kra">Retrieving secrets from KRA</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencies">Dependencies</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">Testing</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#frequently-asked-questions">Frequently Asked Questions</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-use-python-cryptography-instead-of-python-nss">Why use Python Cryptography instead of Python NSS?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#can-different-vault-members-use-different-vault-passwords">Can different vault members use different vault passwords?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#can-the-secrets-in-the-same-vault-be-archived-with-different-passwords">Can the secrets in the same vault be archived with different passwords?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#will-the-secrets-in-the-same-vault-encrypted-with-different-encryption-keys">Will the secrets in the same vault encrypted with different encryption keys?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#can-a-vault-have-more-than-one-escrow-officer">Can a vault have more than one escrow officer?</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#to-do">To Do</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>