

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Promote_CA_to_Renewal_and_CRL_Master &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/Howto/Promote_CA_to_Renewal_and_CRL_Master';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="/_static/freeipa-logo-small.png" class="logo__image only-light" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/Howto/Promote_CA_to_Renewal_and_CRL_Master.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Promote_CA_to_Renewal_and_CRL_Master</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#procedure-in-freeipa-4-0-or-later">Procedure in FreeIPA 4.0 or later</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-current-first-master">Identifying current first master</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reconfiguring-a-ca-as-a-clone">Reconfiguring a CA as a clone</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-clone-renewal">Configure clone renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stop-crl-generation">Stop CRL generation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stop-certificate-status-update-task">Stop Certificate Status Update Task</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reconfigure-a-ca-as-the-new-master">Reconfigure a CA as the new master</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-ca-renewal">Configure CA renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#start-crl-generation">Start CRL generation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#start-certificate-status-update-task">Start Certificate Status Update Task</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#procedure-in-freeipa-4-0">Procedure in FreeIPA &lt; 4.0</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Identifying current first master</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Reconfiguring a CA as a clone</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unconfigure-the-master-renewal">Unconfigure the master renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Configure clone renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Stop CRL generation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Reconfigure a CA as the new master</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unconfigure-the-clone-renewal">Unconfigure the clone renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Configure CA renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Start CRL generation</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="promote-ca-to-renewal-and-crl-master">
<h1>Promote_CA_to_Renewal_and_CRL_Master<a class="headerlink" href="#promote-ca-to-renewal-and-crl-master" title="Permalink to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>A CA replica is called a clone in dogtag parlance, and it is a very apt
description. Several of the CA certificates are duplicated on each
clone. This makes the process of renewing those certificates complicated
because they need to remain the same across the infrastructure.</p>
<p>Another area where clones acts differently is a generation of CRL. The
list needs to be generated from a single server to avoid inconsistent
revocation lists across replicas, for example when a replication is
temporarily broken between such replicas.</p>
<p>And finally, a single server is responsible to execute a task to update
the state of the certificates issued (VALID, EXPIRED, etc). This is run
on a single server to avoid replication issues due to updating the same
values on multiple servers at once. For more details see
<a class="github reference external" href="https://github.com/dogtagpki/pki/wiki/Configuring-Certificate-Status-Update-Task">dogtagpki/pki</a></p>
<p>To achieve this, FreeIPA marks the first installed master with a CA, as
the “first master.” It is configured to renew the certificates and make
them available to the other clones and to listen to and generate the
CRL.</p>
<p>Two important things to note:</p>
<ol class="arabic simple">
<li><p>There should only one master at a time, otherwise the renewed
certificates will step all over each other.</p></li>
<li><p>Any CA can be the master. There is nothing magical about it, this is
just configuration.</p></li>
</ol>
</section>
<section id="procedure-in-freeipa-4-0-or-later">
<h2>Procedure in FreeIPA 4.0 or later<a class="headerlink" href="#procedure-in-freeipa-4-0-or-later" title="Permalink to this heading">#</a></h2>
</section>
<section id="identifying-current-first-master">
<h2>Identifying current first master<a class="headerlink" href="#identifying-current-first-master" title="Permalink to this heading">#</a></h2>
<p>The hostname of the renewal master can be determined from LDAP:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ldapsearch -H ldap://$HOSTNAME -D &#39;cn=Directory Manager&#39; -W -b &#39;cn=masters,cn=ipa,cn=etc,dc=example,dc=com&#39; &#39;(&amp;(cn=CA)(ipaConfigString=caRenewalMaster))&#39; dn
Enter LDAP Password:
# extended LDIF
#
# LDAPv3
# base &lt;cn=masters,cn=ipa,cn=etc,dc=example,dc=com&gt; with scope subtree
# filter: (&amp;(cn=CA)(ipaConfigString=caRenewalMaster))
# requesting: dn
#

# CA, ipa1.example.com, masters, ipa, etc, example.com
dn: cn=CA,cn=ipa1.example.com,cn=masters,cn=ipa,cn=etc,dc=example,dc=com

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1
</pre></div>
</div>
<p>Here it is <code class="docutils literal notranslate"><span class="pre">ipa1.example.com</span></code>.</p>
<p>The CRL generation master can be determined by looking at CS.cfg on each
CA:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># grep ca.crl.MasterCRL.enableCRLUpdates /etc/pki/pki-tomcat/ca/CS.cfg</span>
<span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">MasterCRL</span><span class="o">.</span><span class="n">enableCRLUpdates</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>If the value is <code class="docutils literal notranslate"><span class="pre">true</span></code>, then it is the CRL generation master,
otherwise it is a clone.</p>
</section>
<section id="reconfiguring-a-ca-as-a-clone">
<h2>Reconfiguring a CA as a clone<a class="headerlink" href="#reconfiguring-a-ca-as-a-clone" title="Permalink to this heading">#</a></h2>
<section id="configure-clone-renewal">
<h3>Configure clone renewal<a class="headerlink" href="#configure-clone-renewal" title="Permalink to this heading">#</a></h3>
<p>This is done automatically when you configure some other CA as renewal
master.</p>
</section>
<section id="stop-crl-generation">
<h3>Stop CRL generation<a class="headerlink" href="#stop-crl-generation" title="Permalink to this heading">#</a></h3>
<p>Stop CA service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl stop pki-tomcatd@pki-tomcat</span>
</pre></div>
</div>
<p>Set the value of <code class="docutils literal notranslate"><span class="pre">ca.crl.MasterCRL.enableCRLCache</span></code> and
<code class="docutils literal notranslate"><span class="pre">ca.crl.MasterCRL.enableCRLUpdates</span></code> in
<code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/ca/CS.cfg</span></code> to <code class="docutils literal notranslate"><span class="pre">false</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">MasterCRL</span><span class="o">.</span><span class="n">enableCRLCache</span><span class="o">=</span><span class="n">false</span>
<span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">MasterCRL</span><span class="o">.</span><span class="n">enableCRLUpdates</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
</section>
<section id="stop-certificate-status-update-task">
<h3>Stop Certificate Status Update Task<a class="headerlink" href="#stop-certificate-status-update-task" title="Permalink to this heading">#</a></h3>
<p>Remove the values of <code class="docutils literal notranslate"><span class="pre">ca.transitRecordPageSize</span></code> and
<code class="docutils literal notranslate"><span class="pre">ca.transitMaxRecords</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/ca/CS.cfg</span></code>.</p>
<p>Set the value of <code class="docutils literal notranslate"><span class="pre">ca.certStatusUpdateInterval</span></code> in
<code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/ca/CS.cfg</span></code> to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span><span class="o">.</span><span class="n">certStatusUpdateInterval</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p>Start CA service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl start pki-tomcatd@pki-tomcat</span>
</pre></div>
</div>
<p>Configure Apache to redirect CRL requests to the new master in
<code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d/ipa-pki-proxy.conf</span></code> by uncommenting the RewriteRule
on the last line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Only enable this on servers that are not generating a CRL
RewriteRule ^/ipa/crl/MasterCRL.bin https://&lt;hostname&gt;/ca/ee/ca/getCRL?op=getCRL&amp;crlIssuingPoint=MasterCRL [L,R=301,NC]
</pre></div>
</div>
<p>Restart Apache:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl restart httpd</span>
</pre></div>
</div>
</section>
</section>
<section id="reconfigure-a-ca-as-the-new-master">
<h2>Reconfigure a CA as the new master<a class="headerlink" href="#reconfigure-a-ca-as-the-new-master" title="Permalink to this heading">#</a></h2>
<section id="configure-ca-renewal">
<h3>Configure CA renewal<a class="headerlink" href="#configure-ca-renewal" title="Permalink to this heading">#</a></h3>
<p>Run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ipa-csreplica-manage set-renewal-master</span>
</pre></div>
</div>
</section>
<section id="start-crl-generation">
<h3>Start CRL generation<a class="headerlink" href="#start-crl-generation" title="Permalink to this heading">#</a></h3>
<p>Stop CA service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl stop pki-tomcatd@pki-tomcat</span>
</pre></div>
</div>
<p>Set the value of <code class="docutils literal notranslate"><span class="pre">ca.crl.MasterCRL.enableCRLCache</span></code> and
<code class="docutils literal notranslate"><span class="pre">ca.crl.MasterCRL.enableCRLUpdates</span></code> in
<code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/ca/CS.cfg</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">MasterCRL</span><span class="o">.</span><span class="n">enableCRLCache</span><span class="o">=</span><span class="n">true</span>
<span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">MasterCRL</span><span class="o">.</span><span class="n">enableCRLUpdates</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
</section>
<section id="start-certificate-status-update-task">
<h3>Start Certificate Status Update Task<a class="headerlink" href="#start-certificate-status-update-task" title="Permalink to this heading">#</a></h3>
<p>Set the values <code class="docutils literal notranslate"><span class="pre">ca.transitRecordPageSize</span></code> and <code class="docutils literal notranslate"><span class="pre">ca.transitMaxRecords</span></code>
in <code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/ca/CS.cfg</span></code> ca.transitRecordPageSize=200
ca.transitMaxRecords=1000000</p>
<p>Either remove <code class="docutils literal notranslate"><span class="pre">ca.certStatusUpdateInterval=0</span></code> or set the value to 600
(the default).</p>
<p>Start CA service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl start pki-tomcatd@pki-tomcat</span>
</pre></div>
</div>
<p>Configure Apache to handle CRL requests in
<code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d/ipa-pki-proxy.conf</span></code> by commenting out the
RewriteRule on the last line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only enable this on servers that are not generating a CRL</span>
<span class="c1">#RewriteRule ^/ipa/crl/MasterCRL.bin https://&lt;hostname&gt;/ca/ee/ca/getCRL?op=getCRL&amp;crlIssuingPoint=MasterCRL [L,R=301,NC]</span>
</pre></div>
</div>
<p>Restart Apache:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># systemctl restart httpd</span>
</pre></div>
</div>
<p><a class="github reference external" href="https://github.com/dogtagpki/pki/wiki/Configuring-Certificate-Status-Update-Task">dogtagpki/pki</a></p>
</section>
</section>
<section id="procedure-in-freeipa-4-0">
<h2>Procedure in FreeIPA &lt; 4.0<a class="headerlink" href="#procedure-in-freeipa-4-0" title="Permalink to this heading">#</a></h2>
</section>
<section id="id1">
<h2>Identifying current first master<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h2>
<p>This can be determined by looking at the certificates managed by
certmonger on each CA</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># getcert list -d /var/lib/pki-ca/alias -n &quot;subsystemCert cert-pki-ca&quot; | grep post-save</span>
        <span class="n">post</span><span class="o">-</span><span class="n">save</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ipa</span><span class="o">/</span><span class="n">certmonger</span><span class="o">/</span><span class="n">renew_ca_cert</span> <span class="s2">&quot;subsystemCert cert-pki-ca&quot;</span>
</pre></div>
</div>
<p>If it contains <code class="docutils literal notranslate"><span class="pre">renew_ca_cert</span></code> then it is the CA renewal master.</p>
<p>If it contains <code class="docutils literal notranslate"><span class="pre">restart_pkicad</span></code> then it is a CA renewal clone.</p>
</section>
<section id="id2">
<h2>Reconfiguring a CA as a clone<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h2>
<p>This step changes current <em>first master</em> into a standard clone.</p>
<section id="unconfigure-the-master-renewal">
<h3>Unconfigure the master renewal<a class="headerlink" href="#unconfigure-the-master-renewal" title="Permalink to this heading">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># getcert stop-tracking -d /var/lib/pki-ca/alias -n &quot;auditSigningCert cert-pki-ca&quot;</span>
<span class="c1"># getcert stop-tracking -d /var/lib/pki-ca/alias -n &quot;ocspSigningCert cert-pki-ca&quot;</span>
<span class="c1"># getcert stop-tracking -d /var/lib/pki-ca/alias -n &quot;subsystemCert cert-pki-ca&quot;</span>
<span class="c1"># getcert stop-tracking -d /etc/httpd/alias -n ipaCert</span>
</pre></div>
</div>
<p>You should see output like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Request</span> <span class="s2">&quot;20131127184547&quot;</span> <span class="n">removed</span><span class="o">.</span>
<span class="n">Request</span> <span class="s2">&quot;20131127184548&quot;</span> <span class="n">removed</span><span class="o">.</span>
<span class="n">Request</span> <span class="s2">&quot;20131127184549&quot;</span> <span class="n">removed</span><span class="o">.</span>
<span class="n">Request</span> <span class="s2">&quot;20131127184550&quot;</span> <span class="n">removed</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="id3">
<h3>Configure clone renewal<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<p>First see if the renewal CA is available:</p>
<p><code class="docutils literal notranslate"><span class="pre"># getcert list-cas</span></code></p>
<p>Look for a /var/lib/certmonger/cas/ca_renewal</p>
<p>If it does not exist:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cp /usr/share/ipa/ca_renewal /var/lib/certmonger/cas/ca_renewal</span>
<span class="c1"># chmod 0600 /var/lib/certmonger/cas/ca_renewal</span>
<span class="c1"># /sbin/restorecon  /var/lib/certmonger/cas/ca_renewal</span>
<span class="c1"># service certmonger restart</span>
<span class="c1"># getcert list-cas</span>
</pre></div>
</div>
<p>Verify that the new CA is available in the <code class="docutils literal notranslate"><span class="pre">list-cas</span></code> output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CA</span> <span class="s1">&#39;dogtag-ipa-retrieve-agent-submit&#39;</span><span class="p">:</span>
        <span class="ow">is</span><span class="o">-</span><span class="n">default</span><span class="p">:</span> <span class="n">no</span>
        <span class="n">ca</span><span class="o">-</span><span class="nb">type</span><span class="p">:</span> <span class="n">EXTERNAL</span>
        <span class="n">helper</span><span class="o">-</span><span class="n">location</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">libexec</span><span class="o">/</span><span class="n">certmonger</span><span class="o">/</span><span class="n">dogtag</span><span class="o">-</span><span class="n">ipa</span><span class="o">-</span><span class="n">retrieve</span><span class="o">-</span><span class="n">agent</span><span class="o">-</span><span class="n">submit</span>
</pre></div>
</div>
<p>Get the CA certificate database pin:</p>
<p><code class="docutils literal notranslate"><span class="pre"># grep internal= /var/lib/pki-ca/conf/password.conf</span></code></p>
<p>Configure renewal</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># getcert start-tracking -c dogtag-ipa-retrieve-agent-submit -d /var/lib/pki-ca/alias -n &quot;auditSigningCert cert-pki-ca&quot; -B /usr/lib64/ipa/certmonger/stop_pkicad -C &#39;/usr/lib64/ipa/certmonger/restart_pkicad &quot;auditSigningCert cert-pki-ca&quot;&#39; -T &quot;auditSigningCert cert-pki-ca&quot; -P &lt;pin&gt;</span>
<span class="c1"># getcert start-tracking -c dogtag-ipa-retrieve-agent-submit -d /var/lib/pki-ca/alias -n &quot;ocspSigningCert cert-pki-ca&quot; -B /usr/lib64/ipa/certmonger/stop_pkicad -C &#39;/usr/lib64/ipa/certmonger/restart_pkicad &quot;ocspSigningCert cert-pki-ca&quot;&#39; -T &quot;ocspSigningCert cert-pki-ca&quot; -P &lt;pin&gt;</span>
<span class="c1"># getcert start-tracking -c dogtag-ipa-retrieve-agent-submit -d /var/lib/pki-ca/alias -n &quot;subsystemCert cert-pki-ca&quot; -B /usr/lib64/ipa/certmonger/stop_pkicad -C &#39;/usr/lib64/ipa/certmonger/restart_pkicad &quot;subsystemCert cert-pki-ca&quot;&#39; -T &quot;subsystemCert cert-pki-ca&quot; -P &lt;pin&gt;</span>
<span class="c1"># getcert start-tracking -c dogtag-ipa-retrieve-agent-submit -d /etc/httpd/alias -n ipaCert -C /usr/lib64/ipa/certmonger/restart_httpd -T ipaCert -p /etc/httpd/alias/pwdfile.txt</span>
</pre></div>
</div>
<p>You should see output like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">New</span> <span class="n">tracking</span> <span class="n">request</span> <span class="s2">&quot;20131127184743&quot;</span> <span class="n">added</span><span class="o">.</span>
<span class="n">New</span> <span class="n">tracking</span> <span class="n">request</span> <span class="s2">&quot;20131127184744&quot;</span> <span class="n">added</span><span class="o">.</span>
<span class="n">New</span> <span class="n">tracking</span> <span class="n">request</span> <span class="s2">&quot;20131127184745&quot;</span> <span class="n">added</span><span class="o">.</span>
<span class="n">New</span> <span class="n">tracking</span> <span class="n">request</span> <span class="s2">&quot;20131127184746&quot;</span> <span class="n">added</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3>Stop CRL generation<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h3>
<p>Stop CA service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># service pki-cad stop</span>
</pre></div>
</div>
<p>Set the value of <code class="docutils literal notranslate"><span class="pre">ca.crl.MasterCRL.enableCRLCache</span></code> and
<code class="docutils literal notranslate"><span class="pre">ca.crl.MasterCRL.enableCRLUpdates</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/pki-ca/CS.cfg</span></code> to
<code class="docutils literal notranslate"><span class="pre">false</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">MasterCRL</span><span class="o">.</span><span class="n">enableCRLCache</span><span class="o">=</span><span class="n">false</span>
<span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">MasterCRL</span><span class="o">.</span><span class="n">enableCRLUpdates</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
<p>Start CA service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># service pki-cad start</span>
</pre></div>
</div>
<p>Configure Apache to redirect CRL requests to the new master in
<code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d/ipa-pki-proxy.conf</span></code> by uncommenting the RewriteRule
on the last line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Only enable this on servers that are not generating a CRL
RewriteRule ^/ipa/crl/MasterCRL.bin https://&lt;hostname&gt;/ca/ee/ca/getCRL?op=getCRL&amp;crlIssuingPoint=MasterCRL [L,R=301,NC]
</pre></div>
</div>
<p>Restart Apache:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># service httpd restart</span>
</pre></div>
</div>
</section>
</section>
<section id="id5">
<h2>Reconfigure a CA as the new master<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h2>
<section id="unconfigure-the-clone-renewal">
<h3>Unconfigure the clone renewal<a class="headerlink" href="#unconfigure-the-clone-renewal" title="Permalink to this heading">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># getcert stop-tracking -d /var/lib/pki-ca/alias -n &quot;auditSigningCert cert-pki-ca&quot;</span>
<span class="c1"># getcert stop-tracking -d /var/lib/pki-ca/alias -n &quot;ocspSigningCert cert-pki-ca&quot;</span>
<span class="c1"># getcert stop-tracking -d /var/lib/pki-ca/alias -n &quot;subsystemCert cert-pki-ca&quot;</span>
<span class="c1"># getcert stop-tracking -d /etc/httpd/alias -n ipaCert</span>
</pre></div>
</div>
<p>You should see output like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Request</span> <span class="s2">&quot;20131127163822&quot;</span> <span class="n">removed</span><span class="o">.</span>
<span class="n">Request</span> <span class="s2">&quot;20131127163823&quot;</span> <span class="n">removed</span><span class="o">.</span>
<span class="n">Request</span> <span class="s2">&quot;20131127163824&quot;</span> <span class="n">removed</span><span class="o">.</span>
<span class="n">Request</span> <span class="s2">&quot;20131127164042&quot;</span> <span class="n">removed</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>Configure CA renewal<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h3>
<p>Get the CA certificate database pin:</p>
<p><code class="docutils literal notranslate"><span class="pre"># grep internal= /var/lib/pki-ca/conf/password.conf</span></code></p>
<p>Configure renewal</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># getcert start-tracking -c dogtag-ipa-renew-agent -d /var/lib/pki-ca/alias -n &quot;auditSigningCert cert-pki-ca&quot; -B /usr/lib64/ipa/certmonger/stop_pkicad -C &#39;/usr/lib64/ipa/certmonger/renew_ca_cert &quot;auditSigningCert cert-pki-ca&quot;&#39; -P &lt;pin&gt;</span>
<span class="c1"># getcert start-tracking -c dogtag-ipa-renew-agent -d /var/lib/pki-ca/alias -n &quot;ocspSigningCert cert-pki-ca&quot; -B /usr/lib64/ipa/certmonger/stop_pkicad -C &#39;/usr/lib64/ipa/certmonger/renew_ca_cert &quot;ocspSigningCert cert-pki-ca&quot;&#39; -P &lt;pin&gt;</span>
<span class="c1"># getcert start-tracking -c dogtag-ipa-renew-agent -d /var/lib/pki-ca/alias -n &quot;subsystemCert cert-pki-ca&quot; -B /usr/lib64/ipa/certmonger/stop_pkicad -C &#39;/usr/lib64/ipa/certmonger/renew_ca_cert &quot;subsystemCert cert-pki-ca&quot;&#39; -P &lt;pin&gt;</span>
<span class="c1"># getcert start-tracking -c dogtag-ipa-renew-agent -d /etc/httpd/alias -n ipaCert -C /usr/lib64/ipa/certmonger/renew_ra_cert -p /etc/httpd/alias/pwdfile.txt</span>
</pre></div>
</div>
<p>You should see output like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">New</span> <span class="n">tracking</span> <span class="n">request</span> <span class="s2">&quot;20131127185430&quot;</span> <span class="n">added</span><span class="o">.</span>
<span class="n">New</span> <span class="n">tracking</span> <span class="n">request</span> <span class="s2">&quot;20131127185431&quot;</span> <span class="n">added</span><span class="o">.</span>
<span class="n">New</span> <span class="n">tracking</span> <span class="n">request</span> <span class="s2">&quot;20131127185432&quot;</span> <span class="n">added</span><span class="o">.</span>
<span class="n">New</span> <span class="n">tracking</span> <span class="n">request</span> <span class="s2">&quot;20131127185433&quot;</span> <span class="n">added</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="id7">
<h3>Start CRL generation<a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h3>
<p>Stop CA service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># service pki-cad stop</span>
</pre></div>
</div>
<p>Set the value of <code class="docutils literal notranslate"><span class="pre">ca.crl.MasterCRL.enableCRLCache</span></code> and
<code class="docutils literal notranslate"><span class="pre">ca.crl.MasterCRL.enableCRLUpdates</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/pki-ca/CS.cfg</span></code> to
<code class="docutils literal notranslate"><span class="pre">true</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">MasterCRL</span><span class="o">.</span><span class="n">enableCRLCache</span><span class="o">=</span><span class="n">true</span>
<span class="n">ca</span><span class="o">.</span><span class="n">crl</span><span class="o">.</span><span class="n">MasterCRL</span><span class="o">.</span><span class="n">enableCRLUpdates</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>Start CA service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># service pki-cad start</span>
</pre></div>
</div>
<p>Configure Apache to handle CRL requests in
<code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d/ipa-pki-proxy.conf</span></code> by commenting out the
RewriteRule on the last line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only enable this on servers that are not generating a CRL</span>
<span class="c1">#RewriteRule ^/ipa/crl/MasterCRL.bin https://&lt;hostname&gt;/ca/ee/ca/getCRL?op=getCRL&amp;crlIssuingPoint=MasterCRL [L,R=301,NC]</span>
</pre></div>
</div>
<p>Restart Apache:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># service httpd restart</span>
</pre></div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#procedure-in-freeipa-4-0-or-later">Procedure in FreeIPA 4.0 or later</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-current-first-master">Identifying current first master</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reconfiguring-a-ca-as-a-clone">Reconfiguring a CA as a clone</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-clone-renewal">Configure clone renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stop-crl-generation">Stop CRL generation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stop-certificate-status-update-task">Stop Certificate Status Update Task</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reconfigure-a-ca-as-the-new-master">Reconfigure a CA as the new master</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-ca-renewal">Configure CA renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#start-crl-generation">Start CRL generation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#start-certificate-status-update-task">Start Certificate Status Update Task</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#procedure-in-freeipa-4-0">Procedure in FreeIPA &lt; 4.0</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Identifying current first master</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Reconfiguring a CA as a clone</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unconfigure-the-master-renewal">Unconfigure the master renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Configure clone renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Stop CRL generation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Reconfigure a CA as the new master</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#unconfigure-the-clone-renewal">Unconfigure the clone renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Configure CA renewal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Start CRL generation</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>