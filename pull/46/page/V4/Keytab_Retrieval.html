
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Keytab_Retrieval &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/Keytab_Retrieval';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/Keytab_Retrieval.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Keytab_Retrieval</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation">A load balancing cluster of HTTP server that allow GSSAPI/Krb5 negotiation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-extended-operation">New Extended operation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-control">Access Control</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-schema">New Schema</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-acis">New ACIs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compatibility-with-older-freeipa-servers">Compatibility with older FreeIPA servers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-test">How to Test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation-tbd">Use Case: A load balancing cluster of HTTP server that allow GSSAPI/Krb5 negotiation (TBD)</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="keytab-retrieval">
<h1>Keytab_Retrieval<a class="headerlink" href="#keytab-retrieval" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>Currently, once a Kerberos key has been created it is not possible to
retrieve it from the <a class="reference external" href="Kerberos">KDC</a>. The only option is to generate
a new key. However it is suboptimal when multiple machines (e.g. a
cluster) need to share the same key (high availability/load balancing
purposes). In these cases distributing the key needs to be performed
completely through out of band/custom channels.</p>
<p>A mechanism to be able to retrieve an existing key from the
<a class="reference external" href="Kerberos">KDC</a> (subject to access control) resolves the <em>secure
distribution channel</em> problem. Leaving to the cluster members only the
problem of retrieving the key when a new one is created or an old one
rotated.</p>
<p>Additionally, the current <code class="docutils literal notranslate"><span class="pre">setkeytab</span></code> extended operation is suboptimal
as it creates keys on the client system. This has 2 bad side effects:</p>
<ol class="arabic simple">
<li><p>Password policies can’t be applied because the server never sees the
plain text</p></li>
<li><p>Keys for algorithms unknown to the client but known to the server
cannot be generated (useful when admins workstations request keys on
behalf of other systems).</p></li>
</ol>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h2>
</section>
<section id="a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation">
<h2>A load balancing cluster of HTTP server that allow GSSAPI/Krb5 negotiation<a class="headerlink" href="#a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation" title="Link to this heading">#</a></h2>
<p>The load balancing servers need to be able to share the same Service
Principal Name (SPN) for <code class="docutils literal notranslate"><span class="pre">HTTP/public-http-server-name&#64;REALM</span></code> and key
so that whichever cluster member a client contact can decrypt the ticket
and authenticate the client.</p>
<p>This may be coupled with throwaway machines, where for example the
number of load balancer cluster members increase dynamically with the
traffic, so new machines are added to the pool dynamically.</p>
<p>In this case, assuming provisioning of individual machines credentials
is taken care of by the provisioning software, each machine can be given
the right to fetch the key for the common SPN, so that they can obtain
the necessary key material via an authenticated request to the IPA
server.</p>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Link to this heading">#</a></h2>
<p>The solution is to extend the password management plugin in FreeIPA to
also allow retrieving existing keys, and subject retrieval to <strong>strict
access control</strong>.</p>
<p>One of the problems of designing access control is that we cannot rely
just on making the <code class="docutils literal notranslate"><span class="pre">KrbPrincipalKey</span></code> attribute readable. Because that
attribute is actually encrypted and needs to be decrypted before a
keytab can be returned. It would also mean the attribute can be
explicitly fetched and brute force attacks run on it.</p>
<p>Because we need to process a request we need to create a new extended
operation similar to the <code class="docutils literal notranslate"><span class="pre">setkeytab</span></code> extended operation already
available.</p>
</section>
<section id="new-extended-operation">
<h2>New Extended operation<a class="headerlink" href="#new-extended-operation" title="Link to this heading">#</a></h2>
<p>New Extended operation OID: <strong>2.16.840.1.113730.3.8.10.5</strong></p>
<p>The new extended operation allows to create a new keytab or get an
existing one and aim to supplant the current setkeytab extended
operation, allowing to eventually turn off the old one.</p>
<p>The following is the psudo-ASN.1 code definition for the extended
operation payload:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KeytabGetRequest</span> <span class="p">:</span><span class="o">:=</span> <span class="n">CHOICE</span> <span class="p">{</span>
    <span class="n">newkey</span> <span class="n">s</span>     <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">NewKeys</span><span class="p">,</span>
    <span class="n">curkey</span> <span class="n">s</span>     <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">CurrentKeys</span><span class="p">,</span>
    <span class="n">reply</span>        <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">Reply</span>
<span class="p">}</span>
<span class="n">NewKeys</span> <span class="p">:</span><span class="o">:=</span> <span class="n">SEQUENCE</span> <span class="p">{</span>
    <span class="n">serviceIdentity</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">OCTET</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">enctypes</span>        <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">SEQUENCE</span> <span class="n">OF</span> <span class="n">Int16</span><span class="p">,</span>
    <span class="n">password</span>        <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">OCTET</span> <span class="n">STRING</span> <span class="n">OPTIONAL</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CurrentKeys</span> <span class="p">:</span><span class="o">:=</span> <span class="n">SEQUENCE</span> <span class="p">{</span>
    <span class="n">serviceIdentity</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">OCTET</span> <span class="n">STRING</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the getNew attribute is true a new keytab is being requested. In this
case a password may be provided or not. If not one is generated
randomly. In case a password is provided it is subject to password
policy checking as per policies defined on the entry for which a keytab
is being requested. A list of enctypes is always necessary in input when
a new keytab is requested. However the list is filtered though the
allowable enctypes list and if nothing is left the operation is refused.</p>
<p>If the getNew attribute is false, then the existing key is being
requested. In this case password and enctypes MUST NOT be set.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Reply</span> <span class="p">:</span><span class="o">:=</span> <span class="n">SEQUENCE</span> <span class="p">{</span>
    <span class="n">new_kvno</span>        <span class="n">Int32</span>
    <span class="n">keys</span>            <span class="n">SEQUENCE</span> <span class="n">OF</span> <span class="n">KrbKey</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KrbKey</span> <span class="p">:</span><span class="o">:=</span> <span class="n">SEQUENCE</span> <span class="p">{</span>
    <span class="n">key</span>       <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">EncryptionKey</span><span class="p">,</span>
    <span class="n">salt</span>      <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">KrbSalt</span> <span class="n">OPTIONAL</span><span class="p">,</span>
    <span class="n">s2kparams</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">OCTET</span> <span class="n">STRING</span> <span class="n">OPTIONAL</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EncryptionKey</span> <span class="p">:</span><span class="o">:=</span> <span class="n">SEQUENCE</span> <span class="p">{</span>
    <span class="n">keytype</span>   <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">keyvalue</span>  <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">OCTET</span> <span class="n">STRING</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KrbSalt</span> <span class="p">:</span><span class="o">:=</span> <span class="n">SEQUENCE</span> <span class="p">{</span>
    <span class="nb">type</span>      <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">Int32</span><span class="p">,</span>
    <span class="n">salt</span>      <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">OCTET</span> <span class="n">STRING</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The reply actually is very similar to the current <code class="docutils literal notranslate"><span class="pre">setkeytab</span></code> request
format.</p>
<p>A kvno is returned, followed by a sequence of <code class="docutils literal notranslate"><span class="pre">KrbKeys</span></code>. Each
<code class="docutils literal notranslate"><span class="pre">KrbKey</span></code> is constituted of an <code class="docutils literal notranslate"><span class="pre">EncryptionKey</span></code> buffer which includes
an integer that indicated the encryption type used and an octet string
that holds the actual key material. Optionally a <code class="docutils literal notranslate"><span class="pre">KrbSalt</span></code> is added
again indicating type and optionally a value.</p>
<p>This is the information actually needed by a client to be able to write
out a keytab after receiving the reply.</p>
</section>
<section id="access-control">
<h2>Access Control<a class="headerlink" href="#access-control" title="Link to this heading">#</a></h2>
<p>It would be nice, at this point to be able to have a way to express
access control related to actions taken by extended operations rather
than just direct access to attributes and to relate this access to
actors and targets.</p>
<p>The actors are the users attempting the operation as authenticated by
the <a class="reference external" href="Directory_Server">Directory Server</a>. The targets are the objects
that hold the information. What is missing is a way to describe
permissions that tie a specific extended operation to them.</p>
<p>For this a new schema is necessary, based on a nice feature that is
available in LDAP - <em>sub-types</em>.</p>
</section>
<section id="new-schema">
<h2>New Schema<a class="headerlink" href="#new-schema" title="Link to this heading">#</a></h2>
<p>Attributes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">IPA_OID</span><span class="mf">.11.51</span> <span class="n">NAME</span> <span class="s1">&#39;ipaAllowedToPerform&#39;</span>
              <span class="n">DESC</span> <span class="s1">&#39;DNs allowed to perform an operation&#39;</span>
              <span class="n">SUP</span> <span class="n">distinguishedName</span> <span class="n">X</span><span class="o">-</span><span class="n">ORIGIN</span> <span class="s1">&#39;IPA-v3&#39;</span><span class="p">)</span>
<span class="n">IPA_OID</span><span class="mf">.11.52</span> <span class="n">NAME</span> <span class="s1">&#39;ipaProtectedOperation&#39;</span>
              <span class="n">DESC</span> <span class="s1">&#39;Operation to be protected&#39;</span>
              <span class="n">EQUALITY</span> <span class="n">caseIgnoreMatch</span> <span class="n">SYNTAX</span> <span class="mf">1.3.6.1.4.1.1466.115.121.1.15</span><span class="p">{</span><span class="mi">128</span><span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>Objectclasses:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>IPA_OID.12.22 NAME &#39;ipaAllowedOperations&#39;
              SUP top AUXILIARY
              DESC &#39;Class to apply access controls to arbitrary operations&#39;
              MAY ( ipaAllowedToPerform $ ipaProtectedOperation ) X-ORIGIN &#39;IPA v3&#39;)
</pre></div>
</div>
<p>This schema allows to add the <code class="docutils literal notranslate"><span class="pre">ipaAllowedToPerform</span></code> attribute to an
object, with a sub-type that indicates what special operation we want to
allow. The DN in the value indicates who is allowed to perform the
operation. The <code class="docutils literal notranslate"><span class="pre">ipaProtectedOperation</span></code> attribute is “virtual” and is
only ever used in ACI instructions. An extended plugin that want to
check if an operation is possible will check if operating on the
<code class="docutils literal notranslate"><span class="pre">ipaProtectedOperation;sub-type</span></code> attribute is allowed but that
operation will never actually be performed. However if it were nothing
would really happen, a useless attribute may end up being added to an
object, but that wouldn’t change the security properties of the
operation.</p>
</section>
<section id="new-acis">
<h2>New ACIs<a class="headerlink" href="#new-acis" title="Link to this heading">#</a></h2>
<p>The extended operation uses 2 named sub-types: read_keys/write_keys. The
read_keys sub-type identify the ability to retrieve a key, while
write_keys allows someone to create a new key (from a password or a
randomly generated one).</p>
<p>An example ACI rule to allow retrieval is this:</p>
<p><code class="docutils literal notranslate"><span class="pre">aci:</span> <span class="pre">(targetattr=&quot;ipaProtectedOperation;read_keys&quot;)(version</span> <span class="pre">3.0;</span> <span class="pre">acl</span> <span class="pre">&quot;Users</span> <span class="pre">allowed</span> <span class="pre">to</span> <span class="pre">retrieve</span> <span class="pre">keytab</span> <span class="pre">keys&quot;;</span> <span class="pre">allow(read)</span> <span class="pre">userattr=&quot;ipaAllowedToPerform;read_keys#USERDN&quot;;)</span></code></p>
<p>For this ACI to have effect an attribute needs to be added to a target
service entry like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="nd">@EXAMPLE</span><span class="o">.</span><span class="n">COM</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">services</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">accounts</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">example</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">add</span><span class="p">:</span> <span class="n">objectclass</span>
<span class="n">objectclass</span><span class="p">:</span> <span class="n">ipaAllowedOperations</span>
<span class="o">-</span>
<span class="n">add</span><span class="p">:</span> <span class="n">ipaAllowedToPerform</span><span class="p">;</span><span class="n">read_key</span>
<span class="n">ipaAllowedToPerform</span><span class="p">;</span><span class="n">read_key</span><span class="p">:</span> <span class="n">fqdn</span><span class="o">=</span><span class="n">clustermember1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">computers</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">accounts</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">example</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">ipaAllowedToPerform</span><span class="p">;</span><span class="n">read_key</span><span class="p">:</span> <span class="n">fqdn</span><span class="o">=</span><span class="n">clustermember2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">computers</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">accounts</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">example</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">ipaAllowedToPerform</span><span class="p">;</span><span class="n">read_key</span><span class="p">:</span> <span class="n">fqdn</span><span class="o">=</span><span class="n">clustermember3</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">computers</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">accounts</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">example</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
</pre></div>
</div>
<p>With this ACI and attributes in place clustermember1.example.com,
clustermember2.example.com and clustermember3.example.com hosts can
retrieve an existing keytab for the service HTTP on the www.example.com
host.</p>
<p><a class="reference external" href="V4/Keytab_Retrieval_Management">V4/Keytab Retrieval Management</a>
design page describes administration interface for setting the
ipaAllowedToPerform attribute. CLI equivalent for the LDIF above is:</p>
<p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">service-allow-retrieve-keytab</span> <span class="pre">HTTP/www.example.com</span> <span class="pre">--hosts={clustermember1.example.com,clustermember2.example.com,clustermember3.example.com}</span></code></p>
</section>
<section id="compatibility-with-older-freeipa-servers">
<h2>Compatibility with older FreeIPA servers<a class="headerlink" href="#compatibility-with-older-freeipa-servers" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ipa-getkeytab</span></code> falls back to the old extended operation for fetching
new keys when an old server does not have the new extended operation.</p>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
<p>The old setkeytab operation was used in conjunction with the
<code class="docutils literal notranslate"><span class="pre">managedBy</span></code> attribute to allow to set keytabs by other entities. For
example the host keytab is allowed, by default to request arbitrary
services keys on the same hosts via the <code class="docutils literal notranslate"><span class="pre">managedBy</span></code> attribute.</p>
<p>In order to preserve this feature an additional ACI has been provided:</p>
<p><code class="docutils literal notranslate"><span class="pre">aci:</span> <span class="pre">(targetattr=&quot;ipaProtectedOperation;write_keys&quot;)(version</span> <span class="pre">3.0;</span> <span class="pre">acl</span> <span class="pre">&quot;Entities</span> <span class="pre">are</span> <span class="pre">allowed</span> <span class="pre">to</span> <span class="pre">rekey</span> <span class="pre">managed</span> <span class="pre">entries&quot;;</span> <span class="pre">allow(write)</span> <span class="pre">userattr=&quot;managedby#USERDN&quot;;)</span></code></p>
</section>
<section id="feature-management">
<h2>Feature Management<a class="headerlink" href="#feature-management" title="Link to this heading">#</a></h2>
<p>UI</p>
<p>N/A.</p>
<p>CLI</p>
<p><code class="docutils literal notranslate"><span class="pre">ipa-getkeytab</span></code> has a new <code class="docutils literal notranslate"><span class="pre">-r</span></code> switch:</p>
<p>``  -r, –retrieve                                           Retrieve current keys without changing them``</p>
</section>
<section id="how-to-test">
<h2>How to Test<a class="headerlink" href="#how-to-test" title="Link to this heading">#</a></h2>
</section>
<section id="use-case-a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation-tbd">
<h2>Use Case: A load balancing cluster of HTTP server that allow GSSAPI/Krb5 negotiation (TBD)<a class="headerlink" href="#use-case-a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation-tbd" title="Link to this heading">#</a></h2>
<ol class="arabic">
<li><p>Install FreeIPA server with DNS on a host, e.g. with hostname
<code class="docutils literal notranslate"><span class="pre">server.example.test</span></code></p></li>
<li><p>Enroll FreeIPA clients <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> and
<code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code></p></li>
<li><p>Create DNS A record <code class="docutils literal notranslate"><span class="pre">client.example.test</span></code> that has 2 forward
addresses of <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> and <code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code></p></li>
<li><p>Add a new host <code class="docutils literal notranslate"><span class="pre">client.example.test</span></code> - there will be no client
enrolled to it:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">host-add</span> <span class="pre">client.example.test</span></code></p>
</div></blockquote>
</li>
<li><p>Add a new service HTTP/client.example.test:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">service-add</span> <span class="pre">HTTP/client.example.test</span></code></p>
</div></blockquote>
</li>
<li><p>Allow <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> and <code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code> to read
<code class="docutils literal notranslate"><span class="pre">client.example.test</span></code> Kerberos key by configuring
<code class="docutils literal notranslate"><span class="pre">ipaAllowedToPerform;read_key</span></code> attribute following the example in
<a class="reference external" href="#New_ACIs">New ACIs</a> section.</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">service-allow-retrieve-keytab</span> <span class="pre">HTTP/client.example.test</span> <span class="pre">--hosts={client1.example.test,client2.example.test}</span></code></p>
</div></blockquote>
</li>
<li><p>On both <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> and <code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code> read
the keytab for <code class="docutils literal notranslate"><span class="pre">client.example.test</span></code></p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ipa-getkeytab</span> <span class="pre">-r</span> <span class="pre">-s</span> <span class="pre">server.example.test</span> <span class="pre">-p</span> <span class="pre">HTTP/client.example.test</span> <span class="pre">-k</span> <span class="pre">/etc/httpd/conf/client.keytab</span></code></p>
</div></blockquote>
</li>
<li><p>Configure Apache with mod_auth_kerb on both clients and secure it
with Kerberos</p></li>
<li><p>With any FreeIPA user with valid Kerberos ticket, try to access web
server on <code class="docutils literal notranslate"><span class="pre">client.example.test</span></code>. It should work fine whether
forwarded to <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> or <code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code></p></li>
</ol>
<p><a class="reference external" href="Category:FreeIPA_V4_Test_Plan">Category:FreeIPA V4 Test Plan</a>
<a class="reference external" href="Category:FreeIPA_Test_Plan">Category:FreeIPA Test Plan</a></p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation">A load balancing cluster of HTTP server that allow GSSAPI/Krb5 negotiation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-extended-operation">New Extended operation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#access-control">Access Control</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-schema">New Schema</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-acis">New ACIs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compatibility-with-older-freeipa-servers">Compatibility with older FreeIPA servers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-test">How to Test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation-tbd">Use Case: A load balancing cluster of HTTP server that allow GSSAPI/Krb5 negotiation (TBD)</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>