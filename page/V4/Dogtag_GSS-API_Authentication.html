
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Dogtag_GSS-API_Authentication &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/Dogtag_GSS-API_Authentication';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/Dogtag_GSS-API_Authentication.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Dogtag_GSS-API_Authentication</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Dogtag_GSS-API_Authentication</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-of-dogtag-external-authentication-support">Overview of Dogtag external authentication support</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#freeipa-must-manage-dogtag-acls-that-refer-to-freeipa-entities">FreeIPA must manage Dogtag ACLs that refer to FreeIPA entities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#freeipa-must-configure-dogtag-to-perform-cert-request-validation-and-authorisation">FreeIPA must configure Dogtag to perform cert request validation and authorisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#migration-considerations">Migration considerations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#domain-level-2">Domain Level 2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#server-configuration-changes">Server configuration changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sssd">SSSD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selinux">SELinux</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#httpd">httpd</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#client-certificate">Client certificate</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pki-tomcatd"><code class="docutils literal notranslate"><span class="pre">pki-tomcatd</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cs-cfg"><code class="docutils literal notranslate"><span class="pre">CS.cfg</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dogtag-acl-management">Dogtag ACL management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-externalprocessconstraint-to-profile-configurations">Adding <code class="docutils literal notranslate"><span class="pre">ExternalProcessConstraint</span></code> to profile configurations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-ipa-pki-validate-cert-request-program">The <code class="docutils literal notranslate"><span class="pre">ipa-pki-validate-cert-request</span></code> program</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dogtag-client-credential-cache">Dogtag client credential cache</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use">How to Use</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="dogtag-gss-api-authentication">
<h1>Dogtag_GSS-API_Authentication<a class="headerlink" href="#dogtag-gss-api-authentication" title="Link to this heading">#</a></h1>
</section>
<section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h1>
<p>FreeIPA servers currently use a highly privileged <em>RA Agent</em> certificate
to perform operations in Dogtag (such as certificate issues, managing
profiles and managing lightweight CAs). This lack of privilege
separation has caused numerous security issues i.e. where the IPA
framework has failed to appropriately authorise use of the RA Agent
credential.</p>
<p>External authentication support for Dogtag is being implemented
(<a class="reference external" href="https://fedorahosted.org/pki/ticket/1359">https://fedorahosted.org/pki/ticket/1359</a>). This work will allow
externally-authenticated principals to perform operations in Dogtag,
subject to permission checks against an authorization plugin determined
by the realm of the principal. “Externally-authenticated” means that an
authenticating proxy (e.g. Apache with mod_auth_gssapi and
mod_lookup_identity) has authenticated the user and conveyed the
authenticated principal’s name and groups to Dogtag in the request
environment.</p>
<p>This design describes how FreeIPA will move away from using the
privileged RA Agent credential, to using GSS-API authentication with
proxy tickets (i.e. operating with the privileges of the authenticated
principal).</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h1>
<p>Improved security through privilege separation. Dogtag will enforce
access controls defined by FreeIPA.</p>
<p>Moving CA ACL enforcement and certificate request validation logic to
Dogtag is a first step towards having Dogtag populate a certificate with
information retrieved directly from the FreeIPA directory (other other
resources), instead of relying on users crafting a CSR that is “just
right” for a particular profile, improving usability and expanding the
number of certificate use cases that FreeIPA can satisfy.</p>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Link to this heading">#</a></h1>
<p>As discussed below, a domain level bump is required to switch from using
the RA Agent certificate to using GSS-API and proxy tickets.</p>
<p>No other administrator intervention is expected, and there are no
user-visible changes associated with this effort.</p>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Link to this heading">#</a></h1>
<section id="overview-of-dogtag-external-authentication-support">
<h2>Overview of Dogtag external authentication support<a class="headerlink" href="#overview-of-dogtag-external-authentication-support" title="Link to this heading">#</a></h2>
<p>Design page: <a class="reference external" href="http://pki.fedoraproject.org/wiki/GSS-API_authentication">http://pki.fedoraproject.org/wiki/GSS-API_authentication</a></p>
<p>The most important changes that affect FreeIPA are discussed in the
following subsections.</p>
</section>
<section id="freeipa-must-manage-dogtag-acls-that-refer-to-freeipa-entities">
<h2>FreeIPA must manage Dogtag ACLs that refer to FreeIPA entities<a class="headerlink" href="#freeipa-must-manage-dogtag-acls-that-refer-to-freeipa-entities" title="Link to this heading">#</a></h2>
<p>When authorising operations for externally-authenticated principals,
Dogtag looks up an <code class="docutils literal notranslate"><span class="pre">IAuthzManager</span></code> plugin instance based on the realm
of the principal. FreeIPA must configure this plugin instance, and must
also manage the ACLs that is uses.</p>
<p>FreeIPA already does limited Dogtag ACL management to allow the RA Agent
to perform required operations (these ACLs are loaded by the default
<code class="docutils literal notranslate"><span class="pre">IAuthzManager</span></code> plugin. Now, FreeIPA will need to manage a separate
set of ACLs that will be used by the new authz plugin instance. These
ACLs will refer to principals and groups defined in the IPA domain,
rather than “internal” Dogtag users and groups.</p>
<p>Technical details about these ACLs and management thereof are provided
later in this document.</p>
</section>
<section id="freeipa-must-configure-dogtag-to-perform-cert-request-validation-and-authorisation">
<h2>FreeIPA must configure Dogtag to perform cert request validation and authorisation<a class="headerlink" href="#freeipa-must-configure-dogtag-to-perform-cert-request-validation-and-authorisation" title="Link to this heading">#</a></h2>
<p>Currently, certificates are requested with the RA Agent credential.
FreeIPA-defined certificate profiles are configured to use the
<code class="docutils literal notranslate"><span class="pre">raCertAuth</span></code> plugin which enables immediate issuance of the
certificate when the operator is the RA Agent.</p>
<p>In moving to GSS-API authentication, the certificate will now be
requested with a proxy credential for the FreeIPA principal. (It should
also be noted that a principal that is logged onto a FreeIPA server with
a CA instance will be able to bypass the IPA framework and issue a
certificate request <em>directly</em> to Dogtag). Accordingly, the
authorisation (chiefly, CA ACLs) and request validation checks that are
currently performed in the IPA framework prior to conveying the
certificate request to Dogtag with RA Agent credential must now be
executed within Dogtag itself.</p>
<p>Dogtag will provide the new <code class="docutils literal notranslate"><span class="pre">ExternalProcessConstraint</span></code> profile
component, which can be used for this purpose. FreeIPA must configure an
instance of this program that executes a program provided by FreeIPA,
that will check CA ACLs and validate the CSR. FreeIPA must add the
<code class="docutils literal notranslate"><span class="pre">ExternalProcessConstraint</span></code> instance to all FreeIPA-managed profiles
(including custom profiles).</p>
<p>Technical details about the validation program and profile configuration
are provided later.</p>
</section>
<section id="migration-considerations">
<h2>Migration considerations<a class="headerlink" href="#migration-considerations" title="Link to this heading">#</a></h2>
<p>Existing deployments of FreeIPA cannot be updated to a new version that
supports Dogtag GSS-API authentication all at once. There is inevitably
a period where interoperation of old and new server versions is
required. This presents some challenges.</p>
<p>It will help to first describe the various topologies that can occur.
Here, an <em>old server/CA</em> is at a version that does not support GSS-API
authentication to Dogtag, and a <em>new server/CA</em> is at a version that
does support GSS-API authentication, whether or not it is actually
configured to use it.</p>
<ul class="simple">
<li><p><strong>New server communicating with new CA</strong>. OK to use GSS-API
authentication.</p></li>
<li><p><strong>Old server communicating with new CA</strong>. RA Agent certificate must
be used (server does not support GSS-API auth to Dogtag).</p></li>
<li><p><strong>New server communicating with old CA</strong>. RA Agent certificate must
be used (CA does not support external authentication).</p></li>
</ul>
<p>For normal administrative operations it is obvious that until all
servers in the topology are new servers, servers must retain the RA
Agent certificate. In a mixed topology, new servers talking to new CAs
could use either RA Agent cert auth, or SPNEGO with a proxy ticket. The
latter is preferable security-wise, but we will use the former for
reasons discussed below.</p>
<p>Turning our attention to certificate requests, observe that because
Dogtag certificate profile configurations are stored in LDAP (and
therefore replicated), upgrading FreeIPA-managed profile configurations
(to add the <code class="docutils literal notranslate"><span class="pre">ExternalProcessConstraint</span></code>) cannot occur until all
servers in the topology are new servers (because
<code class="docutils literal notranslate"><span class="pre">ExternalProcessConstraint</span></code> does not exist in older versions of
Dogtag). Therefore, <strong>in a mixed topology we cannot use SPNEGO
authentication for certificate requests, or even upgrade profile
configurations</strong>. Upgrading the profiles must be deferred until there
are no old servers in the topology.</p>
</section>
<section id="domain-level-2">
<h2>Domain Level 2<a class="headerlink" href="#domain-level-2" title="Link to this heading">#</a></h2>
<p>The way to solve this challenge is to introduce a new <em>domain level</em> (at
time of writing, this will be DL 2). It is not possible to upgrade to a
particular domain level unless all servers in the topology support that
domain level, so by introducing a new domain we can enforce the
requirement that all servers in the topology support Dogtag GSS-API
authentication before we start using it.</p>
<p>After upgrading to the new server version, but <em>before</em> setting domain
level = 2:</p>
<ul class="simple">
<li><p>All configuration changes described in this document <em>except</em> profile
configuration changes can be applied (and will have been applied
during server update).</p></li>
<li><p>Accordingly Dogtag (when accessed via the Apache frontend) will
support SPNEGO authentication, but communications between the IPA
framework and Dogtag (which are mediated by the backends defined in
<code class="docutils literal notranslate"><span class="pre">ipaserver.plugins.dogtag</span></code>) will continue to use the RA Agent
credential.</p></li>
</ul>
<p>After setting domain level = 2:</p>
<ul class="simple">
<li><p>IPA-managed profile configurations shall be updated to add the
<code class="docutils literal notranslate"><span class="pre">ExternalProcessConstraint</span></code>. This only needs to be done once
(because of LDAP profile replication). Restart is not required.
Preferably it would be performed automatically. <strong>QUESTION</strong>: is
there a way to trigger this sort of behaviour upon DL change? If not,
can it be put into <code class="docutils literal notranslate"><span class="pre">domainlevel_set</span></code>?</p></li>
<li><p>The Dogtag backends plugin (<code class="docutils literal notranslate"><span class="pre">ipaserver.plugins.dogtag</span></code>) shall begin
using SPNEGO authentication with proxy tickets.</p></li>
<li><p>The RA Agent cert can be removed from each server. It is preferable
for this to occur automatically. It could be deferred until the next
execution of <code class="docutils literal notranslate"><span class="pre">ipa-server-upgrade</span></code> which, if DL &gt;= 2 and RA Agent
cert is present, removes the cert and associated key.</p></li>
<li><p>The RA Agent user account and associated ACLs can be removed from the
Dogtag database. (This is not an essential step; more of a tidy-up).</p></li>
<li><p>Replica installation will not attempt to install the RA Agent cert
(it is not needed and cannot be assumed to exist).</p></li>
</ul>
<p>New installations (which will automatically be in DL 2) will no longer
create the RA Agent account or certificates.</p>
</section>
<section id="server-configuration-changes">
<h2>Server configuration changes<a class="headerlink" href="#server-configuration-changes" title="Link to this heading">#</a></h2>
</section>
<section id="sssd">
<h2>SSSD<a class="headerlink" href="#sssd" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">sssd-dbus</span></code> package, which provides the <em>InfoPipe</em> D-Bus
responder, is required.</p>
<p>SSSD on servers must be configured to allow <em>mod_lookup_identity</em> to
query a principal’s <code class="docutils literal notranslate"><span class="pre">memberOf</span></code> attribute.</p>
<p>Example <code class="docutils literal notranslate"><span class="pre">/etc/sssd/sssd.conf</span></code> configuration (indicative only):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">sssd</span><span class="p">]</span>
<span class="n">services</span> <span class="o">=</span> <span class="n">nss</span><span class="p">,</span> <span class="n">sudo</span><span class="p">,</span> <span class="n">pam</span><span class="p">,</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">ifp</span>
<span class="o">...</span>

<span class="p">[</span><span class="n">domain</span><span class="o">/</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span><span class="p">]</span>
<span class="o">...</span>
<span class="n">ldap_user_extra_attrs</span> <span class="o">=</span> <span class="n">roles</span><span class="p">:</span><span class="n">memberOf</span>

<span class="p">[</span><span class="n">ifp</span><span class="p">]</span>
<span class="n">allowed_uids</span> <span class="o">=</span> <span class="n">apache</span>
<span class="n">user_attributes</span> <span class="o">=</span> <span class="o">+</span><span class="n">roles</span>
</pre></div>
</div>
<p>The attribute is exposed under the name <code class="docutils literal notranslate"><span class="pre">roles</span></code>. The name <code class="docutils literal notranslate"><span class="pre">memberOf</span></code>
seems to have special treatment and does not result in the required
behaviour.</p>
</section>
<section id="selinux">
<h2>SELinux<a class="headerlink" href="#selinux" title="Link to this heading">#</a></h2>
<p>SELinux must be configured to allow Apache to query the SSSD InfoPipe.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo setsebool -P httpd_dbus_sssd 1
</pre></div>
</div>
</section>
<section id="httpd">
<h2>httpd<a class="headerlink" href="#httpd" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">mod_lookup_identity</span></code> package is required.</p>
<p><code class="docutils literal notranslate"><span class="pre">/etc/httpd/conf.d/ipa-pki-proxy.conf</span></code> shall be updated to perform
SPNEGO authentication when a client requests Dogtag resources.
<code class="docutils literal notranslate"><span class="pre">mod_lookup_identity</span></code> shall populate the AJP request environment with
groups and permissions of the authenticated principal (if any).</p>
<p>Example (indicative only):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">If</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">%</span><span class="p">{</span><span class="n">QUERY_STRING</span><span class="p">}</span> <span class="o">=~</span> <span class="o">/</span>\<span class="n">bgssapi</span><span class="o">=/&amp;</span><span class="n">quot</span><span class="p">;</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
  <span class="n">AuthType</span> <span class="n">GSSAPI</span>
  <span class="n">AuthName</span> <span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">Kerberos</span> <span class="n">Login</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span>
  <span class="n">GssapiCredStore</span> <span class="n">keytab</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">ipa</span><span class="o">.</span><span class="n">keytab</span>
  <span class="n">GssapiCredStore</span> <span class="n">client_keytab</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">ipa</span><span class="o">.</span><span class="n">keytab</span>
  <span class="n">GssapiDelegCcacheDir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">ipa</span><span class="o">/</span><span class="n">clientcaches</span>
  <span class="n">GssapiUseS4U2Proxy</span> <span class="n">on</span>
  <span class="n">GssapiAllowedMech</span> <span class="n">krb5</span>
  <span class="n">Require</span> <span class="n">valid</span><span class="o">-</span><span class="n">user</span>
  <span class="n">LookupUserAttrIter</span> <span class="n">roles</span> <span class="o">+</span><span class="n">AJP_REMOTE_USER_GROUP</span>
<span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="o">/</span><span class="n">If</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</pre></div>
</div>
<p>A query string is used to activate SPNEGO authentication because, due
the version interoperability requirements discussed above, this
configuration must be able to support both SPNEGO authentication and the
legacy certificate authentication method. Requiring the query string
allows requests that do not contain it to bypass SPNEGO authentication
and proceed the old-fashioned way.</p>
<p>This imposes a burden on the client: it must provide the query string if
it wishes to use SPNEGO authentication. This is not a problem because
the only client of significance is the IPA framework, which we control.</p>
<section id="client-certificate">
<h3>Client certificate<a class="headerlink" href="#client-certificate" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">NSSVerifyClient</span> <span class="pre">require</span></code> directive shall be relaxed to
<code class="docutils literal notranslate"><span class="pre">NSSVerifyClient</span> <span class="pre">optional</span></code>. This is needed so that GSS-API
authentication can be used for affected resources. Codepaths that are
configured to present a certificate will still do so.</p>
</section>
</section>
<section id="pki-tomcatd">
<h2><code class="docutils literal notranslate"><span class="pre">pki-tomcatd</span></code><a class="headerlink" href="#pki-tomcatd" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">pki-tomcatd</span></code> deployment must be updated to accept external
authentication. In <code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/server.xml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&amp;lt;Connector port=&amp;quot;8009&amp;quot;
  protocol=&amp;quot;AJP/1.3&amp;quot;
  tomcatAuthentication=&amp;quot;false&amp;quot;  &amp;lt;!-- add this attribute --&amp;gt;
  redirectPort=&amp;quot;8443&amp;quot;
  address=&amp;quot;localhost&amp;quot; /&amp;gt;
</pre></div>
</div>
</section>
<section id="cs-cfg">
<h2><code class="docutils literal notranslate"><span class="pre">CS.cfg</span></code><a class="headerlink" href="#cs-cfg" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/{ca,kra}/CS.cfg</span></code> must be updated to define an
<code class="docutils literal notranslate"><span class="pre">IAuthzManager</span></code> plugin instance for the FreeIPA realm.</p>
<p>Directives to be added:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>authz.instance.IPAAuthz.pluginName=DirAclAuthz
authz.instance.IPAAuthz.ldap=internaldb
authz.instance.IPAAuthz.searchBase=cn=IPA,cn=aclResources
authz.instance.IPAAuthz.realm=${ACTUAL_REALM}
</pre></div>
</div>
</section>
<section id="dogtag-acl-management">
<h2>Dogtag ACL management<a class="headerlink" href="#dogtag-acl-management" title="Link to this heading">#</a></h2>
<p>Previously, FreeIPA added attribute values to the main Dogtag ACLs entry
(<code class="docutils literal notranslate"><span class="pre">cn=aclResources,o=ipaca</span></code>) to allow the RA Agent to perform required
operations.</p>
<p>Now, FreeIPA will manage ACLs in a separate entry that will be read by
the <code class="docutils literal notranslate"><span class="pre">IAuthzManager</span></code> for the IPA realm. These ACLs use the standard
Dogtag ACL syntax but will refer to IPA users (or other principal
names), groups and permissions, rather than “internal” Dogtag users and
groups. The entry shall be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cn</span><span class="o">=</span><span class="n">IPA</span><span class="o">.</span><span class="n">LOCAL</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">aclResources</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">ipaca</span>
</pre></div>
</div>
<p>ACLs may need to allow host principals that are members of the
<code class="docutils literal notranslate"><span class="pre">ipaservers</span></code> group to perform some operations (e.g. profile
management) during installation and upgrade.</p>
<p><strong>TODO</strong>: detail the various operations and provide example ACLs.</p>
</section>
<section id="adding-externalprocessconstraint-to-profile-configurations">
<h2>Adding <code class="docutils literal notranslate"><span class="pre">ExternalProcessConstraint</span></code> to profile configurations<a class="headerlink" href="#adding-externalprocessconstraint-to-profile-configurations" title="Link to this heading">#</a></h2>
<p><strong>TODO</strong> describe when and how this will occur</p>
</section>
<section id="the-ipa-pki-validate-cert-request-program">
<h2>The <code class="docutils literal notranslate"><span class="pre">ipa-pki-validate-cert-request</span></code> program<a class="headerlink" href="#the-ipa-pki-validate-cert-request-program" title="Link to this heading">#</a></h2>
<p>The program to be executed by <code class="docutils literal notranslate"><span class="pre">ExternalProcessConstraint</span></code> for
FreeIPA-managed profiles shall be installed at
<code class="docutils literal notranslate"><span class="pre">/usr/libexec/ipa/ipa-pki-validate-cert-request</span></code>.</p>
<p>It will be a Python program whose logic consists primarily of existing
code for checking CA ACLs and validating CSR contents against the IPA
directory. (Refactorings shall occur accordingly). Other behaviour of
the program shall be to unmarshall data from the execution environment
and output the result in the required manner.</p>
<p>The program must be able to connect to the database to look up
information required to authorise and validate the request, including CA
ACLs and virtual operation permissions. Therefore, the bind principal
<strong>must have permission</strong> to read relevant entries, and in the case of
virtual operations, to execute the <code class="docutils literal notranslate"><span class="pre">GetEffectiveRights</span></code> control
against relevant permissions.</p>
<p>Reading effective rights of a given user on an entry can only be done by
<em>cn=Directory Manager</em> or by that user themselves. The implication is
that <code class="docutils literal notranslate"><span class="pre">ipa-pki-validate-cert-request</span></code> must bind as the <em>operator</em>
principal who is executing the certificate request. Therefore, a proxy
ticket for the operator must be acquired and used when talking back to
the FreeIPA directory. Apache must be configured to give Dogtag (i.e.
<code class="docutils literal notranslate"><span class="pre">pkiuser</span></code>) access to a client credential cache for this purpose.</p>
<p><strong>TODO</strong> the precise program contract w.r.t. environment, args, input,
output, exit status, etc, is yet to be finalised.</p>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h1>
<section id="dogtag-client-credential-cache">
<h2>Dogtag client credential cache<a class="headerlink" href="#dogtag-client-credential-cache" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ipa-pki-validate-cert-request</span></code> program must use a proxy ticket to
operate on behalf of the authenticated user when talking back to
FreeIPA. <em>mod_auth_gssapi</em> must be configured to establish a credential
cache that can be read by <code class="docutils literal notranslate"><span class="pre">pkiuser</span></code>.</p>
<p><em>mod_auth_gssapi</em> itself run as the <code class="docutils literal notranslate"><span class="pre">apache</span></code> user. It is not
appropriate to add <code class="docutils literal notranslate"><span class="pre">pkiuser</span></code> to the <code class="docutils literal notranslate"><span class="pre">apache</span></code> group, or vice versa,
in order for <em>mod_auth_gssapi</em> to write credential caches that are
readable by <code class="docutils literal notranslate"><span class="pre">pkiuser</span></code>. Instead, a simple way to accomplish this is to
have <em>mod_auth_gssapi</em> write a <strong>world-readable</strong> ccache inside a
directory that is readable only by <code class="docutils literal notranslate"><span class="pre">apache</span></code> and <code class="docutils literal notranslate"><span class="pre">pkiuser</span></code>.</p>
<p>The containing directory shall be <code class="docutils literal notranslate"><span class="pre">/var/run/pki/clientcaches/</span></code> with
ownership <code class="docutils literal notranslate"><span class="pre">apache:pkiuser</span></code> and mode <code class="docutils literal notranslate"><span class="pre">0640</span></code>. The credential caches
created therein shall have mode <code class="docutils literal notranslate"><span class="pre">0644</span></code>. The following <code class="docutils literal notranslate"><span class="pre">httpd</span></code>
configuration directives are involved:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GssapiDelegCcacheDir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">clientcaches</span>
<span class="n">GssapiDelegCcachePerms</span> <span class="n">mode</span><span class="p">:</span><span class="mi">0644</span>
</pre></div>
</div>
</section>
</section>
<section id="upgrade">
<h1>Upgrade<a class="headerlink" href="#upgrade" title="Link to this heading">#</a></h1>
<p>Explicit upgrade steps that will be required include:</p>
<ul class="simple">
<li><p>Update SSSD config (described above)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">setsebool</span> <span class="pre">-P</span> <span class="pre">httpd_dbus_sssd</span> <span class="pre">1</span></code> (described above)</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/server.xml</span></code> (described above)</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">ExternalAuthenticationValve</span></code> to
<code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/Catalina/localhost/ca.xml</span></code>.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">CS.cfg</span></code> files (described above)</p></li>
<li><p>Write Dogtag ACLs for the FreeIPA realm</p></li>
</ul>
<p>Configuration changes that will automatically occur during upgrade
include:</p>
<ul class="simple">
<li><p>Update <code class="docutils literal notranslate"><span class="pre">ipa-pki-proxy.conf</span></code> (described above; updating the template
is sufficient to effect this change during upgrade).</p></li>
</ul>
</section>
<section id="how-to-use">
<h1>How to Use<a class="headerlink" href="#how-to-use" title="Link to this heading">#</a></h1>
<p>To switch an existing deployment from RA Agent certificate
authentication to SPNEGO proxy ticket authentication:</p>
<ol class="arabic simple">
<li><p>Ensure all servers in the topology are at the new version</p></li>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">domainlevel-set</span> <span class="pre">2</span></code></p></li>
</ol>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Link to this heading">#</a></h1>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Dogtag_GSS-API_Authentication</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-of-dogtag-external-authentication-support">Overview of Dogtag external authentication support</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#freeipa-must-manage-dogtag-acls-that-refer-to-freeipa-entities">FreeIPA must manage Dogtag ACLs that refer to FreeIPA entities</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#freeipa-must-configure-dogtag-to-perform-cert-request-validation-and-authorisation">FreeIPA must configure Dogtag to perform cert request validation and authorisation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#migration-considerations">Migration considerations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#domain-level-2">Domain Level 2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#server-configuration-changes">Server configuration changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sssd">SSSD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#selinux">SELinux</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#httpd">httpd</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#client-certificate">Client certificate</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pki-tomcatd"><code class="docutils literal notranslate"><span class="pre">pki-tomcatd</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cs-cfg"><code class="docutils literal notranslate"><span class="pre">CS.cfg</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dogtag-acl-management">Dogtag ACL management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-externalprocessconstraint-to-profile-configurations">Adding <code class="docutils literal notranslate"><span class="pre">ExternalProcessConstraint</span></code> to profile configurations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-ipa-pki-validate-cert-request-program">The <code class="docutils literal notranslate"><span class="pre">ipa-pki-validate-cert-request</span></code> program</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dogtag-client-credential-cache">Dogtag client credential cache</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use">How to Use</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>