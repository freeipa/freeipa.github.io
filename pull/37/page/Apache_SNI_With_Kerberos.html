
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Apache_SNI_With_Kerberos &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/Apache_SNI_With_Kerberos';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/page/Apache_SNI_With_Kerberos.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Apache_SNI_With_Kerberos</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-sssd-configuration">IPA/SSSD Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apache-configuration">Apache Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#default-ssl-apache-config">Default SSL apache config</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-namebased-virtual-sites-with-ssl">Adding NameBased Virtual Sites with SSL</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-kerberos-authentication-to-the-sites">Adding kerberos authentication to the sites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="apache-sni-with-kerberos">
<h1>Apache_SNI_With_Kerberos<a class="headerlink" href="#apache-sni-with-kerberos" title="Link to this heading">#</a></h1>
<p><strong>Apache Namebased SSL VirtualHosts with optional kerberos login</strong></p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>Apache 2.2.12 added SNI to the TLS support of mod_ssl and RHEL6 brought
2.2.15 which then includes this.</p>
<p>This technology allows for multiple sites utilising a single IP - with
their own certificates … basically name based virtual hosting for SSL
enabled sites.</p>
<p>There are a couple of caveats however - this capability is client
dependant as well as server dependant - an approximate list can be found
<a class="reference external" href="http://en.wikipedia.org/wiki/Server_Name_Indication">here</a> - and
since this requires the host header in the initial request it leaves it
open to packet inspection and logging unlike traditional SSL.</p>
<p>The dogtag part of IPA can be used to handle these certificates and
optionally IPA can handle the login details afterwards.</p>
<p>This documentation is an example from my own implementations at my
workplace.</p>
</section>
<section id="ipa-sssd-configuration">
<h2>IPA/SSSD Configuration<a class="headerlink" href="#ipa-sssd-configuration" title="Link to this heading">#</a></h2>
<p>SSSD does not need any special configuration however if:</p>
<p>`` ipa-getcert list``</p>
<p>shows any errors such as CA_UNREACHABLE when there are multiple replicas
in the topology it is worth checking</p>
<p>`` /etc/ipa/default.conf``</p>
<p>to see which server is being used for certificate requests. Ensure that
the server is accepting requests against the IPA topology and kerberos
tickets are being generated before continuing.</p>
</section>
<section id="apache-configuration">
<h2>Apache Configuration<a class="headerlink" href="#apache-configuration" title="Link to this heading">#</a></h2>
<p>There are several parts to this. Initially the default host will be
configured to ensure there are no basic issues before adding the
complexity of SNI. This guide assumes selinux is enforcing with the
default targeted type in RHEL6.</p>
</section>
<section id="default-ssl-apache-config">
<h2>Default SSL apache config<a class="headerlink" href="#default-ssl-apache-config" title="Link to this heading">#</a></h2>
<p>Before carrying out configuration of the web server on a system with
ipa-admintools:</p>
<p>`` ipa service-add HTTP/``</p>
<p>This adds the service to IPA for the purposes of adding an SSL
certificate to it and then later on for a keytab to the kerberos
principal.</p>
<p>As usual the only requirements to install an SSL capable web server are:</p>
<p>`` yum install httpd mod_ssl``</p>
<p>which will provide for a self signed standard HTTPS server with content
served from /var/www/html.</p>
<p>Certmonger and Apache will need a common area to read and/or write
certificates as such I’d recommend creating a directory for these such
as /etc/httpd/certs.</p>
<p>Certmonger needs to be allowed to write to this area - although it runs
as root selinux will restrict it:</p>
<p>`` semanage fcontext -a -t cert_t ‘/etc/httpd/certs(/.*)?’ &amp;&amp; restorecon -v /etc/httpd/certs``</p>
<p>The apache process is able to read directories of type cert_t to obtain
its certificates and certmonger can then write to this safely.</p>
<p>A certificate/key pair can then be requested through certmonger on the
web server for the default instance via:</p>
<p>:literal:` ipa-getcert request -r -f /etc/httpd/certs/default.crt -k /etc/httpd/certs/default.key -N CN=`uname -n` -D <cite>uname -n</cite> -K HTTP/<cite>uname -n`</cite></p>
<p>To check the status of the request use:</p>
<p>`` ipa-getcert list``</p>
<p>If all is well there should be output similar to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Request</span> <span class="n">ID</span> <span class="s1">&#39;20120618111406&#39;</span><span class="p">:</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">MONITORING</span>
    <span class="n">stuck</span><span class="p">:</span> <span class="n">no</span>
    <span class="n">key</span> <span class="n">pair</span> <span class="n">storage</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="n">FILE</span><span class="p">,</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;/etc/httpd/certs/default.key&#39;</span>
    <span class="n">certificate</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="n">FILE</span><span class="p">,</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;/etc/httpd/certs/default.crt&#39;</span>
    <span class="n">CA</span><span class="p">:</span> <span class="n">IPA</span>
    <span class="n">issuer</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">Certificate</span> <span class="n">Authority</span><span class="p">,</span><span class="n">O</span><span class="o">=&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
    <span class="n">subject</span><span class="p">:</span> <span class="n">CN</span><span class="o">=&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;</span><span class="p">,</span><span class="n">O</span><span class="o">=&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
    <span class="n">expires</span><span class="p">:</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">07</span> <span class="n">UTC</span>
    <span class="n">eku</span><span class="p">:</span> <span class="nb">id</span><span class="o">-</span><span class="n">kp</span><span class="o">-</span><span class="n">serverAuth</span><span class="p">,</span><span class="nb">id</span><span class="o">-</span><span class="n">kp</span><span class="o">-</span><span class="n">clientAuth</span>
    <span class="n">track</span><span class="p">:</span> <span class="n">yes</span>
    <span class="n">auto</span><span class="o">-</span><span class="n">renew</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>The files should be visible in /etc/httpd/certs - the owner should be
changed to make them readable by apache.</p>
<p>Following this edit /etc/httpd/conf.d/ssl.conf to make sure the
following entries read as so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SSLCertificateFile</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">crt</span>
<span class="n">SSLCertificateKeyFile</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">key</span>
</pre></div>
</div>
<p>If you require client validation link or copy /etc/ipa/ca.crt to
/etc/httpd/certs and include:</p>
<p>`` SSLCACertificateFile /etc/httpd/certs/ca.crt``</p>
<p>At the time of writing there is no GUI for client certificates in IPA so
any further configuration down that avenue is left as an exercise to the
reader.</p>
<p>Ensure that TCP/443 is open and then start httpd to give it a test. If
all is well the browser should show a certificate chain starting at the
IPA server and with the certificate requested being served. If there are
any problems here then backtrack and amend before proceeding.</p>
</section>
<section id="adding-namebased-virtual-sites-with-ssl">
<h2>Adding NameBased Virtual Sites with SSL<a class="headerlink" href="#adding-namebased-virtual-sites-with-ssl" title="Link to this heading">#</a></h2>
<p>To allow IPA to handle the certificates there’s some work that needs to
be carried out in the IPA topology before the web server is further
configured.</p>
<p>IPA requires the hostname in the services to match the hostname in the
hosts for permission reasons - without this certmonger will show a
permissions error when submitting the certificate request.</p>
<p>So the first step is to add a dummy host in the ‘hosts’ tab of IPA.</p>
<p>My preference to make this clearer as a dummy host was to put ‘dummy
host’ in the description to make it easy to search for in future and to
put the location as the fully qualified domain name of the actual host.
A DNS record should already be in place for this (or just use the
–force option when adding the host).</p>
<p>To do this via the ipa-admin tools do as follows (or just use the GUI):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span> <span class="n">dnsrecord</span><span class="o">-</span><span class="n">add</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="n">dummyhost</span> <span class="o">--</span><span class="n">a</span><span class="o">-</span><span class="n">rec</span><span class="o">=</span><span class="mf">10.180.80.1</span>
<span class="n">ipa</span> <span class="n">host</span><span class="o">-</span><span class="n">add</span> <span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Dummy Host&quot;</span> <span class="o">--</span><span class="n">location</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span>
<span class="n">ipa</span> <span class="n">host</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">managedby</span> <span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">hosts</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span>
</pre></div>
</div>
<p>Now that the dummy host is in place (no enrollment, keytabs or
certificates needed for this bit) the service can be added.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span> <span class="n">service</span><span class="o">-</span><span class="n">add</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">ipa</span> <span class="n">service</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">host</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">hosts</span><span class="o">=</span><span class="s2">&quot;``\ ``&quot;</span>
</pre></div>
</div>
<p>The IPA topology is then ready to add this as a virtual host on the web
server.</p>
<p>Back on the web server itself the new certificate can now be requested:</p>
<p>`` ipa-getcert request -r -f /etc/httpd/certs/dummyhost.crt -k /etc/httpd/certs/dummyhost.key -N CN=dummyhost.example.com -D dummyhost.example.com -K HTTP/dummyhost.example.com``</p>
<p>Checking the /etc/httpd/certs directory should show the new
certificate/key pair and as before these should be made readable to
apache.</p>
<p>Now that the backend is in place to support the virtual host apache
itself can be configured for it.</p>
<p>Configure Apache to use name based virtual hosts on port 443 (in
addition to the standard 80):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NameVirtualHost</span> <span class="o">*</span><span class="p">:</span><span class="mi">80</span>
<span class="n">NameVirtualHost</span> <span class="o">*</span><span class="p">:</span><span class="mi">443</span>
</pre></div>
</div>
<p>Optionally add a redirect from non-SSL to SSL if you want it as a
requirement:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;VirtualHost *:80&gt;
ServerName dummyhost.example.com
ServerAlias dummyhost
RewriteEngine on
RewriteRule ^/(.*)$ https://dummyhost.example.com/$1
&lt;/VirtualHost&gt;
</pre></div>
</div>
<p>And then add the SSL enabled virtual host:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;VirtualHost *:443&gt;
ServerName dummyhost.example.com
ServerAlias dummyhost
SSLEngine on
SSLProtocol all -SSLv2
SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW
SSLCertificateFile /etc/httpd/certs/dummyhost.crt
SSLCertificateKeyFile /etc/httpd/certs/dummyhost.key
SSLOptions +StdEnvVars
&lt;Location /&gt;
SSLRequireSSL
&lt;/Location&gt;
&lt;/Virtualhost&gt;
</pre></div>
</div>
<p>All the usual SSL/VirtualHost possibilities exist - just ensure the
ServerName is present in the configuration.</p>
<p>If a client does not support SNI then the first virtual host defined
will be used for any SSL session - similar to a non HTTP/1.1 client
requesting a site from a name based virtual host system.</p>
<p>The exception to this is using
<a class="reference external" href="http://httpd.apache.org/docs/2.2/mod/mod_ssl.html#sslstrictsnivhostcheck">SSLStrictSNIVHostCheck</a>
to alter the behaviour as described in the Apache documentation.</p>
<p>Restart the httpd service and check the logs - if all is working the
following should appear in error_log:</p>
<p>`` [Mon Jun 18 13:25:44 2012] [warn] Init: Name-based SSL virtual hosts only work for clients with TLS server name indication support (RFC 4366)``</p>
<p>At this point <a class="reference external" href="https://dummyhost.example.com">https://dummyhost.example.com</a> should then work to show the
virtual host as defined and the certificate chain should be
IPA-&gt;dummyhost when checked. If the IPA root certificate is trusted by
the browser then there should be no certificate errors (name mismatches
etc)… if there are any errors double check the logs and permissions on
the certificates.</p>
<p>This procedure can be repeated for additional virtual hosts off the same
server as required.</p>
</section>
<section id="adding-kerberos-authentication-to-the-sites">
<h2>Adding kerberos authentication to the sites<a class="headerlink" href="#adding-kerberos-authentication-to-the-sites" title="Link to this heading">#</a></h2>
<p>With the sites having communication to the clients encrypted with SSL
authentication can then be added. This authentication can be added
without SSL but be aware that if fallback is enabled in mod_auth_kerb
this will be basic authentication (ie insecure) without SSL in place.</p>
<p>Add the appropriate module for kerberos authentication on the web
server:</p>
<p>`` yum install mod_auth_kerb``</p>
<p>Create a directory to store keytabs for authenticating against IPA:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span>
<span class="n">semanage</span> <span class="n">fcontext</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">t</span> <span class="n">httpd_keytab_t</span> <span class="s1">&#39;/etc/httpd/keytabs/(.*)?&#39;</span>
</pre></div>
</div>
<p>Note that with the selinux context the directory should maintain the
httpd_config_t type (default for anything in /etc/httpd/) but only the
contents has the httpd_keytabs_t type.</p>
<p>The default keytab for the host (for any ‘default’ site requests) can be
obtained via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>`` ipa-getkeytab -s ``\ :literal:` -p HTTP/`uname -n` -k /etc/httpd/keytabs/default`
</pre></div>
</div>
<p>To get a site specific keytab use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>`` ipa-getkeytab -s ``\ `` -p HTTP/dummyhost.example.com -k /etc/httpd/keytabs/dummyhost``
</pre></div>
</div>
<p>Although segregation of keytabs isn’t necessarily required (all hosts
could use the default keytab in principle) separation allows for fine
grained controls later on when integrating with other systems.</p>
<p>Check the contents of the keytab to ensure the expected principals are
present:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klist</span> <span class="o">-</span><span class="n">k</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span><span class="o">/</span><span class="n">default</span>
<span class="n">Keytab</span> <span class="n">name</span><span class="p">:</span> <span class="n">WRFILE</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span><span class="o">/</span><span class="n">default</span>
<span class="n">KVNO</span> <span class="n">Principal</span>
<span class="o">----</span> <span class="o">--------------------------------------------------------------------------</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>

<span class="n">klist</span> <span class="o">-</span><span class="n">k</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span><span class="o">/</span><span class="n">dummyhost</span>
<span class="n">KVNO</span> <span class="n">Principal</span>
<span class="o">----</span> <span class="o">--------------------------------------------------------------------------</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>To require login for all pages in a virtual host add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">Location</span> <span class="o">/&gt;</span>
  <span class="n">AuthType</span> <span class="n">Kerberos</span>
  <span class="n">AuthName</span> <span class="s2">&quot;Web Server Login&quot;</span>
  <span class="n">KrbMethodNegotiate</span> <span class="n">On</span>
  <span class="n">KrbMethodK5Passwd</span> <span class="n">On</span>
  <span class="n">Krb5KeyTab</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span><span class="o">/</span><span class="n">default</span>
  <span class="n">require</span> <span class="n">valid</span><span class="o">-</span><span class="n">user</span>
<span class="o">&lt;/</span><span class="n">Location</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For a non-default keytab (eg the dummyhost above) add/amend as
appropriate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">KrbServiceName</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">Krb5KeyTab</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span><span class="o">/</span><span class="n">dummyhost</span>
</pre></div>
</div>
<p>The REMOTE_USER environment variable will be set to username&#64; by
default. For some systems it’s preferable to just have the shorter
‘username’. This behaviour is obtainable by adding:</p>
<p>`` KrbLocalUserMapping On``</p>
<p>If it is desirable to disable the basic authentication fallback and
restrict the system to kerberos tokens only change KrbMethodK5Passwd to
off and leave KrbMethodNegotiate on.</p>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>If all the steps above have been followed and everything is working
properly the server should then be configured in such a way new virtual
hosts can easily be added to present new sites each with their own SSL
certificates (being tracked and renewed via certmonger) and the IPA
infrastructure being utilised for all authentication on a standard RHEL6
install with nothing outside of the standard RHEL repositories.</p>
<p><a class="reference external" href="Category:CheckUpdate">Category:CheckUpdate</a></p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-sssd-configuration">IPA/SSSD Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#apache-configuration">Apache Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#default-ssl-apache-config">Default SSL apache config</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-namebased-virtual-sites-with-ssl">Adding NameBased Virtual Sites with SSL</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-kerberos-authentication-to-the-sites">Adding kerberos authentication to the sites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>