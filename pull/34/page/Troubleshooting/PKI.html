
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>PKI &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/Troubleshooting/PKI';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/Troubleshooting/PKI.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>PKI</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">PKI</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-won-t-start-expired-certificates">IPA won’t start, expired certificates</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pki-tomcatd-fails-to-start">PKI-tomcatd fails to start</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#authentication-errors">Authentication Errors</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#crl-gets-very-old">CRL gets very old</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#external-ca-renewal-with-ipa-cacert-manage-fails">External CA renewal with ipa-cacert-manage fails</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="pki">
<h1>PKI<a class="headerlink" href="#pki" title="Link to this heading">#</a></h1>
<p>This page contains <strong>PKI</strong> troubleshooting advice. For other issues,
refer to the index at <a class="reference external" href="Troubleshooting">Troubleshooting</a>.</p>
</section>
<section id="ipa-won-t-start-expired-certificates">
<h1>IPA won’t start, expired certificates<a class="headerlink" href="#ipa-won-t-start-expired-certificates" title="Link to this heading">#</a></h1>
<p>Where available (&gt;= v4.8.0?), the <code class="docutils literal notranslate"><span class="pre">ipa-cert-fix</span></code> command can be used
to recover from expired system certificate scenarios. See <a class="reference external" href="https://frasertweedale.github.io/blog-redhat/posts/2019-05-24-ipa-cert-fix.html">blog
post</a>.</p>
<p>Starting with IPA <a class="reference external" href="IPAv3_300_ga">3.0.0</a> all FreeIPA certificates are
tracked by <a class="reference external" href="Certmonger">Certmonger</a> and should be renewed
automatically. In case of problems, see
<a class="reference external" href="Certmonger#Manually_renew_a_certificate">Certmonger#Manually_renew_a_certificate</a>.</p>
<p>If your Certificate Authority certificate is expired, see <a class="reference external" href="Howto/CA_Certificate_Renewal">CA
Certificate Renewal page</a> .</p>
<p>For v2.0 see
<a class="reference external" href="IPA_2x_Certificate_Renewal">IPA_2x_Certificate_Renewal</a>.</p>
<p><strong>DO NOT RUN</strong> <code class="docutils literal notranslate"><span class="pre">ipa-cacert-manage</span> <span class="pre">renew</span></code> in an effort to renew
expirted certificates. This is for renewing the CA certificate only,
which by default is good for 20 years. It is very unlikely you need to
do this.</p>
</section>
<section id="pki-tomcatd-fails-to-start">
<h1>PKI-tomcatd fails to start<a class="headerlink" href="#pki-tomcatd-fails-to-start" title="Link to this heading">#</a></h1>
<p>After an upgrade of IPA packages, pki-tomcatd fails to start. See
<a class="reference external" href="https://floblanc.wordpress.com/2017/09/11/troubleshooting-freeipa-pki-tomcatd-fails-to-start/">Troubleshooting pki-tomcatd fails to
start</a>.</p>
</section>
<section id="authentication-errors">
<h1>Authentication Errors<a class="headerlink" href="#authentication-errors" title="Link to this heading">#</a></h1>
<p>If you see something like
<code class="docutils literal notranslate"><span class="pre">4301</span> <span class="pre">(RPC</span> <span class="pre">failed</span> <span class="pre">at</span> <span class="pre">server.</span> <span class="pre">Certificate</span> <span class="pre">operation</span> <span class="pre">cannot</span> <span class="pre">be</span> <span class="pre">completed:</span> <span class="pre">FAILURE</span></code>
<code class="docutils literal notranslate"><span class="pre">(Authentication</span> <span class="pre">Error))</span></code> or <code class="docutils literal notranslate"><span class="pre">Invalid</span> <span class="pre">Credential</span></code> the likely culprit
is the RA agent certificate that IPA uses to authenticate against
<a class="reference external" href="PKI">PKI</a>.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">getcert</span> <span class="pre">list</span> <span class="pre">-d</span> <span class="pre">/etc/httpd/alias</span> <span class="pre">-n</span> <span class="pre">ipaCert</span></code> to show the current
status of the certificate tracked by <a class="reference external" href="Certmonger">Certmonger</a>. It
should be <strong>MONITORING</strong>.</p>
<p>If it isn’t in MONITORING, or it is and things still aren’t working,
compare the serial number of the certificate with that on other IPA
masters.</p>
<p>If you have the <code class="docutils literal notranslate"><span class="pre">[free]ipa-healthcheck</span></code> package available in your
distribution run that as it will check for this condition.</p>
<p>For IPA &lt; 4.7.0:</p>
<p><code class="docutils literal notranslate"><span class="pre"># certutil -L -d /etc/httpd/alias -n ipaCert | grep Serial</span></code></p>
<p>For IPA &gt;= 4.7.0:</p>
<p><code class="docutils literal notranslate"><span class="pre"># openssl x509 -noout -serial -in /var/lib/ipa/ra-agent.pem</span></code></p>
<p>The serial number should match the value of the 2nd integer at:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``# ldapsearch -x -h localhost -p 389 -b uid=ipara,ou=People,o=ipaca description ``
</pre></div>
</div>
<p>(use port 7389 for 2.x servers)</p>
<p>If they are different this suggests that one has been renewed. Only the
most recent is allowed by dogtag. To repair this, go to the master with
the most recent certificate:</p>
<p>For IPA &lt; 4.7.0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``# certutil -L -d /etc/httpd/alias -n ipaCert -a &gt; /tmp/ra.crt ``
</pre></div>
</div>
<p>This will export all the certificates. Edit this file and remove all but
the first certificate, You can double-check the result with:</p>
<p><code class="docutils literal notranslate"><span class="pre"># openssl x509 -text -in /tmp/ra.crt</span></code></p>
<p>For IPA &gt;= 4.7.0 the certificate is in <code class="docutils literal notranslate"><span class="pre">/var/lib/ipa/ra-agent.pem</span></code></p>
<p>It should have only the cert with the latest serial #.</p>
<p>After removing the unnecessary certificates from the file, for IPA &lt;
4.7.0:</p>
<p>Now add it to your cert database:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># certutil -A -n ipaCert -d /etc/httpd/alias -t u,u,u -a -i /tmp/ra.crt</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># service httpd restart</span></code></div>
</div>
<p>If the certificate is valid and the ou=People entry is ok then check the
<a class="reference external" href="PKI">PKI</a> logs <code class="docutils literal notranslate"><span class="pre">/var/log/pki</span></code> or <code class="docutils literal notranslate"><span class="pre">/var/log/pki-ca</span></code>.</p>
<p>If you see an error like “Failed to connect LDAP server” then try
restarting the tomcat process, either pki-cad (for IPA 3.0) or
<a class="reference external" href="mailto:pki-tomcatd&#37;&#52;&#48;pki-tomcat&#46;service">pki-tomcatd<span>&#64;</span>pki-tomcat<span>&#46;</span>service</a>.</p>
</section>
<section id="crl-gets-very-old">
<h1>CRL gets very old<a class="headerlink" href="#crl-gets-very-old" title="Link to this heading">#</a></h1>
<p>If the main CRL file containing the list of invalidated certificates is
old and not updated, make sure you check that:</p>
<ul class="simple">
<li><p>There is at least one <a class="reference external" href="PKI">PKI</a> master server generating the CRL
- see <a class="reference external" href="CVE-2012-4546">CVE-2012-4546</a> for instructions.</p></li>
<li><p>CRL generation on that server is not blocked by wrong ownership of
<code class="docutils literal notranslate"><span class="pre">/var/lib/ipa/pki-ca/publish/</span></code> directory or there are no SELinux
errors. Consult PKI <code class="docutils literal notranslate"><span class="pre">system</span></code> for details. (<a class="reference external" href="https://www.redhat.com/archives/freeipa-users/2014-November/msg00012.html">related user
case</a>)</p></li>
</ul>
</section>
<section id="external-ca-renewal-with-ipa-cacert-manage-fails">
<h1>External CA renewal with ipa-cacert-manage fails<a class="headerlink" href="#external-ca-renewal-with-ipa-cacert-manage-fails" title="Link to this heading">#</a></h1>
<p>The second step of external CA renewal may fail for a number of reasons:</p>
<ul>
<li><p>Subject name mismatch</p>
<blockquote>
<div><p>The new CA certificate issued by the external CA uses a different
subject name than the old CA certificate.</p>
</div></blockquote>
</li>
<li><p>Subject name encoding mismatch</p>
<blockquote>
<div><p>The new CA certificate issued by the external CA uses the same
subject name as the old CA certificate, but it is encoded
differently. Some CAs like to re-encode the subject name from
certificate signing requests in certificates they issue. This does
not work well with NSS, which considers subject names to be equal
only if they binary representation is exactly the same. To avoid
the problem, configure the external CA to either respect the CSR’s
encoding, or use UTF8String encoding (which is the FreeIPA
default). Microsoft Certificate Services / AD-CS uses
PrintableString as the default encoding in subject names. See
<a class="reference external" href="https://github.com/freeipa/freeipa/pull/930#issuecomment-332748881">this GitHub
thread</a>
for how to observe and configure the AD-CS treatment of Subject DN
encoding.</p>
</div></blockquote>
</li>
<li><p>Subject public key info mismatch</p>
<blockquote>
<div><p>The new CA certificate issued by the external CA uses a different
public / private key pair than the old CA certificate.</p>
</div></blockquote>
</li>
<li><p>Not a valid CA certificate</p>
<blockquote>
<div><p>The new CA certificate issued by the external CA is either missing
the Basic Constraints extension, or the Basic Constraints
extension indicates that the certificate is not a CA certificate.</p>
</div></blockquote>
</li>
</ul>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">PKI</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-won-t-start-expired-certificates">IPA won’t start, expired certificates</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pki-tomcatd-fails-to-start">PKI-tomcatd fails to start</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#authentication-errors">Authentication Errors</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#crl-gets-very-old">CRL gets very old</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#external-ca-renewal-with-ipa-cacert-manage-fails">External CA renewal with ipa-cacert-manage fails</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>