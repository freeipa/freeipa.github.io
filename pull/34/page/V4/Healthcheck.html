
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Healthcheck &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/Healthcheck';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/Healthcheck.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Healthcheck</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#minimum-viable-product">Minimum Viable Product</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mvp-acceptance-criteria">MVP Acceptance Criteria</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#high-level-architecture">High-level Architecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#related-tickets">Related Tickets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use">How to Use</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-it-manually">Running it manually</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#repairing-issues">Repairing Issues</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#independence">Independence</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#errors">Errors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#severity">Severity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis">Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#framework">Framework</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plugins">Plugins</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa">IPA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#certificates-ca-kra">Certificates/CA/KRA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication">Replication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ad-trust">AD Trust</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kerberos">Kerberos</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dns">DNS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#topology">Topology</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custodia">Custodia</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#execution">Execution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#operation">Operation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installation">Installation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="healthcheck">
<h1>Healthcheck<a class="headerlink" href="#healthcheck" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>IPA provides no way to do introspection to discover possible issues. A
framework is needed to assist with the identification, diagnosis and
potentially repair of problems. This has the benefit of increasing
confidence in an IPA installation and reducing costs associated with
addressing issues.</p>
<p>The purpose of the healthcheck tool is to find and report error
conditions that may impact the IPA environment. Automated repair would
be possible in some limited cases.</p>
<p>Source is available at <a class="github reference external" href="https://github.com/freeipa/freeipa-healthcheck">freeipa/freeipa-healthcheck</a></p>
</section>
<section id="minimum-viable-product">
<h2>Minimum Viable Product<a class="headerlink" href="#minimum-viable-product" title="Link to this heading">#</a></h2>
<p>As the explicit goal of the healthcheck tool is to detect issues with
the environment, the Minimum Viable Product is a local, modular tool
that can be run to check IPA status.</p>
<p>The tool must include:</p>
<ul class="simple">
<li><p>local server-specific checks</p></li>
<li><p>a few topology-wide checks like checking for replication conflicts,
topology deficiencies, valid CA renewal master configuration, with
the number of checks expected to be expanded over time. Analysis of
topology-wide checks is left as an exercise for the user for now.</p></li>
</ul>
<p>It is expected to be easily integrated with different monitoring tools.</p>
</section>
<section id="mvp-acceptance-criteria">
<h2>MVP Acceptance Criteria<a class="headerlink" href="#mvp-acceptance-criteria" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>a program that can be run, on-demand or via cron/systemd timer, which
executes health checks.</p></li>
<li><p>the output is a machine-readable file (e.g. JSON).</p></li>
<li><p>the output location is controlled by the caller (e.g. via CLI option
and/or configuration).</p></li>
<li><p>the output includes a timestamp.</p></li>
<li><p>each issue is recorded with a severity related to potential
impact(s).</p></li>
<li><p>each executed test results in a success or failure status so that an
administrator can be sure that the tests are running properly.</p></li>
<li><p>a human-readable version of the output is available (e.g. via a CLI
result printer).</p></li>
</ul>
</section>
<section id="high-level-architecture">
<h2>High-level Architecture<a class="headerlink" href="#high-level-architecture" title="Link to this heading">#</a></h2>
<p>The tool itself which consists of plugins to analyze current
configuration to determine the state of the installation.</p>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h2>
<p>The high level use case is:</p>
<p>As an administrator I want to be able to identify and correct issues in
my IPA installation.</p>
<p>This will be achieved through plugins to a framework which implement the
checks. Some specific use cases implemented by these plugins could
include:</p>
<p>As an administrator I want to be able to identify and correct
replication issues.</p>
<p>As an administrator I want to be able to identify and correct
replication conflicts.</p>
<p>As an administrator I want to be able to ensure that my certificates are
valid.</p>
<p>As an administrator I want to be able to diagnose issues with my CA
infrastructure</p>
<p>As an administrator I want to be able to identify and correct issues
with AD Trust.</p>
<p>As an administrator I want to know that all file permissions/ownership
are ok.</p>
<p>All tools run without issue during upstream integration testing.</p>
</section>
<section id="related-tickets">
<h2>Related Tickets<a class="headerlink" href="#related-tickets" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://pagure.io/freeipa/issue/1749">#1749 Need way to remove dangling managed
groups</a></p></li>
</ul>
<p>Important note: v1 healthcheck will only identify issues, not provide a
mechanism to remediate them.</p>
</section>
<section id="how-to-use">
<h2>How to Use<a class="headerlink" href="#how-to-use" title="Link to this heading">#</a></h2>
<p>Healthcheck executes a series of plugins to collect its information.
Each plugin, referred to later as a source, is organized around a
specific theme (certificate system, file system permissions and
ownership, replication, etc.). A source is a collection of tests,
refered to as checks, that should test one small piece of IPA. The
purpose is so that when developing and running the tests one can control
which are executed.</p>
<p>All checks must report a value unless a feature is not implemented. This
is to prevent the case where the tool reports everything is a-ok because
some unrelated issue causes the tool to not execute properly.</p>
<p>The report will consist of a message describing what was run and the
status. If the status is not successful it may include additional
information for the administrator to use to correct the issue (e.g. a
file has the wrong permissions, expected X and got Y).</p>
<p>By default the collector will execute once nightly on every master where
the package is installed.</p>
</section>
<section id="running-it-manually">
<h2>Running it manually<a class="headerlink" href="#running-it-manually" title="Link to this heading">#</a></h2>
<p>The ipa-healthcheck command will run nightly by default.</p>
<p>Normally ipa-healthcheck will exit with a returncode of 0, even if any
checks discovered issues with the IPA installation. A non-zero
returncode means that ipa-healthcheck failed in a non-recoverable way.</p>
<p>To run it manually simply execute:</p>
<p><code class="docutils literal notranslate"><span class="pre"># ipa-healthcheck</span></code></p>
<p>A specific check can be executed as well:</p>
<p><code class="docutils literal notranslate"><span class="pre"># ipa-healthcheck --source certificate --check expiration</span></code></p>
<p>Output will be a list of sources and checks executed along with the
status.</p>
<p>Running it manually is useful if an administrator is attempting to
correct issues and wants to double-check that something is resolved.</p>
</section>
<section id="repairing-issues">
<h2>Repairing Issues<a class="headerlink" href="#repairing-issues" title="Link to this heading">#</a></h2>
<p>Repairing an issue involves the administrator making the suggested
changes to their system.</p>
<p>ipa-healthcheck will make some recommendations but it is up to a human
to apply them.</p>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Link to this heading">#</a></h2>
</section>
<section id="independence">
<h2>Independence<a class="headerlink" href="#independence" title="Link to this heading">#</a></h2>
<p>The healthcheck tool will reside in its own upstream git repository. It
will import IPA existing modules for LDAP support, certificate handling,
replication topology and communicating with IPA itself. It will be
maintained separately so it can have its own release cycle, increasing
the speed of development. Once the framework is in place a rapid
development/release process can be done. As more plugins or capabilities
are added new releases can be made.</p>
<p>The initial target branches are master (4.8) and ipa-4-7.</p>
<p>Writing a tool that works across versions can be challenging for the
following reasons:</p>
<ul class="simple">
<li><p>Version of python may be limited (e.g. 3.0 was written against Python
2.6)</p></li>
<li><p>IPA libraries may be in different locations on different releases</p></li>
<li><p>IPA libraries may return different data types by version</p></li>
<li><p>Testing across all releases is a challenge</p></li>
</ul>
<p>The IPA server plugin for displaying the data will reside in the FreeIPA
upstream source repository.</p>
<p>It will use similar branching as upstream IPA in order to deal with
differing imports, data types, etc. So there will be an ipa-4-6, ipa-4-7
and master branches eventually.</p>
</section>
<section id="errors">
<h2>Errors<a class="headerlink" href="#errors" title="Link to this heading">#</a></h2>
<p>Error messages should be descriptive without being paragraphs long. It
is very possible that external documentation will be needed to aid a
user in resolving some issues.</p>
</section>
<section id="severity">
<h2>Severity<a class="headerlink" href="#severity" title="Link to this heading">#</a></h2>
<p>Severity of a problem is defined as:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Severity</p></th>
<th class="head"><p>Definition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>success</p></td>
<td><p>The check executed and found no issues.</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>critical</p></td>
<td><p>Something is terribly wrong (e.g. a service is
not started, certificates are expired, etc).</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>error</p></td>
<td><p>Something is wrong but your IPA master is
probably still working (e.g. replication
conflict)</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>warning</p></td>
<td><p>Not an issue yet, but may be (e.g. expiring
certificate soon)</p></td>
</tr>
</tbody>
</table>
<p>A success value is reported so an administrator can know that all checks
have executed.</p>
</section>
<section id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Link to this heading">#</a></h2>
<p>The main flaw of this decentralized design is that it is decentralized.
For example, we require one and only one CRL generator. There is no way
to enforce this currently via healthcheck. Each master can see if it
should be the master and warn as appropriate but there is no “require
only one” option.</p>
<p>Note that for this particular example, and perhaps for all, we can add a
server role for CRL generator. Every master would be able to see this
role. If it is them then they check the config to confirm they are
configured appropriate. If not they raise an error.</p>
</section>
<section id="framework">
<h2>Framework<a class="headerlink" href="#framework" title="Link to this heading">#</a></h2>
<p>The healthcheck plugin framework will be thin, consisting of:</p>
<ul class="simple">
<li><p>option parser</p></li>
<li><p>setup logging (just for when running manually)</p></li>
<li><p>LDAP connection (to be passed to plugins)</p></li>
<li><p>IPA api will be finalized and run in_server=True</p></li>
<li><p>plugin loader</p></li>
<li><p>plugin execution</p></li>
<li><p>recording results in LDAP</p></li>
</ul>
<p>A failure entry will be created if a plugin fails to execute, raises an
exception, and will be cleared if a subsequent run of the plugin is
successful.</p>
</section>
<section id="plugins">
<h2>Plugins<a class="headerlink" href="#plugins" title="Link to this heading">#</a></h2>
<p>Plugins will define a name to be used to in part to record as the
<code class="docutils literal notranslate"><span class="pre">ipaErrorSource</span></code> and to select when manually running individual tests
on the command-line. This is called the “source”.</p>
<p>The entry point to the plugin is a run() method. This will execute all
of the tests provided by the plugin.</p>
<p>Each test will have a short, unique name known as the “check”.</p>
<p>Care will be needed to ensure uniqueness of check names within a given
source. The framework may be able to enforce this.</p>
<p>So: the healthcheck daemon runs sources which executes checks. Failed
checks are stored as errors in LDAP.</p>
<p>Examples of sources and checks:</p>
<ul class="simple">
<li><p>certtool</p>
<ul>
<li><p>expired</p></li>
<li><p>expiring-soon</p></li>
<li><p>tracking</p></li>
</ul>
</li>
<li><p>replication</p>
<ul>
<li><p>sync</p></li>
<li><p>conflict</p></li>
</ul>
</li>
</ul>
<p>Plugins will execute one or more discrete tests. Each test should be as
atomic as possible. It is better to report:</p>
<p><code class="docutils literal notranslate"><span class="pre">File /path/to/foo has incorrect permissions, 0644 and should be 0600</span></code></p>
<p>Rather than</p>
<p><code class="docutils literal notranslate"><span class="pre">Files a, b, c, d have incorrect permissions</span></code></p>
<p>Plugins will return an error class containing the name/value pairs of
errors and the severity as an iterator.</p>
<p>Plugins will return () if no errors are found.</p>
<p><strong>All</strong> errors encountered by a plugin should be reported to the tool
(so aggressive use of try/except is required). The failure of a source
(or check) to execute is a failure that should be reported. There can be
zero chance that a failed check can cause the entire healthcheck command
execution to fail. If executing a source fails then there will be no
value for ipaErrorCheck.</p>
<p>The basic execution will look like:</p>
<p>for source in sources:</p>
<div class="line-block">
<div class="line">``   for check in sources.check():``</div>
<div class="line">``       check()``</div>
</div>
<p>The analysis (deduplicating, writing to LDAP, etc) can be either done
per-source or once globally. It would be fewer LDAP searches to do
globally perhaps but would probably be fine running for each source as
well, at least in the LDAP case.</p>
<p>The initial plugins for the tool are:</p>
<section id="ipa">
<h3>IPA<a class="headerlink" href="#ipa" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>basic service status (are all services running that should)</p></li>
<li><p>file permission and ownership</p></li>
<li><p>SELinux contexts</p></li>
<li><p>hostname sanity</p></li>
<li><p>disk utilization (may require config to set threshold)</p></li>
</ul>
</section>
<section id="certificates-ca-kra">
<h3>Certificates/CA/KRA<a class="headerlink" href="#certificates-ca-kra" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>certificate expiration warnings (may require config to define period)</p></li>
<li><p>certificate tracking issues</p></li>
<li><p>NSS trust</p></li>
<li><p>compare CA entries between dogtag and IPA</p></li>
<li><p>ensure RA agent cert is working</p></li>
<li><p>ensure there is a renewal master</p></li>
<li><p>ensure there is a CRL master</p></li>
<li><p>certmonger request tracking correctness</p></li>
<li><p>CA chain validation</p></li>
<li><p>certificate serial number ranges</p></li>
</ul>
</section>
<section id="replication">
<h3>Replication<a class="headerlink" href="#replication" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>replication consistency (are masters missing entries? expensive)</p></li>
<li><p>replication status</p></li>
<li><p>replication conflicts (old and new style)</p></li>
<li><p>DNA ranges</p></li>
<li><p>Unused RUVs</p></li>
</ul>
</section>
<section id="ad-trust">
<h3>AD Trust<a class="headerlink" href="#ad-trust" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>connectivity</p></li>
</ul>
</section>
<section id="kerberos">
<h3>Kerberos<a class="headerlink" href="#kerberos" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>validate kvno of keytabs</p></li>
</ul>
</section>
<section id="dns">
<h3>DNS<a class="headerlink" href="#dns" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>???</p></li>
</ul>
</section>
<section id="topology">
<h3>Topology<a class="headerlink" href="#topology" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Check number of agreements per master</p></li>
<li><p>Find weak points in topology</p></li>
<li><p>Find single points-of-failure</p></li>
</ul>
</section>
<section id="custodia">
<h3>Custodia<a class="headerlink" href="#custodia" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>verify keys are consistent</p></li>
</ul>
</section>
<section id="upgrade">
<h3>Upgrade<a class="headerlink" href="#upgrade" title="Link to this heading">#</a></h3>
<p>This test is normally not executed by default. It needs to be requested
on the command-line and is for upgrades only. If any critical failures
are reported then an Upgrade failure is recorded in LDAP and the upgrade
is aborted.</p>
<p>Reporting the error via LDAP would provide at least one window into
alerting users that the IPA upgrade has failed.</p>
</section>
</section>
<section id="execution">
<h2>Execution<a class="headerlink" href="#execution" title="Link to this heading">#</a></h2>
<p>As the plugins execute for any given test there will be one of two
outcomes: success or failure. Middle ground may be represented in
ipaErrorLevel. This purpose of this tool is to report errors, not info.</p>
<p>Upon failure:</p>
<ul class="simple">
<li><p>a search for a matching error message and not resolved</p></li>
<li><p>if no matches, create a new record</p></li>
<li><p>otherwise continue</p></li>
</ul>
<p>Upon success:</p>
<ul class="simple">
<li><p>a search for a matching error message and empty date resolved</p></li>
<li><p>if found then mark as resolved with the current date</p></li>
</ul>
<p>A 5-minute default timeout will wrap plugin execution to ensure
completion (it should be customizable per-plugin).</p>
<p>The definition of <em>match</em> here is TBD and depends on localization.
Automatic removal of failures would be done like this:</p>
<ol class="arabic simple">
<li><p>There is an initial set of errors, perhaps 0</p></li>
<li><p>A run is executed, returning 0 or more errors as the <strong>current</strong> list
of errors</p></li>
<li><p>The initial errors are compared to the current errors. Errors in the
<strong>initial</strong> list which are not in the <strong>current</strong> list are marked as
fixed</p></li>
<li><p>Errors in the current run that are <strong>not</strong> in the initial set are
recorded as new errors</p></li>
</ol>
<p>This will automatically account for issues that are fixed either
automatically (e.g. certificate renewal) or as part of a larger effort
to close issues. It is not required for an administrator to mark
anything as fixed. Manually adding a resolved date will make the error
re-appear upon the next run. The exception is if the error is marked as
ignore.</p>
<p>The tool will return 0 if no errors are found, non-zero otherwise.</p>
<section id="configuration">
<h3>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">#</a></h3>
<p>The ipa-healthcheck tool will store its configuration in
/etc/ipa/healthcheck.conf. It will be an ini-style config file using the
same config routines as IPA. The format is</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">[global]</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">plugin_timeout=300</span></code></div>
</div>
<p>In general it would be best to store configuration in LDAP. For the
purposes of timeout LDAP may not be reachable so needs local
configuration.</p>
<p>Other configuration identified (may be out-of-scope for initial
implementation)</p>
<ul class="simple">
<li><p>disk space threshold</p></li>
<li><p>days before certificate expiration warnings appear</p></li>
</ul>
</section>
</section>
<section id="operation">
<h2>Operation<a class="headerlink" href="#operation" title="Link to this heading">#</a></h2>
<p>Kerberos credentials will be required for some operations. Ideally this
can be handled as a bind using the host principal. Bind to LDAP will be
done using ldapi which should provide read access to any data not
available as the host.</p>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Link to this heading">#</a></h2>
<p>The ipa-healthcheck command and plugins will be distributed as a
separate tarball so will be a separate package. The freeipa-server
package will have a dependency on this so it will be included by
default.</p>
<p>The server healthcheck plugin will be delivered in the freeipa-server
package so will be installed by default.</p>
<p><strong>Note:</strong> there is still some uncertainty about whether ipa-healthcheck
will be a separate upstream project or be included in freeIPA. The
advantage to being separate is that it can be updated much more
frequently. The disadvantage is the additional packaging work. This is
still under discussion but for now it is separate.</p>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
</section>
<section id="feature-management">
<h2>Feature Management<a class="headerlink" href="#feature-management" title="Link to this heading">#</a></h2>
<p>UI</p>
<p>TBD. It may be possible to make the output readable by the UI and
display the exceptions.</p>
<p>CLI</p>
<p>ipa-healthcheck:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Options</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ipa-healthcheck</p></td>
<td><p>–source execute only a specific set of test</p></td>
</tr>
<tr class="row-odd"><td><p></p></td>
<td><p>–verbose expanded output</p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td><p>–failures-only</p></td>
</tr>
<tr class="row-odd"><td><p></p></td>
<td><p>–output-file=FILENAME</p></td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">$ ipa-healthcheck</span></code></p>
<p>The ipa-healthcheck command return code indicates whether it was able to
run successfully, not if it encountered any issues with the IPA
installation. A 0 means that all sources and checks were executed. A
non-zero means some unrecoverable condition was encountered and needs
further investigation.</p>
<p>The ipa-healthcheck tool does not log to a file by default, it outputs
to stdout. –output-file can be used to write the JSON output to a file.</p>
<p>The output format by default is JSON and will look like:</p>
<div class="line-block">
<div class="line">`` {``</div>
<div class="line">``   “source”: “filesystemspace”,``</div>
<div class="line">``   “check”: “FileSystemSpaceCheck”,``</div>
<div class="line">``   “severity”: 0,``</div>
<div class="line">``   “uuid”: “7bc5e1f1-a67f-4fe4-8eb2-ffba890aa1a7”,``</div>
<div class="line">``   “when”: “20190620171103Z”,``</div>
<div class="line">``   “duration”: null,``</div>
<div class="line">``   “kw”: {``</div>
<div class="line">``     “msg”: “/tmp: free space within limits: 1971 MiB &gt;= 512 MiB”,``</div>
<div class="line">``     “store”: “/tmp”,``</div>
<div class="line">``     “free_space”: 1971,``</div>
<div class="line">``     “threshold”: 512``</div>
<div class="line">``   }``</div>
</div>
</section>
<section id="test-plan">
<h2>Test Plan<a class="headerlink" href="#test-plan" title="Link to this heading">#</a></h2>
<p>It can be difficult to simulate some issues.</p>
<p>At a minimum it should return 100% success on new installations of the
supported IPA versions.</p>
<p>For testing certificates at least one round of certificate renewals
should be done.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#minimum-viable-product">Minimum Viable Product</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mvp-acceptance-criteria">MVP Acceptance Criteria</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#high-level-architecture">High-level Architecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#related-tickets">Related Tickets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use">How to Use</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-it-manually">Running it manually</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#repairing-issues">Repairing Issues</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#independence">Independence</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#errors">Errors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#severity">Severity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis">Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#framework">Framework</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plugins">Plugins</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa">IPA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#certificates-ca-kra">Certificates/CA/KRA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication">Replication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ad-trust">AD Trust</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kerberos">Kerberos</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dns">DNS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#topology">Topology</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custodia">Custodia</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#upgrade">Upgrade</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#execution">Execution</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#operation">Operation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#installation">Installation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>