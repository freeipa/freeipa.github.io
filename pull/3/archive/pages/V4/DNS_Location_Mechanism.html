<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="DNS_Location_Mechanism_with_per_client_override.html" />
    <link rel="prev" title="Overview" href="DNSSEC_Support.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p><strong>Author</strong>: Simo Sorce with help from Petr Spacek, Martin Basti, and
others</p>
<section id="forewords">
<h2>Forewords<a class="headerlink" href="#forewords" title="Permalink to this heading">¶</a></h2>
<p>This is a new proposal (Jan 2013) to support Location Based discovery in
FreeIPA. It was inspired by <a class="reference external" href="FreeIPAv2:DNS_Location_Discovery">earlier
proposal</a> made a while ago. The
main difference is that it simplifies the whole management by
eliminating IP subnets and special client code while still maintaining a
great deal of flexibility. The key insight being that different
locations can configure the network to use different FreeIPA DNS
servers, that are local to the location being considered.</p>
<p>This document describes versions
<a class="reference external" href="#Design_(Version_2:_DNAME_per_sub-tree)">2</a> and
<a class="reference external" href="#Design_(Version_3:_CNAME_per_service_name)">3</a> of the proposal
which are easier to implement. Version 1 which adds support for
per-client overrides is described in <a class="reference external" href="V4/DNS_Location_Mechanism_with_per_client_override">separate
document</a>. Only
<a class="reference external" href="#Design_(Version_3:_CNAME_per_service_name)">version 3</a> will be
implemented at this time. Please see <a class="reference external" href="#Comparison_of_proposals">comparison of
proposals</a> for further information about
the differences.</p>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>Service Discovery is a process whereby a client uses information stored
in the network to find servers that offer a specific service. It is
useful for two reasons. First, it places the information required for
the location of servers in the network, lessening the burden of client
configuration. Second, it gives system and network administrators a
central point of control that can be used to to define an optimized
policy that determines which clients should use which server and in what
order.</p>
<p>A standard for service discovery is defined in <a class="reference external" href="http://www.rfc-archive.org/getrfc.php?rfc=RFC2782">RFC
2782</a>. This
standard defines a DNS RR with the mnemonic SRV and usage rules around
it. It allows a client to discover servers that offer a given service
over a given protocol.</p>
<p>A drawback of SRV Records is that it assumes clients know the correct
DNS domain to use as the query target. Without any further information,
the client’s options includes using their own DNS domain and the name of
the security domain in which the client operates (such as the domain
name associated to the Kerberos REALM the client refers to). Neither
option is likely to yield optimal results however. One key service
discovery requirement, especially in large distributed enterprises, is
to choose a server that is close to a client. However in many situation
binding the client name to a specific zone that is tied to a physical
location is not possible. And even if it were it would not address the
needs of a roaming client that moves across the networks. We cannot have
the name of a client change when it move across networks as this break
the Kerberos protocol that associates keys to a fixed host name for
Service Principals.</p>
<p>The incompleteness of <a class="reference external" href="http://www.rfc-archive.org/getrfc.php?rfc=RFC2782">RFC
2782</a> is
acknowledged by systems such as <a class="reference external" href="http://en.wikipedia.org/wiki/Active_Directory">Active
Directory</a> that
contain extra functionality to augment SRV lookups to make them site
aware. The basic idea is to use a target in SRV service discovery that
is specific to a location or “site” in AD parlance. Unfortunately AD
clients rely on additional configuration or side protocols to determine
the client “site” and it is quite specific to Microsoft technologies so
the method they use is not easily portable and reusable in other
contexts nor documented in Standards or informative IETF RFCs.</p>
<p>This document specifies a protocol for location discovery based
exclusively on DNS. While the protocol itself can be fully implemented
with a normal DNS the FreeIPA mechanism is augmented by additional
‘location’ awareness and will depend on additional computation done by
the FreeIPA DNS plugins.</p>
<p>Howto document: <a class="reference external" href="Howto/IPA_locations">IPA Locations</a></p>
</section>
</section>
<section id="assumptions">
<h1>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Clients are doing DNS SRV lookup (<a class="reference external" href="http://tools.ietf.org/html/rfc2782">RFC
2782</a>) or DNS URI lookup (<a class="reference external" href="http://tools.ietf.org/html/rfc7553">RFC
7553</a>) to find out information
about servers they should connect to.</p></li>
<li><p>There are sets of servers which are functionally equivalent but
communication costs to different sets of servers vary.</p></li>
<li><p>For a client, it is ‘cheap’ to communicate with servers ‘near’ the
client and it is more ‘expensive’ to communicate with ‘remote’
servers (higher latency, smaller throughput, pay-per-byte etc.).</p>
<ul>
<li><p>Special case: Some clients are able to reach only subset of
servers due to firewall restrictions etc.</p></li>
</ul>
</li>
<li><p>Clients can roam among various networks so optimal set of servers
changes from client’s perspective.</p>
<ul>
<li><p>For this reason only one set of static DNS SRV records cannot
suffice.</p></li>
<li><p>The <em>DNS Locations</em> feature will work only if TTL of DNS records
is shorter than time which clients need to move between two
locations.</p></li>
</ul>
</li>
<li><p>At least one of the FreeIPA servers in each location is a DNS enabled
server.</p>
<ul>
<li><p>In principle this might be relaxed to “DNS view per location” but
then IPA needs integration with DNS views on external servers.</p></li>
</ul>
</li>
<li><p>Clients in each <code class="docutils literal notranslate"><span class="pre">location</span></code> are configured to use a local DNS
server, which is (or recursively queries or forwards to) a local
FreeIPA DNS server. In other words, the assumption is that a client
in a specific location will generally query a FreeIPA server
(possibly through forwarding or recursion) in the same location for
location-specific information.</p>
<ul>
<li><p>If DNS recursion is involved, we assume that recursor is
intelligent enough to query <em>nearest</em> FreeIPA DNS server. This is
commonly done by querying servers with shortest round trip time.
The implicit logic in DNS recursors can be overriden by explicit
forwarding configuration.</p></li>
<li><p>In principle this might be done using “DNS view per location” but
then IPA needs integration with DNS views on external servers.</p></li>
</ul>
</li>
<li><p><strong>To sum up</strong>: 1 <code class="docutils literal notranslate"><span class="pre">location</span></code> is defined as set of servers which
should be prefered by associated DNS clients.</p>
<ul>
<li><p>Typically the servers have the same functionality and
communication costs (as seen from client’s perspective).</p></li>
<li><p>DNS resolution chain typically looks like
<code class="docutils literal notranslate"><span class="pre">client-&gt;(any</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">recursive</span> <span class="pre">resolvers)-&gt;authoritative</span> <span class="pre">server</span> <span class="pre">(or</span> <span class="pre">its</span> <span class="pre">view)</span></code>.
All clients which end up querying the same location-specific DNS
server (or its DNS view if views are in use) are associated with
the same DNS location and will try to contact the same set of
servers.</p></li>
</ul>
</li>
</ul>
<section id="current-use-of-srv-records">
<span id="current-use-of-srv-records5"></span><h2>Current use of SRV records<a class="headerlink" href="#current-use-of-srv-records" title="Permalink to this heading">¶</a></h2>
<p>Client queries for SRV records located in the domain/realm
(<code class="docutils literal notranslate"><span class="pre">example.com</span></code> in the following example) and gets back all servers.
Assuming that all DNS servers responsible for given zone are returning a
static set of records, there is no way how to prioritize a server
‘nearest’ to the client at the moment. Consequenty, all FreeIPA servers
typically have the same priority (0) and weight (100):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``;; QUESTION SECTION:``
``;_ldap._tcp.``\ **``example.com.``**\ `` IN SRV``
``;; ANSWER SECTION:``
``_ldap._tcp.example.com. SRV ``\ **``0``\ ````\ ``100``**\ `` 389 ipa-brno.example.com.``
``_ldap._tcp.example.com. SRV ``\ **``0``\ ````\ ``100``**\ `` 389 ipa-london.example.com.``
</pre></div>
</div>
</section>
</section>
<section id="use-cases">
<span id="use-cases5"></span><h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Roaming clients should connect to set of ‘nearest’ servers so
communication is ‘cheap’. When none of nearest servers is reachable,
failover to remote servers might be desired.</p></li>
<li><p>Some clients might want to connect always to the same set of servers
for some reason, i.e. server can be pinned to a location.</p></li>
<li><p><strong>Future extension - out of scope for FreeIPA 4.4:</strong> The mechanism
can be re-used for non-IPA services. Generally any service which is
using <code class="docutils literal notranslate"><span class="pre">SRV</span></code> records can be hacked in this way. This might require
specifying location on per-zone basics.</p></li>
</ul>
</section>
<section id="feature-management">
<span id="feature-management5"></span><h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<p>Howto document: <a class="reference external" href="Howto/IPA_locations">IPA Locations</a></p>
<p>Current proposal offers limited configuration capabilities on purpose to
limit user inteface complexity.</p>
<p>One location can contain 1 or more FreeIPA servers and 1 server can be
assigned to at most 1 location. Mechanism generating DNS SRV records
will ensure that clients always prefer servers assigned to location over
all other FreeIPA servers in topology (servers in client’s location will
have static priority set to a value higher than all other servers).</p>
<p>Load-balancing among servers in one location is based on
<a class="reference external" href="http://tools.ietf.org/html/rfc2782#page-3">weight</a> which can be
defined by administrator. By default the load will be equally
distributed among all servers in the location.</p>
<p>When none of servers assigned to particular location can be contacted,
the client will use remaining servers (i.e. servers not assigned to the
particular location) as fallback. These fallback servers always have
smaller priority that all other servers assigned to the location by
administrator so clients should return back to local servers as soon as
they become available. (This depends on particular implementation on the
client side.)</p>
<section id="ui">
<h2>UI<a class="headerlink" href="#ui" title="Permalink to this heading">¶</a></h2>
<p>It seems as natural fit to somehow show locations in Topology Graph.
Details TBD</p>
<figure class="align-default" id="id29">
<img alt="Locations-v2-topology-graph.png" src="../../../_images/Locations-v2-topology-graph.png" />
<figcaption>
<p><span class="caption-text">Locations-v2-topology-graph.png</span><a class="headerlink" href="#id29" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<ul class="simple">
<li><p>Drag &amp; drop servers between locations?</p></li>
<li><p>How to add/delete/edit locations?</p></li>
</ul>
</section>
<section id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this heading">¶</a></h2>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><table class="docutils align-default">
<tbody>
</tbody>
</table>
</th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Command</p></td>
<td><p>Options</p></td>
<td><p>Meaning</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>+=======================+=======================+=======================+</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>location-add</p></td>
<td><p>LOCATION_NAME
[–desc=text]</p></td>
<td><p>Add empty IPA
location [with
optional
description].</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>location-del</p></td>
<td><p>LOCATION_NAME</p></td>
<td><p>Delete IPA location.
All servers in given
location will stay
unassigned and will
be used only as
backup servers for
other locations.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>location-find</p></td>
<td><p>[SEARCH_TERM]</p></td>
<td><p>Get locations with
name or description
matching given
SEARCH_TERM. List all
locations if no
SEARCH_TERM was
specified.</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>location-show</p></td>
<td><p>LOCATION_NAME</p></td>
<td><p>Show location name,
description, and list
of all member servers
including their
weights + weights
recalculated to
relative number in
percents. Mark IPA
DNS servers in the
output so it is easy
to see which servers
advertise this
location.</p>
<p>ption: IPA location</p>
<p>dvertised by serve
rs: server1.example</p>
<p>er: server1.example``</p>
<p>lative weight: 33 %``</p>
<p>S server, CA server``</p>
<p>er: server2.example``</p>
<p>lative weight: 67 %``</p>
<p>s: CA server, NTP ser
ver, AD trust agent,
AD trust controller``</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">Example:</span></code>
descri</p>
<p><code class="docutils literal notranslate"><span class="pre">Servers:</span></code>
``  serv</p>
<p>``  weight 100``
``  re</p>
<p>``  Roles: DN</p>
<p>``  serv</p>
<p>``  weight: 200``
``  re</p>
<p>``  Role</p>
</td>
</tr>
<tr class="row-odd"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>dns-</p></td>
<td><p>[–dry-run]</p></td>
<td><p>This command is not</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>update-system-records</p></td>
<td></td>
<td><p>necessary if IPA DNS
is used and no
hand-tweaking is ever
done by user.
Re-generate all DNS
records. This will be
especially useful if
someone manually
tweaks DNS records in
a wrong way or when
external DNS is used.
Option –dry-run will
print the records
without actually
modifying them.</p></td>
<td></td>
</tr>
<tr class="row-even"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>server-mod</p></td>
<td><p>–l
ocation=LOCATION_NAME
[–loca
tion-weight=0..65535]</p></td>
<td><p>Add IPA server into
specified location.
The server will be
advertised in DNS SRV
records for given
location. One server
can be member of at
most 1 location.</p>
<p>All weights in one
location detemine how
requests from clients
are distributed among
IPA servers. Example:
Location has three
servers with weights
50, 25, 25. First
server will receive
50 % of all requests
and second and third
server will receive
25 % requests,
respectively.
Default: 100, i.e.
requests are evenly
distributed among all
servers.</p>
</td>
<td></td>
</tr>
<tr class="row-even"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>server-show</p></td>
<td><p>FQDN</p></td>
<td><p>Show assigned
location and weight
for particular
server.</p></td>
<td></td>
</tr>
<tr class="row-even"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Notes:</p>
<ul class="simple">
<li><p>server-mod command should print a warning if non-empty location has
zero advertising (IPA DNS) servers assigned</p>
<ul>
<li><p>A warning should be printed if location has less than 2 DNS
servers: “For redundancy configure at least two advertising DNS
servers for this location.”</p></li>
</ul>
</li>
</ul>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h2>
<p>IPA DNS servers will automatically generate distinct DNS SRV and DNAME
records for each location as necessary. To function properly, this
feature depends on optimal routing of DNS queries from clients to
nearest IPA DNS servers.</p>
<p>This auto-configuration depends on three conditions:</p>
<ul class="simple">
<li><p>Number of IPA DNS servers &gt;= number of configured IPA locations</p></li>
<li><p>All advertising IPA DNS servers are listed in NS records of IPA DNS
zone</p></li>
<li><p>Server selection algorithm used by recursors (typically something
based on round-trip time) selects nearest IPA DNS server which has to
advertise nearest IPA location for given client</p></li>
</ul>
<p>In standard configuration this should work automatically as long as all
IPA DNS servers and their slaves are listed in NS records and recursors
follow <a class="reference external" href="http://tools.ietf.org/html/rfc1035#page-44">RFC 1035 section
7.2</a>.</p>
<p>Explicit DNS query forwarding overrides normal server selection and can
be used to fine-tune client-to-location assignment (or to
unintentionally break auto-configuration described above).</p>
</section>
</section>
<section id="design-version-1-dname-per-client">
<span id="id1"></span><h1>Design (Version 1: DNAME per client)<a class="headerlink" href="#design-version-1-dname-per-client" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="V4/DNS_Location_Mechanism_with_per_client_override">First version of this
proposal</a> which
allowed per-client override was split to separate page. This version is
being deferred for now.</p>
</section>
<section id="design-version-2-dname-per-sub-tree">
<span id="id2"></span><h1>Design (Version 2: DNAME per sub-tree)<a class="headerlink" href="#design-version-2-dname-per-sub-tree" title="Permalink to this heading">¶</a></h1>
<p>An alternative is to put DNAME redirection onto <code class="docutils literal notranslate"><span class="pre">_udp</span></code> and <code class="docutils literal notranslate"><span class="pre">_tcp</span></code>
(and possibly other) sub-trees of the main domain and redirect these to
location-specific sub-tree.</p>
<p>Similarly to per-client <code class="docutils literal notranslate"><span class="pre">_location</span></code> records, this DNAME redirection
can be different on each server.</p>
<p>This should work out of the box.</p>
<section id="interaction-with-hand-made-records">
<span id="id3"></span><h2>Interaction with hand-made records<a class="headerlink" href="#interaction-with-hand-made-records" title="Permalink to this heading">¶</a></h2>
<p>Side-effect of DNAME-redirecting <code class="docutils literal notranslate"><span class="pre">_udp</span></code> and <code class="docutils literal notranslate"><span class="pre">_tcp</span></code> subdomains is
that all original names under these subdomains will become
occluded/invisible to clients (see <a class="reference external" href="https://tools.ietf.org/html/rfc6672#section-2.4">RFC 6672 section
2.4</a>).</p>
<p>This effectively means that hand-made records in the IPA DNS domain will
become invisible. E.g. following record will disappear when DNS
locations are configured and enabled on IPA domain <code class="docutils literal notranslate"><span class="pre">ipa.example</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">_userservice._udp.ipa.example.  SRV record: 0 100 123 own-server.somewhere.example</span></code></p>
<p>This behavior is in fact necessary for seamless upgrade of replicas
which do not understand the new template LDAP entries in DNS tree. Old
replicas will ignore the template entries and use original sub-tree (and
ignore <code class="docutils literal notranslate"><span class="pre">_locations</span></code> sub-tree). New replicas will uderstand the entry,
generate DNAME records and thus occlude old names and use only new ones
(in <code class="docutils literal notranslate"><span class="pre">_locations</span></code> sub-tree).</p>
<p>Note: This would be unnecessary if IPA used standard DNS update protocol
against standard DNS server with non-replicated zones because we would
not need to play DNAME tricks. In that case we could instead update
records on each server separately. With current LDAP schema we cannot do
that without adding non-replicated part of LDAP tree to each DNS server.</p>
<ul class="simple">
<li><p>If we added non-replicated sub-tree to each IPA DNS server we would
have another set of problems because hand-made entries would not be
replicated among IPA servers.</p></li>
</ul>
<p>Handling of hand-made records adds some interesting questions:</p>
<ul class="simple">
<li><p>How to find hand-made records?</p>
<ul>
<li><p>Blacklist on name-level or record-data level? What record fields
should we compare?</p></li>
</ul>
</li>
<li><p>How to handle collisions with IPA-generated records?</p>
<ul>
<li><p>Ignore hand-made records?</p></li>
<li><p>Add hand-made records?</p></li>
<li><p>Replace IPA generated ones with hand-made ones?</p></li>
</ul>
</li>
<li><p>What triggers hand-made record synchronization?</p>
<ul>
<li><p>Should the user or IPA framework call <em>ipa
location-update-records</em> after each hand-made change to DNS
records?</p></li>
<li><p>How is this synchronization supposed to work with DNS update
protocol? Currently we do not have means to trigger an action when
a records is changed in LDAP.</p></li>
</ul>
</li>
<li><p>How it affects interaction with older IPA DNS servers (see above)?</p></li>
</ul>
<p>There are several options:</p>
<ul class="simple">
<li><p>For first version, document that enabling DNS location will hide
hand-made records in IPA domain.</p></li>
<li><p>Add non-replicated sub-trees for IPA records and somehow solve
replication of hand-made records.</p>
<ul>
<li><p>What is the proper granularity? Create 20 backends so we can
filter on name-level?</p></li>
</ul>
</li>
<li><p>Do ‘something’ which prevents replication of IPA-generated DNS
records among servers while still using one LDAP suffix.</p>
<ul>
<li><p>With this in place we can mark IPA-generated records as
non-replicable while still replicating hand-made records as usual.
(An object class like <code class="docutils literal notranslate"><span class="pre">idnsRecordDoNotReplicate</span></code>?) This would
mean that we can drop whole <code class="docutils literal notranslate"><span class="pre">_locations</span></code> sub-tree and each
server will hold only its own copy of DNS records.</p></li>
</ul>
</li>
<li><p>Find, filter and copy hand-made records from main tree into the
<code class="docutils literal notranslate"><span class="pre">_locations</span></code> sub-trees. This means that every hand-made record
needs to be copied and synchronized N-times where N = number of IPA
locations.</p></li>
</ul>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h2>
<p>Clients will query name <code class="docutils literal notranslate"><span class="pre">_ldap._tcp.example.com.</span></code> as usual but this
name will be redirected to location-specific sub-tree:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">;; QUESTION SECTION:</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">;_ldap._tcp.example.com. IN SRV</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">;; ANSWER SECTION:</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_tcp.example.com. DNAME _tcp.cz._locations.example.com.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_ldap._tcp.example.com. CNAME _ldap._tcp.cz._locations.example.com.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_ldap._tcp.cz._locations.example.com. SRV 0 100 389 ipa-brno.example.com.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_ldap._tcp.cz._locations.example.com. SRV 3 100 389 ipa-london.example.com.</span></code></div>
</div>
<figure class="align-default" id="id30">
<img alt="ExampleLocationsV2.svg" src="../../../_images/ExampleLocationsV2.svg" /><figcaption>
<p><span class="caption-text">ExampleLocationsV2.svg</span><a class="headerlink" href="#id30" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<ul class="simple">
<li><p><strong>(A)</strong> The LDAP database contains records per each location
(“Y.$LOCATION._location.$SUFFIX”) and default records (<em>Y.$SUFFIX</em>)</p></li>
<li><p><strong>(B)</strong> The DNAME record that overrides the default locations in
format
<em>_location.$HOSTNAME</em><strong>DNAME</strong><em>$LOCATION._locations.$SUFFIX</em></p></li>
<li><p><strong>(C)</strong> The DNS server in location using <em>bind-dyndb-ldap</em> generates
DNAME records per protocol for IPA domain. A client from location
<strong>cz</strong> will get SRV records with priority set for this location.</p></li>
<li><p><strong>(D)</strong> The DNS server in location using <em>bind-dyndb-ldap</em> generates
DNAME records per protocol for IPA domain. A client from location
<strong>uk</strong> will get SRV records with priority set for this location.</p></li>
<li><p><strong>(E)</strong> Configuration for client2 has been overridden. The client is
configured to contact location <strong>uk</strong> but DNS server returns results
for location <strong>cz</strong>. Client has to be configured to ask in format
<strong>_service._proto._location.$CLIENT_HOSTNAME</strong> to be overridden
effective.</p></li>
<li><p><strong>[1]</strong> Client wants to connect to the closest LDAP server. (No extra
configuration is required.)</p></li>
<li><p><strong>[2]</strong> Client send DNS query in format <em>_ldap._tcp.$SUFFIX</em> to
server in its location.</p></li>
<li><p><strong>[3]</strong> DNAME records for each protocol for IPA domain has been
dynamically created on DNS server.</p></li>
<li><p><strong>[4]</strong> Server returns DNAME and CNAME (for old clients) records, the
client has to ask server again to receive SRV records for the name
returned by DNAME (CNAME).</p></li>
<li><p><strong>[5]</strong> Server returns SRV records configured for this location
(priority for servers located in CZ (Brno))</p></li>
</ul>
</section>
<section id="compatibility-tests">
<span id="id4"></span><h2>Compatibility tests<a class="headerlink" href="#compatibility-tests" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>FreeIPA client installer:</p>
<ul>
<li><p>Fedora 23: <code class="docutils literal notranslate"><span class="pre">freeipa-client-4.2.3-2.fc23.x86_64</span></code> works</p></li>
<li><p>RHEL 5.11: <code class="docutils literal notranslate"><span class="pre">ipa-client-2.1.3-7.el5</span></code> works</p></li>
</ul>
</li>
<li><p>SSSD (ipa provider):</p>
<ul>
<li><p>Fedora 23: <code class="docutils literal notranslate"><span class="pre">sssd-1.13.1-3.fc23.x86_64</span></code> works</p></li>
<li><p>RHEL 5.11: <code class="docutils literal notranslate"><span class="pre">sssd-1.5.1-71.el5</span></code></p>
<ul>
<li><p>it seems that SSSD has a generic bug which inverts priority in
DNS SRV records or does something else - the discovery found
correct servers but the order was weird</p></li>
<li><p>discovery works with version 2</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_srv_</span></code>discovery does not respect <code class="docutils literal notranslate"><span class="pre">dns_discovery_domain</span></code>
option so version 1 will not work</p></li>
</ul>
</li>
</ul>
</li>
<li><p>nss_ldap (<code class="docutils literal notranslate"><span class="pre">nss_srv_domain</span></code> option)</p>
<ul>
<li><p>RHEL 5.11: <code class="docutils literal notranslate"><span class="pre">nss_ldap-253-52.el5_11.2</span></code> works and respects
priority properly</p></li>
</ul>
</li>
<li><p>nss-pam-ldapd (<code class="docutils literal notranslate"><span class="pre">uri</span> <span class="pre">DNS</span></code> option)</p>
<ul>
<li><p>RHEL 6.7: <code class="docutils literal notranslate"><span class="pre">nss-pam-ldapd-0.7.5-20.el6_6.3.x86_64</span></code> works</p></li>
</ul>
</li>
<li><p>MIT Kerberos libs:</p>
<ul>
<li><p>Fedora 23: <code class="docutils literal notranslate"><span class="pre">krb5-libs-1.13.2-13.fc23.x86_64</span></code>,
<code class="docutils literal notranslate"><span class="pre">krb5-libs-1.14-6.fc23.x86_64</span></code> works</p></li>
<li><p>RHEL 5.11: <code class="docutils literal notranslate"><span class="pre">krb5-libs-1.6.1-80.el5_11</span></code> works</p></li>
</ul>
</li>
<li><p>OpenLDAP libs (<code class="docutils literal notranslate"><span class="pre">-H</span> <span class="pre">dc=...</span></code> parameter):</p>
<ul>
<li><p>Fedora 23: <code class="docutils literal notranslate"><span class="pre">openldap-clients-2.4.40-14.fc23.x86_64</span></code> works</p></li>
<li><p>RHEL 5.11: <code class="docutils literal notranslate"><span class="pre">openldap-clients-2.3.43-29.el5_11</span></code> does not support
DNS SRV lookup at all</p></li>
</ul>
</li>
<li><p>Microsoft Active Directory</p>
<ul>
<li><p>Windows Server 2008 R2 with updates released up to 2016-01-29, AD
functional level 2008 (without R2): works in cross-forest scenario
and respects SRV priorities - is it a way to cheap DNS sites for
AD?</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="design-version-3-cname-per-service-name">
<span id="id5"></span><h1>Design (Version 3: CNAME per service name)<a class="headerlink" href="#design-version-3-cname-per-service-name" title="Permalink to this heading">¶</a></h1>
<p>Version 2 poorly integrates with hand-made records which can be
potentially used by users for non-IPA services in primary IPA DNS
domain. Version 3 attempts to mitigate this problem at the expense of
more complex aliasing and record handling in bind-dyndb-ldap and IPA
framework.</p>
<p>IPA will generate <code class="docutils literal notranslate"><span class="pre">_locations</span></code> DNS sub-tree in the same way as for
<a class="reference external" href="V4/DNS_Location_Mechanism_with_per_client_override">version 1</a> and
<a class="reference external" href="#Design_(Version_2:_DNAME_per_sub-tree)">version 2</a>.</p>
<p>The main difference in comparison with <a class="reference external" href="#Design_(Version_2:_DNAME_per_sub-tree)">version
2</a> is the in way how
redirection from <code class="docutils literal notranslate"><span class="pre">_kerberos._udp.$SUFFIX</span></code> to
<code class="docutils literal notranslate"><span class="pre">_kerberos._udp.$LOCATION._locations.$SUFFIX</span></code> is done.</p>
<p>IPA framework will add a “template” object class and attributes for each
and every DNS name containing managed service records. I.e. a template
will be added to:</p>
<ul class="simple">
<li><p>_kerberos._udp.$SUFFIX</p></li>
<li><p>_kerberos._tcp.$SUFFIX</p></li>
<li><p>_ldap._tcp.$SUFFIX</p></li>
<li><p>_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs.$SUFFIX</p></li>
<li><p>… all of them</p></li>
</ul>
<p>The template will generate CNAME redirection from original name to the
location-specific name (which can be different on each DNS server).
Example:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">;; QUESTION SECTION:</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">;_ldap._tcp.example.com. IN SRV</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">;; ANSWER SECTION:</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_ldap._tcp.example.com. CNAME _ldap._tcp.cz._locations.example.com.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_ldap._tcp.cz._locations.example.com. SRV 0 100 389 ipa-brno.example.com.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_ldap._tcp.cz._locations.example.com. SRV 3 100 389 ipa-london.example.com.</span></code></div>
</div>
<p>Servers which are not assigned to a location (or are too old to
understand the template) will ignore the template and use the original
value in <code class="docutils literal notranslate"><span class="pre">*Record</span></code> attributes.</p>
<p>For more information about mechanism generating the records see
<a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/wiki/Design/RecordGenerator">bind-dyndb-ldap design
page</a>.</p>
<section id="example-1">
<span id="id6"></span><h2>Example<a class="headerlink" href="#example-1" title="Permalink to this heading">¶</a></h2>
<figure class="align-default" id="id31">
<img alt="ExampleLocationsV3.svg" src="../../../_images/ExampleLocationsV3.svg" /><figcaption>
<p><span class="caption-text">ExampleLocationsV3.svg</span><a class="headerlink" href="#id31" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<ul class="simple">
<li><p><strong>(A)</strong> The LDAP database contains records per each location
(“$Y.$LOCATION._location.$SUFFIX”) and default records (<em>Y.$SUFFIX</em>)</p></li>
<li><p><strong>(B)</strong> The CNAME record that overrides the default locations in
format <em>$Y.$SUFFIX</em><strong>CNAME</strong><em>$Y.$LOCATION._locations.$SUFFIX</em></p></li>
<li><p><strong>(C)</strong> The DNS server in location using <em>bind-dyndb-ldap</em> generates
CNAME records per SRV record of IPA service for IPA domain. A client
from location <strong>cz</strong> will get SRV records with priority set for this
location.</p></li>
<li><p><strong>(D)</strong> The DNS server in location using <em>bind-dyndb-ldap</em> generates
CNAME records per SRV record of IPA service for IPA domain. A client
from location <strong>uk</strong> will get SRV records with priority set for this
location.</p></li>
<li><p><strong>(E)</strong> Configuration for client2 has been overridden. The client is
configured to contact location <strong>uk</strong> but DNS server returns results
for location <strong>cz</strong>. Client has to be configured to ask in format
<strong>_service._proto._location.$CLIENT_HOSTNAME</strong> to be overridden
effective. Also, these records are not automatically generated so
administrator has to manually configure CNAME record template for
this client.</p></li>
<li><p><strong>[1]</strong> Client wants to connect to the closest LDAP server. (No extra
configuration is required.)</p></li>
<li><p><strong>[2]</strong> Client send DNS query in format <em>_ldap._tcp.$SUFFIX</em> to
server in its location.</p></li>
<li><p><strong>[3]</strong> CNAME records for each protocol for IPA domain has been
dynamically created on DNS server.</p></li>
<li><p><strong>[4]</strong> Server returns CNAME records, the client has to ask server
again to receive SRV records for the name returned by CNAME.</p></li>
<li><p><strong>[5]</strong> Server returns SRV records configured for this location
(priority for servers located in CZ (Brno))</p></li>
</ul>
</section>
<section id="interaction-with-hand-made-records-1">
<span id="id7"></span><h2>Interaction with hand-made records<a class="headerlink" href="#interaction-with-hand-made-records-1" title="Permalink to this heading">¶</a></h2>
<p>Auto-generated CNAME records avoid problem with occluded/invisible
subdomains in <code class="docutils literal notranslate"><span class="pre">_udp</span></code> and <code class="docutils literal notranslate"><span class="pre">_tcp</span></code> sub-trees.</p>
<p>Hand-made records with names which are not managed by IPA will be
visible as usual because IPA will not add template object class to them.
E.g. following record will stay as is when DNS locations are configured
and enabled on IPA domain <code class="docutils literal notranslate"><span class="pre">ipa.example</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">_userservice._udp.ipa.example.  SRV record: 0 100 123 own-server.somewhere.example.</span></code></p>
<p>This allows the user to use hand-made records as long as they do not
reside under the same DNS name which is managed by IPA. All hand-made
records under IPA-managed names (e.g. <code class="docutils literal notranslate"><span class="pre">_kerberos._udp.$SUFFIX</span></code>) will
be ignored.</p>
<p>This approach also avoids synchronization problem because hand-made
records do not need to be copied into <code class="docutils literal notranslate"><span class="pre">_locations</span></code> sub-tree.</p>
</section>
<section id="compatibility">
<h2>Compatibility<a class="headerlink" href="#compatibility" title="Permalink to this heading">¶</a></h2>
<p>Given that client’s will see only CNAME, from client’s perspective
version 3 should have the same or better properties than <a class="reference external" href="#Design_(Version_2:_DNAME_per_sub-tree)">version
2</a>. Version 2 used
DNAME+CNAME and worked pretty well so I assume that version 2 should
have the same or better compatibility with clients.</p>
</section>
</section>
<section id="comparison-of-proposals">
<span id="id8"></span><h1>Comparison of proposals<a class="headerlink" href="#comparison-of-proposals" title="Permalink to this heading">¶</a></h1>
<blockquote>
<div><table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><table class="docutils align-default">
<tbody>
</tbody>
</table>
</th>
<th class="head"></th>
<th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Property</p></td>
<td><p>v1: <a class="reference external" href="V4/DNS_Location_Mechanism_with_per_client_override">DNAME per
client</a></p></td>
<td><p>v2: <a class="reference external" href="#Design_(Version_2:_DNAME_per_sub-tree)">DNAME per
sub-tree</a></p></td>
<td><p>v3: <a class="reference external" href="#Design_(Version_3:_CNAME_per_service_name)">CNAME per
service
name</a></p></td>
</tr>
<tr class="row-odd"><td><p>+================+================+================+================+</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Requires</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>client-side</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>support</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Risk of</p></td>
<td><p>zero</p></td>
<td><p>small</p></td>
<td><p>small</p></td>
</tr>
<tr class="row-odd"><td><p>i</p></td>
<td></td>
<td><p><a class="reference external" href="#fn1">1</a></p></td>
<td><p><a class="reference external" href="#fn2">2</a></p></td>
</tr>
<tr class="row-even"><td><p>ncompatibility</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>with old</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>clients</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Per client</p></td>
<td><p>yes</p></td>
<td><p>no</p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p>override</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Works as</p></td>
<td><p>no</p></td>
<td><p>yes</p></td>
<td><p>yes</p></td>
</tr>
<tr class="row-even"><td><p>cross-realm</p></td>
<td><p><a class="reference external" href="#fn3">3</a></p></td>
<td><p><a class="reference external" href="#fn4">4</a></p></td>
<td><p><a class="reference external" href="#fn5">5</a></p></td>
</tr>
<tr class="row-odd"><td><p>optimization</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Implementation</p></td>
<td><p>hard</p></td>
<td><p>easy</p></td>
<td><p>harder than</p></td>
</tr>
<tr class="row-even"><td><p>with standard</p></td>
<td><p><a class="reference external" href="#fn6">6</a></p></td>
<td><p><a class="reference external" href="#fn7">7</a></p></td>
<td><p>v2 &lt;#</p></td>
</tr>
<tr class="row-odd"><td><p>DNS server</p></td>
<td></td>
<td></td>
<td><p>Design
but much
easier than
v1
<a class="reference external" href="#fn8">8</a></p></td>
</tr>
<tr class="row-even"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>DNS query</p></td>
<td><p>1 extra hop</p></td>
<td><p>1 extra hop</p></td>
<td><p>1 extra hop</p></td>
</tr>
<tr class="row-even"><td><p>overhead</p></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>DNS zone size</p></td>
<td><p>factor ~ 2.3</p></td>
<td><p>negligible</p></td>
<td><p>negligible</p></td>
</tr>
<tr class="row-odd"><td><p>overhead</p></td>
<td></td>
<td><p><a class="reference external" href="#fn9">9</a></p></td>
<td><p><a class="reference external" href="#fn10">10</a></p></td>
</tr>
<tr class="row-even"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Zone signing</p></td>
<td><p>factor ~ 2.3</p></td>
<td><p>negligible</p></td>
<td><p>negligible</p></td>
</tr>
<tr class="row-even"><td><p>CPU overhead</p></td>
<td></td>
<td><p><a class="reference external" href="#fn11">11</a></p></td>
<td><p><a class="reference external" href="#fn12">12</a></p></td>
</tr>
<tr class="row-odd"><td><table class="docutils align-default">
<tbody>
</tbody>
</table>
</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div></blockquote>
<section id="comparison-with-microsoft-active-directory-sites">
<span id="comparison-with-microsoft-active-directory-sites5"></span><h2>Comparison with Microsoft Active Directory Sites<a class="headerlink" href="#comparison-with-microsoft-active-directory-sites" title="Permalink to this heading">¶</a></h2>
<p>Some administrators might be familiar with concept of <a class="reference external" href="https://technet.microsoft.com/en-us/library/cc754697.aspx">Active Directory
Sites</a>.
Please note that FreeIPA’s <em>DNS Locations</em> are different in several
aspects:</p>
<ul class="simple">
<li><p>FreeIPA’s replication topology is not affected in any way by <em>DNS
Locations</em></p></li>
<li><p>There is no concept of intra-site links between <em>DNS Locations</em></p></li>
<li><p>Client’s location is determined by DNS server used by the client for
making DNS queries for records in FreeIPA primary DNS domain</p>
<ul>
<li><p>All clients using particular DNS server always belong to one <em>DNS
Location</em></p></li>
</ul>
</li>
<li><p>In current implementation, there is no way to statically configure a
client to always use particular location</p></li>
<li><p>Clients are using standard DNS queries and generally do not need to
be aware of concept of locations</p>
<ul>
<li><p>Consequently, the facility will work with any standard-compliant
client (please see <a class="reference external" href="#Assumptions">#Assumptions</a>)</p></li>
</ul>
</li>
</ul>
<p>One thing is common to AD Sites and FreeIPA DNS Locations:</p>
<ul class="simple">
<li><p>Set of servers assigned to one site (in case of FreeIPA servers with
highest priority) are assumed to be <em>optimal</em> choice for clients
assigned to that particular site.</p></li>
</ul>
</section>
</section>
<section id="security-considerations">
<span id="security-considerations5"></span><h1>Security Considerations<a class="headerlink" href="#security-considerations" title="Permalink to this heading">¶</a></h1>
<p>As always DNS replies can be spoofed relatively easily (unless the zone
is DNSSEC signed and records are validated on the client).</p>
<p>We recommend that SRV records resolution is used only for those clients
that normally use an additional security protocol to talk to network
resources and can use additional mechanisms to authenticate these
resources. For example a client that uses an LDAP server for security
related information like user identity information should only trust SRV
record discovery for the LDAP service if LDAPS or STARTTLS over LDAP are
mandatory and certificate verification is fully turned on, or if
SASL/GSSAPI is used with mutual authentication, integrity and
confidentiality options required.</p>
<p>Use of DNSSEC and full DNS signature verification may be considered an
additional requirement in some cases.</p>
</section>
<section id="summmary-of-meeting-2016-02-04">
<span id="id9"></span><h1>Summmary of meeting 2016-02-04<a class="headerlink" href="#summmary-of-meeting-2016-02-04" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Participants: Simo Sorce, Petr Spacek, Martin Basti</p></li>
<li><p>We will start with per sub-tree approach and deffer <a class="reference external" href="per-client_overrides">V4/DNS Location
Mechanism with per client override</a> for now.</p></li>
<li><p>Keep in mind that bind-dyndb-ldap might get rid of GSSAPI. LDAPI
mapping to a principal may change results from LDAP whoami.</p></li>
<li><p>LDAP schema and user interface has to be defined.</p>
<ul>
<li><p>We should think about supporting DNS locations per (server &amp; zone)
so different zones can be assigned to different locations.</p></li>
</ul>
</li>
</ul>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<p>The implementation consists of several phases (preferably in this
order):</p>
<ul class="simple">
<li><p>Add <a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/wiki/Design/PerServerConfigInLDAP">per-IPA DNS server configuration
capabilities</a>
to bind-dyndb-ldap</p></li>
<li><p>Add <a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/wiki/Design/RecordGenerator">Per bind-dyndb-ldap instance record
generation</a></p></li>
<li><p>Cleanup and unification of DNS record generators in FreeIPA framework
and installers</p></li>
<li><p>Add location management capabilities to FreeIPA (location-*
commands)</p></li>
<li><p>Combine new record generators in FreeIPA framework with locations</p></li>
<li><p>Add support for default TTL value into bind-dyndb-ldap and FreeIPA
(so roaming clients are not stuck with cached records)</p></li>
<li><p>Add management UI for per-DNS server configuration (to make it more
manageable)</p></li>
</ul>
<section id="dns-server-configuration">
<span id="id10"></span><h2>DNS server configuration<a class="headerlink" href="#dns-server-configuration" title="Permalink to this heading">¶</a></h2>
<p>This FreeIPA feature depends on two sub-features of bind-dyndb-ldap:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/wiki/Design/PerServerConfigInLDAP">Per-server configuration in
LDAP</a></p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/wiki/Design/RecordGenerator">Per bind-dyndb-ldap instance record
generation</a></p></li>
</ul>
<p>Both features contain a new attributes and related access controls. For
details please see separate pages.</p>
<p>When a FreeIPA server is assigned to a location (which will be
advertised to clients), the DNS name of the location will be put into
<code class="docutils literal notranslate"><span class="pre">idnsSubstitutionVariable;ipaLocation</span></code> attribute in
<code class="docutils literal notranslate"><span class="pre">idnsServerConfigObject</span></code> representing the DNS server.</p>
</section>
<section id="cname-data-generation">
<span id="id11"></span><h2>CNAME data generation<a class="headerlink" href="#cname-data-generation" title="Permalink to this heading">¶</a></h2>
<p>FreeIPA must create <code class="docutils literal notranslate"><span class="pre">idnsTemplateObject</span></code> at all SRV records belongs to
IPA services in FreeIPA primary DNS domain.</p>
<p>All these objects need to contain attribute
<code class="docutils literal notranslate"><span class="pre">idnsTemplateAttribute;CNAMERecord</span></code> which will instruct
bind-dyndb-ldap to generate the CNAME records for the particular
location.</p>
<section id="example-2">
<span id="id12"></span><h3>Example<a class="headerlink" href="#example-2" title="Permalink to this heading">¶</a></h3>
<p>Following example will instruct bind-dyndb-ldap to generate
<code class="docutils literal notranslate"><span class="pre">CNAMERecord</span></code> attribute with value constructed from prefix <code class="docutils literal notranslate"><span class="pre">_udp.</span></code>,
user-defined variable <code class="docutils literal notranslate"><span class="pre">ipalocation</span></code>, and suffix <code class="docutils literal notranslate"><span class="pre">._locations</span></code>.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">dn: idnsName=_ldap._tcp,idnsname=example.com.,cn=dns,dc=example,dc=com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectClass: idnsTemplateObject</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectClass: top</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectClass: idnsRecord</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">idnsName: _ldap._tcp</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">srvrecord: 0 100 389 ipa.example.com.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">idnsTemplateAttribute;cnamerecord: _ldap._tcp.\{substitutionvariable_ipalocation\}._locations</span></code></div>
</div>
</section>
</section>
<section id="records-generated-for-ipa-services">
<span id="id13"></span><h2>Records generated for IPA services<a class="headerlink" href="#records-generated-for-ipa-services" title="Permalink to this heading">¶</a></h2>
<p><strong>One in IPA domain:</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">_kerberos TXT {IPA_REALM}</span></code></p>
<p><strong>For each IPA master:</strong></p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">_ldap._tcp SRV 0 100 389 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kerberos._tcp SRV 0 100 88 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kerberos._udp SRV 0 100 88 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kerberos-master._tcp SRV 0 100 88 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kerberos-master._udp SRV 0 100 88 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kpasswd._tcp SRV 0 100 464 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kpasswd._udp SRV 0 100 464 {hostname}</span></code></div>
</div>
<p><strong>For each IPA CA server:</strong></p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipa-ca A {ipv4 address of server}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipa-ca AAAA {ipv6 address of server}</span></code></div>
</div>
<p><strong>For each IPA NTP server:</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">_ntp._udp SRV 0 100 123 {hostname}</span></code></p>
<p><strong>For each ADTrust controller</strong>:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">_ldap._tcp.Default-First-Site-Name._sites.dc._msdcs SRV  0 100 389 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_ldap._tcp.dc._msdcs SRV 0 100 389 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kerberos._tcp.Default-First-Site-Name._sites.dc._msdcs SRV 0 100 88 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kerberos._udp.Default-First-Site-Name._sites.dc._msdcs SRV 0 100 88 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kerberos._tcp.dc._msdcs SRV 0 100 88 {hostname}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">_kerberos._udp.dc._msdcs SRV 0 100 88 {hostname}</span></code></div>
</div>
</section>
<section id="location-data-generation">
<span id="id14"></span><h2>Location data generation<a class="headerlink" href="#location-data-generation" title="Permalink to this heading">¶</a></h2>
<p>We have to modify FreeIPA Python code responsible for generating DNS
records in installers etc. so FreeIPA is able to automatically generate
DNS records for each possible combination (service, location).</p>
<p>Preferably, there should be a standardized way for a service to yield
set of records which should be placed into the DNS so this set of
records can be further transformed and either placed into FreeIPA DNS or
sent as update to an external DNS server.</p>
<p>This will require refactoring described in FreeIPA ticket <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5620">#5620:
Centralize DNS record creation in IPA
services</a>.</p>
<p>The record generator will be executed for the FreeIPA primary DNS domain
and then again with modified priority and weight for each DNS location.</p>
</section>
<section id="ldap-data-structure">
<span id="id15"></span><h2>LDAP Data structure<a class="headerlink" href="#ldap-data-structure" title="Permalink to this heading">¶</a></h2>
<section id="objectclasses-and-attributes">
<span id="id16"></span><h3>Objectclasses and attributes<a class="headerlink" href="#objectclasses-and-attributes" title="Permalink to this heading">¶</a></h3>
<p>Bind-dyndb-related (<a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/wiki/Design/RecordGenerator">Record
generator</a>,
<a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/wiki/Design/PerServerConfigInLDAP">Per server config in
LDAP</a>),
all located in DNS subtree</p>
<p><code class="docutils literal notranslate"><span class="pre">attributeTypes: ( 2.16.840.1.113730.3.8.5.31 NAME 'idnsServerId' DESC 'DNS server identifier' EQUALITY caseIgnoreMatch SINGLE-VALUE SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 X-ORIGIN 'IPA v4.4' )</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">attributeTypes: ( 2.16.840.1.113730.3.8.5.30 NAME 'idnsSubstitutionVariable' DESC 'User defined variable for DNS plugin' EQUALITY caseIgnoreIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 X-ORIGIN 'IPA v4.4' )</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">objectClasses: ( 2.16.840.1.113730.3.8.6.6 NAME 'idnsServerConfigObject' DESC 'DNS server configuration options' STRUCTURAL MUST ( idnsServerId ) MAY ( idnsSubstitutionVariable $ idnsSOAmName $ idnsForwarders $ idnsForwardPolicy ) X-ORIGIN 'IPA v4.4' )</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">attributeTypes: ( 2.16.840.1.113730.3.8.5.29 NAME 'idnsTemplateAttribute' DESC 'Template attribute for dynamic attribute generation' EQUALITY caseIgnoreIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 X-ORIGIN 'IPA v4.4' )</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">objectClasses: ( 2.16.840.1.113730.3.8.6.5 NAME 'idnsTemplateObject' DESC 'Template object for dynamic DNS attribute generation' AUXILIARY MUST ( idnsTemplateAttribute ) X-ORIGIN 'IPA v4.4' )</span></code></p>
<p>IPA locations part, in cn=etc subtree:</p>
<p><code class="docutils literal notranslate"><span class="pre">attributeTypes: ( 2.16.840.1.113730.3.8.5.32 NAME 'ipaLocation' DESC 'Reference to IPA location' EQUALITY distinguishedNameMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.12 SINGLE-VALUE X-ORIGIN 'IPA v4.4' )</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">attributeTypes: ( 2.16.840.1.113730.3.8.5.33 NAME 'ipaLocationWeight' DESC 'Weight for the server in IPA location' EQUALITY integerMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.27 SINGLE-VALUE X-ORIGIN 'IPA v4.4' )</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">objectClasses: (  2.16.840.1.113730.3.8.6.7 NAME 'ipaLocationObject' DESC 'Object for storing IPA server location' STRUCTURAL MUST ( idnsName ) MAY ( description ) X-ORIGIN 'IPA v4.4' )</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">objectClasses: (  2.16.840.1.113730.3.8.6.8 NAME 'ipaLocationMember' DESC 'Member object of IPA location' AUXILIARY MAY ( ipaLocation $ ipaLocationWeight ) X-ORIGIN 'IPA v4.4' )</span></code></p>
</section>
<section id="locations-ldap-structure">
<span id="id17"></span><h3>Locations LDAP structure<a class="headerlink" href="#locations-ldap-structure" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DN: cn=locations, cn=etc, $SUFFIX</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectlcass: nsContainer</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">cn: locations</span></code></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DN: idnsName=prague, cn=locations, cn=etc, $SUFFIX</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectclass: ipaLocationObject</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">idnsName: prague</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">description: Servers in Prague area</span></code></div>
</div>
</section>
<section id="servers-ldap-structure">
<span id="id18"></span><h3>Servers LDAP structure<a class="headerlink" href="#servers-ldap-structure" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">DN: cn=ipa-server.example.com,cn=masters,cn=ipa,cn=etc, $SUFFIX</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectclass: top</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectclass: nsContainer</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectclass: ipaSupportedDomainLevelConfig</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectclass: ipaReplTopoManagedService</span></code></div>
<div class="line"><strong>``objectclass:````````ipaLocationMember``</strong></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">cn: ipa-server.example.com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipaMaxDomainLevel: 1</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipaMinDomainLevel: 0</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipaReplTopoManagedSuffix: o=ipaca</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipaReplTopoManagedSuffix: $SUFFIX</span></code></div>
<div class="line"><strong>``ipaLocation:````````idnsName=prague,cn=locations,cn=etc,$SUFFIX``</strong></div>
<div class="line"><strong>``ipaLocationWeight:````````100``</strong></div>
</div>
</section>
</section>
<section id="ipa-commands-affected-by-this-feature">
<span id="id19"></span><h2>IPA commands affected by this feature<a class="headerlink" href="#ipa-commands-affected-by-this-feature" title="Permalink to this heading">¶</a></h2>
<p>When following commands are executed, resulting of that commands might
result into a need to update location records</p>
<section id="server-del">
<span id="id20"></span><h3>server-del<a class="headerlink" href="#server-del" title="Permalink to this heading">¶</a></h3>
<p>system records should be updated</p>
</section>
<section id="server-mod">
<span id="id21"></span><h3>server-mod<a class="headerlink" href="#server-mod" title="Permalink to this heading">¶</a></h3>
<p>system records should be updated only if <em>location</em> or <em>weight</em> have
been changed</p>
</section>
<section id="ipa-replica-manage-del">
<span id="id22"></span><h3>ipa-replica-manage del<a class="headerlink" href="#ipa-replica-manage-del" title="Permalink to this heading">¶</a></h3>
<p>system records should be updated</p>
</section>
<section id="ipa-server-install">
<span id="id23"></span><h3>ipa-server-install<a class="headerlink" href="#ipa-server-install" title="Permalink to this heading">¶</a></h3>
<p>system records should be updated</p>
</section>
<section id="ipa-replica-install">
<span id="id24"></span><h3>ipa-replica-install<a class="headerlink" href="#ipa-replica-install" title="Permalink to this heading">¶</a></h3>
<p>system records should be updated</p>
</section>
<section id="location-add">
<span id="id25"></span><h3>location-add<a class="headerlink" href="#location-add" title="Permalink to this heading">¶</a></h3>
<p>TBD</p>
</section>
<section id="location-del">
<span id="id26"></span><h3>location-del<a class="headerlink" href="#location-del" title="Permalink to this heading">¶</a></h3>
<p>system records should be updated, unused location records should be
removed</p>
</section>
</section>
<section id="permissions-and-privileges">
<span id="id27"></span><h2>permissions and privileges<a class="headerlink" href="#permissions-and-privileges" title="Permalink to this heading">¶</a></h2>
<p><em>DNS Administrator</em> privilege must have read and write access to
locations</p>
<p><em>DNS Servers</em> privilege must have read access to new container in cn=DNS
subtree</p>
<section id="new-permissions">
<span id="id28"></span><h3>New permissions<a class="headerlink" href="#new-permissions" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>System: Read IPA Locations</strong>: allows to read locations in location
container</p></li>
<li><p><strong>System: Add IPA Locations</strong>: allows to add new locations into
locations container</p></li>
<li><p><strong>System: Remove IPA Locations</strong>: allows to remove location from
locations container</p></li>
<li><p><strong>System: Modify IPA Locations</strong>: allows to modify locations in
location container (just description)</p></li>
<li><p><strong>System: Read Locations of IPA Servers</strong>: allows to read assigned
location to server in masters container and weight attribute of
server</p></li>
<li><p><strong>System: Read Server Roles</strong>: allows to read which roles belong to
IPA servers (this is needed for proper generation of DNS SRV records)</p></li>
</ul>
</section>
</section>
</section>
<section id="upgrade">
<h1>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>bind-dyndb-ldap’s feature <a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/wiki/Design/PerServerConfigInLDAP">Per-server configuration in
LDAP</a>
describe which options from <code class="docutils literal notranslate"><span class="pre">named.conf</span></code> should be migrated to LDAP
tree during upgrade</p></li>
<li><p>For each upgraded server, <code class="docutils literal notranslate"><span class="pre">cn=DNS</span></code> entry in <code class="docutils literal notranslate"><span class="pre">cn=masters</span></code> should
be extended with <code class="docutils literal notranslate"><span class="pre">ipaConfigString</span></code> = <code class="docutils literal notranslate"><span class="pre">dnsLocationsVersion</span> <span class="pre">1</span></code>
which will make it easy to check if particular server supports
locations or not.</p></li>
</ul>
</section>
<section id="how-to-test">
<span id="how-to-test5"></span><h1>How to Test<a class="headerlink" href="#how-to-test" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Install at least two IPA DNS servers</p></li>
<li><p>Create at least two locations:</p></li>
</ul>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipa location-add loc1</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipa location-add loc2</span></code></div>
</div>
<ul class="simple">
<li><p>Assign one or more FreeIPA servers to each location</p></li>
<li><p>Assign first FreeIPA DNS server to one location (must have non-empty
set of servers)</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ipa server-mod server1.example --location=loc1</span></code></p>
<ul class="simple">
<li><p>Assign second FreeIPA DNS server to second location (must have
non-empty set of servers)</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ipa server-mod server2.example --location=loc2</span></code></p>
<ul class="simple">
<li><p>Query SRV records from the first FreeIPA DNS server:</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">$ dig &#64;$FIRST_IPA_DNS_SERVER _kerberos._udp.$PRIMARYDNSDOMAIN SRV</span></code></p>
<p>The answer must contain FreeIPA server assigned to first location with
higher priority (smaller number) and the second server must have lower
priority (higher number).</p>
</section>
<section id="test-plan">
<span id="test-plan5"></span><h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="V4/DNS_Location_Mechanism/Test_Plan">DNS Location Mechanism V4.4 test
plan</a></p>
</section>
<section id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h1>
<p>SRV Records: <a class="reference external" href="http://www.rfc-archive.org/getrfc.php?rfc=RFC2782">RFC
2782</a></p>
<p>DNAME Records: <a class="reference external" href="http://www.rfc-archive.org/getrfc.php?rfc=RFC6672">RFC
6672</a></p>
<hr class="docutils" />
<ol class="arabic simple">
<li><p>Some clients can be theoretically confused when ordinary query for
<code class="docutils literal notranslate"><span class="pre">_ldap._tcp</span></code> returns <code class="docutils literal notranslate"><span class="pre">CNAME</span></code> pointing to a location sub-tree.
<a class="reference external" href="#Compatibility_tests">#Compatibility_tests</a> suggest that this
should be rare.<a class="reference external" href="#fnref1">↩︎</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_location.$HOSTNAME</span></code> domain can contain only <code class="docutils literal notranslate"><span class="pre">SRV</span></code> records for
client’s realm. Consequently, clients which only query for
<code class="docutils literal notranslate"><span class="pre">_location.$HOSTNAME</span></code> does not have a way to find tailored <code class="docutils literal notranslate"><span class="pre">SRV</span></code>
records from other realms.<a class="reference external" href="#fnref3">↩︎</a></p></li>
<li><p>Clients from different realms will obtain tailored <code class="docutils literal notranslate"><span class="pre">SRV</span></code> records
from “nearest” DNS server. This was tested with Microsoft AD 2008 R2,
see
<a class="reference external" href="#Compatibility_tests">#Compatibility_tests</a>.<a class="reference external" href="#fnref4">↩︎</a></p></li>
<li><p>Per client approach requires some mechanism which creates <code class="docutils literal notranslate"><span class="pre">DNAME</span></code>
record for every new <code class="docutils literal notranslate"><span class="pre">A/AAAA</span></code> record created on the server. This
does not sound as an easy task with a general-purpose DNS
server.<a class="reference external" href="#fnref6">↩︎</a></p></li>
<li><p>General-purpose DNS server can be manually configured with <code class="docutils literal notranslate"><span class="pre">DNAME</span></code>
records for sub-trees. Alternativelly these records can be
dynamically updated by IPA framework.<a class="reference external" href="#fnref7">↩︎</a></p></li>
<li><p>General-purpose DNS server can be manually configured with <code class="docutils literal notranslate"><span class="pre">CNAME</span></code>
records for each service name. Alternativelly these records can be
dynamically updated by IPA framework.<a class="reference external" href="#fnref8">↩︎</a></p></li>
<li><p>2 DNAME records per zone<a class="reference external" href="#fnref9">↩︎</a></p></li>
<li><p>Each service name requires one CNAME<a class="reference external" href="#fnref10">↩︎</a></p></li>
</ol>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/DNS_Location_Mechanism.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>