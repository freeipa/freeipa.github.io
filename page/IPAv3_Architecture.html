
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IPAv3_Architecture &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/IPAv3_Architecture';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/page/IPAv3_Architecture.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>IPAv3_Architecture</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">IPAv3_Architecture</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipav3-goals">IPAv3 Goals</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#required-features-to-reach-the-goal">Required Features to reach the Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#required-components">Required Components</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipav3-layout">IPAv3 Layout</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-trust-relationships">Setting up trust relationships</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interactions">Interactions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#components">Components</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smbd">SMBD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#epmd">EPMD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#netlogon-lsa-samr">Netlogon/LSA/SAMR</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#netlogon">Netlogon</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lsa">LSA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#samr">SAMR</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#libndr-krb5">libndr_krb5</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-ad-trust-relationships-at-work">IPA - AD trust relationships at work</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ad-client-needs-services-from-ipa-server">AD client needs services from IPA server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-client-needs-services-from-ad-server">IPA client needs services from AD server</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-managed-server-and-ms-pac">IPA managed server and MS-PAC</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-managed-server-and-password-based-login">IPA managed server and Password based Login</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-a-name-for-a-sid">Finding a name for a SID</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="ipav3-architecture">
<h1>IPAv3_Architecture<a class="headerlink" href="#ipav3-architecture" title="Link to this heading">#</a></h1>
</section>
<section id="ipav3-goals">
<h1>IPAv3 Goals<a class="headerlink" href="#ipav3-goals" title="Link to this heading">#</a></h1>
<p>The IPA v3 goal is to be able to set up trust relationships with AD
Forests.</p>
<p>This will allow AD Admins to see IPA as a Resource Domain where all
Linux machines are handled by the Linux Admins.</p>
<p>Ad users will be able to freely access Linux (Unix) machines with their
AD credentials.</p>
<section id="required-features-to-reach-the-goal">
<h2>Required Features to reach the Goal<a class="headerlink" href="#required-features-to-reach-the-goal" title="Link to this heading">#</a></h2>
<p>In order to reach the stated goal, IPA needs to be able to interoperate
with Windows domain controllers of a Trusted Forest. For most operations
all is needed is access to the KDC. But to setup the actual trusts,
manage them and do some name resolution it is necessary to provide
Windows domain controllers with at least access to MS-RPC services. The
MS-RPC services needed are named NETLOGON, LSARPC and SAMR. These
services can be reached over the SMB (or SMB2) transport (port 445) and
directly over TCP/IP through the help of the EPM (End Point Mapper) RPC
service (port 135) that allows a remote server to discover on which
ports the services are listening. The LDAP port MUST be filtered, as our
LDAP schema and DIT are not compatible with what AD clients expect and
may confuse them.</p>
</section>
<section id="required-components">
<h2>Required Components<a class="headerlink" href="#required-components" title="Link to this heading">#</a></h2>
<p>MS-RPC services are implemented by Samba, as well as the EPM and SMBD
daemons. These services need to be made available both via the SMB/SMB2
protocols, that are handled via SMBD) and via TCP/IP by running
additional daemon(s) that can listen to ports above 1024. These services
need to be able to access the IPA database in order to access and
translate information in the format Windows Servers find suitable.</p>
<p>The KDC also needs to be able to handle some of the information Windows
clients/servers need, in form of an Authorization structure called
MS-PAC (Privileged Access Certificate) embedded in Kerberos Tickets.</p>
</section>
</section>
<section id="ipav3-layout">
<h1>IPAv3 Layout<a class="headerlink" href="#ipav3-layout" title="Link to this heading">#</a></h1>
<p>The following image shows a high level view of the principal components
we need to integrate/develop in order to achieve the goal.</p>
<figure class="align-default" id="id1">
<img alt="IPAv3-Layout.png" src="../_images/IPAv3-Layout.png" />
<figcaption>
<p><span class="caption-text">IPAv3-Layout.png</span><a class="headerlink" href="#id1" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>As you can see in this drawing there are 2 new components compared to a
v2 server. Samba components (in blue) are quite evident. But there is
also a new KDC related component called IPA-KDB. This is an IPA specific
DAL backend, and replaces the original MIT kldap DAL backend used in v2.</p>
</section>
<section id="setting-up-trust-relationships">
<h1>Setting up trust relationships<a class="headerlink" href="#setting-up-trust-relationships" title="Link to this heading">#</a></h1>
<p>As mentioned, MS-RPC services are necessary in order to setup a trust
relationship with an AD Forest. The MS-RPC services are also used to
perform some sid2name name2sid lookups and Netlogon related functions
for working trusts.</p>
<figure class="align-default" id="id2">
<img alt="IPAv3-LDAP-SAMBA.png" src="../_images/IPAv3-LDAP-SAMBA.png" />
<figcaption>
<p><span class="caption-text">IPAv3-LDAP-SAMBA.png</span><a class="headerlink" href="#id2" title="Link to this image">#</a></p>
</figcaption>
</figure>
<section id="interactions">
<h2>Interactions<a class="headerlink" href="#interactions" title="Link to this heading">#</a></h2>
<p>When a AD DC server needs to perform a MS-RPC operation against IPA, two
possible routes can be taken. It can try a direct TCP/IP connection (1)
against the service, possibly contacting the EPM Service (1.b) in
advance to know which ports the service is listening (the service
pre-registers (1.a) to the EPM so that the information is available
there). Alternatively the server can try to use SMB/SMB2 (2) to connect
to the server and open a named pipe (2.a) with the name of the service.</p>
<p>The authentication is performed using the DCE-Style GSSAPI-Krb5 method
or, as a fallback, NTLMSSP. The credentials used will depend on the
operation being performed. During the trust setup operation,
administrative credentials are used in order to establish a trust
secret. Generally for normal operations the trust secret is used. In
case Kerberos authentication is used, the PAC will contain the
credentials and is decoded by libndr_krb5 (4), otherwise the user will
be searched through IPASAM (3) on the LDAP server.</p>
<p>Once connected, the service will either request data or request
modification to the data. In all cases this will be performed through
the IPASAM backend (3) which contains the code used to properly
format/fetch (3.a) data from the LDAP server. The RPC Service is
responsible for performing authorization checks and permit/deny the
requested operation.</p>
</section>
<section id="components">
<h2>Components<a class="headerlink" href="#components" title="Link to this heading">#</a></h2>
<p>In the picture we can see 5 major components of Samba we are currently
interested in:</p>
<ul class="simple">
<li><p>SMBD</p></li>
<li><p>EPMD</p></li>
<li><p>The Netlogon/LSA/SAMR daemon(s)</p></li>
<li><p>IPASAM</p></li>
<li><p>libndr_krb5</p></li>
</ul>
</section>
<section id="smbd">
<h2>SMBD<a class="headerlink" href="#smbd" title="Link to this heading">#</a></h2>
<p>The SMBD daemon is useful basically only as a transport for MS-RPC over
named pipes. The default configuration should be limited to exposing
named pipes only, and possibly it should disable all named pipes that
are not necessary for setting up the trust relationships and serving the
data necessary to keep them working.</p>
</section>
<section id="epmd">
<h2>EPMD<a class="headerlink" href="#epmd" title="Link to this heading">#</a></h2>
<p>The EPM Daemon is a very tiny and simple yet fundamental daemon that
allow Windows machines to connect directly to MS-RPC Services over
TCP/IP. This will be either a separate binary or a process forked out by
SMBD at startup.</p>
</section>
<section id="netlogon-lsa-samr">
<h2>Netlogon/LSA/SAMR<a class="headerlink" href="#netlogon-lsa-samr" title="Link to this heading">#</a></h2>
<p>This is the core component of Samba that allows IPA to be configured as
a trusted Forest by Windows. The implementation may comprise separate
daemons or a set of process forked by SMBD at startup. These services
will work in concert to provide access to information and set
information in the LDAP directory through the IPASAM interface. The LDAP
directory is responsible for storing all the long term data. … These 3
services provide the following functionality:</p>
<section id="netlogon">
<h3>Netlogon<a class="headerlink" href="#netlogon" title="Link to this heading">#</a></h3>
<p>The Netlogon service deals with Secure Channel setup, pass-through
authentication and domain trusts related functions among other things.</p>
<p>This service is use both at trust set up time and during normal usage to
handle authentication related operations.</p>
</section>
<section id="lsa">
<h3>LSA<a class="headerlink" href="#lsa" title="Link to this heading">#</a></h3>
<p>This is the most important interface for setting up trusts and managing
trusts information. At the same time it also implements methods to
perform name translation services like name2sid, sid2name and others. So
it will be used both for setup operations and as day to day translation
of SIDs and names.</p>
</section>
<section id="samr">
<h3>SAMR<a class="headerlink" href="#samr" title="Link to this heading">#</a></h3>
<p>The SAMR (System Account Management RPC) service handles user group and
domain data (query, add, remove, modify of accounts). This interface is
generally exposed together with the LSA interface and complements it in
some places.</p>
</section>
</section>
<section id="libndr-krb5">
<h2>libndr_krb5<a class="headerlink" href="#libndr-krb5" title="Link to this heading">#</a></h2>
<p>… Finally the libndr_krb5 library provides the means for packing and
unpacking authorization structures used by Windows, including the MS-PAC
structure embedded in Kerberos Tickets.</p>
</section>
</section>
<section id="ipa-ad-trust-relationships-at-work">
<h1>IPA - AD trust relationships at work<a class="headerlink" href="#ipa-ad-trust-relationships-at-work" title="Link to this heading">#</a></h1>
<p>During normal operations the most important piece, in order to allow
authentication and SSO is the Kerberos infrastructure. It is especially
important for trust relationships as kerberos is used not only to
perform authentication but also to convey authorization data via the
MS-PAC.</p>
<figure class="align-default" id="id3">
<img alt="IPAv3-KDC-AD-trusts.png" src="../_images/IPAv3-KDC-AD-trusts.png" />
<figcaption>
<p><span class="caption-text">IPAv3-KDC-AD-trusts.png</span><a class="headerlink" href="#id3" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>The picture summarizes the set of operations involving the IPA and AD
KDCs from the perspective of both Windows and IPA clients and servers.
It is assumed that a trust relationship is already in place. It is also
assumed the clients already have a valid TGT.</p>
<section id="ad-client-needs-services-from-ipa-server">
<h2>AD client needs services from IPA server<a class="headerlink" href="#ad-client-needs-services-from-ipa-server" title="Link to this heading">#</a></h2>
<p>The AD client performs a TGS Request for the service to the AD KDC
(a.1), the KDC recognizes that the service belongs to a trusted domain
and send sback to the client a cross-realm TGT and a referral to go ask
the trusted KDC.</p>
<p>The AD client uses the cross-realm TGT to request a ticket to the IPA
KDC (a.2).</p>
<p>At this point the IPA KDC needs to validate the MS-PAC being transmitted
with the cross-realm TGT. The IPA-KDB may, optionally, check the LDAP
directory (c.1) to see if foreign principals are allowed to get tickets
for the requested service. The IPA-KDB plugin then decodes the MS-PAC
using the libndr_krb5 library (c.2) and verify and eventually filters
the data. It perform lookups (c.1) in the LDAP server to check if it
needs to augment the MS-PAC with additional information (local groups
for example), then uses the libndr_krb5 library (c.2) to encoded the PAC
again, sign it and send it back attached to the service ticket.</p>
<p>The AD client can now contact the IPA service (a.3).</p>
</section>
<section id="ipa-client-needs-services-from-ad-server">
<h2>IPA client needs services from AD server<a class="headerlink" href="#ipa-client-needs-services-from-ad-server" title="Link to this heading">#</a></h2>
<p>The IPA client performs a TGT Request for the service it wants to
contact to the IPA KDC (b.1). The KDC recognizes the service belongs to
another realm, checks the realm is known and trusted, and, eventually,
that the client is allowed to request services from foreign realms.</p>
<p>The KDC checks if the client’s TGT has a MS-PAC attached to it. If it
doesn’t (or it contains a PAD instead) the KDC does a lookup in the
directory (c.1) to get the principal data. With this data (or using the
data from the PAD) it creates a MS-PAC and encodes it using libndr_krb5
(c.2). Then the KDC sends back a cross-realm TGT to the IPA client.</p>
<p>The IPA client contacts the AD KDC (b.2) to request a ticket for the AD
service, presenting the cross-realm TGT containing the MS-PAC provided
by the IPA KDC.</p>
<p>The AD server validates and filters the PAC and returns a ticket for the
AD server.</p>
<p>The IPA client can now contact the Ad service (b.3).</p>
</section>
</section>
<section id="ipa-managed-server-and-ms-pac">
<h1>IPA managed server and MS-PAC<a class="headerlink" href="#ipa-managed-server-and-ms-pac" title="Link to this heading">#</a></h1>
<p>In a domain with AD trusts an IPA managed servers need to handle
identity/authorization data conveyed in the form of a MS-PAC structure.</p>
<figure class="align-default" id="id4">
<img alt="IPAv3-MS-PAC-Login.png" src="../_images/IPAv3-MS-PAC-Login.png" />
<figcaption>
<p><span class="caption-text">IPAv3-MS-PAC-Login.png</span><a class="headerlink" href="#id4" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>When a client connects (1) to the server and uses GSSAPI-Krb5 to
authenticate it can provide a MS-PAC structure with the service ticket
it presents to the login application. This application is linked (2)
against the libgssapi library which can extract the MS-PAC data and
pass it (3) to SSSD through a local Unix socket or equivalent mechanism.
The SSSD validates the MS-PAC data by checking signatures and then
use libndr_krb5 (4) to decode the MS-PAC. Once the MS-PAC is decoded,
SSSD will update the cache with the information contained so that
following getent requests can be properly fulfilled.</p>
<p>If the user space application requires more information than is
available in the PAC (for example various group names) then SSSD may
contact (5) the IPA Identity Server to get the information it
needs. The IPA server may need eventually to contact the AD Domain
to resolve Names to SIDs or SIDs to Name to reply to the client’s
request. IPA will use a LSARPC call, eventually on a Secure Channel, to
contact (6) the AD domain controller and perform queries.</p>
<p>NOTE: In many cases the IPA KDC will have filtered all foreign groups
from the MS-PAC and augmented it with local groups, so that this last
step is rarely necessary.</p>
<p>The method to be used is not completely finalised yet. One option
assumes libgssapi will be modified to use a mechglue-proxy so that SSSD
does the actual acceptor exchange and gives back the application only
the session keys. Another option assumes that we have to trust all
applications that have access to kerberos keys and the only thing being
passed to SSSD is the actual MS-PAC. A third option is about not
trusting applications but still only getting the MS-PAC blob, this means
SSSD will need to validate the MS-PAC by asking one of the IPA KDCs to
verify the KDC signature.</p>
<p>An Ms-PAC contains only SIDs to represent group memberships, SSSD
will be able to translate SIDs directly into GIDs, but will not have
direct access to the group names (unless these groups have been
previously cached). In this case only the initgroups() call can be
successfully replied to w/o additional name resolution work.</p>
<p>The protocol that will be used to resolve “foreign” users and
groups from SSSD is not yet defined. It may involve using LSARPC calls
against the IPA’s Samba instance, or perhaps a special LDAP extended
operation. This protocol will be better defined later on and this page
will be corrected to reflect the decision.</p>
</section>
<section id="ipa-managed-server-and-password-based-login">
<h1>IPA managed server and Password based Login<a class="headerlink" href="#ipa-managed-server-and-password-based-login" title="Link to this heading">#</a></h1>
<p>In a domain with AD trusts an IPA managed servers need to handle
password based authentication too.</p>
<figure class="align-default" id="id5">
<img alt="IPAv3-Password-Login.png" src="../_images/IPAv3-Password-Login.png" />
<figcaption>
<p><span class="caption-text">IPAv3-Password-Login.png</span><a class="headerlink" href="#id5" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>In this case a client wishes to connect (1) but the protocol being used
or other reasons (no kerberos support on client, etc..) requires the
Login application to accept a user/password pair. In this case during
(1) User names will have to be fully qualified. If the AD domain name is
ad.example.com with a short name of AD, Ideally we will accept at least
the 2 following forms for a username:</p>
<ul class="simple">
<li><p>ADusername</p></li>
<li><p><a class="reference external" href="mailto:username&#37;&#52;&#48;ad&#46;example&#46;com">username<span>&#64;</span>ad<span>&#46;</span>example<span>&#46;</span>com</a></p></li>
</ul>
<p>These 2 forms allow SSSD to understand that we are trying to log into
the system as a user from a specific domain (as opposed to the default
which is IPA’s). SSSD will query IPA (3) or used cached knowledge to
check if this domain is known and trusted and to get back indication on
how to reach the other domain KDC. Then SSSD proceeds (4) to contact the
AD KDC to ask for a TGT for the user using the user’s password as the
shared secret.</p>
<p>AD will reply back with a TGT containing the MS-PAC. At this point SSSD
will perform validation by first asking the AD server (5) for a
cross-realm TGT for the IPA domain and then using this TGT to get a
host/ ticket (6) against itself. At this point he IPA KDC will perform
the usual filtering and signing of the MS-PAC (*) and attach it to the
service ticket for the host.</p>
<p>Once the service ticket is obtained SSSD can validate that the user’s
TGT is correct, and can check the signatures on the MS-PAC sent back by
the IPA KDC, and can decode (7) it. The resulting structure is used to
populate SSSD caches and authentication and operations proceed in the
same way as in the previous scenario.</p>
<p>(*) In a not too distant future, the IPA KDC may even decide to
translate the MS-PAC into a PAD (Principal Authorization Data) which is
similar but contains information in a way that is more complete for
Posix machines. We are currently working on a draft proposal within IETF
to have the PAD standardized so that we can soon start to use it in IPA.</p>
</section>
<section id="finding-a-name-for-a-sid">
<h1>Finding a name for a SID<a class="headerlink" href="#finding-a-name-for-a-sid" title="Link to this heading">#</a></h1>
<p>For groups memberships the PAC only contains SIDs and no groups names.
In order to use group name for access control or other kind of
permission checking the SIDs have to be resolved to groups names. This
can either be a name of a group of the IPA domain which has a mapping to
a SID or the name of a group in the AD domain.</p>
<figure class="align-default" id="id6">
<img alt="IPAv3-Sid-2-Name.png" src="../_images/IPAv3-Sid-2-Name.png" />
<figcaption>
<p><span class="caption-text">IPAv3-Sid-2-Name.png</span><a class="headerlink" href="#id6" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>Once the Kerberos ticket is received, e.g. via a GSSAPI login (1), the
PAC is extracted (2) and send to SSSD (3). SSSD splits the PAC into its
components (4). If SSSD cannot find the name of a group related to a SID
in its local cache it uses an LDAP extended operation (5) to ask the IPA
server to return the names of group objects given by a list of SIDs.</p>
<p>For every SID in the list the IPA server will first check if a mapping
to a local group is available (6) or if the SID can be found in a cache
(7). If there are still unresolved SIDs the IPA server will open a RPC
connection to a domain controller of the AD domain with the help of the
trust credentials and sends a request to resolve the SIDs to names (8).
This RPC call is preferably done directly from the extended operation
plugin of the directory server. But if it is easier an external program
like rpcclient or winbind can be used for a first step. The returned
names are stored together with the corresponding SID in the cache and
returned to the client.</p>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">IPAv3_Architecture</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipav3-goals">IPAv3 Goals</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#required-features-to-reach-the-goal">Required Features to reach the Goal</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#required-components">Required Components</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipav3-layout">IPAv3 Layout</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-trust-relationships">Setting up trust relationships</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interactions">Interactions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#components">Components</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#smbd">SMBD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#epmd">EPMD</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#netlogon-lsa-samr">Netlogon/LSA/SAMR</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#netlogon">Netlogon</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lsa">LSA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#samr">SAMR</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#libndr-krb5">libndr_krb5</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-ad-trust-relationships-at-work">IPA - AD trust relationships at work</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ad-client-needs-services-from-ipa-server">AD client needs services from IPA server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-client-needs-services-from-ad-server">IPA client needs services from AD server</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-managed-server-and-ms-pac">IPA managed server and MS-PAC</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-managed-server-and-password-based-login">IPA managed server and Password based Login</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-a-name-for-a-sid">Finding a name for a SID</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>