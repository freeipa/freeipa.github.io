<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Overview" href="Samba_4_Schema_Mapping.html" />
    <link rel="prev" title="Overview" href="Samba_4_Replication.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>A security identifier (SID) is a unique value of variable length that is
used to identify a security principal or security group in Active
Directory/Samba. Each domain has an SID which is generated during setup.
Each user/group has an SID which is generated when the user/group is
created. The user/group SID is created by concatenating the domain SID
with a relative identifier (RID).</p>
<p>A domain may contain multiple domain controllers (DC). To guarantee
uniqueness across the entire domain, the RID must be obtained from an
integer pool which is maintained by the DC where the user/group is being
created.</p>
<p>Active Directory uses an RID Manager which resides on the master DC. The
RID Manager is responsible for distributing non-overlapping RID pools to
the DC’s. When a DC is running out of entries in its pool, it will
request for a new pool from the RID Manager.</p>
<p>Currently Samba doesn’t have such RID Manager. Basically each Samba
instances has a large pool but the range overlaps with other pools in
other instances, meaning that SID conflicts can occur.</p>
<p>One solution is to implement an RID Manager similar to Active Directory,
but this could take some time.</p>
<p>A faster solution is using the DNA plugin in Fedora DS to generate
unique SID’s across DS instances. Unlike RID Manager, the DNA plugin
doesn’t rely on a single master server.</p>
</section>
<section id="sid-formats">
<span id="id1"></span><h1>SID Formats<a class="headerlink" href="#sid-formats" title="Permalink to this heading">¶</a></h1>
<p>SID has both binary and string (human readable) formats. SID is stored
in the directory in its binary format (i.e. objectSid attribute) but
should be displayed in UI in its string format.</p>
<p>SID binary format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">revision</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">sub</span><span class="o">-</span><span class="n">authority</span> <span class="n">count</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">identifier</span> <span class="n">authority</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">sub</span><span class="o">-</span><span class="n">authority</span><span class="o">&gt;*</span>
</pre></div>
</div>
<ul class="simple">
<li><p>revision: 1 byte</p></li>
<li><p>sub-authority count: 1 byte</p></li>
<li><p>identifier authority: 6 bytes (big-endian)</p></li>
<li><p>sub-authority: 4 bytes (little-endian)</p></li>
</ul>
<p>SID string format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">S</span> <span class="o">-</span> <span class="o">&lt;</span><span class="n">revision</span><span class="o">&gt;</span> <span class="o">-</span> <span class="o">&lt;</span><span class="n">identifier</span> <span class="n">authority</span><span class="o">&gt;</span> <span class="p">[</span> <span class="o">-</span> <span class="o">&lt;</span><span class="n">sub</span><span class="o">-</span><span class="n">authority</span><span class="o">&gt;</span> <span class="p">]</span><span class="o">*</span>
</pre></div>
</div>
<ul class="simple">
<li><p>revision: decimal</p></li>
<li><p>identifier authority: decimal</p></li>
<li><p>sub-authority: decimal</p></li>
</ul>
<p>Consider the following domain SID in binaries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">01</span> <span class="mi">04</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">05</span> <span class="mi">15</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">01</span> <span class="n">d2</span> <span class="n">f9</span> <span class="mi">89</span> <span class="n">aa</span> <span class="mi">27</span> <span class="n">ba</span> <span class="n">fc</span> <span class="n">d8</span> <span class="n">a2</span> <span class="mi">6</span><span class="n">c</span> <span class="n">ff</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Revision: 01 = 1</div>
<div class="line">Sub-authority count: 04 = 4</div>
<div class="line">Identifier authority: 00 00 00 00 00 05 = 000000000005 = 5</div>
<div class="line">1st sub-authority: 15 00 00 00 = 00000015 = 21</div>
<div class="line">2nd sub-authority: 01 d2 f9 89 = 89f9d201 = 2314850817</div>
<div class="line">3rd sub-authority: aa 27 ba fc = fcba27aa = 4240058282</div>
<div class="line">4th sub-authority: d8 a2 6c ff = ff6ca2d8 = 4285309656</div>
<div class="line">The string representation of the domain SID is:</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">2314850817</span><span class="o">-</span><span class="mi">4240058282</span><span class="o">-</span><span class="mi">4285309656</span>
</pre></div>
</div>
<p>The following user SID is generated by adding an RID (e.g. 1158) to the
above domain SID:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">01</span> <span class="mi">05</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">05</span> <span class="mi">15</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">01</span> <span class="n">d2</span> <span class="n">f9</span> <span class="mi">89</span> <span class="n">aa</span> <span class="mi">27</span> <span class="n">ba</span> <span class="n">fc</span> <span class="n">d8</span> <span class="n">a2</span> <span class="mi">6</span><span class="n">c</span> <span class="n">ff</span> <span class="mi">86</span> <span class="mi">04</span> <span class="mi">00</span> <span class="mi">00</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Notice that the sub-authority count is now 5.</div>
<div class="line">5th sub-authority: 86 04 00 00 = 00000486 = 1158</div>
<div class="line">The string representation of the user SID is:</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">2314850817</span><span class="o">-</span><span class="mi">4240058282</span><span class="o">-</span><span class="mi">4285309656</span><span class="o">-</span><span class="mi">1158</span>
</pre></div>
</div>
</section>
<section id="dna-plugin">
<span id="id2"></span><h1>DNA Plugin<a class="headerlink" href="#dna-plugin" title="Permalink to this heading">¶</a></h1>
<p>DNA plugin provides a way to generate integer values that are unique
across DS instances. These values are called managed values. A prefix
can be specified so that it will be prepended to all managed values.</p>
<p>The DNA plugin can be used to generate SID values by splitting the SID
in two parts:</p>
<ul class="simple">
<li><p>prefix: domain SID (e.g. S-1-5-21-2314850817-4240058282-4285309656)</p></li>
<li><p>managed value: RID (e.g. 1158)</p></li>
</ul>
<p>When a new user is added into the DS, the plugin will automatically
assign a full SID value which consists of the domain SID and the RID.</p>
</section>
<section id="current-code">
<span id="id3"></span><h1>Current Code<a class="headerlink" href="#current-code" title="Permalink to this heading">¶</a></h1>
<section id="sam-ldb-module">
<span id="id4"></span><h2>SAM LDB Module<a class="headerlink" href="#sam-ldb-module" title="Permalink to this heading">¶</a></h2>
<p>Currently the SAM LDB module generates SID values for new users. The
code is located in source4/dsdb/samdb/ldb_modules/samldb.c:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>static int samldb_fill_object(struct samldb_ctx *ac, const char *type)
{
    // check entry SID
    ac-&gt;sid = samdb_result_dom_sid(ac, ac-&gt;msg, &quot;objectSid&quot;);

    if ( ! ac-&gt;sid) { // no entry SID specified

        // generate entry SID from domain SID and (next RID + 1)
        samldb_add_step(ac, samldb_new_sid);

    } else { // new entry contains SID

        // find domain object and next RID based on entry SID
        samldb_add_step(ac, samldb_get_sid_domain);
    }

    // increment next RID in the domain object
    samldb_add_step(ac, samldb_notice_sid);
}
</pre></div>
</div>
</section>
</section>
<section id="proposed-changes">
<span id="id5"></span><h1>Proposed Changes<a class="headerlink" href="#proposed-changes" title="Permalink to this heading">¶</a></h1>
<section id="samba-configuration">
<span id="id6"></span><h2>Samba Configuration<a class="headerlink" href="#samba-configuration" title="Permalink to this heading">¶</a></h2>
<p>A new parameter should be added into smb.conf to control how the SID
will be generated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="nb">globals</span><span class="p">]</span>
    <span class="n">sid</span> <span class="n">generator</span> <span class="o">=</span> <span class="n">backend</span>
</pre></div>
</div>
<p>Valid values:</p>
<ul class="simple">
<li><p>internal: Samba will generate the SID and add it to the backend</p></li>
<li><p>backend: Backend will generate the SID</p></li>
</ul>
<p>If the paramater is not specified, the default value should be
“internal”.</p>
<p>The parameter should be defined in source4/param/loadparm.c:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">enum</span> <span class="n">sid_generator</span> <span class="p">{</span>
    <span class="n">SID_GENERATOR_INTERNAL</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">SID_GENERATOR_BACKEND</span><span class="o">=</span><span class="mi">1</span>
<span class="p">};</span>

<span class="n">struct</span> <span class="n">loadparm_global</span>
<span class="p">{</span>
    <span class="n">enum</span> <span class="n">sid_generator</span> <span class="n">sid_generator</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">const</span> <span class="n">struct</span> <span class="n">enum_list</span> <span class="n">enum_sid_generator</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="n">SID_GENERATOR_INTERNAL</span><span class="p">,</span> <span class="s2">&quot;internal&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="n">SID_GENERATOR_BACKEND</span><span class="p">,</span> <span class="s2">&quot;backend&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">static</span> <span class="n">struct</span> <span class="n">parm_struct</span> <span class="n">parm_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span><span class="s2">&quot;sid generator&quot;</span><span class="p">,</span> <span class="n">P_ENUM</span><span class="p">,</span> <span class="n">P_GLOBAL</span><span class="p">,</span> <span class="n">GLOBAL_VAR</span><span class="p">(</span><span class="n">sid_generator</span><span class="p">),</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">enum_sid_generator</span><span class="p">},</span>

<span class="n">_PUBLIC_</span> <span class="n">FN_GLOBAL_INTEGER</span><span class="p">(</span><span class="n">lp_sid_generator</span><span class="p">,</span> <span class="n">sid_generator</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="sam-ldb-module-1">
<span id="id7"></span><h2>SAM LDB Module<a class="headerlink" href="#sam-ldb-module-1" title="Permalink to this heading">¶</a></h2>
<p>The module should generate the SID values only when the “sid generator”
parameter is set to “internal”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>static int samldb_fill_object(struct samldb_ctx *ac, const char *type)
{
    sid_generator = lp_sid_generator(lp_ctx);
    if (sid_generator == SID_GENERATOR_INTERNAL) {

        // check entry SID
        ac-&gt;sid = samdb_result_dom_sid(ac, ac-&gt;msg, &quot;objectSid&quot;);

        if ( ! ac-&gt;sid) { // no entry SID specified

            // generate entry SID from domain SID and (next RID + 1)
            samldb_add_step(ac, samldb_new_sid);

        } else { // new entry contains SID

            // find domain object and next RID based on entry SID
            samldb_add_step(ac, samldb_get_sid_domain);
        }

        // increment next RID in the domain object
        samldb_add_step(ac, samldb_notice_sid);
    }
}
</pre></div>
</div>
</section>
<section id="provisioning-tool">
<span id="id8"></span><h2>Provisioning Tool<a class="headerlink" href="#provisioning-tool" title="Permalink to this heading">¶</a></h2>
<p>The provisioning tool should generate the following configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dn: cn=Samba SIDs,cn=Distributed Numeric Assignment Plugin,cn=plugins,cn=config
objectClass: top
objectClass: extensibleObject
cn: Samba SIDs
dnaType: sambaSID
dnaMaxValue: 10000
dnaMagicRegen: 0
dnaFilter: (|(objectClass=user)(objectClass=group))
dnaScope: ${DOMAINDN}
dnaNextValue: 1000
dnaSharedCfgDn: cn=Samba SIDs,ou=Ranges,${SAMBADN}
dnaPrefix: ${DOMAINSID}-
</pre></div>
</div>
<p>The plugin should be enabled:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">Distributed</span> <span class="n">Numeric</span> <span class="n">Assignment</span> <span class="n">Plugin</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span>
<span class="n">nsslapd</span><span class="o">-</span><span class="n">pluginEnabled</span><span class="p">:</span> <span class="n">on</span>
</pre></div>
</div>
<p>The provisioning tool should also add a container entry for sharing SID
ranges among multiple DS instances.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dn: ou=Ranges,${SAMBADN}
objectClass: top
objectClass: organizationalUnit
ou: Ranges

dn: ou=Ranges,${SAMBADN}
dn: cn=Samba SIDs,ou=Ranges,${SAMBADN}
objectClass: top
objectClass: nsContainer
cn: Object SIDs
</pre></div>
</div>
</section>
</section>
<section id="issues">
<h1>Issues<a class="headerlink" href="#issues" title="Permalink to this heading">¶</a></h1>
<p>Samba currently stores the SID in DS in its binary format. However, the
DNA plugin currently only supports generating integer and string
attributes. The options are:</p>
<ul class="simple">
<li><p><a class="reference external" href="Obsolete:DS_Binary_Support_in_DNA_Plugin">Adding binary support in DNA
plugin</a></p></li>
<li><p><a class="reference external" href="Obsolete:Samba_4_Storing_SID_in_String_Format">Modifying Samba to store SID in its string
format</a></p></li>
</ul>
</section>
<section id="patches">
<h1>Patches<a class="headerlink" href="#patches" title="Permalink to this heading">¶</a></h1>
<p>The following patch has been applied to the source repository:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://gitweb.samba.org/?p=samba.git;a=commit;h=e035433bab87cb5f2f12def900e194da877e6925">s4 - SID allocation using 389 DS DNA
plugin</a></p></li>
</ul>
</section>
<section id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="http://support.microsoft.com/kb/243330">Well-known security identifiers in Windows operating
systems</a></p></li>
<li><p><a class="reference external" href="http://support.microsoft.com/kb/305475">Description of RID Attributes in Active
Directory</a></p></li>
<li><p><a class="reference external" href="http://support.microsoft.com/kb/316201">“Domain controller has failed to obtain a new identifier pool” error
event in Windows 2000 Server SP3 and
earlier</a></p></li>
<li><p><a class="reference external" href="http://directory.fedoraproject.org/wiki/DNA_Plugin">DNA Plugin</a></p></li>
<li><p>[<a class="reference external" href="http://technet.microsoft.com/en-us/library/cc779144(WS.10).aspx">http://technet.microsoft.com/en-us/library/cc779144(WS.10).aspx</a> How
Security Principals Work]</p></li>
</ul>
<p><a class="reference external" href="Category:Obsolete">Category:Obsolete</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/archive/pages/Samba_4_SID_Allocation_using_DNA_Plugin.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>