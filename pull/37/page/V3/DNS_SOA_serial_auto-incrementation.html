
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>DNS_SOA_serial_auto-incrementation &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V3/DNS_SOA_serial_auto-incrementation';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V3/DNS_SOA_serial_auto-incrementation.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>DNS_SOA_serial_auto-incrementation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">DNS_SOA_serial_auto-incrementation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#structure-of-dns-sub-tree-in-ldap">Structure of DNS sub-tree in LDAP</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#design-in-ipa-3-0">Design in IPA 3.0</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advantages">Advantages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#disadvantages">Disadvantages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#very-basic-implementation">Very basic implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-found-after-implementation-to-ipa-3-0">Problems found after implementation to IPA 3.0</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-managment">Feature Managment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#major-configuration-options-and-enablement">Major configuration options and enablement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replication">Replication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#updates-and-upgrades">Updates and Upgrades</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencies">Dependencies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#external-impact">External Impact</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#design-in-ipa-3-1">Design in IPA 3.1</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-idea">Basic idea</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#soa-serial-incrementation-algorithm">SOA serial incrementation algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interaction-with-bind-serial-update-mechanism">Interaction with BIND serial update mechanism</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#possible-optimization">Possible optimization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variant-with-delayed-serial-write">Variant with delayed serial write</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variant-with-modified-search-operation">Variant with modified search operation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Replication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Updates and Upgrades</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Dependencies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">External Impact</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#impact-on-testing">Impact on testing</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="dns-soa-serial-auto-incrementation">
<h1>DNS_SOA_serial_auto-incrementation<a class="headerlink" href="#dns-soa-serial-auto-incrementation" title="Link to this heading">#</a></h1>
</section>
<section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h1>
<p><em>Short overview of the problem set and any back ground material or
references one would need to understand the details.</em></p>
<p>Each DNS zone has <em>serial number</em>, i.e. version number of the zone. Nice
explanation can be found e.g. in <a class="reference external" href="http://www.zytrax.com/books/dns/ch8/soa.html">Zytrax book about DNS, chapter
8</a>.</p>
<p>Quotations from <a class="reference external" href="http://www.zytrax.com/books/dns/">Zytrax DNS book</a>:</p>
<blockquote>
<div><p>sn = serial number</p>
<p>This value MUST increment when any resource record in the zone file
is updated.</p>
<p>A slave (Secondary) DNS server will read the master DNS SOA record
periodically, either on expiry of refresh (defined below) or when it
receives a NOTIFY and compares arithmetically its current value of sn
with that received from the master DNS. If the sn value from the
master is arithmetically HIGHER than that currently stored by the
slave then a zone transfer (AXFR/IXFR) is initiated. If the value of
sn from the master DNS SOA is the same or LOWER then no zone transfer
is initiated.</p>
</div></blockquote>
<blockquote>
<div><p>Note: the arithmetic used by the serial number is defined in <a class="reference external" href="http://tools.ietf.org/html/rfc1982">RFC
1982</a>.</p>
</div></blockquote>
<section id="structure-of-dns-sub-tree-in-ldap">
<h2>Structure of DNS sub-tree in LDAP<a class="headerlink" href="#structure-of-dns-sub-tree-in-ldap" title="Link to this heading">#</a></h2>
<p>Please get familiar with <a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/wiki/DatabaseStructure">the way how DNS data are stored in
LDAP</a>.</p>
</section>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h1>
<p>Correct serial number is a requirement for functional zone tranfers.
Corrent zone transfers from IPA to non-IPA DNS server are impossible if
zone serial number is not incremented after each change.</p>
</section>
<section id="design-in-ipa-3-0">
<h1>Design in IPA 3.0<a class="headerlink" href="#design-in-ipa-3-0" title="Link to this heading">#</a></h1>
<p>Design was discussed on freeipa-devel mailing list: At the beginning (in
<a class="reference external" href="http://www.redhat.com/archives/freeipa-devel/2012-April/msg00222.html">e-mail thread from April
2012</a>)
various options were discussed. Maintaining single global SOA serial for
all servers was found as hard problem. Attributes like
<code class="docutils literal notranslate"><span class="pre">modifyTimestamp</span></code> can’t be used because they can go back in time
(because of replication).</p>
<p><a class="reference external" href="http://www.redhat.com/archives/freeipa-devel/2012-May/msg00047.html">In May
2012</a>
different approach was proposed: Maintain SOA serial separately for each
IPA server and do not synchronize serials between IPA servers at all.</p>
<p>This design is significantly simpler and was implemented in IPA 3.0.</p>
<section id="advantages">
<h2>Advantages<a class="headerlink" href="#advantages" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>It is relatively simple to implement.</p></li>
<li><p>No DS plugin is required, all the logic is part of bind-dyndb-ldap
plugin for BIND.</p></li>
</ul>
</section>
<section id="disadvantages">
<h2>Disadvantages<a class="headerlink" href="#disadvantages" title="Link to this heading">#</a></h2>
<p>Slave DNS servers cannot fall-back to other masters, because of SOA
serial inconsistency.</p>
</section>
<section id="very-basic-implementation">
<h2>Very basic implementation<a class="headerlink" href="#very-basic-implementation" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Do not replicate <code class="docutils literal notranslate"><span class="pre">idnsSOASerial</span></code> attribute between IPA servers: Use
<a class="reference external" href="https://access.redhat.com/knowledge/docs/en-US/Red_Hat_Directory_Server/9.0/html/Administration_Guide/fractional-repl-total.html">nsDS5ReplicatedAttributeList</a>
attribute to exclude <code class="docutils literal notranslate"><span class="pre">idnsSOASerial</span></code> from replication.</p></li>
<li><p>Use persistent search to watch for incoming changes.</p></li>
<li><p>After each change increment “local” SOA serial number (and write it
to LDAP - to survive DNS server restart).</p></li>
<li><p>Always increment stored SOA serial number after DNS server start.
Data in LDAP could be changed when bind-dyndb-ldap didn’t listen on
persistent search.</p></li>
</ol>
<p>Implementation was done in the scope of <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/2554">IPA ticket
#2554</a> and
<a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/ticket/67">bind-dyndb-ldap ticket
#67</a>.</p>
</section>
<section id="problems-found-after-implementation-to-ipa-3-0">
<h2>Problems found after implementation to IPA 3.0<a class="headerlink" href="#problems-found-after-implementation-to-ipa-3-0" title="Link to this heading">#</a></h2>
<p>Problem described in following text appears only in environments with at
least one IPA replica.</p>
<p>IPA command stores newly added zone to one chosen LDAP server, including
some initial value of <code class="docutils literal notranslate"><span class="pre">idnsSOAserial</span></code> attribute. The new zone is
replicated to other LDAP servers, except <code class="docutils literal notranslate"><span class="pre">idnsSOAserial</span></code> attribute.
This behaviour creates an inconsistent state, where mandatory attribute
<code class="docutils literal notranslate"><span class="pre">idnsSOAserial</span></code> is not present in some LDAP databases.</p>
<p>IPA tools and bind-dyndb-ldap are not ready for state where mandatory
<code class="docutils literal notranslate"><span class="pre">idnsSOAserial</span></code> attribute is missing.</p>
<ul class="simple">
<li><p>bind-dyndb-ldap: <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=895083">Red Hat bug
895083</a>,
<a class="reference external" href="https://fedorahosted.org/bind-dyndb-ldap/ticket/103">bind-dyndb-ldap ticket
#103</a>,
<a class="reference external" href="http://git.fedorahosted.org/cgit/bind-dyndb-ldap.git/commit/?id=5fcfb292ca07d0aa3a0d1a87baf2f6b35336dba2">hot-fix</a></p></li>
<li><p>IPA: <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=894143">Red Hat bug
894143</a>
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3341">FreeIPA ticket
#3341</a>, <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=894131">Red Hat bug
894131</a>
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3340">FreeIPA ticket
#3340</a>,
<a class="reference external" href="https://fedorahosted.org/freeipa/changeset/55bace6546095d78760be413896c824efe9c2f20/">hot-fix</a></p></li>
</ul>
<p>According to <a class="reference external" href="http://lists.fedoraproject.org/pipermail/389-users/2013-January/015436.html">conversation on
389-users-list</a>
389 DS is not able to replicate data during ADD operations and don’t
replicate data during MOD operations. Rich Megginson proposed another
solution:</p>
<blockquote>
<div><p>So <code class="docutils literal notranslate"><span class="pre">idnsSOAserial</span></code> is a “local only” attribute that lives in a
“global” entry.</p>
<p>I agree that this is an attribute that should be managed internally
by the directory server, like the entryusn attribute.</p>
</div></blockquote>
</section>
<section id="feature-managment">
<h2>Feature Managment<a class="headerlink" href="#feature-managment" title="Link to this heading">#</a></h2>
</section>
<section id="major-configuration-options-and-enablement">
<h2>Major configuration options and enablement<a class="headerlink" href="#major-configuration-options-and-enablement" title="Link to this heading">#</a></h2>
<p>SOA serial is managed internally by bind-dyndb-ldap plugin. New boolean
option <code class="docutils literal notranslate"><span class="pre">serial_autoincrement</span></code> was added to <code class="docutils literal notranslate"><span class="pre">/etc/named.conf</span></code>. Value
<code class="docutils literal notranslate"><span class="pre">yes</span></code> enables this feature.</p>
<p>There is no command for enabling/disabling this feature.</p>
<p>WebUI~</p>
<p>WebUI doesn’t manage this option.</p>
<p>CLI</p>
<p>New option for <code class="docutils literal notranslate"><span class="pre">ipa-server-install</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">serial</span><span class="o">-</span><span class="n">autoincrement</span>
                    <span class="n">Do</span> <span class="ow">not</span> <span class="n">enable</span> <span class="n">SOA</span> <span class="n">serial</span> <span class="n">autoincrement</span>
</pre></div>
</div>
<p>This feature is enabled by default. Persistent search is required for
SOA serial auto-increment feature, so <code class="docutils literal notranslate"><span class="pre">--no-persistent-search</span></code> can’t
be used without <code class="docutils literal notranslate"><span class="pre">--no-serial-autoincrement</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">dnszone</span></code> commands are unchanged:</p>
<ul class="simple">
<li><p>It is possible to show SOA serial value. Shown value is read from
single LDAP server. This value can be different on other LDAP
servers.</p></li>
<li><p>Any modification via <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">dnszone-mod</span></code> affects only single LDAP
server (i.e. server which was selected by IPA CLI for particular
operation).</p></li>
</ul>
</section>
<section id="replication">
<h2>Replication<a class="headerlink" href="#replication" title="Link to this heading">#</a></h2>
<p>Zone attribute <code class="docutils literal notranslate"><span class="pre">idnsSOASerial</span></code> is not replicated between IPA servers.
<code class="docutils literal notranslate"><span class="pre">idnsSOASerial</span></code> is added to the <code class="docutils literal notranslate"><span class="pre">nsDS5ReplicatedAttributeList</span></code>
attribute inside each replication agreement.</p>
<p>Each write to <code class="docutils literal notranslate"><span class="pre">idnsSOAserial</span></code> can potentially trigger same problem as
described in <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/2534">IPA ticket
#2534</a>.</p>
</section>
<section id="updates-and-upgrades">
<h2>Updates and Upgrades<a class="headerlink" href="#updates-and-upgrades" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Option <code class="docutils literal notranslate"><span class="pre">serial_autoincrement</span> <span class="pre">yes</span></code> has to be added to
<code class="docutils literal notranslate"><span class="pre">/etc/named.conf</span></code>.</p></li>
<li><p>Persistent search is required for SOA serial auto-increment feature,
so <code class="docutils literal notranslate"><span class="pre">psearch</span></code> option has to be switched to <code class="docutils literal notranslate"><span class="pre">yes</span></code>.</p></li>
</ul>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>bind-dyndb-ldap version &gt;= 2.0 is required.</p></li>
</ul>
</section>
<section id="external-impact">
<h2>External Impact<a class="headerlink" href="#external-impact" title="Link to this heading">#</a></h2>
<p>(Hopefully) none.</p>
</section>
</section>
<section id="design-in-ipa-3-1">
<h1>Design in IPA 3.1<a class="headerlink" href="#design-in-ipa-3-1" title="Link to this heading">#</a></h1>
<p>Move SOA serial maintenance from bind-dyndb-ldap to (new) 389 DS plugin:
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3347">IPA ticket #3347</a>.</p>
<p>DS plugin watches <code class="docutils literal notranslate"><span class="pre">cn=dns</span></code> sub-tree for changes.</p>
<p>Any change in DNS record in this subtree will increment
<code class="docutils literal notranslate"><span class="pre">idnsSOAserial</span></code> attribute in record’s parent zone.</p>
<section id="basic-idea">
<h2>Basic idea<a class="headerlink" href="#basic-idea" title="Link to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">objectClass</span> <span class="ow">is</span> <span class="n">idnsZone</span>
    <span class="n">increment</span> <span class="n">idnsSOAserial</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">same</span> <span class="nb">object</span>
<span class="k">else</span> <span class="k">if</span> <span class="n">objectClass</span> <span class="ow">is</span> <span class="n">idnsRecord</span>
    <span class="n">increment</span> <span class="n">idnsSOAserial</span> <span class="ow">in</span> <span class="nb">object</span><span class="s1">&#39;s immediate parent</span>
    <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">idnsName</span><span class="o">=</span><span class="n">test</span><span class="p">,</span> <span class="n">idnsName</span><span class="o">=</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="n">dns</span> <span class="n">will</span> <span class="n">increment</span> <span class="n">idnsSOAserial</span> <span class="ow">in</span> <span class="nb">object</span> <span class="n">idnsName</span><span class="o">=</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">cn</span><span class="o">=</span><span class="n">dns</span>
    <span class="k">if</span> <span class="n">parent</span><span class="s1">&#39;s objectClass is not idnsZone</span>
         <span class="n">log</span> <span class="n">an</span> <span class="n">error</span> <span class="p">(</span><span class="n">This</span> <span class="n">should</span> <span class="n">never</span> <span class="n">happen</span> <span class="p">:</span><span class="o">-</span><span class="p">))</span>
 <span class="k">else</span>
    <span class="n">do</span> <span class="n">nothing</span>
</pre></div>
</div>
</section>
<section id="soa-serial-incrementation-algorithm">
<h2>SOA serial incrementation algorithm<a class="headerlink" href="#soa-serial-incrementation-algorithm" title="Link to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OLDSerial</span> <span class="o">=</span> <span class="n">actual</span> <span class="n">idnsSOAserial</span> <span class="n">value</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">actual</span> <span class="n">UNIX</span> <span class="n">timestamp</span>
<span class="k">if</span> <span class="p">(</span><span class="n">OLDSerial</span> <span class="o">&lt;</span> <span class="n">timestamp</span><span class="p">)</span>
    <span class="n">newSerial</span> <span class="o">=</span> <span class="n">timestamp</span>
<span class="k">else</span>
   <span class="n">newSerial</span> <span class="o">=</span> <span class="n">OLDSerial</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">Write</span> <span class="n">newSerial</span> <span class="n">value</span> <span class="n">to</span> <span class="n">particular</span> <span class="n">idnsSOAserial</span> <span class="n">attribute</span>
</pre></div>
</div>
</section>
<section id="interaction-with-bind-serial-update-mechanism">
<h2>Interaction with BIND serial update mechanism<a class="headerlink" href="#interaction-with-bind-serial-update-mechanism" title="Link to this heading">#</a></h2>
<p>BIND does direct SOA serial update (not trigerred by serial
autoincrement feature) after any dynamic update. We have to catch those
attempts and ignore them:</p>
<ul class="simple">
<li><p>A plugin can intercept any modify and manipulate it, including
suppressing changes to SOA Serial.</p></li>
<li><p>It should be possible to catch &amp; discard SOA serial modifications
inside BIND. This will save some load from LDAP server.</p></li>
</ul>
</section>
<section id="possible-optimization">
<h2>Possible optimization<a class="headerlink" href="#possible-optimization" title="Link to this heading">#</a></h2>
<p>Increment serial value at most once per second.</p>
<p><strong>Problem</strong>: How to solve LDAP server crash?</p>
<p>Problematic scenario:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">numbers</span> <span class="n">represent</span> <span class="n">time</span> <span class="ow">in</span> <span class="s2">&quot;second.millisecond&quot;</span> <span class="nb">format</span><span class="p">)</span>

<span class="mf">1.000</span> <span class="p">:</span> <span class="n">new_serial</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="mf">1.100</span> <span class="p">:</span> <span class="n">record</span> <span class="n">test</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span> <span class="n">updated</span>
<span class="mf">1.100</span> <span class="p">:</span> <span class="n">zone</span> <span class="n">serial</span> <span class="n">overwritten</span> <span class="k">with</span> <span class="n">new_serial</span>
<span class="mf">1.500</span> <span class="p">:</span> <span class="n">zone</span> <span class="n">transfer</span> <span class="n">started</span>
<span class="mf">1.500</span> <span class="p">:</span> <span class="n">search</span> <span class="n">result</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">records</span> <span class="ow">and</span> <span class="n">zone</span> <span class="n">serial</span> <span class="n">stored</span>
<span class="mf">1.500</span> <span class="p">:</span> <span class="n">search</span> <span class="n">result</span> <span class="ow">is</span> <span class="n">transferred</span> <span class="n">to</span> <span class="n">slaves</span>
<span class="mf">1.700</span> <span class="p">:</span> <span class="n">record</span> <span class="n">test2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span> <span class="n">updated</span>
<span class="mf">1.700</span> <span class="p">:</span> <span class="n">zone</span> <span class="n">serial</span> <span class="n">overwritten</span> <span class="k">with</span> <span class="n">new_serial</span>
<span class="o">&lt;</span><span class="n">no</span> <span class="n">changes</span> <span class="kn">from</span> <span class="nn">now</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Result: Zones on master and it’s slave servers have serial =
“new_serial” but the zone content is different (records under
test2.example.com. are not equal).</p>
</section>
<section id="variant-with-delayed-serial-write">
<h2>Variant with delayed serial write<a class="headerlink" href="#variant-with-delayed-serial-write" title="Link to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">When</span> <span class="n">updating</span> <span class="n">zone</span> <span class="n">serial</span><span class="p">:</span>
<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="n">serial</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">time</span><span class="p">())</span>
   <span class="n">cancel</span> <span class="n">scheduled</span> <span class="n">serial</span> <span class="n">write</span> <span class="p">(</span><span class="k">if</span> <span class="n">exists</span><span class="p">)</span>
   <span class="n">write</span> <span class="n">zone</span> <span class="n">serial</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="k">else</span>
   <span class="n">schedule</span> <span class="n">serial</span> <span class="n">bump</span> <span class="n">after</span> <span class="mi">1</span> <span class="n">second</span>
   <span class="p">(</span><span class="n">do</span> <span class="n">nothing</span> <span class="k">if</span> <span class="n">bump</span> <span class="ow">is</span> <span class="n">scheduled</span> <span class="n">already</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">When</span> <span class="n">starting</span> <span class="n">Directory</span> <span class="n">Server</span><span class="p">:</span>
<span class="n">Bump</span> <span class="n">each</span> <span class="n">serial</span> <span class="n">by</span> <span class="n">one</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="variant-with-modified-search-operation">
<h2>Variant with modified search operation<a class="headerlink" href="#variant-with-modified-search-operation" title="Link to this heading">#</a></h2>
<p>Modify search operation for zone serial to return:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">serial</span> <span class="n">value</span> <span class="o">==</span> <span class="n">time</span><span class="p">())</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">serial</span> <span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">else</span>
   <span class="k">return</span> <span class="p">(</span><span class="n">serial</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Scenario</span><span class="p">:</span>
<span class="mf">1.000</span> <span class="p">:</span> <span class="n">new_serial</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="mf">1.100</span> <span class="p">:</span> <span class="n">record</span> <span class="n">test</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span> <span class="n">updated</span>
<span class="mf">1.100</span> <span class="p">:</span> <span class="n">zone</span> <span class="n">serial</span> <span class="n">overwritten</span> <span class="k">with</span> <span class="n">new_serial</span>
<span class="mf">1.500</span> <span class="p">:</span> <span class="n">zone</span> <span class="n">transfer</span> <span class="n">started</span>
<span class="mf">1.500</span> <span class="p">:</span> <span class="n">search</span> <span class="n">result</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">records</span> <span class="ow">and</span> <span class="n">zone</span> <span class="n">serial</span> <span class="n">stored</span>
<span class="mf">1.500</span> <span class="p">:</span> <span class="n">zone</span> <span class="n">serial</span> <span class="ow">in</span> <span class="n">search</span> <span class="n">result</span> <span class="ow">is</span> <span class="p">(</span><span class="n">new_serial</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="mf">1.500</span> <span class="p">:</span> <span class="n">snapshot</span> <span class="ow">is</span> <span class="n">transferred</span> <span class="n">to</span> <span class="n">slaves</span>
<span class="mf">1.700</span> <span class="p">:</span> <span class="n">record</span> <span class="n">test2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span> <span class="n">updated</span>
<span class="mf">1.700</span> <span class="p">:</span> <span class="n">zone</span> <span class="n">serial</span> <span class="n">overwritten</span> <span class="k">with</span> <span class="n">new_serial</span>
<span class="o">&lt;</span><span class="n">no</span> <span class="n">changes</span> <span class="kn">from</span> <span class="nn">now</span><span class="o">&gt;</span>
<span class="mf">2.000</span> <span class="p">:</span> <span class="n">now</span> <span class="n">the</span> <span class="n">search</span> <span class="k">for</span> <span class="n">serial</span> <span class="n">value</span> <span class="n">returns</span> <span class="n">new_serial</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="n">slaves</span> <span class="n">see</span> <span class="n">value</span> <span class="n">incremented</span> <span class="n">by</span> <span class="n">one</span> <span class="kn">from</span> <span class="nn">last</span> <span class="n">zone</span> <span class="n">transfer</span> <span class="p">(</span><span class="mf">1.500</span><span class="p">)</span>
<span class="mf">9.000</span> <span class="p">:</span> <span class="n">serial</span> <span class="n">value</span> <span class="ow">is</span> <span class="n">unchanged</span> <span class="kn">from</span> <span class="nn">last</span> <span class="n">search</span>
</pre></div>
</div>
<p><strong>Expected result:</strong> Zone data can be inconsistent between master and
slaves for only one second. Data will be consistent if directory server
crashed at 1.701 - new zone transfer can be initiated after server
restart.</p>
<p><strong>Requirement:</strong> DS plugin have to modify serial value during reads.</p>
<p><strong>Problem:</strong> It is hard to intercept and modify search operation.</p>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
<p>Any additional requirements or changes discovered during the
implementation phase.</p>
</section>
<section id="feature-management">
<h2>Feature Management<a class="headerlink" href="#feature-management" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Add new option like <code class="docutils literal notranslate"><span class="pre">serial_remote</span></code> to <code class="docutils literal notranslate"><span class="pre">/etc/named.conf</span></code>. This
option should be mutually exclusive with <code class="docutils literal notranslate"><span class="pre">serial_autoincrement</span></code>
option from IPA 3.0.</p></li>
<li><p>Do not create UI for enabling/disabling this feature. We can provide
some boolean directly in plugin configuration, but nothing else.</p></li>
</ul>
</section>
<section id="id1">
<h2>Replication<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>No change from IPA 3.0.</p>
</section>
<section id="id2">
<h2>Updates and Upgrades<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<p>Replace <code class="docutils literal notranslate"><span class="pre">serial_autoincrement</span></code> option in <code class="docutils literal notranslate"><span class="pre">/etc/named.conf</span></code> with
<code class="docutils literal notranslate"><span class="pre">serial_remote</span></code> option.</p>
</section>
<section id="id3">
<h2>Dependencies<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>New version of bind-dyndb-ldap + the new 389 DS plugin.</p>
</section>
<section id="id4">
<h2>External Impact<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<p>Hopefully none.</p>
</section>
<section id="impact-on-testing">
<h2>Impact on testing<a class="headerlink" href="#impact-on-testing" title="Link to this heading">#</a></h2>
<p>Zone serial should be incremented after each change. Delay between
record change and serial change should be at most 1 second.</p>
<p>In IPA 3.0 there was some delay, but prediction for 3.0 is harder.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">DNS_SOA_serial_auto-incrementation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#structure-of-dns-sub-tree-in-ldap">Structure of DNS sub-tree in LDAP</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#design-in-ipa-3-0">Design in IPA 3.0</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advantages">Advantages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#disadvantages">Disadvantages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#very-basic-implementation">Very basic implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problems-found-after-implementation-to-ipa-3-0">Problems found after implementation to IPA 3.0</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-managment">Feature Managment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#major-configuration-options-and-enablement">Major configuration options and enablement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#replication">Replication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#updates-and-upgrades">Updates and Upgrades</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dependencies">Dependencies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#external-impact">External Impact</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#design-in-ipa-3-1">Design in IPA 3.1</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-idea">Basic idea</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#soa-serial-incrementation-algorithm">SOA serial incrementation algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interaction-with-bind-serial-update-mechanism">Interaction with BIND serial update mechanism</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#possible-optimization">Possible optimization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variant-with-delayed-serial-write">Variant with delayed serial write</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variant-with-modified-search-operation">Variant with modified search operation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Replication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Updates and Upgrades</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Dependencies</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">External Impact</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#impact-on-testing">Impact on testing</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>