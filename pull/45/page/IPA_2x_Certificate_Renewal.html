
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IPA_2x_Certificate_Renewal &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/IPA_2x_Certificate_Renewal';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/page/IPA_2x_Certificate_Renewal.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>IPA_2x_Certificate_Renewal</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process">Process</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notes">Notes</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="ipa-2x-certificate-renewal">
<h1>IPA_2x_Certificate_Renewal<a class="headerlink" href="#ipa-2x-certificate-renewal" title="Link to this heading">#</a></h1>
<p>__NOTOC__</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>Automated certificate renewal of the CA subsystem certificates was added
in <a class="reference external" href="IPAv3_300_ga">IPA 3.0</a>. If you can’t upgrade, here are some
manual steps that should get you moving forward.</p>
<p>You probably have several certificates tracked by certmonger in a
CA_UNREACHABLE state, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Request</span> <span class="n">ID</span> <span class="s1">&#39;20111111152846&#39;</span><span class="p">:</span>
        <span class="n">status</span><span class="p">:</span> <span class="n">CA_UNREACHABLE</span>
        <span class="n">ca</span><span class="o">-</span><span class="n">error</span><span class="p">:</span> <span class="n">Server</span> <span class="n">failed</span> <span class="n">request</span><span class="p">,</span> <span class="n">will</span> <span class="n">retry</span><span class="p">:</span> <span class="o">-</span><span class="mi">504</span> <span class="p">(</span><span class="n">libcurl</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">HTTP</span> <span class="n">POST</span> <span class="n">transaction</span><span class="o">.</span>  <span class="n">Peer</span> <span class="n">certificate</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">authenticated</span> <span class="k">with</span> <span class="n">known</span> <span class="n">CA</span> <span class="n">certificates</span><span class="p">)</span><span class="o">.</span>
        <span class="n">stuck</span><span class="p">:</span> <span class="n">yes</span>
        <span class="n">key</span> <span class="n">pair</span> <span class="n">storage</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="n">NSSDB</span><span class="p">,</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;/etc/httpd/alias&#39;</span><span class="p">,</span><span class="n">nickname</span><span class="o">=</span><span class="s1">&#39;Server-Cert&#39;</span><span class="p">,</span><span class="n">token</span><span class="o">=</span><span class="s1">&#39;NSS Certificate DB&#39;</span><span class="p">,</span><span class="n">pinfile</span><span class="o">=</span><span class="s1">&#39;/etc/httpd/alias/pwdfile.txt&#39;</span>
        <span class="n">certificate</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="n">NSSDB</span><span class="p">,</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;/etc/httpd/alias&#39;</span><span class="p">,</span><span class="n">nickname</span><span class="o">=</span><span class="s1">&#39;Server-Cert&#39;</span><span class="p">,</span><span class="n">token</span><span class="o">=</span><span class="s1">&#39;NSS Certificate DB&#39;</span>
        <span class="n">CA</span><span class="p">:</span> <span class="n">IPA</span>
        <span class="n">issuer</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">Certificate</span> <span class="n">Authority</span><span class="p">,</span><span class="n">O</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
        <span class="n">subject</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">ipa</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">,</span><span class="n">O</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
        <span class="n">expires</span><span class="p">:</span> <span class="mi">2013</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">46</span> <span class="n">UTC</span>
        <span class="n">eku</span><span class="p">:</span> <span class="nb">id</span><span class="o">-</span><span class="n">kp</span><span class="o">-</span><span class="n">serverAuth</span><span class="p">,</span><span class="nb">id</span><span class="o">-</span><span class="n">kp</span><span class="o">-</span><span class="n">clientAuth</span>
        <span class="n">pre</span><span class="o">-</span><span class="n">save</span> <span class="n">command</span><span class="p">:</span>
        <span class="n">post</span><span class="o">-</span><span class="n">save</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ipa</span><span class="o">/</span><span class="n">certmonger</span><span class="o">/</span><span class="n">restart_httpd</span>
        <span class="n">track</span><span class="p">:</span> <span class="n">yes</span>
        <span class="n">auto</span><span class="o">-</span><span class="n">renew</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
</section>
<section id="process">
<h2>Process<a class="headerlink" href="#process" title="Link to this heading">#</a></h2>
<p>The first thing you need to do is update certmonger to at least 0.58-1:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">yum</span> <span class="pre">update</span> <span class="pre">certmonger</span></code></p>
<p>This provides the dogtag-ipa-renew-agent CA that can directly renew the
dogtag CA subsystem certificates. You only need to do this on those
masters with a CA (so it won’t hurt if you upgrade it in other places
too but it won’t help with this problem either).</p>
<p>In order for this to work you are going to need to go back in time to
when the certificates are all still valid. First we need to stop the NTP
service:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">/sbin/service</span> <span class="pre">ntpd</span> <span class="pre">stop</span></code></p>
<p>To find out when the certificates were still valid, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># for nickname in &quot;auditSigningCert cert-pki-ca&quot; &quot;ocspSigningCert cert-pki-ca&quot; &quot;subsystemCert cert-pki-ca&quot; &quot;Server-Cert cert-pki-ca&quot;
  do
    echo $nickname
    certutil -L -d /var/lib/pki-ca/alias -n &quot;${nickname}&quot; | grep -i after
  done
</pre></div>
</div>
<p>This tells us when to set time back to. I recommend setting time back at
least 24 hours before expiration.</p>
<p>Next, you need to determine the PIN for the CA NSS database:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">grep</span> <span class="pre">internal=</span> <span class="pre">/var/lib/pki-ca/conf/password.conf</span></code></p>
<p>Now we need to tell certmonger about all the CA certificates it needs to
renew</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># for nickname in &quot;auditSigningCert cert-pki-ca&quot; &quot;ocspSigningCert cert-pki-ca&quot; &quot;subsystemCert cert-pki-ca&quot; &quot;Server-Cert cert-pki-ca&quot;</span>
 <span class="n">do</span>
     <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">getcert</span> <span class="n">start</span><span class="o">-</span><span class="n">tracking</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pki</span><span class="o">-</span><span class="n">ca</span><span class="o">/</span><span class="n">alias</span> <span class="o">-</span><span class="n">n</span> <span class="s2">&quot;$</span><span class="si">{nickname}</span><span class="s2">&quot;</span> <span class="o">-</span><span class="n">c</span> <span class="n">dogtag</span><span class="o">-</span><span class="n">ipa</span><span class="o">-</span><span class="n">renew</span><span class="o">-</span><span class="n">agent</span> <span class="o">-</span><span class="n">P</span> <span class="o">&lt;</span><span class="n">internal</span> <span class="n">pin</span><span class="o">&gt;</span>
 <span class="n">done</span>
</pre></div>
</div>
<p>We also need to renew the agent certificate that IPA uses to
authenticate:</p>
<p>`` # /usr/bin/getcert start-tracking -d /etc/httpd/alias -n ipaCert -c dogtag-ipa-renew-agent -p /etc/httpd/alias/pwdfile.txt``</p>
<p>Use “getcert list” to confirm that these 5 certs are now being tracked
and note the Request IDs. You should be tracking a total of 8
certificates now.</p>
<p>Now it’s time to go back in time to when the certificates are valid,
something like:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">date</span> <span class="pre">102910262013</span></code></p>
<p>Let’s force renewal on all of the certificates:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">for</span> <span class="pre">line</span> <span class="pre">in</span> <span class="pre">`getcert</span> <span class="pre">list</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">Request</span> <span class="pre">|</span> <span class="pre">cut</span> <span class="pre">-d</span> <span class="pre">&quot;'&quot;</span> <span class="pre">-f2</span></code>; do getcert resubmit -i $line; done`</p>
<p>This will renew the CA subsystem certificates but the server
certificates for Apache and 389-ds will have failed. We need to do a
little more work to get those renewed, and to get the CA fully
operational again.</p>
<p>Running <code class="docutils literal notranslate"><span class="pre">getcert</span> <span class="pre">list</span></code> should confirm this. The two 389-ds and the
Apache certs are still in CA_UNREACHABLE, though the reason is now SSL
peer rejected your certificate as expired.</p>
<p>Let’s continue getting the CA up and running. The audit subsystem
certificate is recreated with the wrong trust permissions. To fix this
run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``# certutil -M -n &quot;auditSigningCert cert-pki-ca&quot; -d /var/lib/pki-ca/alias -t u,u,Pu ``
</pre></div>
</div>
<p>The dogtag configuration file has a base64-encoded copy of most of these
certificates in it. You’ll need to update those by hand.</p>
<p>To get this run:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">for</span> <span class="pre">nickname</span> <span class="pre">in</span> <span class="pre">&quot;auditSigningCert</span> <span class="pre">cert-pki-ca&quot;</span> <span class="pre">&quot;ocspSigningCert</span> <span class="pre">cert-pki-ca&quot;</span> <span class="pre">&quot;subsystemCert</span> <span class="pre">cert-pki-ca&quot;</span> <span class="pre">&quot;Server-Cert</span> <span class="pre">cert-pki-ca&quot;;</span> <span class="pre">do</span> <span class="pre">certutil</span> <span class="pre">-L</span> <span class="pre">-d</span> <span class="pre">/var/lib/pki-ca/alias</span> <span class="pre">-n</span> <span class="pre">&quot;${nickname}&quot;</span> <span class="pre">-a</span> <span class="pre">&gt;</span> <span class="pre">/tmp/&quot;${nickname}&quot;;</span> <span class="pre">done</span></code></p>
<p>Stop the CA service:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">/sbin/service</span> <span class="pre">pki-cad</span> <span class="pre">stop</span></code></p>
<p>Then edit /etc/pki-ca/CS.cfg and find the cert entry for each one and
replace the blobs. The option names are like ca.audit_signing.cert,
ca.ocsp_signing.cert, etc. It should be fairly straightforward. There
are 4 certs you need to replace.</p>
<p>Here are the nicknames and values:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;auditSigningCert cert-pki-ca&#39;</span><span class="p">:</span> <span class="s1">&#39;ca.audit_signing.cert&#39;</span>
<span class="s1">&#39;ocspSigningCert cert-pki-ca&#39;</span><span class="p">:</span> <span class="s1">&#39;ca.ocsp_signing.cert&#39;</span>
<span class="s1">&#39;subsystemCert cert-pki-ca&#39;</span><span class="p">:</span> <span class="s1">&#39;ca.subsystem.cert&#39;</span>
<span class="s1">&#39;Server-Cert cert-pki-ca&#39;</span><span class="p">:</span> <span class="s1">&#39;ca.sslserver.cert&#39;</span>
</pre></div>
</div>
<p>The PEM exported by certutil is going to be broken into several
64-character lines. You will need to combine them into a single line.</p>
<p>Backing up this file in advance would be a good idea.</p>
<p>Now you can try to restart the CA to see what happens. It should come up
fine:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">/sbin/service</span> <span class="pre">pki-cad</span> <span class="pre">start</span></code></p>
<p>For ipaCert, stored in /etc/httpd/alias you have another job to do. This
certificate is used to authenticate with the CA. You’ll need to use
ldapmodify to fix things up.</p>
<p>Start by looking at the new value for ipaCert. You need to do two
things:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">certutil</span> <span class="pre">-L</span> <span class="pre">-d</span> <span class="pre">/etc/httpd/alias</span> <span class="pre">-n</span> <span class="pre">ipaCert</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">serial</span></code></p>
<p>Next you need the base64-encoded value of the cert like before:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">certutil</span> <span class="pre">-L</span> <span class="pre">-d</span> <span class="pre">/etc/httpd/alias</span> <span class="pre">-n</span> <span class="pre">ipaCert</span> <span class="pre">-a</span></code></p>
<p>Again you’ll need to drop the header/footer and combine this into a
single line.</p>
<p>Next see what is already there with:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ldapsearch</span> <span class="pre">-x</span> <span class="pre">-h</span> <span class="pre">localhost</span> <span class="pre">-p</span> <span class="pre">7389</span> <span class="pre">-D</span> <span class="pre">'cn=directory</span> <span class="pre">manager'</span> <span class="pre">-W</span> <span class="pre">-b</span> <span class="pre">uid=ipara,ou=People,o=ipaca</span></code></p>
<p>You need to replace the serial number in the description attribute with
the new one. The serial number is the 2nd number. The format of the
description line is:</p>
<p><code class="docutils literal notranslate"><span class="pre">2;</span></code><code class="docutils literal notranslate"><span class="pre">;</span></code><code class="docutils literal notranslate"><span class="pre">;</span></code></p>
<p>The change is going to look something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ldapmodify -x -h localhost -p 7389 -D &#39;cn=directory manager&#39; -w password</span>
<span class="n">dn</span><span class="p">:</span> <span class="n">uid</span><span class="o">=</span><span class="n">ipara</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">people</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">ipaca</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">add</span><span class="p">:</span> <span class="n">usercertificate</span>
<span class="n">usercertificate</span><span class="p">::</span> <span class="n">MII</span><span class="o">...</span><span class="n">PNQ</span><span class="o">=</span>
<span class="o">-</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">description</span>
<span class="n">description</span><span class="p">:</span> <span class="mi">2</span><span class="p">;</span><span class="mi">16</span><span class="p">;</span><span class="n">CN</span><span class="o">=</span><span class="n">Certificate</span> <span class="n">Authority</span><span class="p">,</span><span class="n">O</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span><span class="p">;</span><span class="n">CN</span><span class="o">=</span><span class="n">IPA</span> <span class="n">RA</span><span class="p">,</span><span class="n">O</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="o">&lt;</span><span class="n">extra</span> <span class="n">blank</span> <span class="n">line</span> <span class="n">to</span> <span class="n">finish</span><span class="o">&gt;</span>
<span class="o">^</span><span class="n">D</span> <span class="n">to</span> <span class="n">exit</span>
</pre></div>
</div>
<p>Now restart the Apache service</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">/sbin/service</span> <span class="pre">httpd</span> <span class="pre">restart</span></code></p>
<p>Next we need to renew the two 389-ds and the Apache server certificates.</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa-getcert</span> <span class="pre">list</span></code></p>
<p>For each of the three Request IDs run something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``# ipa-getcert resubmit -i ``
</pre></div>
</div>
<p>Restart the world:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">/sbin/service</span> <span class="pre">ipa</span> <span class="pre">restart</span></code></p>
<p>Return to the present time.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># /sbin/service ntpd start</span>
<span class="c1"># date (confirm it is now)</span>
</pre></div>
</div>
<p>To make sure that communication with the CA is working run:</p>
<p><code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">ipa</span> <span class="pre">cert-show</span> <span class="pre">1</span></code></p>
</section>
<section id="notes">
<h2>Notes<a class="headerlink" href="#notes" title="Link to this heading">#</a></h2>
<p>I tested this on a RHEL 6.4 system that I installed ipa-server-2.2.0 and
krb5-server-1.9. I did this by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># date 111110262011</span>
<span class="c1"># ipa-server-install -N ...</span>
</pre></div>
</div>
<p>I confirmed that things were working, then I brought time to today:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``# rdate -s ``
</pre></div>
</div>
<p>So I basically simulated an installation 2 years in the past and see
today that my certificates are expired. Then I did the renewal
procedure. I did the install without an NTP server because otherwise it
would have reset the current time to today during the install, and I
wanted to be in the past.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process">Process</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#notes">Notes</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>