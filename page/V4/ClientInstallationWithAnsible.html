
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>ClientInstallationWithAnsible &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/ClientInstallationWithAnsible';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/ClientInstallationWithAnsible.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>ClientInstallationWithAnsible</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-client-configuration">IPA client configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-client-unconfiguration">IPA client unconfiguration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ansible-ipaclient-module">Ansible ipaclient module</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ansible-ipahost-module">Ansible ipahost module</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ansible-ipaclient-role">Ansible ipaclient role</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#state-present">state: present</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#state-absent">state: absent</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use">How to Use</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-ansible-ipaclient-module-to-unconfigure-ipa">Using the Ansible ipaclient module to unconfigure IPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-ansible-role-ipaclient-to-unconfigure-ipa">Using the Ansible role ipaclient to unconfigure IPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-ipaclient-module-to-configure-ipa-client-by-providing-username-and-password">Use the ipaclient module to configure IPA client by providing username and password</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-ipahost-and-ipaclient-modules-to-configure-ipa-client-by-providing-an-otp-password">Use the ipahost and ipaclient modules to configure IPA client by providing an OTP password</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-ipaclient-role-to-configure-ipa-client">Use the ipaclient role to configure IPA client</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="clientinstallationwithansible">
<h1>ClientInstallationWithAnsible<a class="headerlink" href="#clientinstallationwithansible" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>Automation of installation and configuration tasks is an important part
of the sysadmin’s responsibilities.
<a class="reference external" href="http://docs.ansible.com/ansible/latest/index.html">Ansible</a> is a
powerful engine providing automation, that is becoming widely used, and
can allow to avoid the repetition of manual tasks.</p>
<p>In this context, IPA client deployment is a perfect candidate for
automation through Ansible: when the sysadmin needs to configure
additional IdM clients, Ansible can be used to install the IdM packages
and configure IdM client on the nodes with the same set of options.</p>
<p>The goal of this project is to provide Ansible
<a class="reference external" href="http://docs.ansible.com/ansible/latest/modules.html">modules</a> and
<a class="reference external" href="http://docs.ansible.com/ansible/latest/playbooks_roles.html">roles</a>
allowing the automation of IdM client configuration.</p>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h2>
</section>
<section id="ipa-client-configuration">
<h2>IPA client configuration<a class="headerlink" href="#ipa-client-configuration" title="Link to this heading">#</a></h2>
<p>A sysadmin has already deployed IdM on one or more servers, and wants to
configure one or more nodes as IdM clients using Ansible. The sysadmin
needs to define an <a class="reference external" href="http://docs.ansible.com/ansible/latest/intro_inventory.html">inventory
file</a>
describing the IdM clients and the IdM server (hostname, domain name,
realm name…) and is able to call ansible either through an <a class="reference external" href="http://docs.ansible.com/ansible/latest/playbooks.html">Ansible
playbook</a> or
<a class="reference external" href="http://docs.ansible.com/ansible/latest/intro_adhoc.html">Ansible ad-hoc
commands</a> in
order to configure the IdM clients.</p>
<p>If a host defined as IdM client in the inventory is already configured,
Ansible will detect this and check that the domain and realm are
matching the expectations of the inventory file.</p>
<ul class="simple">
<li><p>If it is the case, Ansible will skip the configuration of IPA client.
Note: if the configuration options (except domain and realm) differ,
the IPA client will not be reconfigured. This means that the solution
will not be able to repair broken installations or modify
installation options.</p></li>
<li><p>If the domain or realm is different, Ansible will exit on error for
the specified host.</p></li>
</ul>
<p>If the host defined as IdM client in the inventory is not configured yet
as IPA client, Ansible will configure IPA client.</p>
<p>This use case can be enhanced in the future, in order to allow:</p>
<ul class="simple">
<li><p>repair of broken installations (by comparing what should be
configured with the actual settings)</p></li>
<li><p>modification of current installation (for instance in order to re-run
ipa-client-install but with a different set of options)</p></li>
</ul>
<p>but the scope for this first release is limited to the configuration and
check of domain and realm consistency.</p>
<p>As an authorized user is required to join a client machine to IPA,
Ansible needs to be provided either with the keytab of a user allowed to
join hosts (which will be used to call ipa host-add and create a OTP for
the machine), or a kerberos principal + password.</p>
<p>The re-enrollment of a host is also supported by providing Ansible with
a backed up host keytab from previous enrollment.</p>
</section>
<section id="ipa-client-unconfiguration">
<h2>IPA client unconfiguration<a class="headerlink" href="#ipa-client-unconfiguration" title="Link to this heading">#</a></h2>
<p>A sysadmin has already deployed IPA client on a host (either using
Ansible or with the ipa-client-install command line), and wants to
un-enroll the host from IdM. The sysadmin needs to define an inventory
file containing the host to be unenrolled and is able to call ansible
either through an Ansible playbook or Ansible ad-hoc commands in order
to unconfigure the IdM client.</p>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Link to this heading">#</a></h2>
<p>The solution is implemented as Ansible modules and role:</p>
<ul class="simple">
<li><p>a module “ipahost” allowing to perform the equivalent to ipa
host-add/mod/del, supporting the –random option in order to create a
One-Time Password used for host enrollment</p></li>
<li><p>a module “ipaclient” checking if the host is already configured for
IPA and wrapping ipa-client-install. This module accepts a “state”
parameter which can take “present” or “absent” values and will either
configure or unconfigure IPA client depending on this value.</p></li>
<li><p>a role “ipaclient” combining the above modules and existing ansible
modules (for instance the
<a class="reference external" href="http://docs.ansible.com/ansible/latest/package_module.html">package</a>
module to install ipa-client package), accepting a “state” parameter
with value either “present” or “absent”.</p></li>
</ul>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
</section>
<section id="ansible-ipaclient-module">
<h2>Ansible ipaclient module<a class="headerlink" href="#ansible-ipaclient-module" title="Link to this heading">#</a></h2>
<p>The ansible ipaclient module is a module performing the equivalent of
ipa-client-install. In this first version, it is written as a wrapper
calling ipa-client-install. It requires ipa-client packages to be
installed on the managed node.</p>
<p>Potential issues:</p>
<ul class="simple">
<li><p>Compatibility of the Ansible modules with various versions of
ipa-client: what is the requirement? What is the minimum supported
version of ipa-client?</p></li>
</ul>
<p>The module supports a “state” parameter allowing to either configure
(state=present) or unconfigure (state=absent) IPA client.</p>
<p>The module supports the Ansible check_mode, i.e. if called with -C or
–check, it will not perform any modification but simply return if
changes would need to be made.</p>
<p>==== state=present ====</p>
<p>In order to guarantee idempotency, the module first checks if ipa client
is already installed, by checking for the presence of
/etc/ipa/default.conf and
/var/lib/ipa-client/sysrestore/sysrestore.state.</p>
<ul class="simple">
<li><p>If IPA client is already installed, it checks that the required
domain and realm are matching the configured domain and realm (as
read from the configuration in /etc/ipa/default.conf).</p>
<ul>
<li><p>If domain and realm are matching, the module exits successfully
and reports that it did not perform any modification
(changed=False).</p></li>
<li><p>If domain or realm is inconsistent with the module parameters, the
module exits on error</p></li>
</ul>
</li>
<li><p>If IPA client is not installed, it calls ipa-client-install</p></li>
</ul>
<p>The module doesn’t support exactly the same set of parameters as those
supported by ipa-client-install. This allows to handle some parts of the
configuration with other Ansible modules. For instance, the ipaclient
module always calls ipa-client-install with the –no-ntp option and the
NTP configuration is done in the ipaclient role by calling existing
Ansible module for NTP.</p>
<p>This strategy will allow to gradually transfer the configuration of IPA
components to Ansible modules and benefit from their features (repair
config, update config…)</p>
<p>==== state=absent ====</p>
<p>The module first checks if ipa client is already installed.</p>
<ul class="simple">
<li><p>If IPA client is installed, the module wraps a call to
ipa-client-install –uninstall -U in order to unconfigure IPA client.</p></li>
<li><p>If IPA client is not installed, the module simply returns
successfully and reports that it did not perform any modification
(changed=False).</p></li>
</ul>
<p>The uninstallation is possible for IPA clients installed with the
command line ipa-client-install as well as clients installed with
Ansible.</p>
</section>
<section id="ansible-ipahost-module">
<h2>Ansible ipahost module<a class="headerlink" href="#ansible-ipahost-module" title="Link to this heading">#</a></h2>
<p>Note: Ansible already provides <a class="reference external" href="http://docs.ansible.com/ansible/latest/list_of_identity_modules.html">Identity
Modules</a>
for IPA, especially one for
<a class="reference external" href="http://docs.ansible.com/ansible/latest/ipa_host_module.html">ipa_host</a>,
but these modules currently lack some features:</p>
<ul class="simple">
<li><p>ipa_host module does not allow to create a random One-Time Password</p></li>
<li><p>all the IPA modules are authenticating to IPA server using principal
+ password and do not support keytabs</p></li>
<li><p>all the IPA modules are communicating with the IPA server using the
remote JSON API instead of the Python API</p></li>
</ul>
<p>These limitations argue in favor of a new ipahost module.</p>
<p>The ansible ipahost module is a module performing the equivalent of ipa
host-add/mod/del. It must be executed on an IPA host. It is needed
especially when the goal is to install a client using a One-Time
Password and allows to obtain the OTP.</p>
<p>It is written with an ansible Action Plugin which allows to prepare the
authentication, and a module executed on the managed node.</p>
<p>The action plugin is executed on the control node and:</p>
<ul class="simple">
<li><p>creates a kerberos client configuration file using IPA server, stored
in a temp directory</p></li>
<li><p>sets the environment variable KRB5_CONFIG on the control node to the
temp kerberos config file</p></li>
<li><p>performs kinit on the control node, using a specific credential cache
file in the temp directory, and specifying a limited lifetime</p></li>
<li><p>copies the credential cache file from the control node to the managed
node in the Ansible temp directory used by the module</p></li>
<li><p>calls the module on the managed node by providing the path to the
credential cache file</p></li>
</ul>
<p>The module is executed on the managed node and:</p>
<ul class="simple">
<li><p>sets the environment variable KRB5CCNAME to the credential cache file</p></li>
<li><p>uses IPA client API to add/mod/del the host.</p></li>
</ul>
<p>When the module has finished its execution, the credential cache file is
automatically deleted on the managed node as Ansible removes the temp
directory used by the module.</p>
<p>The kinit can be done either with principal/password or with a keytab.
They are provided as arguments to the ansible module. The password or
the keytab are never transfered to the managed node, only the cache file
is.</p>
<p>The module can be called with the argument state=present or state=absent
to add or remove a host.</p>
<p>The module supports the Ansible check_mode, i.e. if called with -C or
–check, it will not perform any modification but simply return if
changes would need to be made.</p>
<p>==== state=present ====</p>
<p>When called with state=present (or state not defined), the module
ensures that the host is defined in IPA configuration: it performs the
equivalent of ipa host-show to check if the host is already defined.</p>
<ul class="simple">
<li><p>if the host is already defined, it compares the host attributes with
the ones specified by the module. If needed, it calls the equivalent
of ipa host-mod.</p></li>
<li><p>if the host is not defined, it calls the equivalent of ipa host-add.</p></li>
</ul>
<p>==== state=absent ====</p>
<p>When called with state=absent, the module ensures that the host is not
defined in IPA configuration: it performs the equivalent of ipa
host-show to check if the host is already defined.</p>
<ul class="simple">
<li><p>if the host is already defined, it calls the equivalent of ipa
host-del.</p></li>
<li><p>if the host is not defined, it returns successfully and reports that
it did not perform any modification (changed=false).</p></li>
</ul>
<p>It is desirable to be able to set an OTP on a host prior to calling the
client enrollment module so the client host entry will be in a state
ready for enrollment, even if this means re-enrollment. It cannot be
assumed that an enrolled host can unenroll itself to handle cases of a
broken or missing keytab.</p>
<p>IPA currently (as of IPA 4.6) prevents setting an OTP on an enrolled
host by a check in the host_mod pre callback. I’d propose a new option
to allow overriding this for backwards compatibility in case existing
integration relies on the ValidationError raised when setting an OTP on
an enrolled client to know the state. I’d propose –force.</p>
<p>Similarly the 389-ds ipa_enrollment plugin prevents enrolling an already
enrolled host in ipa_join(). This will be needed to be updated to handle
re-enrollment as well, particularly in the assumptions about what
objectclasses and attributes already exist in the host entry.</p>
</section>
<section id="ansible-ipaclient-role">
<h2>Ansible ipaclient role<a class="headerlink" href="#ansible-ipaclient-role" title="Link to this heading">#</a></h2>
<p>The ipaclient role takes a “state” parameter allowing to either
configure or unconfigure IPA client. It combines the installation of ipa
client packages (using the pre-existing Ansible module “package”) and
the configuration of IPA client using the Ansible module ipaclient.</p>
<section id="state-present">
<h3>state: present<a class="headerlink" href="#state-present" title="Link to this heading">#</a></h3>
<p>When the role is called with the parameter “state: present” (or the
parameter state is not defined), the role performs IPA client
configuration:</p>
<ul class="simple">
<li><p>install the packages required by IPA client</p></li>
<li><p>if needed obtain a One-Time Password for enrolling the host using
Ansible module “ipahost”</p></li>
<li><p>configure IPA client using the Ansible module “ipaclient”</p></li>
</ul>
<p>The package names depend on the OS of the managed node: in RHEL the
package is named ipa-client while in Fedora freeipa-client. In order to
work with both OSes, it is possible to import variables specific to the
distribution. The role defines the ipaclient_package variable which will
have a default value of freeipa-client, or a value ipa-client for RHEL.</p>
<p>Question: which OS should be supported for the IPA client? fedora, rhel,
other distros?</p>
<p>IPA client enrollment can be performed using one of the 3 following
methods:</p>
<ul class="simple">
<li><p>supply a principal and a password</p></li>
<li><p>supply a principal and a One-Time Password</p></li>
<li><p>supply a host keytab from previous enrollment</p></li>
</ul>
</section>
<section id="state-absent">
<h3>state: absent<a class="headerlink" href="#state-absent" title="Link to this heading">#</a></h3>
<p>When the role is called with the parameter “state: absent”, the role
performs IPA client unconfiguration. The role is using the Ansible
module “ipaclient”.</p>
<p>Question: should the role with state=absent also remove ipa-client
packages?</p>
</section>
</section>
<section id="how-to-use">
<h2>How to Use<a class="headerlink" href="#how-to-use" title="Link to this heading">#</a></h2>
<p>Example of inventory file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat inventory/hosts
[ipaclients]
ipaclient1.example.com
ipaclient2.example.com
[ipaservers]
ipaserver.example.com
[ipaclients:vars]
ipaclient_domain=example.com
ipaclient_realm=EXAMPLE.COM
ipaclient_extraargs=[ &#39;--kinit-attempts=3&#39;, &#39;--mkhomedir&#39;]
# To enroll the IPAclient, the module needs either a host keytab from a previous enrollment,
# or a principal + password, or a One-Time Password
# If you wish to use principal + password, you need to provide ipaclient_principal and ipaclient_password:
ipaclient_principal=admin
ipaclient_password=MySecretPassword123
# If you wish to use a host keytab from a previous enrollment, you need to provide ipaclient_keytab:
#ipaclient_keytab=
# If you wish to use a One-Time Password, you need to select an auth method to IPA server
# (either using password or keytab) and need to provide
# - for password auth: ipaserver_principal and ipaserver_password:
#ipaserver_principal=
#ipaserver_password=
# - for keytab auth: ipaserver_principal and ipaserver_keytab:
#ipaserver_principal=
#ipaserver_keytab=
</pre></div>
</div>
</section>
<section id="using-the-ansible-ipaclient-module-to-unconfigure-ipa">
<h2>Using the Ansible ipaclient module to unconfigure IPA<a class="headerlink" href="#using-the-ansible-ipaclient-module-to-unconfigure-ipa" title="Link to this heading">#</a></h2>
<p>Create a playbook calling the ipaclient module, with state=absent</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat uninstall.yml
---
- name: Playbook to unconfigure IPA clients
  hosts: ipaclients
  become: true
  tasks:
  - name: Unconfigure IPA client
    ipaclient:
      state: absent
</pre></div>
</div>
<p>Call the playbook</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">ansible-playbook</span> <span class="pre">-i</span> <span class="pre">inventory/hosts</span> <span class="pre">uninstall.yml</span></code></p>
</section>
<section id="using-the-ansible-role-ipaclient-to-unconfigure-ipa">
<h2>Using the Ansible role ipaclient to unconfigure IPA<a class="headerlink" href="#using-the-ansible-role-ipaclient-to-unconfigure-ipa" title="Link to this heading">#</a></h2>
<p>Create a playbook calling the ipaclient role, with state=absent</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat uninstall.yml
---
- name: Playbook to unconfigure IPA clients
  hosts: ipaclients
  become: true
  roles:
  - role: ipaclient
    state: absent
</pre></div>
</div>
<p>Call the playbook</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">ansible-playbook</span> <span class="pre">-i</span> <span class="pre">inventory/hosts</span> <span class="pre">uninstall.yml</span></code></p>
</section>
<section id="use-the-ipaclient-module-to-configure-ipa-client-by-providing-username-and-password">
<h2>Use the ipaclient module to configure IPA client by providing username and password<a class="headerlink" href="#use-the-ipaclient-module-to-configure-ipa-client-by-providing-username-and-password" title="Link to this heading">#</a></h2>
<p>Create a playbook calling the ipaclient module, with state=present. The
module takes principal and password as arguments.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat install.yml
---
- name: Playbook to configure IPA clients with username/password
  hosts: ipaclients
  become: true
  tasks:
  - name: Install IPA client package
    package:
      name: ipa-client
      state: present
  - name: Configure IPA client
    ipaclient:
      state: present
      domain: &quot;{{ ipaclient_domain }}&quot;
      realm: &quot;{{ ipaclient_realm }}&quot;
      principal: &quot;{{ ipaclient_principal }}&quot;
      password: &quot;{{ ipaclient_password }}&quot;
      extra_args: &quot;{{ipaclient_extraargs }}&quot;
</pre></div>
</div>
<p>Call the playbook</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">ansible-playbook</span> <span class="pre">-i</span> <span class="pre">inventory/hosts</span> <span class="pre">install.yml</span></code></p>
<p>Note: Ansible provides a feature named <a class="reference external" href="http://docs.ansible.com/ansible/latest/playbooks_vault.html">Ansible
Vault</a>
to avoid writing clear-text sensible data in playbooks. The sysadmin can
create a file containing the password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat playbook_sensitive_data.yml
---
ipaclient_password: MySecretPassword123
</pre></div>
</div>
<p>Then encrypt this file using ansible-vault command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-vault encrypt playbook_sensitive_data.yml
New Vault password:
Confirm New Vault password:
Encryption successful
$
</pre></div>
</div>
<p>At this point, the file is encrypted and the variables it contains can
be used by the playbook:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">...</span><span class="p">]</span>
  <span class="n">hosts</span><span class="p">:</span> <span class="n">ipaclients</span>
  <span class="n">become</span><span class="p">:</span> <span class="n">true</span>
   <span class="n">vars_files</span><span class="p">:</span>
   <span class="o">-</span>  <span class="n">playbook_sensitive_data</span><span class="o">.</span><span class="n">yml</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Configure</span> <span class="n">IPA</span> <span class="n">client</span>
    <span class="n">ipaclient</span><span class="p">:</span>
      <span class="n">state</span><span class="p">:</span> <span class="n">present</span>
      <span class="n">domain</span><span class="p">:</span> <span class="s2">&quot;{{ ipaclient_domain }}&quot;</span>
      <span class="n">realm</span><span class="p">:</span> <span class="s2">&quot;{{ ipaclient_realm }}&quot;</span>
      <span class="n">principal</span><span class="p">:</span> <span class="s2">&quot;{{ ipaclient_principal }}&quot;</span>
       <span class="n">password</span><span class="p">:</span>  <span class="s2">&quot;{{  ipaclient_password  }}&quot;</span>
      <span class="n">extra_args</span><span class="p">:</span> <span class="s2">&quot;{{ipaclient_extraargs }}&quot;</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>When the playbook is called, the password used to protect the file is
either supplied interactively:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``$ ansible-playbook -i inventory/hosts --ask-vault-pass install.yml``
</pre></div>
</div>
<p>or provided in a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>``$ ansible-playbook -in inventory/hosts --vault-password-file~/.vault_pass.txt install.yml``
</pre></div>
</div>
</section>
<section id="use-the-ipahost-and-ipaclient-modules-to-configure-ipa-client-by-providing-an-otp-password">
<h2>Use the ipahost and ipaclient modules to configure IPA client by providing an OTP password<a class="headerlink" href="#use-the-ipahost-and-ipaclient-modules-to-configure-ipa-client-by-providing-an-otp-password" title="Link to this heading">#</a></h2>
<p>Create a playbook calling ipahost module in order to create an OTP
password for the managed node, then calling ipaclient module to
configure IPA with the OTP password just obtained.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat install_otp.yml
---
- name: Playbook to configure IPA clients with an OTP password
  hosts: ipaclients
  become: true
  tasks:
  - name: For OTP client registration, add client and get OTP
    ipahost:
      state: present
      principal: &quot;{{ ipaserver_principal }}&quot;
      keytab: &quot;{{ ipaserver_keytab }}&quot;
      fqdn: &quot;{{ ansible_fqdn }}&quot;
      random: True
    register: ipahost_output
    delegate_to: &quot;{{ groups.ipaservers[0] }}&quot;
  - name: Configure ipaclient
    ipaclient:
      state: present
      domain: &quot;{{ ipaclient_domain }}&quot;
      realm: &quot;{{ ipaclient_realm }}&quot;
      otp: &quot;{{ ipahost_output.host.randompassword }}&quot;
      extra_args: &quot;{{ ipaclient_extraargs }}&quot;
</pre></div>
</div>
<p>Call the playbook</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">ansible-playbook</span> <span class="pre">-i</span> <span class="pre">inventory/hosts</span> <span class="pre">install_otp.yml</span></code></p>
<p>Note: the ipahost module can also be called with a principal and
password instead of the admin keytab:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">For</span> <span class="n">OTP</span> <span class="n">client</span> <span class="n">registration</span><span class="p">,</span> <span class="n">add</span> <span class="n">client</span> <span class="ow">and</span> <span class="n">get</span> <span class="n">OTP</span>
  <span class="n">ipahost</span><span class="p">:</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">present</span>
    <span class="n">principal</span><span class="p">:</span> <span class="s2">&quot;{{ ipaserver_principal }}&quot;</span>
    <span class="n">password</span><span class="p">:</span> <span class="s2">&quot;{{ ipaserver_password }}&quot;</span>
    <span class="n">fqdn</span><span class="p">:</span> <span class="s2">&quot;{{ ansible_fqdn }}&quot;</span>
    <span class="n">random</span><span class="p">:</span> <span class="kc">True</span>
  <span class="n">register</span><span class="p">:</span> <span class="n">ipahost_output</span>
  <span class="n">delegate_to</span><span class="p">:</span> <span class="s2">&quot;{{ groups.ipaservers[0] }}&quot;</span>
</pre></div>
</div>
</section>
<section id="use-the-ipaclient-role-to-configure-ipa-client">
<h2>Use the ipaclient role to configure IPA client<a class="headerlink" href="#use-the-ipaclient-role-to-configure-ipa-client" title="Link to this heading">#</a></h2>
<p>Create a playbook calling ipaclient role.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat install_with_role.yml
---
- name: Playbook to install IPA clients
  hosts: ipaclients
  become: true
  roles:
  - role: ipaclient
    state: present
</pre></div>
</div>
<p>Call the playbook</p>
<p><code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">ansible-playbook</span> <span class="pre">-i</span> <span class="pre">inventory/hosts</span> <span class="pre">install_with_role.yml</span></code></p>
<p>The role is written to handle the various cases based on the content of
the inventory:</p>
<ul class="simple">
<li><p>enrollment options:</p>
<ul>
<li><p>if ipaclient_principal and ipaclient_password are specified, the
IPA client will be configured with the specified credentials
(equivalent to ipa-client-install –principal … –password …)</p></li>
<li><p>if ipaclient_keytab is specified, the IPA client will be
configured with the specified keytab (equivalent to
ipa-client-install –keytab …)</p></li>
<li><p>if neither ipaclient_password nor ipaclient_keytab is specified,
the role will assume that OTP enrollment is desired and will
register the host as client using ipahost module. The ipahost
module requires authentication to the IPA server as described
below.</p></li>
</ul>
</li>
<li><p>if the ipahost module is needed to create a OTP, it will be delegated
to the server and will use one of the following auth methods:</p>
<ul>
<li><p>use ipaserver_principal and ipaserver_password, or</p></li>
<li><p>use ipaserver_principal and ipaserver_keytab</p></li>
</ul>
</li>
</ul>
</section>
<section id="test-plan">
<h2>Test Plan<a class="headerlink" href="#test-plan" title="Link to this heading">#</a></h2>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-client-configuration">IPA client configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-client-unconfiguration">IPA client unconfiguration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ansible-ipaclient-module">Ansible ipaclient module</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ansible-ipahost-module">Ansible ipahost module</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ansible-ipaclient-role">Ansible ipaclient role</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#state-present">state: present</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#state-absent">state: absent</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-use">How to Use</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-ansible-ipaclient-module-to-unconfigure-ipa">Using the Ansible ipaclient module to unconfigure IPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-ansible-role-ipaclient-to-unconfigure-ipa">Using the Ansible role ipaclient to unconfigure IPA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-ipaclient-module-to-configure-ipa-client-by-providing-username-and-password">Use the ipaclient module to configure IPA client by providing username and password</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-ipahost-and-ipaclient-modules-to-configure-ipa-client-by-providing-an-otp-password">Use the ipahost and ipaclient modules to configure IPA client by providing an OTP password</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-ipaclient-role-to-configure-ipa-client">Use the ipaclient role to configure IPA client</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>