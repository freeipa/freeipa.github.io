

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>LDAP_Connection_Management_Refactoring &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/LDAP_Connection_Management_Refactoring';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="/_static/freeipa-logo-small.png" class="logo__image only-light" alt="Logo image" />
</a>
<div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/LDAP_Connection_Management_Refactoring.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>LDAP_Connection_Management_Refactoring</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-framework">In framework</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#local-server">Local server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-server">Remove server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proper-usage">Proper usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#api-backend-ldap2">api.Backend.ldap2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#restarting-directory-server">Restarting Directory Server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adhoc-connections">Adhoc connections</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ldap2">ldap2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changes">Changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#merge-ipadmin-to-ldapclient">Merge IPAdmin to LDAPClient</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-ldapi-when-connecting-to-localhost">Use ldapi when connecting to localhost</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-a-shared-ldap-connection-in-installers-and-install-tools">Use a shared LDAP connection in installers and install tools</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#future-effors">Future effors</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="ldap-connection-management-refactoring">
<h1>LDAP_Connection_Management_Refactoring<a class="headerlink" href="#ldap-connection-management-refactoring" title="Permalink to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">#</a></h2>
<p>Improvements in managing the LDAP connections have been made as a part o
the 4.5 refactoring effort. This document describes how to properly use
LDAP connections now and what changes have been made.</p>
<p>Historically, LDAP connections to Directory Server (DS) have been
established adhoc and there was duplicated code scattered around the
code base. Some connections weren’t closed properly. There were multiple
ways to connect to LDAP.</p>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">#</a></h2>
</section>
<section id="in-framework">
<h2>In framework<a class="headerlink" href="#in-framework" title="Permalink to this heading">#</a></h2>
<p>When working with a framework, you can use api.Backend.ldap2.</p>
<p>You do not need to worry about connects and disconnects. These are
handled in an upper abstraction layer along with setting proper size and
time limits.</p>
</section>
<section id="local-server">
<h2>Local server<a class="headerlink" href="#local-server" title="Permalink to this heading">#</a></h2>
<p>When you’re writing a script that needs to connect to a local server,
you need to explicitly connect and disconnect from the LDAP server. The
following code will connect with LDAPI and use external bind:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ipalib</span> <span class="kn">import</span> <span class="n">api</span>

<span class="n">api</span><span class="o">.</span><span class="n">Backend</span><span class="o">.</span><span class="n">ldap2</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Use api.Backend.ldap2</span>
    <span class="c1"># ...</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">Backend</span><span class="o">.</span><span class="n">ldap2</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="remove-server">
<h2>Remove server<a class="headerlink" href="#remove-server" title="Permalink to this heading">#</a></h2>
<p>When connecting to a remote server, use LDAPClient. An example with
LDAPClient and simple_bind():</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ipapython</span> <span class="kn">import</span> <span class="n">ipaldap</span>

<span class="n">ldap_uri</span> <span class="o">=</span> <span class="n">ipaldap</span><span class="o">.</span><span class="n">get_ldap_uri</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="k">with</span> <span class="n">ipaldap</span><span class="o">.</span><span class="n">LDAPClient</span><span class="p">(</span><span class="n">ldap_uri</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">simple_bind</span><span class="p">(</span><span class="n">bind_dn</span><span class="p">,</span> <span class="n">bind_pw</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">unbind</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="proper-usage">
<h2>Proper usage<a class="headerlink" href="#proper-usage" title="Permalink to this heading">#</a></h2>
</section>
<section id="api-backend-ldap2">
<h2>api.Backend.ldap2<a class="headerlink" href="#api-backend-ldap2" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Use whenever accessing local directory server</p></li>
<li><p>Connect only at start and end of script</p></li>
<li><p>Connection is automatically re-established if DS is restarted</p></li>
<li><p>Uses ldapi</p></li>
</ul>
</section>
<section id="restarting-directory-server">
<h2>Restarting Directory Server<a class="headerlink" href="#restarting-directory-server" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Use start(), stop() and restart() methods of DsInstance</p>
<ul>
<li><p>These already manage the api.Backend.ldap2 connection</p></li>
</ul>
</li>
<li><p>Using knownservices to restart a DS instance is deprecated and
requires a manual dis/re/connect of api.Backend.ldap2</p></li>
</ul>
</section>
<section id="adhoc-connections">
<h2>Adhoc connections<a class="headerlink" href="#adhoc-connections" title="Permalink to this heading">#</a></h2>
<p>api.Backend.ldap2 should be always preferred if connecting to the local
server. In the cases, where you need to establish a connection to other
server, you can use an adhoc connection.</p>
<ul class="simple">
<li><p>Use get_ldap_uri() to generate ldap_uri from protocol, host, port,
…</p></li>
<li><p>Initialize the connection with LDAPClient</p></li>
<li><p>Make sure to properly close the connection when it is no longer used</p></li>
</ul>
</section>
<section id="ldap2">
<h2>ldap2<a class="headerlink" href="#ldap2" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>No time_limit and size_limit by default</p></li>
<li><p>Set time_limit=None and size_limit=None to respect values in ipa
config file</p></li>
</ul>
</section>
<section id="changes">
<h2>Changes<a class="headerlink" href="#changes" title="Permalink to this heading">#</a></h2>
<p>The following improvements have been made as a part of the 4.5
refactoring effort.</p>
</section>
<section id="merge-ipadmin-to-ldapclient">
<h2>Merge IPAdmin to LDAPClient<a class="headerlink" href="#merge-ipadmin-to-ldapclient" title="Permalink to this heading">#</a></h2>
<p>IPAdmin was merged into LDAPClient and removed completely. The following
changes were made in ipaldap:</p>
<ul class="simple">
<li><p>Removed wait and timeout for establishing a connection (in IPAdmin).</p>
<ul>
<li><p>This code was obsolete, because there is a wait when the directory
server is start / restarted.</p></li>
</ul>
</li>
<li><p>Used simple_bind(), external_bind() and gssapi_bind() instead of
their do_* alternatives, which were removed.</p></li>
<li><p>Removed user name from external_bind() and always set it to effective
user name.</p></li>
<li><p>Removed obsolete and unused IPAdmin properties</p>
<ul>
<li><p>ldapi</p></li>
<li><p>realm</p></li>
<li><p>suffixes</p></li>
</ul>
</li>
<li><p>Moved the following IPAdmin properties to LDAPClient:</p>
<ul>
<li><p>host (automatically parsed from ldap_uri)</p></li>
<li><p>port (automatically parsed from ldap_uri)</p></li>
<li><p>cacert (IPAdmin) -&gt; _cacert (LDAPClient)</p></li>
</ul>
</li>
<li><p>Added the following options to LDAPClient constructor:</p>
<ul>
<li><p>cacert</p></li>
<li><p>sasl_nocanon</p></li>
</ul>
</li>
<li><p>Created get_ldap_uri() function to determine ldap_uri from former
IPAdmin constructor arguments</p></li>
<li><p>Replaced all occurrences of IPAdmin with LDAPClient</p>
<ul>
<li><p>get_ldap_uri() is used to construct ldap_uri</p></li>
<li><p>LDAPClient object is initialized with the ldap_uri</p></li>
</ul>
</li>
</ul>
</section>
<section id="use-ldapi-when-connecting-to-localhost">
<h2>Use ldapi when connecting to localhost<a class="headerlink" href="#use-ldapi-when-connecting-to-localhost" title="Permalink to this heading">#</a></h2>
<p>When a local connection is established, it should use ldapi whenever
possible. api.Backend.ldap2 was configured to use ldapi. Some adhoc
connections were replaced with api.Backend.ldap2.</p>
<p>ldap2 default time and size limit was set to unlimited. Limit for use in
rpc still respects the ipa config file.</p>
</section>
<section id="use-a-shared-ldap-connection-in-installers-and-install-tools">
<h2>Use a shared LDAP connection in installers and install tools<a class="headerlink" href="#use-a-shared-ldap-connection-in-installers-and-install-tools" title="Permalink to this heading">#</a></h2>
<p>In installers and install tools, an ldap connection (if needed) should
be established at the start of the script and properly closed at the end
of the script. When a directory server is started, stopped or restarted,
the connection should dis/re/connect accordingly.</p>
<ul class="simple">
<li><p>api.Backend.ldap2 was used across installers and install tools for
local LDAP connection</p></li>
<li><p>Directory Server installation required the following modifications:</p>
<ul>
<li><p>Enabled ldapi and configured autobind for root after instance
creation</p></li>
<li><p>Overriden start, stop and restart method of DsInstance to also
dis/re/connect the api.Backend.ldap2.connection</p></li>
</ul>
</li>
</ul>
</section>
<section id="future-effors">
<h2>Future effors<a class="headerlink" href="#future-effors" title="Permalink to this heading">#</a></h2>
<p>Not all the issues with LDAP connection management were removed due to
time and scope constraints of this effort.</p>
<p>Future changes may include the following:</p>
<ul class="simple">
<li><p>Replaces instance creations of ldap2() with LDAPClient</p></li>
<li><p>Remove all unnecessary adhoc connections</p></li>
<li><p>Consider using a single adhoc connection to a replica during
install/promote instead of repeatedly connecting.</p></li>
<li><p>Remove modify_s()</p></li>
</ul>
</section>
</section>


                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#in-framework">In framework</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#local-server">Local server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remove-server">Remove server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#proper-usage">Proper usage</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#api-backend-ldap2">api.Backend.ldap2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#restarting-directory-server">Restarting Directory Server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adhoc-connections">Adhoc connections</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ldap2">ldap2</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changes">Changes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#merge-ipadmin-to-ldapclient">Merge IPAdmin to LDAPClient</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-ldapi-when-connecting-to-localhost">Use ldapi when connecting to localhost</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-a-shared-ldap-connection-in-installers-and-install-tools">Use a shared LDAP connection in installers and install tools</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#future-effors">Future effors</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>