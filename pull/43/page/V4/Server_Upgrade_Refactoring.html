
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Server_Upgrade_Refactoring &#8212; FreeIPA  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=384b581d" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'page/V4/Server_Upgrade_Refactoring';</script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><a class="navbar-brand logo" href="/">
    <img src="https://raw.githubusercontent.com/freeipa/freeipa.github.io/main/src/_static/freeipa-logo-small.png" class="logo__image" alt="Logo image" />
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><div class="sidebar-primary-item">
    <nav class="bd-links" id="bd-docs-nav" aria-label="Main">
        <div class="bd-toc-item navbar-nav active">
            <ul class="nav bd-sidenav">
                <li class="toctree-l1"><a class="reference internal" href="/About.html">About</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Contribute.html">Contribute</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Documentation.html">Documentation</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/page/Troubleshooting.html">Troubleshooting</a></li>
                <li class="toctree-l1"><a class="reference internal" href="/Downloads.html">Downloads</a></li>
            </ul>
        </div>
    </nav>
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/page/V4/Server_Upgrade_Refactoring.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Server_Upgrade_Refactoring</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-upgrade-process-more-deterministic">Make upgrade process more deterministic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ordering-ldap-updates">Ordering LDAP updates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plugin-the-new-update-file-directive"><em>plugin</em> - the new update file directive</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#update-plugins-modifications">Update plugins modifications</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#merge-server-update-commands-into-the-one-command">Merge server update commands into the one command</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-server-upgrade-characteristics">ipa-server-upgrade characteristics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prevent-to-run-ipa-if-version-mismatch">Prevent to run IPA if version mismatch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#refactor-ipa-upgradeconfig-into-modules-plugins-used-by-ipa-server-update">Refactor ipa-upgradeconfig into modules/plugins used by ipa-server-update</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#requirements-for-using-updates-in-containers">Requirements for using updates in containers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-configuration-version-and-platform-place-format">Storing configuration version and platform (place, format)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-test">How to Test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#author">Author</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="server-upgrade-refactoring">
<h1>Server_Upgrade_Refactoring<a class="headerlink" href="#server-upgrade-refactoring" title="Link to this heading">#</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>FreeIPA server becomes full of new features and enhancements over the
time, which makes upgrade process hard to keep in shape.</p>
<p>Following improvements, listed in this design, should make server update
process more deterministic, robust and working well in various update
environments (%posttrans update, containers, etc.).</p>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Make update process more deterministic</p></li>
<li><p>Merge server update commands into the one command
(<code class="docutils literal notranslate"><span class="pre">ipa-server-upgrade</span></code>)</p></li>
<li><p>Solve upgrades in containers</p></li>
<li><p>Prevent to run IPA service, if code version and configuration version
does not match</p>
<ul>
<li><p>ipactl should execute ipa-server-upgrade if needed</p></li>
</ul>
</li>
<li><p>Prevent user to use <code class="docutils literal notranslate"><span class="pre">ipa-upgradeconfig</span></code> and <code class="docutils literal notranslate"><span class="pre">ipa-ldap-updater</span></code></p>
<ul>
<li><p>remove ipa-upgradeconfig</p></li>
<li><p>refactor ipa-ldap-updater to allow execute updates for specified
files with HUGE warning (disallow to execute overall update)</p></li>
</ul>
</li>
</ul>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Link to this heading">#</a></h2>
</section>
<section id="make-upgrade-process-more-deterministic">
<h2>Make upgrade process more deterministic<a class="headerlink" href="#make-upgrade-process-more-deterministic" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="http://www.redhat.com/archives/freeipa-devel/2014-December/msg00183.html">Freeipa-devel list
discussion</a></p>
<p>Currently update process do several optimizations which may prevent some
errors during update (do update in proper relation parent to children,
respectively children to parent during removing). In other hand, the
parent to child relation, is not the only one restriction. We use
several plugins in 389 directory server, which require proper order of
updates in different sub trees.</p>
<p>It causes unexpected errors because the order of updates in files is not
the same as real update. Developers should be responsible for proper
order of updates, as is not possible to create effective updates
sorting, which will respect all 389 DS plugins requirements.</p>
<p>This effort consist of following steps:</p>
<ul class="simple">
<li><p>Do not sort order of updates based on length of DN.</p></li>
<li><p>Do not use dictionary to store updates. Dictionary mixes the order of
particular updates per file. Using lists achieve, the order of
updates will be same as order in files.</p></li>
<li><p>Apply updates per file, in specified order from top to bottom.</p></li>
</ul>
<section id="ordering-ldap-updates">
<h3>Ordering LDAP updates<a class="headerlink" href="#ordering-ldap-updates" title="Link to this heading">#</a></h3>
<p>All LDAP update files are ordered/executed in alphabetical order. Update
files should keep the number prefix, but this is not required anymore by
updater.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">05</span><span class="o">-</span><span class="n">pre</span><span class="o">-</span><span class="n">update</span><span class="o">-</span><span class="n">plugins</span><span class="o">.</span><span class="n">update</span>
<span class="mi">10</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">update</span>
<span class="mi">20</span><span class="o">-</span><span class="n">syncrepl</span><span class="o">.</span><span class="n">update</span>
<span class="o">...</span>
<span class="mi">90</span><span class="o">-</span><span class="n">last</span><span class="o">.</span><span class="n">update</span>
<span class="n">ZZ</span><span class="o">.</span><span class="n">update</span>  <span class="c1"># this will work, but we should avoid of using number less update files</span>
</pre></div>
</div>
</section>
<section id="plugin-the-new-update-file-directive">
<h3><em>plugin</em> - the new update file directive<a class="headerlink" href="#plugin-the-new-update-file-directive" title="Link to this heading">#</a></h3>
<p>Plugins are called from update files, using new directive <strong>plugin:</strong></p>
<p>Plugins which edits ldap data directly, without using modlists, should
be in separate files.</p>
</section>
<section id="update-plugins-modifications">
<h3>Update plugins modifications<a class="headerlink" href="#update-plugins-modifications" title="Link to this heading">#</a></h3>
<p>Execution order of plugins is specified in .update files. There is no
need to keep PRE_UPDATE and POST_UPDATE plugin classes and FIRST,
MIDDLE, LAST order specifications.</p>
<p>Class <strong>Updater</strong> is used for all update plugins instead of <em>PreUpdate</em>
and <em>Postupdate</em> classes.</p>
<p>The <strong>execute</strong> method of the class, returns only 2 values
(<em>restart_ds</em>, <em>modlist</em>)</p>
<ul class="simple">
<li><p><em>restart_ds</em> - boolean value, DS server will be restarted after
<em>modlist</em> application</p></li>
<li><p><em>modlist</em> - list of required changes</p></li>
</ul>
</section>
</section>
<section id="merge-server-update-commands-into-the-one-command">
<h2>Merge server update commands into the one command<a class="headerlink" href="#merge-server-update-commands-into-the-one-command" title="Link to this heading">#</a></h2>
<p>Related ticket:
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4834">#4834</a>,
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3351">#3351</a></p>
<p>Currently two commands exist, which have to be exucuted in proper order
to upgrade IPA:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span><span class="o">-</span><span class="n">ldap</span><span class="o">-</span><span class="n">updater</span> <span class="o">--</span><span class="n">upgrade</span>
<span class="n">ipa</span><span class="o">-</span><span class="n">upgradeconfig</span>
</pre></div>
</div>
<p>Using these commands in wrong order, or execute ipa-upgradecofig if
ipa-ldap-updater failed, can break the system.</p>
<p>To resolve issues mentioned above only one command should do upgrade:
<code class="docutils literal notranslate"><span class="pre">ipa-server-upgrade</span></code>.</p>
<section id="ipa-server-upgrade-characteristics">
<h3>ipa-server-upgrade characteristics<a class="headerlink" href="#ipa-server-upgrade-characteristics" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>LDAPI only is used for upgrade (no binding using DM password)</p></li>
<li><p>check the version of configuration and code version, run only if
installed version is newer than configuration version
(<em>–skip-version-check</em> overrides this check, see steps).</p></li>
<li><p>upgrade steps:</p></li>
</ul>
<ol class="arabic simple">
<li><p>stop IPA services</p></li>
<li><p>check build and installed platform, if platform mismatch abort
upgrade</p></li>
<li><p>check build version and installed version</p>
<ol class="arabic simple">
<li><p>newer build than data: continue</p></li>
<li><p>same version of data and build: skip data upgrade</p></li>
<li><p>older version of build: abort upgrade</p></li>
</ol>
</li>
<li><p>prepare DS to upgrade (stop DS, save configuration, disabling
listeners, start DS)</p></li>
<li><p>SCHEMA update</p></li>
<li><p>LDAP data update + update plugins (update of user data in LDAP, and
cn=config LDAP configurations)</p></li>
<li><p>upgrade configuration (upgrade of services: httpd, named, etc…)</p></li>
<li><p>restore DS (stop DS, restoring configuration)</p></li>
<li><p>(re)start IPA services</p></li>
</ol>
<ul class="simple">
<li><p>update configuration version, if update was successful</p></li>
<li><p>only former <strong>–upgrade</strong>/offline method is supported</p></li>
</ul>
</section>
</section>
<section id="prevent-to-run-ipa-if-version-mismatch">
<h2>Prevent to run IPA if version mismatch<a class="headerlink" href="#prevent-to-run-ipa-if-version-mismatch" title="Link to this heading">#</a></h2>
<p>Related ticket: <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3849">#3849</a></p>
<p><code class="docutils literal notranslate"><span class="pre">ipactl</span> <span class="pre">{start|restart}</span></code></p>
<ol class="arabic simple">
<li><p>compare build platform and platform from the last
upgrade/installation (based on <em>ipaplatform</em> file)</p>
<ol class="arabic simple">
<li><p>if platform mismatch, raise error and prevent to start IPA
services</p></li>
</ol>
</li>
<li><p>compare version of LDAP data(+schema included) and build version
(<em>VENDOR_VERSION</em> will be used)</p>
<ol class="arabic simple">
<li><p>if LDAP data version <strong>&gt;</strong> build version: raise error and prevent
services to start (newer data than IPA build)</p></li>
<li><p>if LDAP data version <strong>&lt;</strong> build version: upgrade required (data
are older than IPA build)</p></li>
<li><p>if LDAP data version <strong>==</strong> build version: continue (data up to
date)</p></li>
</ol>
</li>
<li><p>check if any of services requires upgrade<strong>**</strong></p>
<ol class="arabic simple">
<li><p>if any service requires upgrade, upgrade is required</p></li>
<li><p>if any service raises an error about wrong configuration (which
requires manual fix by user), raise error and prevent to start
services</p></li>
</ol>
</li>
<li><p>if any upgrade is required, prevent to start services and prompt user
to run <em>ipa-server-upgrade</em> (ipactl will not execute upgrade itself)</p></li>
<li><p>(otherwise) start services</p></li>
</ol>
<p><strong>**</strong> will be available after installers refactoring</p>
<p>This behavior is required in container environments (or fedup), where
the ipa-server-upgrade can not be executed as RPM %postrans operation,
but data and configuration must be updated before first start of newer
IPA.</p>
<p><code class="docutils literal notranslate"><span class="pre">ipactl</span> <span class="pre">start|restart</span></code> option <code class="docutils literal notranslate"><span class="pre">--skip-version-check</span></code> overrides this
check.</p>
</section>
<section id="refactor-ipa-upgradeconfig-into-modules-plugins-used-by-ipa-server-update">
<h2>Refactor ipa-upgradeconfig into modules/plugins used by ipa-server-update<a class="headerlink" href="#refactor-ipa-upgradeconfig-into-modules-plugins-used-by-ipa-server-update" title="Link to this heading">#</a></h2>
<p>This will be done during the installer refactoring.</p>
</section>
<section id="requirements-for-using-updates-in-containers">
<h2>Requirements for using updates in containers<a class="headerlink" href="#requirements-for-using-updates-in-containers" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Upgrade must run before first start of IPA services (if required)</p></li>
<li><p>Switching between images based on different OS distribution is not
supported, upgrade can’t handle differences in distribution patches.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ipactl</span> <span class="pre">start</span> <span class="pre">|</span> <span class="pre">restart</span></code> refuse to start IPA services if
ipaplatform doesn’t match the platform in configuration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-server-upgrade</span></code> refuse to start upgrading if ipaplatform
doesn’t match the platform in configuration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--skip-version-check</span></code> option allows to override this check, but
there is no guarantee the IPA will work as expected</p></li>
</ul>
</li>
</ul>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h2>
</section>
<section id="storing-configuration-version-and-platform-place-format">
<h2>Storing configuration version and platform (place, format)<a class="headerlink" href="#storing-configuration-version-and-platform-place-format" title="Link to this heading">#</a></h2>
<p>The ipapython.version.IPA_VENDOR_VERSION variable is used to determine
IPA version. The format is 4.1.2-0.fc21.</p>
<p>The platform value consist of ipaplatform file name which is used for a
build. The platform name is detected during first run of
ipa-server-upgrade on existing systems, respectively during installation
IPA 4.2+ servers.</p>
<p>Values are stored into <strong>sysupgrade.state</strong> file as <strong>ipa_version</strong> and
<strong>ipa_platform</strong></p>
</section>
<section id="feature-management">
<h2>Feature Management<a class="headerlink" href="#feature-management" title="Link to this heading">#</a></h2>
<p>UI</p>
<p>N/A</p>
<p>CLI</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Options</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ipa-server-upgrade</p></td>
<td><div class="pst-scrollable-table-container"><table class="table">
<tbody>
<tr class="row-odd"><td><p>–skip-v
ersion-check</p></td>
<td><p>do not check
IPA version</p></td>
</tr>
<tr class="row-even"><td><p>–version</p></td>
<td><p>show
program’s
version
number and
exit</p></td>
</tr>
<tr class="row-odd"><td><p>-h, –help</p></td>
<td><p>show this
help message
and exit</p></td>
</tr>
<tr class="row-even"><td><p>-d, –debug</p></td>
<td><p>print
debugging
information</p></td>
</tr>
<tr class="row-odd"><td><p>-q, –quiet</p></td>
<td><p>output only
errors</p></td>
</tr>
<tr class="row-even"><td><p>–l
og-file=FILE</p></td>
<td><p>log to the
given file</p></td>
</tr>
</tbody>
</table>
</div>
</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">#</a></h2>
<p>N/A</p>
</section>
<section id="how-to-test">
<h2>How to Test<a class="headerlink" href="#how-to-test" title="Link to this heading">#</a></h2>
<p>Run <code class="docutils literal notranslate"><span class="pre">ipa-server-update</span></code> on various old versions of IPA.</p>
</section>
<section id="test-plan">
<h2>Test Plan<a class="headerlink" href="#test-plan" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="http://www.freeipa.org/page/V4/Server_Upgrade_Refactoring/Test_Plan">Test
Plan</a></p>
</section>
<section id="author">
<h2>Author<a class="headerlink" href="#author" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="User:Mbasti">Martin Basti</a></p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-cases">Use Cases</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-upgrade-process-more-deterministic">Make upgrade process more deterministic</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ordering-ldap-updates">Ordering LDAP updates</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plugin-the-new-update-file-directive"><em>plugin</em> - the new update file directive</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#update-plugins-modifications">Update plugins modifications</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#merge-server-update-commands-into-the-one-command">Merge server update commands into the one command</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ipa-server-upgrade-characteristics">ipa-server-upgrade characteristics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prevent-to-run-ipa-if-version-mismatch">Prevent to run IPA if version mismatch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#refactor-ipa-upgradeconfig-into-modules-plugins-used-by-ipa-server-update">Refactor ipa-upgradeconfig into modules/plugins used by ipa-server-update</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#requirements-for-using-updates-in-containers">Requirements for using updates in containers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#storing-configuration-version-and-platform-place-format">Storing configuration version and platform (place, format)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-management">Feature Management</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-test">How to Test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-plan">Test Plan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#author">Author</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By FreeIPA Team
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023, FreeIPA Team.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>